import{r as o,b as Na,u as ka,j as a}from"./index-Cr-4waUE.js";import{d as m,c as I,a as D,b as g}from"./index.esm-B75P6HjL.js";import{g as Ma,a as N,p as ne,c as Ra}from"./api-BUyL__Lx.js";import{S as fe}from"./react-select.esm-CzoKIuj1.js";import{a as _e,b as je,e as xe,c as ye,d as ve,g as Pa}from"./DefaultLayout-B8rErgo7.js";import{C as _}from"./CFormLabel-C33rygdk.js";import{C as v}from"./CFormInput-KPF1mpuU.js";import{C as Qe}from"./RawMaterial-21BlczCs.js";import{C as B,a as q}from"./CCardBody-DpPesGF7.js";import{C as Ea}from"./CCardHeader-CC-r8sJV.js";import{C as Ye}from"./CForm-BOPMc5UW.js";import{C as Ze}from"./CInputGroup-6t6wGJL1.js";import{c as Xe}from"./cil-x-0440B5Ce.js";import{c as Je}from"./cil-file-CeQgYs_D.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./emotion-react.browser.esm-C9aOzpPl.js";import"./floating-ui.dom-ByRZgDQ1.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-Bkuvlzpx.js";import"./CFormControlWrapper-BYXowQRV.js";import"./CFormControlValidation-CByzp8AE.js";var Fa=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M471.993,112h-89.2L366.551,65.25a32.023,32.023,0,0,0-30.229-21.5H175.241a31.991,31.991,0,0,0-30.294,21.691L129.1,112h-89.1a24.027,24.027,0,0,0-24,24V448a24.027,24.027,0,0,0,24,24H471.993a24.027,24.027,0,0,0,24-24V136A24.027,24.027,0,0,0,471.993,112Zm-8,328H48.007V144h104.01l23.224-68.25H336.322L360.032,144H463.993Z' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M256,168A114,114,0,1,0,370,282,114.13,114.13,0,0,0,256,168Zm0,196a82,82,0,1,1,82-82A82.093,82.093,0,0,1,256,364Z' class='ci-primary'/>"];const oe=()=>new Date().toISOString().split("T")[0],Ke=()=>({project_id:"",project_name:"",date:oe(),machineReading:[{uid:Date.now().toString()+Math.random().toString(36).slice(2),operator_id:"",machine_id:"",mode_id:"",mode:"",machine_start:"",machine_end:"",actual_machine_hr:0,price_per_hour:0,machine_start_pic:null,machine_end_pic:null,work_type_id:""}]}),rs=()=>{var Ge;const i=Ma(),j=i==null?void 0:i.type;i==null||i.name;const[h,w]=o.useState(()=>{var e;return{project_id:"",project_name:"",date:oe(),machineReading:[{uid:Date.now().toString()+Math.random().toString(36).slice(2),operator_id:j===2&&((e=i==null?void 0:i.id)==null?void 0:e.toString())||"",machine_id:"",mode_id:"",mode:"",machine_start:"",machine_end:"",actual_machine_hr:0,price_per_hour:0,machine_start_pic:null,machine_end_pic:null,work_type_id:""}]}}),{showToast:c}=Na(),[ea,ie]=o.useState(!1),[we,ce]=o.useState([]),[V,C]=o.useState(""),[G,Ce]=o.useState([]),[W,aa]=o.useState([]),[sa,le]=o.useState([]),[ta,b]=o.useState(!1),[be,ra]=o.useState(0),[$,Q]=o.useState(!1),[Se,Y]=o.useState(null),[de,Z]=o.useState(null),[me,na]=o.useState(null),[z,oa]=o.useState(""),[R,k]=o.useState([]);o.useState([]);const[Ne,ke]=o.useState(!1),[Me,Re]=o.useState(!1),[Pe,he]=o.useState([]),[O,P]=o.useState({}),[ia,M]=o.useState({}),[ue,X]=o.useState(!1),[f,J]=o.useState({customer_name:"",mobile_number:"",project_cost:"",supervisor_id:"",work_place:"",commission:"",start_date:"",end_date:"",is_visible:!0,remark:"",gst_number:"",operator_id:[""]}),[Ee,L]=o.useState({}),[Fe,K]=o.useState(!1),[Aa,ca]=o.useState([]),[Ta,la]=o.useState([]),[Ia,da]=o.useState({}),[E,ma]=o.useState(!1),[Ae,Te]=o.useState([]);o.useEffect(()=>{(async()=>{try{const r=(await N("/api/workingType")||[]).map(t=>({value:t.id,label:t.type_of_work}));Te(r)}catch(s){console.error("Error fetching work types",s)}})()},[]);const[ee,Ie]=o.useState("environment"),ae=o.useCallback(()=>{var e;w({project_id:"",project_name:"",date:oe(),machineReading:[{uid:Date.now().toString()+Math.random().toString(36).slice(2),operator_id:j===2&&((e=i==null?void 0:i.id)==null?void 0:e.toString())||"",machine_id:"",mode_id:"",mode:"",machine_start:"",machine_end:"",actual_machine_hr:0,price_per_hour:0,machine_start_pic:null,machine_end_pic:null,work_type_id:""}]}),C(""),k([]),A(!1),le([]),b(!1),P({}),M({})},[j,i==null?void 0:i.id]);o.useEffect(()=>{ae()},[ae]),o.useEffect(()=>{const e=async()=>{try{const r=await N("/api/operatorsByCompanyIdOperator");ca(r||[])}catch(r){console.error("Error fetching operators:",r)}},s=async()=>{try{const r=await N("/api/machine-operators");la(r||[]);const t={};r==null||r.forEach(d=>{Array.isArray(d.operator_id)&&d.operator_id.forEach(n=>{t[n]||(t[n]=[]),t[n].push(d)})}),da(t)}catch(r){console.error("Error fetching machines:",r)}};ue&&(e(),s())},[ue]);const[F,A]=o.useState(!1);ka();const We=async(e,s)=>{if(!e)return c("danger","No image file to upload."),null;const r=new FormData;r.append("file",e),r.append("dest",s);try{const t=await Ra("/api/fileUpload",r);if(t&&t.success)return c("success",t.message),t.fileName;throw new Error(t.message||"File upload failed.")}catch(t){return console.error("Error uploading image:",t),c("danger",t.message||"Could not upload image."),null}},H=o.useRef(null),pe=o.useRef(null),T=o.useRef(null);o.useRef(!1),G.filter(e=>sa.includes(e.value));const[ha,se]=o.useState(!1),[ge,$e]=o.useState(""),[te,ze]=o.useState(null),ua=async()=>{if(!ge.trim()){c("danger","Please enter work type name");return}try{const e=await ne("/api/saveWorkingType",{type_of_work:ge.trim()});c("success","Work type added successfully");const s={value:e.data.id,label:e.data.type_of_work};Te(r=>[...r,s]),P(r=>({...r,[te]:s.label})),M(r=>({...r,[te]:!1})),te!==null&&x(te,"work_type_id",s.value),$e(""),ze(null),se(!1)}catch(e){console.error(e),c("danger","Failed to add work type")}},pa=e=>{P(s=>({...s,[e]:""})),M(s=>({...s,[e]:!0}))},Oe=e=>e?Ae.filter(s=>s.label.toLowerCase().includes(e.toLowerCase())):Ae,re=o.useCallback(async e=>{try{const s=await N(`/api/projects?searchQuery=${e}`);ce(s||[])}catch(s){console.error("Error fetching projects:",s),ce([])}},[]);o.useEffect(()=>{N("/api/operatorsByType").then(e=>{const s=e.map(r=>({value:r.id.toString(),label:r.name}));if(j===2&&(i!=null&&i.id)){const r=s.find(t=>t.value===i.id.toString());Ce(r?[r]:s)}else Ce(s)}).catch(e=>{console.error("Error fetching operators:",e)})},[j,i==null?void 0:i.id]),o.useEffect(()=>{(async()=>{try{const s=await N("/api/machine-operators");console.log("machines from workslog",s),Array.isArray(s)&&aa(s)}catch(s){console.error("Error fetching machineries:",s)}})()},[]),o.useEffect(()=>{(async()=>{try{const s=await N("/api/machine-price");console.log("machine prices",s),Array.isArray(s)?he(s):(console.error("Unexpected response format:",s),he([]))}catch(s){console.error("Error fetching machine prices:",s),he([])}})()},[]),o.useEffect(()=>{const e=setTimeout(()=>{re(V)},300);return()=>clearTimeout(e)},[V,re]);const ga=()=>{C(""),re(""),b(!0)},Le=o.useCallback(async()=>{if(!E)try{const e={video:{facingMode:ee,width:{ideal:1280},height:{ideal:720}}},s=await navigator.mediaDevices.getUserMedia(e);T.current=s,H.current&&(H.current.srcObject=s)}catch(e){console.error("Camera access failed:",e),c("danger","Camera access denied. Please allow camera permission."),ma(!0)}},[ee,E,c]),U=o.useCallback(()=>{T.current&&(T.current.getTracks().forEach(e=>e.stop()),T.current=null)},[]),He=o.useCallback((e,s=.7,r=800,t=600)=>new Promise(d=>{const n=document.createElement("canvas"),l=n.getContext("2d"),u=new Image;u.onload=()=>{let{width:p,height:y}=u;if(p>r||y>t){const S=Math.min(r/p,t/y);p*=S,y*=S}n.width=p,n.height=y,l.drawImage(u,0,0,p,y),n.toBlob(S=>{const Sa=new File([S],"machine_photo.jpg",{type:"image/jpeg",lastModified:Date.now()});d(Sa)},"image/jpeg",s)},u.src=URL.createObjectURL(e)}),[]),fa=o.useCallback(async()=>{if(!H.current||!pe.current)return;const e=pe.current,s=H.current,r=e.getContext("2d");e.width=s.videoWidth,e.height=s.videoHeight,r.drawImage(s,0,0),e.toBlob(async t=>{if(t){Y(URL.createObjectURL(t));const d=await He(t);Z(d),c("success","Photo captured successfully")}},"image/jpeg",.8)},[He,c]),Ue=o.useCallback((e,s)=>{na(e),oa(s),Y(null),Z(null),Q(!0)},[]),_a=o.useCallback(async()=>{if(!de){c("warning","Please capture a photo");return}const s=await We(de,z==="start"?"machine_start_photos":"machine_end_photos");if(s){if(F&&z==="end"){const r=[...R];r[me].machine_end_pic=s,k(r)}else{const r=z==="start"?"machine_start_pic":"machine_end_pic",t=[...h.machineReading];t[me][r]=s,w({...h,machineReading:t})}Q(!1),Y(null),Z(null),U()}},[de,me,z,h,R,F,U,c,We]),ja=(e,s)=>{const r=[...h.machineReading];r[e][s]=null,w({...h,machineReading:r})},xa=(e,s)=>{if(!e||!s)return 0;const r=parseFloat(s)-parseFloat(e);return r>=0?r.toFixed(2):0},x=(e,s,r)=>{const t=[...h.machineReading];t[e][s]=r,(s==="machine_start"||s==="machine_end")&&(t[e].actual_machine_hr=xa(t[e].machine_start,t[e].machine_end)),w({...h,machineReading:t})},De=(e,s,r)=>{const t=[...R];if(s==="machine_end"){let l=r.replace(/[^0-9.]/g,"");const u=l.split(".");u.length>2&&(l=u[0]+"."+u.slice(1).join("")),t[e][s]=l}else t[e][s]=r;const d=parseFloat(t[e].start_reading)||0,n=parseFloat(t[e].machine_end);!isNaN(n)&&n>0?t[e].actual_machine_hr=(n-d>=0?n-d:0).toFixed(2):t[e].actual_machine_hr=0,k(t)},Be=o.useCallback(async e=>{if(!e)return[];try{const s=await N(`/api/pending?project_id=${e}`);return console.log("pending",s),Array.isArray(s)?s:[]}catch(s){return console.error("Error fetching pending readings from server",s),[]}},[]),qe=async e=>{w(s=>({...s,project_id:e.id,project_name:e.project_name})),le(e.operator_id||[]),C(e.customer_name),ce([]),b(!1);try{const s=await Be(e.id);s&&s.length>0?(c("info",`Found ${s.length} machine(s) with pending end readings.`),k(s),A(!0)):(c("success","No pending readings found. You can add new start readings."),A(!1))}catch(s){console.error("Error fetching pending readings:",s),c("danger","Failed to check project status from the server.")}},ya=(e,s)=>{w(r=>({...r,[e]:s}))},va=o.useCallback(async e=>{ke(!0);try{console.log("validReadings"),console.log(e);const s=e.map(r=>{const t={project_id:h.project_id,machine_id:r.machine_id,operator_id:r.operator_id,mode_id:r.mode_id,work_type_id:r.work_type_id,machine_start:r.machine_start,date:h.date,machine_start_pic:r.machine_start_pic};return ne("/api/start",t)});await Promise.all(s)}finally{ke(!1)}},[h.date,h.project_id]),wa=async()=>{if(!h.project_id){c("danger","Please select a Customer.");return}j===2&&(h.machineReading=h.machineReading.map(t=>({...t,operator_id:i.id.toString()})));const e=[],s=[],r=[];if(h.machineReading.forEach((t,d)=>{const n=t.operator_id&&t.machine_id&&t.mode_id&&t.work_type_id&&t.machine_start,l=j===2?!!t.machine_start_pic:!0;n&&l?e.push(t):n?l||s.push(d+1):r.push(d+1)}),e.length===0){s.length>0?c("danger",`Start photo is required for row(s): ${s.join(", ")}. Please upload a photo.`):r.length>0?c("danger",`Incomplete data in row(s): ${r.join(", ")}. Please fill machine, mode, and start reading.`):c("danger","Please add at least one complete machine reading.");return}try{await va(e),c("success",`${e.length} start reading(s) saved successfully.`);const t=await Be(h.project_id);t.length>0?(k(t),A(!0)):(ae(),c("success","Form cleared. Ready to add a new work log."))}catch{c("danger","Error saving start readings. Please try again.")}},Ca=o.useCallback(async e=>{if(!e||!e.id)throw new Error("Invalid reading to update");const s={machine_end:parseFloat(e.machine_end).toFixed(2),machine_end_pic:e.machine_end_pic};return await ne(`/api/end/${e.id}`,s)},[]),ba=async()=>{const e=[],s=[],r=[];if(R.forEach((t,d)=>{var p;const n=parseFloat(t.machine_end),l=parseFloat(t.start_reading)||0,u=((p=W.find(y=>y.id===parseInt(t.machine_id)))==null?void 0:p.machine_name)||`Machine #${t.machine_id}`;if(isNaN(n)){r.push(u);return}if(n<=l){s.push(u);return}j===2&&!t.machine_end_pic&&e.push(u)}),e.length>0){c("danger",`End photo is required for: ${e.slice(0,3).join(", ")}${e.length>3?` and ${e.length-3} more`:""}.`);return}if(s.length>0){c("danger",`End reading must be greater than start reading for: ${s.slice(0,3).join(", ")}${s.length>3?` and ${s.length-3} more`:""}.`);return}if(r.length>0){c("danger",`Invalid end reading (not a number) for: ${r.slice(0,3).join(", ")}${r.length>3?` and ${r.length-3} more`:""}.`);return}Re(!0);try{const t=R.map(n=>Ca(n));await Promise.all(t),c("success","All end readings have been submitted successfully!"),ie(!0),setTimeout(()=>ie(!1),2500);const d=Ke();w(d),k([]),A(!1),C(""),le([]),b(!1),ae(),c("success","Form reset. Ready for new entry.")}catch(t){c("danger","An error occurred while saving end readings."),console.error(t)}finally{Re(!1)}},Ve=o.useCallback(e=>e?W.filter(s=>Array.isArray(s.operator_id)&&s.operator_id.includes(String(e))).map(s=>({value:s.id,label:s.machine_name})):[],[W]);return o.useEffect(()=>{if(!$){U();return}if(!E){const e=/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);Ie(e?"environment":"user")}},[$,E,U]),o.useEffect(()=>{!$||E||(U(),Le())},[ee,$,E]),o.useEffect(()=>{j===2&&(i!=null&&i.id)&&ra(i.id.toString())},[j,i==null?void 0:i.id]),a.jsxs("div",{className:"",children:[a.jsxs(_e,{visible:ha,onClose:()=>se(!1),alignment:"center",children:[a.jsx(je,{children:a.jsx(xe,{children:"Add New Work Type"})}),a.jsxs(ye,{children:[a.jsx(_,{children:"Work Type Name"}),a.jsx(v,{type:"text",placeholder:"e.g. Excavation, Heavy Lifting",value:ge,onChange:e=>$e(e.target.value)})]}),a.jsxs(ve,{children:[a.jsx(m,{color:"secondary",onClick:()=>se(!1),children:"Cancel"}),a.jsx(m,{color:"primary",onClick:ua,children:"Save"})]})]}),a.jsxs("div",{fluid:!0,children:[ea&&a.jsx(Qe,{color:"success",dismissible:!0,onClose:()=>ie(!1),children:"Form submitted successfully!"}),a.jsxs(B,{className:"",children:[a.jsx(Ea,{className:"bg-primary text-white",children:a.jsxs("h1",{className:"mb-2 h4 d-flex align-items-center",children:[a.jsx(I,{icon:Pa,className:"me-2"})," Daily Work"]})}),a.jsx(q,{className:"p-2",children:a.jsxs(Ye,{children:[a.jsx(B,{className:"mb-4 border-0",color:"info",textColor:"dark",children:a.jsx(q,{className:"bg-info-subtle rounded rounded-lg",children:a.jsxs(D,{className:"g-3",children:[a.jsxs(g,{md:6,children:[a.jsx(_,{children:"Customer Name"}),a.jsxs(Ze,{children:[a.jsx(v,{type:"text",value:V,onChange:e=>{C(e.target.value),b(!0)},placeholder:"Search for a customer...",disabled:F}),h.project_name&&a.jsx(m,{type:"button",color:"danger",variant:"outline",onClick:()=>{w(Ke()),k([]),A(!1),C(""),b(!1)},children:"âœ•"}),a.jsx(m,{type:"button",color:"danger",variant:"outline",onClick:ga,children:"Show All"})]}),ta&&a.jsx("div",{className:"border rounded bg-white",style:{maxHeight:"150px",overflowY:"auto"},children:we.length>0?we.map(e=>a.jsxs("div",{className:"p-2 hover-bg-light",style:{cursor:"pointer"},onClick:()=>{qe(e),C(e.customer_name),b(!1)},children:[a.jsx("div",{children:e.customer_name}),a.jsx("div",{className:"text-muted small",style:{fontSize:"0.85em"},children:e.mobile_number||"No Mobile"})]},e.id)):a.jsxs("div",{className:"p-2",children:[a.jsx("div",{children:"No Customer found."}),a.jsx(m,{color:"primary",size:"sm",className:"mt-2",onClick:()=>X(!0),children:"Add New Customer"})]})})]}),a.jsxs(g,{md:6,children:[a.jsx(_,{children:"Date "}),a.jsx(v,{type:"date",value:h.date||oe(),onChange:e=>ya("date",e.target.value),disabled:F||j===2})]})]})})}),F?a.jsx(B,{className:"mb-4 border-0",color:"warning",textColor:"dark",children:a.jsxs(q,{className:"bg-warning-subtle rounded rounded-lg",children:[a.jsx("h5",{className:"text-warning-emphasis mb-3 d-flex align-items-center",children:"Add Machine End Readings"}),R.map((e,s)=>{var u;const r=((u=G.find(p=>p.value===e.operator_id))==null?void 0:u.label)||"N/A",t=Pe.find(p=>p.id===parseInt(e.mode_id)),d=t?t.mode.charAt(0).toUpperCase()+t.mode.slice(1).replace(/-/g," "):"N/A",n=W.find(p=>p.id===parseInt(e.machine_id)),l=(n==null?void 0:n.machine_name)||"N/A";return a.jsx(B,{className:"mb-3",children:a.jsx(q,{children:a.jsxs(D,{className:"align-items-center gx-3",children:[a.jsx(g,{md:4,children:a.jsxs("div",{className:"p-2 border border-secondary rounded bg-light",children:[a.jsxs("p",{className:"mb-1",children:[a.jsx("strong",{children:"Operator:"})," ",r]}),a.jsxs("p",{className:"mb-0",children:[a.jsx("strong",{children:"Machine:"})," ",l]}),a.jsxs("p",{className:"mb-0",children:[a.jsx("strong",{children:"Mode:"})," ",d]})]})}),a.jsxs(g,{md:2,className:"text-center",children:[a.jsx(_,{children:"Total Reading"}),a.jsx("p",{className:"fw-bold fs-5 mb-0",children:Math.max(e.machine_end-e.start_reading,0).toFixed(2)})]}),a.jsx(g,{sm:4,children:a.jsxs(D,{className:"gx-2 align-items-end",children:[a.jsxs(g,{xs:6,children:[a.jsx(_,{children:"Start Reading"}),a.jsx(v,{type:"text",value:e.start_reading,readOnly:!0,disabled:!0})]}),a.jsxs(g,{xs:6,children:[a.jsxs(_,{children:["End Reading ",a.jsx("span",{style:{color:"red"},children:"*"})]}),a.jsx(v,{type:"text",inputMode:"numeric",pattern:"[0-9]*\\.?[0-9]*",value:e.machine_end||"",placeholder:"0",invalid:e.machine_end!==void 0&&e.machine_end!==""&&parseFloat(e.machine_end)<=parseFloat(e.start_reading),onChange:p=>{let y=p.target.value.replace(/[^0-9.]/g,"");const S=y.split(".");S.length>2&&(y=S[0]+"."+S.slice(1).join("")),De(s,"machine_end",y)}}),e.machine_end!==void 0&&e.machine_end!==""&&parseFloat(e.machine_end)<=parseFloat(e.start_reading)&&a.jsxs("small",{className:"text-danger d-block",children:["End reading must be greater than ",e.start_reading]})]})]})}),a.jsxs(g,{md:2,children:[a.jsxs(_,{children:["End Photo  ",j===2&&a.jsx("span",{style:{color:"red"},children:"*"})]}),e.machine_end_pic?a.jsxs("div",{className:"d-flex align-items-center gap-2",children:[a.jsx("span",{className:"text-success small",children:"âœ“ Captured"}),a.jsx(m,{color:"danger",variant:"ghost",size:"sm",onClick:()=>De(s,"machine_end_pic",null),children:a.jsx(I,{icon:Xe})})]}):a.jsx(m,{color:"primary",size:"sm",onClick:()=>Ue(s,"end"),disabled:!e.machine_end,className:"w-100",children:"ðŸ“· End Reading Photo"})]})]})})},e.id)})]})}):a.jsx(B,{className:"mb-4 border-0",color:"success",textColor:"dark",children:a.jsxs(q,{className:"bg-success-subtle rounded rounded-lg",children:[a.jsxs("div",{className:"d-flex justify-content-between align-items-center md:mb-3",children:[a.jsx("h5",{className:"text-success mb-3 d-flex align-items-center",children:"Add Machine Start Readings"}),j===1&&a.jsxs("div",{className:"d-flex gap-2",children:[h.machineReading.length>1&&a.jsx(m,{color:"danger",variant:"outline",type:"button",size:"md",className:"d-flex align-items-center",onClick:()=>{if(h.machineReading.length<=1)return;const e=[...h.machineReading];e.pop(),w(s=>({...s,machineReading:e}))},children:"Remove Last"}),a.jsx(m,{color:"success",variant:"outline",type:"button",size:"md",className:"d-flex align-items-center",onClick:()=>w(e=>{var s;return{...e,machineReading:[...e.machineReading,{uid:Date.now().toString()+Math.random().toString(36).slice(2),operator_id:j===2&&((s=i==null?void 0:i.id)==null?void 0:s.toString())||"",machine_id:"",mode_id:"",mode:"",machine_start:"",machine_end:"",actual_machine_hr:0,machine_start_pic:null,machine_end_pic:null}]}}),children:"Add"})]})]}),a.jsx(D,{className:"g-1",children:h.machineReading.map((e,s)=>{var d;const r=W.find(n=>n.id===parseInt(e.machine_id)),t=(d=r==null?void 0:r.mode_id)!=null&&d.length?Pe.filter(n=>r.mode_id.map(String).includes(String(n.id))).map(n=>({price_per_hour:n.price,id:n.id,value:n.id,label:n.mode.charAt(0).toUpperCase()+n.mode.slice(1).replace(/-/g," ")})):[];return a.jsxs(D,{className:"mb-2 gx-1",children:[j===1&&a.jsxs(g,{xs:12,md:3,className:"p-1",children:[a.jsxs(_,{children:["Select Operator ",a.jsx("span",{style:{color:"red"},children:"*"})]}),a.jsx(fe,{options:G,isSearchable:!0,placeholder:"Operators",value:G.find(n=>n.value===e.operator_id)||null,onChange:n=>{x(s,"operator_id",n?n.value:""),x(s,"machine_id",""),x(s,"mode_id",""),x(s,"mode","")}})]}),a.jsxs(g,{xs:12,md:3,className:"p-1",children:[a.jsxs(_,{children:["Select Machine ",a.jsx("span",{style:{color:"red"},children:"*"})]}),a.jsx(fe,{options:Ve(e.operator_id||be),isSearchable:!0,placeholder:"Machinery",value:Ve(e.operator_id||be).find(n=>n.value===e.machine_id)||null,onChange:n=>{x(s,"machine_id",n?n.value:""),x(s,"mode_id",""),x(s,"mode","")}})]}),a.jsxs(g,{xs:12,md:2,className:"p-1",children:[a.jsxs(_,{children:["Select Mode ",a.jsx("span",{style:{color:"red"},children:"*"})]}),a.jsx(fe,{options:t,isSearchable:!1,placeholder:"Select Mode",isDisabled:!e.machine_id||t.length===0,value:t.find(n=>n.value===e.mode_id)||null,onChange:n=>{x(s,"mode_id",n?n.value:""),x(s,"price_per_hour",n?n.price_per_hour:0)}})]}),a.jsxs(g,{xs:12,md:3,className:"p-1",children:[a.jsxs(_,{children:["Work Type ",a.jsx("span",{style:{color:"red"},children:"*"})]}),a.jsxs(Ze,{children:[a.jsx(v,{type:"text",value:O[s]||"",onChange:n=>{P(l=>({...l,[s]:n.target.value})),M(l=>({...l,[s]:!0}))},placeholder:"Search work type..."}),O[s]&&a.jsx(m,{type:"button",color:"danger",variant:"outline",size:"sm",onClick:()=>{x(s,"work_type_id",""),P(n=>({...n,[s]:""})),M(n=>({...n,[s]:!1}))},children:"âœ•"}),!O[s]&&a.jsx(m,{type:"button",color:"primary",variant:"outline",size:"sm",onClick:()=>pa(s),children:"Show All"})]}),ia[s]&&a.jsx("div",{className:"border rounded bg-white position-absolute",style:{maxHeight:"200px",overflowY:"auto",zIndex:1e3,width:"calc(100% - 0.5rem)"},children:Oe(O[s]).length>0?Oe(O[s]).map(n=>a.jsx("div",{className:"p-2 hover-bg-light",style:{cursor:"pointer"},onClick:()=>{x(s,"work_type_id",n.value),P(l=>({...l,[s]:n.label})),M(l=>({...l,[s]:!1}))},children:n.label},n.value)):a.jsxs("div",{className:"p-2",children:[a.jsx("div",{children:"No work type found."}),a.jsx(m,{color:"primary",size:"sm",className:"mt-2",onClick:()=>{ze(s),se(!0),M(n=>({...n,[s]:!1}))},children:"Add New Work Type"})]})})]}),a.jsxs(g,{xs:12,md:1,className:"p-1",children:[a.jsx(_,{children:"Start Reading"}),a.jsx(v,{type:"text",inputMode:"numeric",pattern:"[0-9.:]*",value:e.machine_start===0?"":e.machine_start,placeholder:"0",onChange:n=>{let l=n.target.value.replace(/[^0-9.:]/g,"");x(s,"machine_start",l===""?0:l)}})]}),a.jsxs(g,{xs:12,md:2,className:"p-1",children:[a.jsx(_,{children:"Start Reading Photo "}),e.machine_start_pic?a.jsxs("div",{className:"d-flex align-items-center gap-2 w-100",children:[a.jsx("span",{className:"text-muted small",children:"Photo captured"}),a.jsx(m,{color:"danger",variant:"ghost",size:"sm",onClick:()=>ja(s,"machine_start_pic"),children:a.jsx(I,{icon:Xe})})]}):a.jsx(m,{color:"primary",size:"sm",onClick:()=>Ue(s,"start"),disabled:!e.machine_start,className:"w-100",children:"ðŸ“· Start Reading Photo"})]})]},e.uid||s)})})]})}),a.jsx("div",{className:"d-flex justify-content-center",children:F?a.jsxs(m,{color:"warning",size:"lg",className:"px-5 d-flex align-items-center",onClick:ba,disabled:Me,children:[a.jsx(I,{icon:Je,className:"me-2"})," ",Me?"Saving...":"Save End Readings"]}):a.jsxs(m,{color:"danger",size:"lg",className:"px-5 d-flex align-items-center",onClick:wa,disabled:Ne,children:[a.jsx(I,{icon:Je,className:"me-2"})," ",Ne?"Saving...":"Save Start Readings"]})})]})})]}),a.jsxs(_e,{visible:$,onClose:()=>Q(!1),size:"lg",alignment:"center",children:[a.jsxs(je,{className:"d-flex align-items-center justify-content-between",children:[a.jsx("div",{className:"d-flex align-items-center",children:a.jsx(xe,{className:"me-3",children:z==="start"?"ðŸ“¸ Capture Start Photo":"ðŸ“· Capture End Photo"})}),a.jsxs("div",{className:"d-flex align-items-center gap-3",children:[T.current&&a.jsx("span",{className:"text-muted small",children:((Ge=T.current.getVideoTracks()[0])==null?void 0:Ge.getSettings().facingMode)==="environment"?"Rear Camera Active":"Front Camera Active"}),a.jsx(m,{color:"primary",variant:"outline",size:"sm",className:"rounded-pill px-3 fw-semibold shadow-sm",onClick:()=>{Ie(e=>e==="environment"?"user":"environment")},children:ee==="environment"?"Switch to Front":"Switch to Rear"})]})]}),a.jsx(ye,{children:a.jsx("div",{className:"text-center",children:Se?a.jsxs("div",{children:[a.jsx("div",{className:"mb-3",children:a.jsx("img",{src:Se,alt:"Captured",className:"img-fluid rounded",style:{maxHeight:"400px",objectFit:"cover"}})}),a.jsxs("div",{className:"d-flex gap-2 justify-content-center",children:[a.jsx(m,{color:"secondary",onClick:()=>{Y(null),Z(null),Le()},children:"Retake"}),a.jsx(m,{color:"success",onClick:_a,children:"Submit Photo"})]})]}):a.jsxs("div",{children:[a.jsxs("div",{className:"position-relative mb-3",children:[a.jsx("video",{ref:H,autoPlay:!0,playsInline:!0,muted:!0,className:"w-100 rounded",style:{maxHeight:"400px",objectFit:"cover"}}),a.jsx("canvas",{ref:pe,style:{display:"none"}})]}),a.jsxs(m,{color:"primary",size:"lg",onClick:fa,className:"mb-3",children:[a.jsx(I,{icon:Fa,className:"me-2"})," Capture Photo"]})]})})}),a.jsx(ve,{children:a.jsx(m,{color:"secondary",onClick:()=>Q(!1),children:"Cancel"})})]}),a.jsxs(_e,{visible:ue,onClose:()=>X(!1),size:"xl",alignment:"center",children:[a.jsx(je,{children:a.jsx(xe,{children:"Add New Customer"})}),a.jsx(ye,{children:a.jsx(Ye,{id:"new-project-form",onSubmit:async e=>{var r,t,d;if(e.preventDefault(),L({}),K(!0),f.end_date&&f.start_date&&new Date(f.end_date)<new Date(f.start_date)){L({end_date:"End date must be after or equal to start date."}),K(!1);return}if(f.operator_id.some((n,l)=>{if(!n||n==="")return!1;const u=f[`machine_${l}`];return!u||u===""})){L({general:"Please assign a machine to all selected operators."}),K(!1);return}try{const n=f.operator_id.map((p,y)=>p&&p!==""?f[`machine_${y}`]:null).filter(p=>p!==null),l={...f,machine_id:n},u=await ne("/api/projects",l);c("success","Customer added successfully!"),X(!1),re(V),qe(u),C(u.customer_name),b(!1)}catch(n){console.error("Error creating project:",n),(r=n.response)!=null&&r.data.errors?L(n.response.data.errors):L({general:((d=(t=n.response)==null?void 0:t.data)==null?void 0:d.message)||"Failed to create project."})}finally{K(!1)}},children:a.jsxs("div",{className:"row g-3",children:[Ee.general&&a.jsx(Qe,{color:"danger",children:Ee.general}),a.jsxs(g,{md:4,children:[a.jsx(_,{children:"Customer Name"}),a.jsx(v,{type:"text",name:"customer_name",value:f.customer_name,onChange:e=>J({...f,[e.target.name]:e.target.value}),required:!0,placeholder:"Enter Customer Name..."})]}),a.jsxs(g,{md:4,children:[a.jsx(_,{children:"Customer Mobile Number"}),a.jsx(v,{type:"text",name:"mobile_number",value:f.mobile_number,onChange:e=>{const s=e.target.value.replace(/\D/g,"");s.length<=10&&J({...f,mobile_number:s})},required:!0,placeholder:"Enter Customer Mobile..."})]}),a.jsxs(g,{md:4,children:[a.jsx(_,{children:"GST number"}),a.jsx(v,{type:"text",name:"gst_number",value:f.gst_number,onChange:e=>J({...f,[e.target.name]:e.target.value}),placeholder:"Enter GST number...",maxLength:15})]}),a.jsxs(g,{md:4,children:[a.jsx(_,{children:"Location"}),a.jsx(v,{type:"text",name:"work_place",value:f.work_place,onChange:e=>J({...f,[e.target.name]:e.target.value}),placeholder:"Enter Your Location..."})]})]})})}),a.jsxs(ve,{children:[a.jsx(m,{color:"secondary",onClick:()=>X(!1),children:"Cancel"}),a.jsx(m,{type:"submit",form:"new-project-form",color:"primary",disabled:Fe,children:Fe?"Submitting...":"Add Customer"})]})]})]})]})};export{rs as default};

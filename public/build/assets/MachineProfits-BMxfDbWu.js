import{u as te,b as se,c as re,r as o,j as t,C as ne}from"./index-Cn-27-TL.js";import{g as ae,a as k}from"./api-BUyL__Lx.js";import{u as v,w as oe}from"./xlsx-DjuO7_Ju.js";import{E as ie}from"./jspdf.es.min-C59mXbfK.js";import"./jspdf.plugin.autotable-DlXpEGqW.js";import{u as ce,C as le}from"./DefaultLayout-Vrb03iJh.js";import{a as M,b as E,d as P}from"./index.esm-2RRpQEeO.js";import{C as de,a as me}from"./CCardBody-Bfh-O-BQ.js";import{C as he}from"./CCardHeader-DyQDv_BY.js";import{C as W}from"./CFormLabel-CFBomnnz.js";import{C as $}from"./CFormInput-CL8d5WGe.js";import{C as pe,a as xe,b as T,c as m,d as ue,e as f}from"./CTable-CtRsnfwM.js";import"./typeof-QjJsDpFa.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-O4w4bCVl.js";import"./CNavItem-EvCITOBp.js";import"./CFormControlWrapper-CPiMjLs0.js";import"./CFormControlValidation-BvfkKe2L.js";const We=()=>{const H=te(),{showToast:b}=se();ce("global");const{machineid:p}=re(),h=ae(),[F,I]=o.useState([]),[w,R]=o.useState([]),[x,B]=o.useState(null),[c,fe]=o.useState({key:null,direction:"asc"}),[A,D]=o.useState(!0),[ge,Y]=o.useState(window.innerWidth<=768),[C,O]=o.useState(""),[_,G]=o.useState(""),U=async()=>{try{D(!0);const s=(await k(`/api/machineLog?company_id=${h.company_id}`)).filter(a=>Number(a.machine_id)===Number(p));I(s)}catch(e){b("danger","Error fetching machine logs: "+e)}finally{D(!1)}},V=async()=>{try{const s=(await k("/api/machineries1")).find(a=>Number(a.id)===Number(p));B(s)}catch(e){b("danger","Error fetching machine details: "+e)}},X=async()=>{try{const e=await k("/api/myProjects");R(Array.isArray(e)?e:[]),console.log("response"),console.log(e)}catch(e){console.error("Error fetching projects:",e)}};o.useEffect(()=>{X()},[]),o.useEffect(()=>{h!=null&&h.company_id&&p&&(U(),V())},[p]),o.useEffect(()=>{const e=()=>{Y(window.innerWidth<=768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const u=e=>({marginLeft:"8px",fontSize:"14px",opacity:c.key===e?1:.5,color:c.key===e?"#0d6efd":"#6c757d",transition:"all 0.2s ease"}),i=e=>{const s=parseFloat(e)||0,[a,r="00"]=s.toFixed(2).split("."),n=a.slice(-3),l=a.slice(0,-3);return`INR ${l.length>0?l.replace(/\B(?=(\d{2})+(?!\d))/g,",")+","+n:n}.${r}`},N=e=>{const s={day:"numeric",month:"short",year:"numeric"},r=new Date(e).toLocaleDateString("en-US",s).replace(",",""),[n,l]=r.split(" ");return`${l} ${n}`},g=o.useMemo(()=>{let e=F.map((s,a)=>({...s,sr_no:a+1,hours:(parseFloat(s.end_reading)||0)-(parseFloat(s.start_reading)||0),earnings:((parseFloat(s.end_reading)||0)-(parseFloat(s.start_reading)||0))*(parseFloat(s.price_per_hour)||0)}));return C&&(e=e.filter(s=>s.work_date>=C)),_&&(e=e.filter(s=>s.work_date<=_)),c.key?[...e].sort((s,a)=>{let r=s[c.key],n=a[c.key];return typeof r=="string"&&(r=r.toLowerCase()),typeof n=="string"&&(n=n.toLowerCase()),r<n?c.direction==="asc"?-1:1:r>n?c.direction==="asc"?1:-1:0}):e},[F,C,_,c]),S=o.useMemo(()=>g.reduce((e,s)=>e+s.earnings,0),[g]),q=()=>{const e=g.map(r=>{var n;return{"Sr No":r.sr_no,"Work Date":N(r.work_date),"Customer Name":((n=w.find(l=>l.id===Number(r.project_id)))==null?void 0:n.customer_name)||"-",Hours:r.hours||0,"Price per Hour":i(r.price_per_hour),Earnings:i(r.earnings)}}),s=v.json_to_sheet(e),a=v.book_new();v.book_append_sheet(a,s,"Machine Profits"),oe(a,`Machine_Profits_${p}_${new Date().toISOString().split("T")[0]}.xlsx`),b("success","Excel file downloaded successfully!")},J=()=>{const e=new ie({orientation:"landscape",unit:"pt",format:"a4"}),s=e.internal.pageSize.getWidth(),a=e.internal.pageSize.getHeight(),r=40,n=s-2*r;e.setFont("helvetica","bold"),e.setFontSize(18),e.setTextColor(22,160,133),e.text(`Machine Profits Report - ${(x==null?void 0:x.machine_name)||"Machine"}`,r,50),e.setFontSize(11),e.setTextColor(100),e.setFont("helvetica","normal");const l=(h==null?void 0:h.company_name)||"Your Company",L=new Date().toLocaleDateString("en-GB");e.text(`${l} â€¢ Generated on ${L}`,r,70);const Q=[["Sr No","Work Date","Customer Name","Hours","Price / Hour (Rs.)","Earnings (Rs.)"]],Z=g.map(d=>{var j,y,z;return[((j=d.sr_no)==null?void 0:j.toString())||"",N(d.work_date),((y=w.find(ee=>ee.id===Number(d.project_id)))==null?void 0:y.customer_name)||"-",((z=d.hours)==null?void 0:z.toString())||"0",i(d.price_per_hour),i(d.earnings)]});e.autoTable({head:Q,body:Z,startY:100,theme:"striped",styles:{fontSize:9,cellPadding:6,overflow:"linebreak",halign:"center",valign:"middle"},headStyles:{fillColor:[22,160,133],textColor:255,fontStyle:"bold",fontSize:10},columnStyles:{0:{cellWidth:n*.08},1:{cellWidth:n*.2},2:{cellWidth:n*.2},3:{cellWidth:n*.12},4:{cellWidth:n*.2},5:{cellWidth:n*.2}},didDrawPage:d=>{const j=d.cursor.y+25;e.setFontSize(11),e.setFont("helvetica","bold"),e.setTextColor(34,34,34);const y=n/6;e.text("TOTAL",r+y*4,j),e.text(i(S),r+y*5,j,{align:"center"}),e.setFontSize(9),e.setTextColor(150),e.text(`Page ${e.internal.getCurrentPageInfo().pageNumber}`,s-r-50,a-20)}});const K=`Machine_Profits_${p}_${new Date().toISOString().split("T")[0]}.pdf`;e.save(K),b("success","PDF downloaded successfully!")};return A?t.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:t.jsxs("div",{className:"text-center",children:[t.jsx(ne,{color:"primary",size:"lg"}),t.jsx("p",{className:"mt-3 text-muted",children:"Loading machine profits..."})]})}):t.jsxs(t.Fragment,{children:[t.jsx("style",{jsx:!0,global:!0,children:`
        // Similar styles as in MachineExpenses.jsx, adapted for this component
        .table-container { height: 350px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; }
        // ... (copy relevant styles)
      `}),t.jsx(M,{children:t.jsx(E,{xs:12,children:t.jsxs(de,{className:"mb-4",children:[t.jsxs(he,{className:"d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 gap-md-3 pb-3 border-bottom border-md-0",children:[t.jsx(P,{color:"secondary",size:"sm",onClick:()=>H(-1),className:"align-self-start align-self-md-center",children:"Back"}),t.jsx("div",{className:"flex-grow-1 text-center text-md-start",children:t.jsx("strong",{className:"fs-5",children:`Machine : ${(x==null?void 0:x.machine_name)||"Machine"}`})}),t.jsxs("div",{className:"d-flex flex-column flex-md-row align-items-center gap-2 text-center text-md-end",children:[t.jsxs("div",{className:"d-flex gap-2 order-2 order-md-1",children:[t.jsx(P,{color:"success",size:"sm",onClick:q,children:"Export Excel"}),t.jsx(P,{color:"danger",size:"sm",onClick:J,children:"Export PDF"})]}),t.jsxs("div",{className:"order-1 order-md-2 mt-1 mt-md-0",children:[t.jsx("strong",{children:"Total Earnings: "}),t.jsx(le,{color:"success",className:"ms-1",children:i(S)})]})]})]}),t.jsxs(me,{children:[t.jsxs(M,{className:"mb-2 align-items-center gap-5",children:[t.jsx(E,{xs:12,md:3,children:t.jsxs("div",{className:"d-flex align-items-center",children:[t.jsx(W,{className:"mb-0 flex-shrink-0",style:{width:"90px"},children:"Start Date :"}),t.jsx($,{type:"date",value:C,onChange:e=>O(e.target.value),style:{flex:1}})]})}),t.jsx(E,{xs:12,md:3,children:t.jsxs("div",{className:"d-flex align-items-center",children:[t.jsx(W,{className:" mb-0 flex-shrink-0",style:{width:"90px"},children:"End Date :"}),t.jsx($,{type:"date",value:_,onChange:e=>G(e.target.value),style:{flex:1}})]})})]}),t.jsx("div",{className:"table-container",style:{width:"100%",overflowX:"auto",overflowY:"auto",border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff"},children:t.jsxs(pe,{hover:!0,striped:!0,bordered:!0,color:"light",className:"mb-0",children:[t.jsx(xe,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:t.jsxs(T,{children:[t.jsxs(m,{className:"text-center align-middle",children:["Sr No ",t.jsx("span",{style:u("sr_no")})]}),t.jsxs(m,{className:"text-center align-middle",children:["Work Date ",t.jsx("span",{style:u("work_date")})]}),t.jsxs(m,{className:"text-center align-middle",children:["Customer Name",t.jsx("span",{style:u("project_id")})]}),t.jsxs(m,{className:"text-center align-middle",children:["Hours ",t.jsx("span",{style:u("hours")})]}),t.jsxs(m,{className:"text-center align-middle",children:["Price/Hour ",t.jsx("span",{style:u("price_per_hour")})]}),t.jsxs(m,{className:"text-center align-middle",children:["Earnings ",t.jsx("span",{style:u("earnings")})]})]})}),t.jsxs(ue,{children:[g.map(e=>{var s;return t.jsxs(T,{children:[t.jsx(f,{children:e.sr_no}),t.jsx(f,{children:N(e.work_date)}),t.jsx(f,{children:((s=w.find(a=>a.id===Number(e.project_id)))==null?void 0:s.customer_name)||"-"}),t.jsx(f,{children:e.hours||0}),t.jsx(f,{children:i(e.price_per_hour)}),t.jsx(f,{children:i(e.earnings)})]},e.id)}),t.jsxs(T,{children:[t.jsx(m,{colSpan:5,className:"text-end",children:"Total"}),t.jsx(m,{children:i(S)})]})]})]})})]})]})})})]})};export{We as default};

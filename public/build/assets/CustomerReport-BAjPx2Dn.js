import{b as we,r as a,j as t,C as _e}from"./index-DytM8ejS.js";import{a as C}from"./api-BUyL__Lx.js";import{E as Se}from"./jspdf.es.min-DcYEdrxZ.js";import"./jspdf.plugin.autotable-D45ZwAEA.js";import{a as M,d as p,b as h}from"./index.esm-CwEsjKuX.js";import{a as be,b as ye,c as ve,d as Me,e as Pe,C as P}from"./DefaultLayout-C8flodPp.js";import{C as ke,a as Te}from"./CCardBody-8PK9ymk0.js";import{C as ze}from"./CCardHeader-CHPNZi9P.js";import{C as Le}from"./CInputGroup-DW9YzzN9.js";import{C as We}from"./CInputGroupText-iq7Xygpz.js";import{C as Ee}from"./CFormInput-BiKhmGTd.js";import{C as B}from"./CFormSelect-QrrXqPUP.js";import{C as Fe,a as De,b as G,c as m,d as He,e as d}from"./CTable-C3gvlNt3.js";import"./typeof-QjJsDpFa.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-BbmPFW3_.js";import"./CNavItem-lUoRkAFO.js";import"./CFormControlWrapper-BcaF3RGm.js";import"./CFormControlValidation-C-j7lld-.js";import"./CFormLabel-CqwMi-ru.js";const at=()=>{const{showToast:w}=we(),[V,ne]=a.useState([]),[_,k]=a.useState([]),[T,ce]=a.useState([]),[z,oe]=a.useState([]),[L,le]=a.useState([]),[S,Y]=a.useState(""),[ie,Q]=a.useState(""),[g,X]=a.useState(""),[f,q]=a.useState(""),[N,J]=a.useState("");a.useState(null),a.useState(!1);const[de,K]=a.useState(!1),[me,b]=a.useState(!1),[U,Z]=a.useState(""),[y,W]=a.useState(1),he=async()=>{K(!0);try{const e=await C("/api/machineLog");ne(e||[])}catch(e){w("danger","Error fetching machine logs: "+e)}finally{K(!1)}},ee=a.useCallback(async(e="")=>{try{const s=await C(`/api/projects?searchQuery=${e}`);if(Array.isArray(s)){const r=s.map(c=>({id:c.id,name:c.customer_name}));k(r)}else k([])}catch(s){console.error("Error fetching projects:",s),k([])}},[]);a.useEffect(()=>{C("/api/operatorsByType").then(e=>{const s=e.map(r=>({value:r.id.toString(),label:r.name}));ce(s)}).catch(e=>{console.error("Error fetching operators:",e)})},[]),a.useEffect(()=>{(async()=>{try{const s=await C("/api/machine-operators");if(Array.isArray(s)){const r=s.map(c=>({id:c.id,name:c.machine_name}));oe(r)}}catch(s){console.error("Error fetching machineries:",s)}})()},[]);const xe=async()=>{try{const e=await C("/api/machine-price");console.log("prices"),console.log(e),le(e)}catch(e){console.error("Error fetching machine prices:",e),w("danger","Error fetching machine prices")}};a.useEffect(()=>{he(),ee(),xe()},[ee]);const E=e=>{console.log(_);const s=_.find(r=>r.id==e);return console.log("projets"),console.log(s),s?s.name:e},F=e=>{const s=T.find(r=>r.value===(e==null?void 0:e.toString()));return s?s.label:e},D=e=>{const s=z.find(r=>r.id==e);return s?s.name:e},i=a.useMemo(()=>{let e=V.map((s,r)=>({...s,sr_no:r+1}));if(g&&(e=e.filter(s=>{var r;return((r=s.project_id)==null?void 0:r.toString())===g})),f&&(e=e.filter(s=>{var r;return((r=s.operator_id)==null?void 0:r.toString())===f})),N&&(e=e.filter(s=>{var r;return((r=s.machine_id)==null?void 0:r.toString())===N})),S.trim()){const s=S.toLowerCase();e=e.filter(r=>{var c,o,x;return E(r.project_id).toLowerCase().includes(s)||D(r.machine_id).toLowerCase().includes(s)||F(r.operator_id).toLowerCase().includes(s)||((c=r.work_date)==null?void 0:c.toLowerCase().includes(s))||((o=r.start_reading)==null?void 0:o.toString().includes(s))||((x=r.end_reading)==null?void 0:x.toString().includes(s))})}return e},[V,S,g,f,N,_,T,z]),H=a.useMemo(()=>[...i].sort((e,s)=>new Date(s.work_date)-new Date(e.work_date)),[i]),I=10,A=Math.max(1,Math.ceil(H.length/I)),u=(y-1)*I,te=a.useMemo(()=>H.slice(u,u+I),[H,u]),pe=()=>{Q(""),Y(""),X(""),q(""),J(""),W(1)},se=e=>{if(!e)return"";const[s,r,c]=e.split("-");return`${c}-${r}-${s}`},ue=()=>{const e=new Se({orientation:"landscape",unit:"pt",format:"a4"}),s=e.internal.pageSize.getWidth(),r=e.internal.pageSize.getHeight(),c=40,o=s-2*c;e.setFont("helvetica","bold"),e.setFontSize(18),e.setTextColor(22,160,133),e.text("Work Logs Report",c,50),e.setFontSize(11),e.setTextColor(100),e.setFont("helvetica","normal");const x=new Date().toLocaleDateString("en-GB");e.text(`Your Company • Generated on ${x}`,c,70);const $=[["Sr","Date","Customer","Machine","Operator","Start","End","Net Hrs","Mode","Rate/Hr","Total"]],O=i.sort((n,l)=>new Date(l.work_date)-new Date(n.work_date)).map((n,l)=>{const j=L.find(Ce=>Ce.id===Number(n.mode_id)),R=j?j.mode:"N/A",v=Number(n.price_per_hour)||0,ae=n.end_reading&&n.start_reading?Number(n.end_reading)-Number(n.start_reading):0,Ne=ae*v;return[(l+1).toString(),se(n.work_date),E(n.project_id),D(n.machine_id),F(n.operator_id),n.start_reading||"-",n.end_reading||"-",ae.toFixed(2),R,`Rs.${v.toFixed(2)}`,`Rs.${Ne.toFixed(2)}`]}),je=i.reduce((n,l)=>{const j=l.end_reading&&l.start_reading?Number(l.end_reading)-Number(l.start_reading):0;return n+j},0),ge=i.reduce((n,l)=>{L.find(v=>v.id===Number(l.mode_id));const j=Number(l.price_per_hour)||0,R=l.end_reading&&l.start_reading?Number(l.end_reading)-Number(l.start_reading):0;return n+R*j},0);e.autoTable({head:$,body:O,startY:100,theme:"striped",styles:{fontSize:8,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:[22,160,133],textColor:255,fontStyle:"bold",fontSize:9},columnStyles:{0:{cellWidth:o*.05},1:{cellWidth:o*.08},2:{cellWidth:o*.14},3:{cellWidth:o*.12},4:{cellWidth:o*.12},5:{cellWidth:o*.07},6:{cellWidth:o*.07},7:{cellWidth:o*.07},8:{cellWidth:o*.08},9:{cellWidth:o*.08},10:{cellWidth:o*.1}},foot:[[{content:"TOTAL",colSpan:7,styles:{halign:"right",fontStyle:"bold"}},je.toFixed(2),"","",`Rs.${ge.toFixed(2)}`]],footStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:"bold",fontSize:9},didDrawPage:n=>{const l=e.internal.getNumberOfPages();e.setFontSize(9),e.setTextColor(150),e.text(`Page ${n.pageNumber} of ${l}`,s-c-80,r-20)}});const fe=`Work_Logs_Report_${new Date().toISOString().split("T")[0]}.pdf`;e.save(fe),w("success","PDF downloaded successfully!")};return de?t.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[t.jsx(_e,{color:"primary",size:"lg"}),t.jsx("p",{className:"mt-3 text-muted",children:"Loading machine logs..."})]}):t.jsxs(M,{children:[t.jsxs(be,{visible:me,onClose:()=>b(!1),size:"lg",children:[t.jsx(ye,{closeButton:!0,children:t.jsx(ve,{children:"View Image"})}),t.jsx(Me,{className:"text-center p-4",children:U?t.jsx("img",{src:U,alt:"Machine Log",className:"img-fluid rounded",style:{maxHeight:"70vh",width:"auto"},onError:e=>{e.target.onerror=null,w("danger","Image could not be loaded.")}}):t.jsx("p",{className:"text-muted",children:"No image selected."})}),t.jsx(Pe,{children:t.jsx(p,{color:"secondary",onClick:()=>b(!1),children:"Close"})})]}),t.jsx(h,{xs:12,children:t.jsxs(ke,{className:"shadow-sm",children:[t.jsxs(ze,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap gap-2",children:[t.jsxs("div",{className:"d-flex align-items-center flex-wrap gap-2",children:[t.jsx("strong",{className:"fs-5",children:"Work Logs Report"}),t.jsxs(P,{color:"info",children:[i.length," records"]})]}),t.jsx(p,{color:"warning",size:"sm",onClick:ue,disabled:i.length===0,className:"w-auto",children:"Download PDF"})]}),t.jsxs(Te,{children:[t.jsxs(M,{className:"g-2 mb-3",children:[t.jsx(h,{xs:12,md:6,lg:3,children:t.jsxs(Le,{size:"sm",children:[t.jsx(We,{children:"Search"}),t.jsx(Ee,{type:"text",placeholder:"Search all fields...",value:ie,onChange:e=>{Q(e.target.value),Y(e.target.value)}})]})}),t.jsx(h,{xs:12,md:6,lg:3,children:t.jsxs(B,{size:"sm",value:g,onChange:e=>X(e.target.value),children:[t.jsx("option",{value:"",children:"All Customers"}),_.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})}),t.jsx(h,{xs:12,md:6,lg:3,children:t.jsxs(B,{size:"sm",value:f,onChange:e=>q(e.target.value),children:[t.jsx("option",{value:"",children:"All Operators"}),T.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))]})}),t.jsx(h,{xs:12,md:6,lg:3,children:t.jsxs(B,{size:"sm",value:N,onChange:e=>J(e.target.value),children:[t.jsx("option",{value:"",children:"All Machines"}),z.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})})]}),i.length>0&&t.jsxs(M,{className:"g-2 mb-2",children:[t.jsx(h,{xs:6,md:3,children:t.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[t.jsx("small",{className:"d-block",children:"Total Logs"}),t.jsx("strong",{className:"fs-6",children:i.length})]})}),t.jsx(h,{xs:6,md:3,children:t.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[t.jsx("small",{className:"d-block",children:"Customers"}),t.jsx("strong",{className:"fs-6",children:new Set(i.map(e=>e.project_id)).size})]})}),t.jsx(h,{xs:6,md:3,children:t.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[t.jsx("small",{className:"d-block",children:"Operators"}),t.jsx("strong",{className:"fs-6",children:new Set(i.map(e=>e.operator_id)).size})]})}),t.jsx(h,{xs:6,md:3,children:t.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[t.jsx("small",{className:"d-block",children:"Machines"}),t.jsx("strong",{className:"fs-6",children:new Set(i.map(e=>e.machine_id)).size})]})})]}),(S||g||f||N)&&t.jsx(M,{className:"mb-3",children:t.jsx(h,{children:t.jsx(p,{color:"light",size:"sm",onClick:pe,children:"Clear Filters"})})}),t.jsx("div",{style:{overflowX:"auto",WebkitOverflowScrolling:"touch",maxWidth:"100%"},children:t.jsxs(Fe,{hover:!0,striped:!0,bordered:!0,className:"table-sm mb-0",style:{minWidth:"1000px",whiteSpace:"nowrap"},children:[t.jsx(De,{className:"sticky-top bg-light",children:t.jsxs(G,{children:[t.jsx(m,{className:"text-center",children:"Sr. No."}),t.jsx(m,{className:"text-center",children:"Date"}),t.jsx(m,{className:"text-center",children:"Customer"}),t.jsx(m,{className:"text-center",children:"Machine"}),t.jsx(m,{className:"text-center",children:"Operator"}),t.jsx(m,{className:"text-center",children:"Start"}),t.jsx(m,{className:"text-center",children:"Start Photo"}),t.jsx(m,{className:"text-center",children:"End"}),t.jsx(m,{className:"text-center",children:"End Photo"}),t.jsx(m,{className:"text-center",children:"Net"}),t.jsx(m,{className:"text-center",children:"Mode"}),t.jsx(m,{className:"text-center",children:"₹/Hr"}),t.jsx(m,{className:"text-center",children:"Total"})]})}),t.jsx(He,{children:i.length===0?t.jsx(G,{children:t.jsx(d,{colSpan:12,className:"text-center py-5",children:t.jsxs("div",{className:"text-muted",children:[t.jsx("span",{style:{fontSize:"3rem"},children:"Empty"}),t.jsx("p",{className:"mt-2 mb-0",children:"No machine logs found"}),t.jsx("small",{children:"Try adjusting your filters"})]})})}):[...te].sort((e,s)=>new Date(s.work_date)-new Date(e.work_date)).map((e,s)=>{const r=L.find(O=>O.id===Number(e.mode_id)),c=r?r.mode:"N/A",o=e.price_per_hour,x=e.end_reading&&e.start_reading?Number(e.end_reading)-Number(e.start_reading):0,re=x*o,$=u+s+1;return t.jsxs(G,{children:[t.jsx(d,{className:"text-start fw-bold small",children:$}),t.jsx(d,{className:"small",children:t.jsx(P,{color:"secondary",className:"p-1 small",children:se(e.work_date)})}),t.jsx(d,{className:"text-start small text-truncate",style:{maxWidth:"120px"},children:E(e.project_id)}),t.jsx(d,{className:"small text-truncate",style:{maxWidth:"100px"},children:D(e.machine_id)}),t.jsx(d,{className:"small text-truncate",style:{maxWidth:"100px"},children:F(e.operator_id)}),t.jsx(d,{className:"text-start small",children:e.start_reading||"-"}),t.jsx(d,{className:"text-center",children:e.start_photo?t.jsx(p,{size:"sm",color:"info",variant:"outline",onClick:()=>{Z(`/img/${e.start_photo}`),b(!0)},children:"View"}):t.jsx("span",{className:"text-muted small",children:"-"})}),t.jsx(d,{className:"text-start small",children:e.end_reading||"-"}),t.jsx(d,{className:"text-center",children:e.end_photo?t.jsx(p,{size:"sm",color:"info",variant:"outline",onClick:()=>{Z(`/img/${e.end_photo}`),b(!0)},children:"View"}):t.jsx("span",{className:"text-muted small",children:"-"})}),t.jsx(d,{className:"text-end small",children:x.toFixed(2)}),t.jsx(d,{className:"text-center",children:t.jsx(P,{color:"info",className:"small",children:c})}),t.jsxs(d,{className:"text-end small fw-bold",children:["₹",o]}),t.jsx(d,{className:"text-center",children:t.jsxs(P,{color:"success",className:"p-2 small",children:["₹",re.toFixed(2)]})})]},e.id)})})]})}),i.length>0&&t.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2",children:[t.jsxs("small",{className:"text-muted",children:["Showing ",u+1,"–",Math.min(u+te.length,i.length)," of ",i.length]}),t.jsxs("div",{className:"d-flex align-items-center gap-2",children:[t.jsx(p,{color:"light",size:"sm",disabled:y===1,onClick:()=>W(e=>Math.max(1,e-1)),children:"Previous"}),t.jsxs("span",{className:"small text-muted",children:["Page ",y," of ",A]}),t.jsx(p,{color:"light",size:"sm",disabled:y===A,onClick:()=>W(e=>Math.min(A,e+1)),children:"Next"})]})]})]})]})})]})};export{at as default};

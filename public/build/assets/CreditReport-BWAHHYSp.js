import{b as U,j as e,r,C as z}from"./index-WEbTLRLZ.js";import{a as v,b as o,d as D,c as F}from"./index.esm-CZeMoYDH.js";import{g as O,a as G}from"./api-Ba1wfMeh.js";import{C as q,a as J}from"./CCardBody-CtNgr8m7.js";import{C as K}from"./CCardHeader-LFhc_ZAM.js";import{C as Q}from"./DefaultLayout-CnBEfSKd.js";import{C as V}from"./CInputGroup-Ds1aMRVv.js";import{C as W}from"./CInputGroupText-Bqk6jF70.js";import{C as X}from"./CFormInput-D3dwui72.js";import{C as Y,a as Z,b as k,c as m,d as ee,e as x}from"./CTable-DcVbcKI_.js";import{c as se,a as te}from"./cil-phone-DD-NWLBR.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-Cd7YjP3x.js";import"./CNavItem-u5MAKPdZ.js";import"./CFormControlWrapper-DljGJ9Vz.js";import"./CFormLabel-D964ZFYD.js";const be=()=>{var T,_,$;const{showToast:E}=U(),h=(T=O())==null?void 0:T.company_id,R=(($=(_=O())==null?void 0:_.company_info)==null?void 0:$.company_name)||"Our Company";if(!h)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[b,A]=r.useState([]),[f,w]=r.useState(""),[H,S]=r.useState(""),[L,I]=r.useState(!1),M=async()=>{I(!0);try{const s=await G(`/api/project-payments?company_id=${h}`);A(Array.isArray(s)?s:[])}catch(s){E("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{I(!1)}};r.useEffect(()=>{M()},[h]);const C=s=>`₹${Number(s||0).toFixed(2)}`,P=r.useMemo(()=>b.filter(s=>s.company_id===h),[b,h]),N=r.useMemo(()=>{const s={};if(P.forEach(t=>{var c;const a=((c=t.project)==null?void 0:c.customer_name)||"Unknown";s[a]||(s[a]=[]),s[a].push(t)}),f){const t=f.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([a])=>a.toLowerCase().includes(t)))}return s},[P,f]),u=r.useMemo(()=>{const s=Object.values(N),t=s.flat(),a=t.filter(l=>!l.is_advance),c=s.length,j=t.length,i=a.reduce((l,d)=>l+Number(d.total||0),0),p=a.reduce((l,d)=>l+Number(d.paid_amount||0),0),n=i-p;return{customerCount:c,totalInvoices:j,totalBilled:i,totalPaid:p,totalOutstanding:n}},[N]);return L&&!b.length?e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(z,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading credit report..."})]}):e.jsx(v,{children:e.jsx(o,{xs:12,children:e.jsxs(q,{className:"shadow-sm",children:[e.jsx(K,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Credit Report"}),e.jsxs(Q,{color:"info",className:"ms-2",children:[u.customerCount," customers"]})]})}),e.jsxs(J,{children:[e.jsxs(v,{className:"mb-2",children:[e.jsx(o,{xs:12,md:6,children:e.jsxs(V,{children:[e.jsx(W,{children:"Search"}),e.jsx(X,{placeholder:"Search by customer name...",value:H,onChange:s=>{S(s.target.value),w(s.target.value)}})]})}),f&&e.jsx(o,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(D,{color:"light",size:"sm",onClick:()=>{S(""),w("")},children:"Clear"})})]}),e.jsxs(v,{className:"g-2 mb-3",children:[e.jsx(o,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:u.totalInvoices})]})}),e.jsx(o,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Total Billed"}),e.jsx("strong",{className:"fs-6",children:C(u.totalBilled)})]})}),e.jsx(o,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:C(u.totalPaid)})]})}),e.jsx(o,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:C(u.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(Y,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(m,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(m,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(m,{className:"text-center align-middle",children:"Total"}),e.jsx(m,{className:"text-center align-middle",children:"Paid"}),e.jsx(m,{className:"text-center align-middle",children:"Remaining"}),e.jsx(m,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ee,{children:Object.entries(N).map(([s,t],a)=>{var d,B;const c=t.filter(g=>!g.is_advance),j=c.reduce((g,y)=>g+Number(y.total||0),0),i=c.reduce((g,y)=>g+Number(y.paid_amount||0),0),p=j-i,n=((B=(d=t[0])==null?void 0:d.project)==null?void 0:B.mobile_number)||"",l=`Hello ${s}, your total bill is ${j.toFixed(2)}, paid amount is ${i.toFixed(2)}, and remaining amount is ${p.toFixed(2)}. Please pay the remaining amount. - ${R}`;return e.jsxs(k,{children:[e.jsx(x,{children:a+1}),e.jsxs(x,{children:[s,n&&e.jsx("div",{className:"small text-muted",children:n})]}),e.jsxs(x,{className:"text-end",children:["₹",j.toFixed(2)]}),e.jsxs(x,{className:"text-success fw-bold text-end",children:["₹",i.toFixed(2)]}),e.jsxs(x,{className:"text-danger fw-bold text-end",children:["₹",p.toFixed(2)]}),e.jsx(x,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[n&&e.jsxs(e.Fragment,{children:[e.jsx("a",{href:`tel:${n}`,className:"btn btn-sm btn-info text-white",title:"Call Customer",children:e.jsx(F,{icon:se})}),e.jsx("a",{href:`sms:${n}?body=${encodeURIComponent(l)}`,className:"btn btn-sm btn-success text-white",title:"Send SMS",children:e.jsx(F,{icon:te})})]}),!n&&e.jsx("span",{className:"text-muted small",children:"No Mobile"})]})})]},s)})})]})})]})]})})})};export{be as default};

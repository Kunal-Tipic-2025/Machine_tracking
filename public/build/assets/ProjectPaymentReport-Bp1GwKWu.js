import{r as n,R as Ns,j as e,C as le,b as ys}from"./index-Bp6YZ4a_.js";import{d as y,c as de,a as K,b as N}from"./index.esm-CYpkJS97.js";import{a as $,g as Ee,h as Xe}from"./api-BUyL__Lx.js";import{g as cs,h as vs}from"./InvoiceMulPdf-B8f_frM4.js";import{C as Re,a as He}from"./CCardBody-CqLGfd9F.js";import{C as Oe}from"./CCardHeader-JJf0C1sG.js";import{C as fe,j as _s,a as ae,b as re,c as ie,d as ce,e as Ze}from"./DefaultLayout-Cl1ShzgU.js";import{C as ws}from"./RawMaterial-DQRsRjmM.js";import{C as je,a as pe,b as g,c as o,d as ge,e as r}from"./CTable-Cf6JrZ8e.js";import{C as Cs}from"./CInputGroup-2rurnWgW.js";import{C as Ps}from"./CInputGroupText-BN-mRoLl.js";import{C as Fe}from"./CFormInput-Bho2i8i0.js";import{C as Je}from"./CTooltip-CPOo11LX.js";import{c as Fs}from"./cil-money-Dk3vHnQB.js";import{c as ks}from"./cil-history-D-FQjjfl.js";import"./jspdf.es.min-Bw6WAas3.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-DIKN9LSg.js";import"./CFormControlWrapper-CHuDwT-y.js";import"./CFormControlValidation-6izUS8cV.js";import"./CFormLabel-D4tkwmcW.js";import"./getTransitionDurationFromElement-Cpu4p4hx.js";var ze=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='272 434.744 272 209.176 240 209.176 240 434.744 188.118 382.862 165.49 405.489 256 496 346.51 405.489 323.882 382.862 272 434.744' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M400,161.176c0-79.4-64.6-144-144-144s-144,64.6-144,144a96,96,0,0,0,0,192h80v-32H112a64,64,0,0,1,0-128h32v-32a112,112,0,0,1,224,0v32h32a64,64,0,0,1,0,128H320v32h80a96,96,0,0,0,0-192Z' class='ci-primary'/>"];const Ss=({projectId:h,inModal:c=!1})=>{const[a,be]=n.useState([]),[L,Q]=n.useState(!0),[E,oe]=n.useState([]),[R,V]=n.useState({show:!1,message:"",type:"success"}),[f,M]=n.useState([]),[H,Y]=n.useState(!1),[ee,me]=n.useState(!1),[W,se]=n.useState([]),[w,q]=n.useState(!1);n.useState(null),n.useState(null),n.useState(!1);const[S,Ne]=n.useState([]),[te,ke]=n.useState([]),[U,Be]=n.useState([]),[Se,ne]=n.useState(!1),[x,Le]=n.useState([]),[O,xe]=n.useState([]);n.useEffect(()=>{(async()=>{try{const u=await $("/api/workingType");xe(u||[])}catch(u){console.error("Error fetching work types",u)}})()},[]);const We=Ns.useMemo(()=>{const t={};return O.forEach(u=>{t[u.id]=u.type_of_work}),t},[O]),Ae=async()=>{try{const t=await $("/api/machine-operators");console.log("machineries",t),Ne(t||[])}catch(t){console.error("Error fetching machineries:",t)}},Ue=async()=>{try{const t=await $("/api/machineLog");ke(t||[])}catch(t){console.error("Error fetching machine logs:",t)}};n.useEffect(()=>{if(a!=null&&a.worklog_ids&&te.length>0){const t=te.filter(u=>a.worklog_ids.includes(u.id));Be(t),console.log("Filtered Logs:",t)}},[a,te]);const ye=async()=>{try{Q(!0);const t=await $(`/api/project-payments/${h}`);console.log(t),be(t),t!=null&&t.additionalCharges&&Le(t.additionalCharges)}catch(t){console.error("Error fetching orders:",t),X("Failed to fetch orders","danger")}finally{Q(!1)}},ve=()=>{$("/api/operatorsByCompanyIdOperator").then(t=>{console.log(t),se(t)}).catch(t=>{console.log(t.message)})};n.useEffect(()=>{ye()},[h]),n.useEffect(()=>{Ue(),ve(),Ae(),v()},[]);const X=(t,u="success")=>{V({show:!0,message:t,type:u}),setTimeout(()=>V({show:!1,message:"",type:"success"}),5e3)},v=async()=>{try{const t=await $("/api/machine-price");oe(t)}catch(t){console.error("Error fetching machine price:",t)}},C=async()=>{if(f.length===0){X("Please select at least one work order to download","warning");return}Y(!0);try{await generateWorkOrdersPDF(f),X(`PDF generated successfully for ${f.length} work order(s)`,"success"),M([])}catch(t){console.error("Error generating PDF:",t),X("Failed to generate PDF. Please try again.","danger")}finally{Y(!1)}},De=()=>{q(!0)},_e=async()=>{var t,u,p,T,D;if(!(!a||Object.keys(a).length===0))try{ne(!0);const b=(t=Ee())==null?void 0:t.company_info;if(!b){R("Company information not found. Please log in again.");return}const Ge=Ie(a.created_at),we={invoice_number:a.invoice_number,date:Ge,name:((u=a.project)==null?void 0:u.customer_name)||"N/A",address:((p=a.project)==null?void 0:p.work_place)||"",mobile:((T=a.project)==null?void 0:T.mobile_number)||"",gst_number:((D=a.project)==null?void 0:D.gst_number)||"",consignee:{name:b.company_name,address:`${b.land_mark||""}, ${b.Tal||""}, ${b.Dist||""}, ${b.pincode||""}`,phone_no:b.phone_no,gst_number:b.gst_number,email_id:b.email_id},totalAmount:j,amountPaid:A,finalAmount:j,baseTotal:Z,additionalChargesTotal:I,additionalCharges:x,paymentMode:a.payment_mode,transaction_id:a.transaction_id,is_fixed_bid:a.is_fixed_bid==1,is_advance:a.is_advance==1,remark:a.remark},Ce=U.map(he=>({id:he.id,data:he}));await cs(we,Ce,W,S,E,Ce,"english","save",We)}catch(b){console.error("Error generating PDF:",b),R("Failed to generate PDF. Please try again.")}finally{ne(!1)}},Ie=t=>t?new Date(t).toLocaleDateString("en-GB"):"",Me=t=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[t]||t;if(L)return e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})});if(!a||Object.keys(a).length===0)return e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No invoice data found."})});const I=x.reduce((t,u)=>{var D;const p=Number(u.amount||0);return u.amount_deduct||((D=u.charge_definition)==null?void 0:D.amount_deduct)?t-p:t+p},0),Z=Number((a==null?void 0:a.work_order_amount)||(a==null?void 0:a.base_total)||0),j=Number((a==null?void 0:a.grand_total)||(a==null?void 0:a.total)||Z+I),A=Number((a==null?void 0:a.paid_amount)||0),z=Number((a==null?void 0:a.remaining)!==void 0?a.remaining:j-A),Te=z<=.01;return e.jsx("div",{className:"p-4",children:e.jsxs(Re,{children:[e.jsx(Oe,{className:"bg-primary text-white",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Details"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(fe,{color:Te?"success":"warning",className:"fs-6 px-3 py-2 rounded-pill",children:Te?"✔️ Completed":"⏳ Pending"}),e.jsx(y,{color:"success",size:"sm",onClick:_e,disabled:Se||!a,children:Se?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})})]})]})}),e.jsxs(He,{children:[e.jsxs(K,{className:"mb-4",children:[e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Invoice Number:"}),e.jsx("div",{className:"text-muted",children:a.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Date:"}),e.jsx("div",{className:"text-muted",children:Ie(a.created_at)})]})]}),e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Payment Mode:"}),e.jsx("div",{className:"text-muted",children:a.payment_mode||"-"})]}),a.transaction_id&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Transaction ID:"}),e.jsx("div",{className:"text-muted",children:a.transaction_id})]}),a.project&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Customer:"}),e.jsx("div",{className:"text-muted",children:a.project.customer_name||"-"})]})]})]}),!c&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:f.length>0&&e.jsxs("span",{className:"text-muted small",children:[f.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(y,{color:"primary",onClick:C,disabled:f.length===0||H,className:"d-flex align-items-center",size:"sm",children:H?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),f.length>0&&` (${f.length})`]})}),e.jsx(y,{color:"success",onClick:De,disabled:ee,className:"d-flex align-items-center",size:"sm",children:ee?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:_s,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),R.show&&e.jsx(ws,{color:R.type,dismissible:!0,onClose:()=>V({show:!1,message:"",type:"success"}),children:R.message}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto",overflowX:"auto",borderRadius:"6px"},children:e.jsxs(je,{striped:!0,bordered:!0,hover:!0,className:"mb-0",children:[e.jsx(pe,{style:{position:"sticky",top:0,zIndex:2,backgroundColor:"#f8f9fa",boxShadow:"0 2px 3px rgba(0,0,0,0.05)"},children:e.jsxs(g,{children:[e.jsx(o,{children:"Sr no."}),e.jsx(o,{children:"Work Date"}),e.jsx(o,{children:"Machine"}),e.jsx(o,{children:"Mode"}),e.jsx(o,{children:"Operator"}),e.jsx(o,{children:"Work Type"}),e.jsx(o,{children:"Start Reading"}),e.jsx(o,{children:"End Reading"}),e.jsx(o,{children:"Net Reading"}),e.jsx(o,{children:"Price Per Hour"}),e.jsx(o,{className:"text-end",children:"Total Price"})]})}),e.jsxs(ge,{children:[U.length>0?U.map((t,u)=>{var p,T,D;return e.jsxs(g,{children:[e.jsx(r,{children:u+1}),e.jsx(r,{children:(t==null?void 0:t.work_date)||"-"}),e.jsx(r,{children:((p=S.find(b=>String(b.id)===String(t==null?void 0:t.machine_id)))==null?void 0:p.machine_name)||"N/A"}),e.jsx(r,{children:((T=E.find(b=>b.id===Number(t.mode_id)))==null?void 0:T.mode)||"-"}),e.jsx(r,{children:((D=W.find(b=>b.id===Number(t==null?void 0:t.operator_id)))==null?void 0:D.name)||"Unknown Operator"}),e.jsx(r,{children:We[t==null?void 0:t.work_type_id]||"—"}),e.jsx(r,{children:(t==null?void 0:t.start_reading)||"-"}),e.jsx(r,{children:(t==null?void 0:t.end_reading)||"-"}),e.jsx(r,{children:t!=null&&t.end_reading&&(t!=null&&t.start_reading)?t.end_reading-t.start_reading:"-"}),e.jsxs(r,{children:["₹",(t==null?void 0:t.price_per_hour)||"0"]}),e.jsxs(r,{className:"text-end",children:["₹",t!=null&&t.end_reading&&(t!=null&&t.start_reading)&&(t!=null&&t.price_per_hour)?((t.end_reading-t.start_reading)*t.price_per_hour).toFixed(2):"0.00"]})]},t.id)}):e.jsx(g,{children:e.jsx(r,{colSpan:10,className:"text-center text-muted py-4",children:"No work orders found for this invoice."})}),x&&x.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(g,{style:{backgroundColor:"#f0f8ff"},children:e.jsx(r,{colSpan:11,className:"fw-bold text-primary",children:"Additional Charges"})}),x.map((t,u)=>{var T;const p=t.amount_deduct||((T=t.charge_definition)==null?void 0:T.amount_deduct);return e.jsxs(g,{style:{backgroundColor:"#f8f9fa"},children:[e.jsx(r,{children:U.length+u+1}),e.jsx(r,{children:t.date?new Date(t.date).toLocaleDateString("en-GB"):"-"}),e.jsxs(r,{colSpan:7,children:[e.jsxs("strong",{children:[Me(t.charge_type)," ",p?"(-)":"(+)"]}),t.remark&&e.jsxs("div",{className:"small text-muted mt-1",children:["Note: ",t.remark]})]}),e.jsx(r,{className:"text-center",children:e.jsx(fe,{color:t.is_paid?"success":"warning",children:t.is_paid?"Paid":"Pending"})}),e.jsxs(r,{className:"text-end fw-bold",style:{color:p?"red":"inherit"},children:[p?"-":"","₹",Number(t.amount).toFixed(2)]})]},`charge-${t.id}`)})]}),x.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Work Orders Subtotal"}),e.jsxs(r,{className:"text-end",children:["₹",Z.toFixed(2)]})]}),e.jsxs(g,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Additional Charges Total"}),e.jsxs(r,{className:"text-end",children:["₹",I.toFixed(2)]})]})]}),e.jsxs(g,{className:"fw-bold bg-primary text-white",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Grand Total"}),e.jsxs(r,{className:"text-end",children:["₹",j.toFixed(2)]})]}),e.jsxs(g,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Paid Amount"}),e.jsxs(r,{className:"text-end text-success",children:["₹",A.toFixed(2)]})]}),e.jsxs(g,{className:"fw-bold bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Remaining Amount"}),e.jsxs(r,{className:`text-end ${z>0?"text-danger":"text-success"}`,children:["₹",z.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"mt-4 p-3 bg-light rounded",children:[e.jsxs(K,{className:"w-100",children:[e.jsx(N,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Total Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold",children:["₹",j.toFixed(2)]})]})}),e.jsx(N,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Paid Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold text-success",children:["₹",A.toFixed(2)]})]})}),e.jsx(N,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Remaining:"}),e.jsxs("span",{className:`fs-5 fw-bold ${z>0?"text-danger":"text-success"}`,children:["₹",z.toFixed(2)]})]})})]}),a.payment_mode&&e.jsx("div",{className:"mt-2 pt-2 border-top",children:e.jsxs("div",{className:"",children:[e.jsx("span",{className:"fw-bold me-2",children:"Payment Mode:"}),e.jsx(fe,{color:"info",className:"fs-6",children:a.payment_mode})]})})]})]})]})})},As=({paymentId:h})=>{const[c,a]=n.useState(null),[be,L]=n.useState(!0),[Q,E]=n.useState(!1);n.useEffect(()=>{h&&oe()},[h]);const oe=async()=>{try{L(!0);const f=await $(`/api/project-payments/${h}`);a(f)}catch(f){console.error("Error fetching advance payment:",f)}finally{L(!1)}},R=f=>f?new Date(f).toLocaleDateString("en-GB"):"",V=async()=>{var f,M,H,Y,ee,me,W,se;if(c)try{E(!0);const w=(f=Ee())==null?void 0:f.company_info;if(!w){alert("Company information not found. Please log in again.");return}const q=R(c.created_at),S=c.is_fixed_bid==1,Ne=!S,te={invoice_number:c.invoice_number,date:q,customer:{name:((M=c.project)==null?void 0:M.customer_name)||"N/A",address:((H=c.project)==null?void 0:H.work_place)||"",mobile:((Y=c.project)==null?void 0:Y.mobile_number)||"",gst_number:((ee=c.project)==null?void 0:ee.gst_number)||""},consignee:{name:w.company_name,address:`${w.land_mark||""}, ${w.Tal||""}, ${w.Dist||""}, ${w.pincode||""}`,phone_no:w.phone_no,gst_number:w.gst_number,email_id:w.email_id},totalAmount:c.total,amountPaid:c.paid_amount,finalAmount:c.total,paymentMode:c.payment_mode||(S?"Fixed Bid":"Advance"),transaction_id:c.transaction_id,is_fixed_bid:S,is_advance:Ne,remark:c.remark,name:((me=c.project)==null?void 0:me.customer_name)||"N/A",address:((W=c.project)==null?void 0:W.work_place)||"",mobile:((se=c.project)==null?void 0:se.mobile_number)||"",total:c.total};await cs(te,[],[],[],[],[],"english","save")}catch(w){console.error("Error generating PDF:",w),alert("Failed to generate PDF. Please try again.")}finally{E(!1)}};return be?e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})}):c?e.jsx("div",{className:"p-4",children:e.jsxs(Re,{children:[e.jsxs(Oe,{className:"bg-warning text-dark d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:c.is_fixed_bid==1?"Fixed Bid Invoice":"Advance Payment Invoice"}),e.jsx(y,{color:"success",size:"sm",onClick:V,disabled:Q||!c,children:Q?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})})]}),e.jsxs(He,{children:[e.jsxs(K,{className:"mb-4",children:[e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Invoice Number:"})," ",e.jsx("span",{className:"text-muted",children:c.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Date:"})," ",e.jsx("span",{className:"text-muted",children:R(c.created_at)})]})]}),e.jsxs(N,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Payment Mode:"})," ",e.jsx("span",{className:"text-muted",children:c.payment_mode||(c.is_fixed_bid==1?"Fixed Bid":"Advance")})]}),c.transaction_id&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Transaction ID:"})," ",e.jsx("span",{className:"text-muted",children:c.transaction_id})]})]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(g,{children:[e.jsx(o,{children:"Description"}),e.jsx(o,{className:"text-end",children:"Amount"}),e.jsx(o,{className:"text-end",children:"Remaining"})]})}),e.jsxs(ge,{children:[e.jsxs(g,{children:[e.jsxs(r,{children:[e.jsx("strong",{children:c.is_fixed_bid==1?"Fixed Bid Work":"Advance Payment"}),c.remark&&e.jsx("div",{className:"text-muted small mt-1",children:c.remark})]}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-success",children:["₹",Number(c.total||0).toFixed(2)]})}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-danger",children:["₹",(Number(c.total||0)-Number(c.paid_amount||0)).toFixed(2)]})})]}),e.jsxs(g,{children:[e.jsx(r,{colSpan:2,children:e.jsx("strong",{children:"Total Paid Amount"})}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["₹",Number(c.paid_amount||0).toFixed(2)]})})]})]})]})}),e.jsx("div",{className:"mt-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Payment Mode:"}),e.jsx("span",{className:"badge bg-info fs-6 ms-2",children:c.payment_mode||(c.is_fixed_bid==1?"Fixed Bid":"Advance")})]})}),c.project&&e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Cust. Name :"}),e.jsx("span",{className:"text-muted ms-2",children:c.project.customer_name||"-"})]})})]})})]})]})}):e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No payment data found."})})},Ds=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-eye",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}),e.jsx("path",{d:"M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"})]}),tt=()=>{var es,ss;const{showToast:h}=ys(),c=(es=Ee())==null?void 0:es.company_id;if(!c)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[a,be]=n.useState([]),[L,Q]=n.useState(""),[E,oe]=n.useState(""),[R,V]=n.useState(""),[f,M]=n.useState(!1),[H,Y]=n.useState(null),[ee,me]=n.useState(!1),[W,se]=n.useState(null),[w,q]=n.useState(!1);n.useState("");const[S,Ne]=n.useState(null),[te,ke]=n.useState(!1),[U,Be]=n.useState([]),[Se,ne]=n.useState(!1),[x,Le]=n.useState(null),[O,xe]=n.useState(""),[We,Ae]=n.useState(""),[Ue,ye]=n.useState(!1),[ve,X]=n.useState(""),[v,C]=n.useState(""),[De,_e]=n.useState([]);n.useState(!1);const[Ie,Me]=n.useState(!1),[I,Z]=n.useState(""),[j,A]=n.useState(!1);n.useState(""),n.useState([]);const[z,Te]=n.useState([]),[t,u]=n.useState(!1),[p,T]=n.useState(null),D=async()=>{M(!0);try{const s=await $(`/api/project-payments?company_id=${c}`);be(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{M(!1)}},b=async()=>{M(!0);try{const s=await $("/api/project-wise-hours");Te(s.project_wise_hours||[]),console.log("machine hourse",s.project_wise_hours)}catch(s){h("danger","Error fetching Hours: "+((s==null?void 0:s.message)||s))}finally{M(!1)}},Ge=async()=>{try{const s=await $("/api/projects");if(!Array.isArray(s)){_e([]);return}const i={};s.forEach(l=>{var m;if(l.company_id!==c)return;const d=(m=l.customer_name)==null?void 0:m.trim();d&&(i[d]||(i[d]={name:d,mobile:l.mobile_number||"",projects:[]}),i[d].projects.push({id:l.id,company_id:l.company_id}))}),_e(Object.values(i))}catch(s){console.error(s),_e([])}},we=async()=>{if(S){M(!0);try{const s=await $(`/api/repayments?company_id=${c}&project_id=${S}`);Be(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching history: "+((s==null?void 0:s.message)||s))}finally{M(!1)}}};n.useEffect(()=>{D(),Ge(),b()},[c]),n.useEffect(()=>{S&&we()},[S,c]);const Ce=s=>s?new Date(s).toLocaleDateString("en-GB"):"",he=s=>`₹${Number(s||0).toFixed(2)}`,ls=s=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[s]||s,Ke=n.useMemo(()=>a.filter(s=>s.company_id===c),[a,c]),ds=n.useMemo(()=>{const s={};return z.forEach(i=>{s[Number(i.project_id)]=Number(i.total_hours||0)}),s},[z]),os=n.useMemo(()=>z.reduce((s,i)=>s+Number(i.total_hours||0),0),[z]),ms=s=>[...new Set(s.map(l=>{var d;return(d=l.project)==null?void 0:d.id}).filter(Boolean))].reduce((l,d)=>l+(ds[d]||0),0),$e=n.useMemo(()=>{const s={};if(Ke.forEach(i=>{var d;const l=((d=i.project)==null?void 0:d.customer_name)||"Unknown";s[l]||(s[l]=[]),s[l].push(i)}),E){const i=E.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([l])=>l.toLowerCase().includes(i)))}return s},[Ke,E]),Pe=n.useMemo(()=>{const s=Object.values($e),i=s.flat(),l=i.filter(F=>!F.is_advance),d=s.length,m=i.length,_=l.reduce((F,G)=>F+Number(G.total||0),0),J=l.reduce((F,G)=>F+Number(G.paid_amount||0),0),ue=_-J;return{customerCount:d,totalInvoices:m,totalBilled:_,totalPaid:J,totalOutstanding:ue}},[$e]);if(f&&!a.length)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(le,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading project payments..."})]});const xs=async()=>{if(!x)return;const s=Number(O)||0,i=j&&Number(v)||0,l=s+i,d=Number(x.total)-Number(x.paid_amount);if(l<=0)return h("danger","Total payment must be greater than 0");if(l>d+.01)return h("danger","Total amount exceeds remaining balance");if(j&&i>P)return h("danger","Advance amount exceeds available balance");try{const m={company_id:c,project_id:x.project_id,invoice_id:x.invoice_number,payment:s,advance_used:i,payment_mode:"Cash"};await Xe("/api/repayments",m),h("success","Payment recorded successfully"),ne(!1),xe(""),Ae(""),C(""),A(!1),D(),S&&we()}catch(m){console.error("Payment update error:",m),h("danger","Failed to update payment: "+((m==null?void 0:m.message)||m))}};if(!H)return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx(N,{xs:12,children:e.jsxs(Re,{className:"shadow-sm",children:[e.jsx(Oe,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Customers Payment Report"}),e.jsxs(fe,{color:"info",className:"ms-2",children:[Pe.customerCount," customers"]})]})}),e.jsxs(He,{children:[e.jsxs(K,{className:"mb-2",children:[e.jsx(N,{xs:12,md:6,children:e.jsxs(Cs,{children:[e.jsx(Ps,{children:"Search"}),e.jsx(Fe,{placeholder:"Search by customer name...",value:R,onChange:s=>{V(s.target.value),oe(s.target.value)}})]})}),E&&e.jsx(N,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(y,{color:"light",size:"sm",onClick:()=>{V(""),oe("")},children:"Clear"})})]}),e.jsxs(K,{className:"g-2 mb-3",children:[e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:Pe.totalInvoices})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsxs("small",{className:"d-block",children:["Total Billed (",os,"hrs.)"]}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalBilled)})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalPaid)})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(g,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(o,{className:"text-center align-middle",children:"Hours"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ge,{children:Object.entries($e).map(([s,i],l)=>{const d=i.filter(F=>!F.is_advance),m=d.reduce((F,G)=>F+Number(G.total||0),0),_=d.reduce((F,G)=>F+Number(G.paid_amount||0),0),J=m-_,ue=ms(i);return e.jsxs(g,{children:[e.jsx(r,{children:l+1}),e.jsx(r,{children:s}),e.jsx(r,{style:{color:ue<0?"red":"blue",fontWeight:600},children:ue}),e.jsxs(r,{className:"text-end",children:["₹",m.toFixed(2)]}),e.jsxs(r,{className:"text-success fw-bold text-end",children:["₹",_.toFixed(2)]}),e.jsxs(r,{className:"text-danger fw-bold text-end",children:["₹",J.toFixed(2)]}),e.jsx(r,{className:"text-center",children:e.jsx(y,{size:"sm",color:"info",onClick:()=>{Y(s),Ne(i[0].project_id)},children:"View Invoices"})})]},s)})})]})})]})]})})}),e.jsxs(ae,{visible:Ue,onClose:()=>{ye(!1),X(""),C("")},children:[e.jsx(re,{children:e.jsx(ie,{children:"Advance Payment"})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Customer"}),e.jsxs("select",{className:"form-select",value:ve,onChange:s=>X(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select --"}),De.map(s=>e.jsxs("option",{value:s.name,children:[s.name," ",s.mobile?`(${s.mobile})`:""]},s.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(Fe,{type:"number",placeholder:"Enter amount",value:v,onChange:s=>C(s.target.value),min:"0"})]})]}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>ye(!1),children:"Cancel"}),e.jsx(y,{color:"primary",onClick:async()=>{var m;if(!ve)return h("danger","Select a customer");const s=Number(v);if(!s||s<=0)return h("danger","Enter a valid amount");const i=De.find(_=>_.name===ve);if(!((m=i==null?void 0:i.projects)!=null&&m.length))return h("danger","No project for this customer");const{id:l,company_id:d}=i.projects[0];try{await Xe("/api/advance-payment",{company_id:d,project_id:l,amount:s}),h("success","Advance payment recorded"),ye(!1),X(""),C(""),D()}catch(_){h("danger","Failed: "+((_==null?void 0:_.message)||"Unknown error"))}},children:"Submit"})]})]})]});const Ve=$e[H]||[],Qe=Ve.filter(s=>!s.is_advance),Ye=Qe.reduce((s,i)=>s+Number(i.total||0),0),qe=Qe.reduce((s,i)=>s+Number(i.paid_amount||0),0),B=Ye-qe,P=(U||[]).filter(s=>s.is_advance&&!s.advance_taken).reduce((s,i)=>s+Number(i.payment||0),0),hs=async()=>{const s=Number(I)||0,i=j&&Number(v)||0,l=s+i;if(l<=0)return h("danger","Total payment must be greater than 0");if(l>B)return h("danger","Total amount exceeds remaining balance");if(j&&i>P)return h("danger","Advance amount exceeds available balance");try{await Xe("/api/repayments",{company_id:c,project_id:S,invoice_id:null,payment:s,advance_used:i}),h("success","Payment recorded successfully"),q(!1),Z(""),C(""),A(!1),D(),we()}catch(d){console.error("Repayment error:",d),h("danger","Error: "+((d==null?void 0:d.message)||d))}},us=async()=>{var ns,as,rs,is;const s=a.find(k=>k.invoice_number===L);if(!s)return;const i=U.filter(k=>(k==null?void 0:k.invoice_id)===L);if(i.length===0){h("warning","No history to download");return}const l=(ns=Ee())==null?void 0:ns.company_info;if(!l){alert("Company information not found. Please log in again.");return}const d=((as=s.project)==null?void 0:as.customer_name)||"N/A",m=s.is_fixed_bid==1?"FIXED BID INVOICE":"INVOICE",_=Number(s.total||0).toFixed(2),J=Number(s.paid_amount||0).toFixed(2),ue=(Number(s.total)-Number(s.paid_amount)).toFixed(2);let F=0;const G=Number(s.total||0),js=i.map((k,fs)=>{F+=Number(k.payment||0);const bs=G-F;return`
            <tr>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${fs+1}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    ${k!=null&&k.date?k.date.slice(0,10).split("-").reverse().join("-"):"-"}
                </td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(k.payment).toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${bs.toFixed(2)}</td>
            </tr>
        `}).join(""),ps=`
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <!-- Header Section -->
            <div style="border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        ${l.logo?`<img src="/img/${l.logo}" alt="Logo" style="max-width: 120px; height: auto;" />`:""}
                    </div>
                    <div style="text-align: right; flex: 1;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">${l.company_name||""}</h2>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${l.land_mark||""}, ${l.Tal||""}, ${l.Dist||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Pincode: ${l.pincode||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Phone: ${l.phone_no||""}</p>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div style="text-align: center; background-color: #0d6efd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <h2 style="margin: 0; color: #fff; font-size: 20px;">PAYMENT HISTORY - ${m}</h2>
            </div>

            <!-- Invoice & Customer Details -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Invoice Details</h3>
                    <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${s.invoice_number}</p>
                    <p style="margin: 5px 0;"><strong>Date:</strong> ${Ce(s.created_at)}</p>
                    <p style="margin: 5px 0;"><strong>Total Amount:</strong> ₹${_}</p>
                    <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ₹${J}</p>
                    <p style="margin: 5px 0;"><strong>Remaining:</strong> ₹${ue}</p>
                </div>
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Customer Details</h3>
                    <p style="margin: 5px 0;"><strong>Customer Name:</strong> ${d}</p>
                    <p style="margin: 5px 0;"><strong>Mobile:</strong> ${((rs=s.project)==null?void 0:rs.mobile_number)||"-"}</p>
                    <p style="margin: 5px 0;"><strong>Site:</strong> ${((is=s.project)==null?void 0:is.work_place)||"-"}</p>
                </div>
            </div>

            <!-- History Table -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Sr. No.</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Date</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Paid Amount</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    ${js}
                </tbody>
            </table>

            <!-- Footer -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 12px;">
                <p>This is a computer-generated document and is valid without signature.</p>
            </div>
        </div>
    `,ts=document.createElement("div");ts.innerHTML=ps;const gs={margin:[10,10,10,10],filename:`History-${s.invoice_number}-${d}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};try{await vs().set(gs).from(ts).save(),h("success","History PDF downloaded successfully")}catch(k){console.error("PDF generation error:",k),h("danger","Failed to generate PDF")}};return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx(N,{xs:12,children:e.jsxs(Re,{className:"shadow-sm",children:[e.jsxs(Oe,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"fs-5",children:["Invoices for ",H]}),e.jsxs(fe,{color:"info",className:"ms-2",children:[Ve.length," entries"]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(y,{color:"success",onClick:()=>{q(!0);const s=P>0&&P<=B;A(s),Z("")},children:"Record Payment"}),e.jsx(y,{color:"secondary",size:"sm",onClick:()=>Y(null),children:"Back"})]})]}),e.jsxs(He,{children:[e.jsxs(K,{className:"g-2 mb-2",children:[e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-primary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Total"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Ye.toFixed(2)]})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-success text-center text-white shadow-sm",children:[e.jsx("small",{children:"Paid"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",qe.toFixed(2)]})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-danger text-center text-white shadow-sm",children:[e.jsx("small",{children:"Remaining"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",B.toFixed(2)]})]})}),e.jsx(N,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-secondary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Advance"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",P.toFixed(2)]})]})})]}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"500px",overflowY:"auto"},children:e.jsxs(je,{hover:!0,bordered:!0,children:[e.jsx(pe,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa"},children:e.jsxs(g,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Invoice"}),e.jsx(o,{className:"text-center align-middle",children:"Date"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Mode"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ge,{children:Ve.sort((s,i)=>new Date(i.created_at)-new Date(s.created_at)).map((s,i)=>{const l=(Number(s.total)-Number(s.paid_amount)).toFixed(2);return e.jsxs(g,{className:s.is_advance==1?"table-primary":s.is_fixed_bid==1?"table-warning":"",children:[e.jsx(r,{children:i+1}),e.jsx(r,{children:s.is_advance==1?"Advance Payment":s.invoice_number}),e.jsx(r,{className:"text-center align-middle",children:Ce(s.created_at)}),e.jsxs(r,{className:"text-end fw-bold",children:["₹",Number(s.total).toFixed(2)]}),e.jsxs(r,{className:"text-success fw-bold text-end",children:["₹",Number(s.paid_amount).toFixed(2)]}),e.jsxs(r,{className:"text-danger fw-bold text-end",children:["₹",l]}),e.jsx(r,{children:s.payment_mode||"-"}),e.jsx(r,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-1",children:[s.is_advance==0&&e.jsx(Je,{content:"Add Payment",placement:"top",children:e.jsx(y,{color:"success",size:"sm",onClick:()=>{Le(s),ne(!0)},children:e.jsx(de,{icon:Fs})})}),s.is_advance==0&&e.jsx(Je,{content:"Payment History",placement:"top",children:e.jsx(y,{color:"info",size:"sm",onClick:()=>{Q(s.invoice_number),ke(!0)},children:e.jsx(de,{icon:ks})})}),e.jsx(Je,{content:s.is_advance==1?"View Advance Invoice":s.is_fixed_bid==1?"View Fixed Bid Invoice":"View Invoice",placement:"top",children:e.jsx(y,{color:s.is_advance==1||s.is_fixed_bid==1?"warning":"secondary",size:"sm",onClick:()=>{s.is_advance==1||s.is_fixed_bid==1?(se(s.id),Me(!0)):(se(s.id),me(!0))},children:e.jsx(Ds,{})})})]})})]},s.id)})})]})})]})]})})}),e.jsxs(ae,{visible:Ie,onClose:()=>Me(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:((ss=a.find(s=>s.id===W))==null?void 0:ss.is_fixed_bid)==1?"Fixed Bid Invoice":"Advance Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(As,{paymentId:W})})]}),e.jsxs(ae,{visible:w,onClose:()=>q(!1),children:[e.jsx(re,{children:e.jsxs(ie,{children:["Add Repayment - ",H]})}),e.jsxs(ce,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total :"})," ₹",Ye.toFixed(2)]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Advance Paid:"})," ",e.jsxs("span",{className:"text-success",children:["₹",P.toFixed(2)]})]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Paid :"})," ",e.jsxs("span",{className:"text-success",children:["₹",qe.toFixed(2)]})]}),e.jsxs("p",{className:"mb-3",children:[e.jsx("strong",{children:"Remaining :"})," ",e.jsxs("span",{className:"text-danger",children:["₹",B.toFixed(2)]})]}),e.jsx("hr",{}),B>0?e.jsxs(e.Fragment,{children:[P>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheck",checked:j,onChange:s=>{A(s.target.checked),s.target.checked}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheck",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("label",{className:"form-label small",children:["Advance to Use (Max: ₹",Math.min(B,P).toFixed(2),")"]}),e.jsx(Fe,{type:"number",placeholder:"Enter advance amount",value:v,onChange:s=>{parseFloat(s.target.value),C(s.target.value)},onBlur:s=>{let i=parseFloat(s.target.value)||0;const l=Math.min(B,P);i>l&&C(l)},min:"0",max:Math.min(B,P)})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Amount (Cash/Online)"}),e.jsx(Fe,{type:"number",placeholder:"Enter amount to pay",value:I,onChange:s=>Z(s.target.value),min:"0"}),Number(I)===0&&I!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-3 text-end",children:[e.jsxs("div",{children:[e.jsx("small",{children:"Advance Used:"})," ₹",Number(j?v:0).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("small",{children:"Cash/Online:"})," ₹",Number(I||0).toFixed(2)]}),e.jsxs("div",{className:"fw-bold fs-5 mt-1 text-primary",children:["Total Payment: ₹",((j?Number(v):0)+(Number(I)||0)).toFixed(2)]}),(j?Number(v):0)+(Number(I)||0)>B&&e.jsx("div",{className:"text-danger small mt-1",children:"Total exceeds remaining balance!"})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>{q(!1),A(!1),Z(""),C("")},children:"Cancel"}),e.jsx(y,{color:"primary",onClick:hs,disabled:B<=0||(Number(I)||0)+(j&&Number(v)||0)<=0,children:"Submit"})]})]}),e.jsxs(ae,{visible:te,onClose:()=>ke(!1),size:"lg",children:[e.jsx(re,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx(ie,{children:"Payment History"}),e.jsxs(y,{color:"success",size:"sm",className:"me-4",onClick:us,title:"Download History PDF",children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})]})}),e.jsx(ce,{children:U.filter(s=>(s==null?void 0:s.invoice_id)===L).length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(pe,{color:"dark",children:e.jsxs(g,{children:[e.jsx(o,{children:"Date"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Remaining"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(ge,{children:(()=>{var d;const s=U.filter(m=>(m==null?void 0:m.invoice_id)===L),i=((d=s[0])==null?void 0:d.total)||0;let l=0;return s.map((m,_)=>{l+=Number(m.payment||0);const J=Number(i)-l;return e.jsxs(g,{children:[e.jsx(r,{children:m!=null&&m.date?m.date.slice(0,10).split("-").reverse().join("-"):""}),e.jsxs(r,{children:["₹",m.payment]}),e.jsxs(r,{children:["₹",J.toFixed(2)]}),e.jsx(r,{children:m.remark})]},_)})})()})]})}):e.jsx("div",{className:"text-center py-4 text-muted",children:e.jsx("p",{className:"mb-0",children:"No payment history found for this invoice."})})})]}),e.jsxs(ae,{visible:Se,onClose:()=>{ne(!1),xe(""),C(""),A(!1),Ae("")},children:[e.jsx(re,{closeButton:!0,children:e.jsx(ie,{children:"Make Payment"})}),e.jsx(ce,{children:x&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice:"})," ",x.invoice_number]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Total:"}),e.jsxs("strong",{children:["₹",Number(x.total).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Paid:"}),e.jsxs("span",{className:"text-success",children:["₹",Number(x.paid_amount).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Remaining:"}),e.jsxs("span",{className:"text-danger",children:["₹",(Number(x.total)-Number(x.paid_amount)).toFixed(2)]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"d-flex justify-content-between mb-3",children:[e.jsx("span",{children:"Available Advance:"}),e.jsxs("span",{className:"text-primary fw-bold",children:["₹",P.toFixed(2)]})]}),Number(x.total)-Number(x.paid_amount)>0?e.jsxs(e.Fragment,{children:[P>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheckInvoice",checked:j,onChange:s=>{A(s.target.checked)}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheckInvoice",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label small",children:"Advance to Use"}),e.jsx(Fe,{type:"number",placeholder:"Enter advance amount",value:v,onChange:s=>{Number(x.total)-Number(x.paid_amount),parseFloat(s.target.value),C(s.target.value)},onBlur:s=>{const i=Number(x.total)-Number(x.paid_amount);let l=parseFloat(s.target.value)||0;const d=Math.min(i,P);l>d&&C(d)},min:"0"}),e.jsxs("small",{className:"text-muted",children:["Max: ₹",Math.min(Number(x.total)-Number(x.paid_amount),P).toFixed(2)]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label fw-semibold",children:"Amount (Cash/Online)"}),e.jsx("input",{type:"number",className:"form-control",value:O,onChange:s=>xe(s.target.value),min:"0",placeholder:"Enter amount"}),Number(O)===0&&O!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-2 text-end",children:[e.jsx("strong",{children:"Total Payment: "}),e.jsxs("span",{className:(j?Number(v):0)+(Number(O)||0)>Number(x.total)-Number(x.paid_amount)?"text-danger":"text-success",children:["₹",((j?Number(v):0)+(Number(O)||0)).toFixed(2)]})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]})}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>{ne(!1),A(!1),xe(""),C("")},children:"Cancel"}),e.jsx(y,{color:"success",disabled:!x||Number(x.total)-Number(x.paid_amount)<=0||(Number(O)||0)+(j&&Number(v)||0)<=0,onClick:xs,children:"Confirm"})]})]}),e.jsxs(ae,{visible:ee,onClose:()=>me(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:"Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(Ss,{projectId:W,inModal:!0})})]}),e.jsxs(ae,{visible:t,onClose:()=>{u(!1),T(null)},size:"lg",children:[e.jsx(re,{children:e.jsxs(ie,{children:["Additional Charges - ",p==null?void 0:p.invoice_number]})}),e.jsx(ce,{children:p!=null&&p.additionalCharges&&p.additionalCharges.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(g,{children:[e.jsx(o,{children:"Charge Type"}),e.jsx(o,{children:"Amount"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(ge,{children:p.additionalCharges.map((s,i)=>e.jsxs(g,{children:[e.jsx(r,{children:ls(s.charge_type)}),e.jsxs(r,{className:"text-end",children:["₹",Number(s.amount).toFixed(2)]}),e.jsxs(r,{className:"text-end text-success fw-bold",children:["₹",Number(s.paid_amount||0).toFixed(2)]}),e.jsx(r,{children:e.jsx(fe,{color:s.is_paid?"success":"warning",children:s.is_paid?"Paid":"Pending"})}),e.jsx(r,{children:s.remark||"-"})]},s.id))})]})}):e.jsx("p",{className:"text-muted text-center",children:"No additional charges"})})]})]})};export{tt as default};

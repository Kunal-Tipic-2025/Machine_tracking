import{r as l,u as Q,b as Z,j as e,C as ee}from"./index-BaFO0fBD.js";import{g as se,a as v,d as re,b as _,h as ie}from"./api-BUyL__Lx.js";import{C as te}from"./ConfirmationModal-BsIVVqWL.js";import{C as ne,a as ae}from"./CCardBody-C_DcNhkI.js";import{C as oe}from"./CCardHeader-uQH1AYuq.js";import{d as h}from"./index.esm-6sS0QU7y.js";import{C as le,a as de,b as N,c as p,d as ce,e as c}from"./CTable-BC39XzuD.js";import{a as me,b as he,c as pe,d as ge,e as xe}from"./DefaultLayout-CO5Zw0Z5.js";import{C as E}from"./CFormInput-Bf1zI-co.js";import{C as M}from"./CFormSelect-CKz9M81i.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-D7bfBri4.js";import"./CNavItem-BYh17SIg.js";import"./CFormControlWrapper-DiPXZd7c.js";import"./CFormControlValidation-D0XpqgJc.js";import"./CFormLabel-zcG2lLqz.js";function Ae(){const[T,k]=l.useState(!0),[S,O]=l.useState([]),[A,x]=l.useState(!1),[n,m]=l.useState({id:null,machine_name:"",register_number:"",ownership_type:"",operator_id:[],mode_id:[]}),[d,u]=l.useState([]),[j,D]=l.useState([]),[g,I]=l.useState([]),[U,y]=l.useState(!1),[H,P]=l.useState(null),z=Q(),{showToast:o}=Z(),b=se(),w=b==null?void 0:b.company_info;console.log("userData from session:",w);const C=async()=>{try{const r=(await v("/api/machine-operators")).filter(i=>i.company_id===w.company_id);console.log("Filtered Response : ",r),O(r)}catch(s){console.error("Error fetching machineries:",s),o("danger","Error fetching machineries")}finally{k(!1)}},B=async()=>{try{const s=await v("/api/appUsers");console.log("All the users from users:",s.data);const r=s.data.filter(i=>i.type===2);console.log("Filtered users (type = 2):",r),D(r)}catch(s){console.error("Error fetching Users:",s),o("danger","Error fetching Users")}},R=async()=>{try{const s=await v("/api/machine-price");console.log("response"),console.log(s),I(s)}catch(s){console.error("Error fetching Users:",s),o("danger","Error fetching Users")}},F=s=>{P(s),y(!0)},L=async()=>{try{await re(`/api/machine-operators/${H}`),C(),o("success","Machine deleted successfully"),y(!1)}catch(s){console.error("Error deleting machinery:",s),o("danger","Error deleting machinery")}},V=async s=>{console.log("handle Edit",s),m({id:s.id,machine_name:s.machine_name,register_number:s.register_number,ownership_type:s.ownership_type,operator_id:s.operator_id||[],mode_id:s.mode_id||[]});try{const r=(s.mode_id||[]).map(t=>g.find(a=>String(a.id)===String(t))).filter(Boolean);console.log("Selected modes for edit:",r);const i=r.map(t=>({id:t.id,mode:t.mode,price:Number(t.price)}));u(i)}catch(r){console.error("Error preparing machine modes:",r),u([])}x(!0)},q=s=>{var t;const r=s.target.value;if(!r||d.some(a=>a.mode===r))return;const i=((t=g.find(a=>a.mode===r))==null?void 0:t.price)||0;u([...d,{mode:r,price:Number(i)}]),s.target.value=""},$=s=>{const r=d[s],i=d.filter((t,a)=>a!==s);u(i),m(t=>({...t,mode_id:t.mode_id.filter(a=>String(a)!==String(r.id))}))},Y=s=>Array.isArray(s)?s.map(r=>{const i=g.find(t=>String(t.id)===String(r));return i?i.mode:null}).filter(Boolean):[],W=async()=>{var s;if(!n.machine_name.trim())return o("danger","Machine Name is required");if(!n.register_number.trim())return o("danger","Registration Number is required");if(!n.ownership_type)return o("danger","Ownership Type is required");if(d.some(r=>!r.mode||!r.price||r.price<=0))return o("danger","Please fill all mode and price fields correctly");try{console.log("edit",n),await _(`/api/machine-operators/${n.id}`,{machine_name:n.machine_name,register_number:n.register_number,ownership_type:n.ownership_type,operator_id:n.operator_id});const r=[...n.mode_id||[]];for(const i of d){const t=g.find(a=>a.mode===i.mode);if(t)t.price!==i.price&&await _(`/api/machine-price/${t.id}`,{...t,price:i.price}),r.includes(String(t.id))||r.push(String(t.id));else{const f=(s=(await ie("/api/machine-price",{mode:i.mode,price:i.price})).data)==null?void 0:s.id;f&&r.push(String(f))}}await _(`/api/machine-operators/${n.id}`,{mode_id:r}),await R(),await C(),x(!1),o("success","Machine updated successfully")}catch(r){console.error("Error updating machinery:",r),o("danger","Failed to update machinery")}},X=()=>{z("/addMachinery")};l.useEffect(()=>{C(),B(),R()},[]);const G=s=>{m(r=>({...r,operator_id:r.operator_id.filter(i=>String(i)!==String(s))}))},J=s=>{const r=s.target.value;r&&(m(i=>i.operator_id.includes(String(r))?i:{...i,operator_id:[...i.operator_id,String(r)]}),s.target.value="")},K=[...new Set(g.map(s=>s.mode))].filter(s=>!d.some(r=>r.mode===s));return T?e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(ee,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading machines..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ne,{className:"mb-4",children:[e.jsxs(oe,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Machineries List"}),e.jsx(h,{color:"danger",onClick:X,children:"Add New Machinery"})]}),e.jsx(ae,{children:e.jsx("div",{className:"table-responsive",style:{width:"100%",overflowX:"auto",overflowY:"auto",border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff"},children:e.jsxs(le,{hover:!0,striped:!0,bordered:!0,color:"light",className:"mb-0",children:[e.jsx(de,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs(N,{children:[e.jsx(p,{className:"text-center align-middle",children:"SR. NO."}),e.jsx(p,{className:"text-center align-middle",children:"Machine Name"}),e.jsx(p,{className:"text-center align-middle",children:"Reg. Number"}),e.jsx(p,{className:"text-center align-middle",children:"Ownership"}),e.jsx(p,{className:"text-center align-middle",children:"Operators"}),e.jsx(p,{className:"text-center align-middle",children:"Modes"}),e.jsx(p,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ce,{children:S.length>0?S.map((s,r)=>{var i;return e.jsxs(N,{children:[e.jsx(c,{children:r+1}),e.jsx(c,{children:s.machine_name}),e.jsx(c,{children:s.register_number}),e.jsx(c,{children:s.ownership_type=="owned"?"Own":s.ownership_type=="rented"?"Rent":"Lease"}),e.jsx(c,{children:(i=s==null?void 0:s.operator_id)==null?void 0:i.map(t=>{const a=j.find(f=>String(f.id)===String(t));return e.jsx("li",{style:{listStyleType:"none"},children:a==null?void 0:a.name},t)})}),e.jsx(c,{children:Y(s.mode_id).map((t,a)=>e.jsx("li",{style:{listStyleType:"none"},children:t},a))}),e.jsxs(c,{style:{minHeight:"100%"},children:[e.jsx(h,{color:"info",size:"sm",className:"me-2 text-white",onClick:()=>V(s),children:"Edit"}),e.jsx(h,{color:"danger",size:"sm",onClick:()=>F(s.id),children:"Delete"})]})]},s.id)}):e.jsx(N,{children:e.jsx(c,{colSpan:7,className:"text-center",children:"No machineries found"})})})]})})})]}),e.jsxs(me,{visible:A,onClose:()=>x(!1),size:"lg",children:[e.jsx(he,{closeButton:!0,children:e.jsx(pe,{children:"Edit Machinery"})}),e.jsxs(ge,{children:[e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-4 mb-3",children:e.jsx(E,{type:"text",label:"Machine Name",value:n.machine_name||"",onChange:s=>m({...n,machine_name:s.target.value})})}),e.jsx("div",{className:"col-md-4 mb-3",children:e.jsx(E,{type:"text",label:"Reg. Number",value:n.register_number||"",onChange:s=>m({...n,register_number:s.target.value})})}),e.jsx("div",{className:"col-md-4 mb-3",children:e.jsxs(M,{label:"Ownership Type",value:n.ownership_type||"",onChange:s=>m({...n,ownership_type:s.target.value}),children:[e.jsx("option",{value:"",children:"-- Select Ownership Type --"}),e.jsx("option",{value:"owned",children:"Own"}),e.jsx("option",{value:"rented",children:"Rent"}),e.jsx("option",{value:"leased",children:"Lease"})]})})]}),e.jsxs("div",{className:" position-relative",children:[e.jsx("span",{style:{position:"relative",top:"3px",left:"0",backgroundColor:"white",paddingRight:"8px",color:"#0d6efd",fontWeight:"600"},children:"Modes detail"}),e.jsx("hr",{style:{marginTop:"0.5rem",border:"none",borderTop:"2px solid #0d6efd"}})]}),e.jsxs("div",{className:"row align-items-start",children:[e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs(M,{className:"mt-2",defaultValue:"",onChange:q,label:"Add Mode",children:[e.jsx("option",{value:"",children:"-- Select Mode --"}),K.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:e.jsx("strong",{children:"Assigned Modes"})}),e.jsx("div",{className:"p-2 border rounded bg-light",style:{maxHeight:"250px",overflowY:"auto"},children:d.length>0?d.map((s,r)=>e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("span",{children:[e.jsx("span",{style:{display:"inline-block",width:"10px",height:"10px",borderRadius:"50%",backgroundColor:"#0d6efd",marginRight:"8px"}}),s.mode," -",e.jsxs("span",{style:{marginLeft:"10px",fontWeight:"500"},children:["â‚¹",s.price]})]}),e.jsx(h,{color:"danger",size:"sm",onClick:()=>$(r),children:"Remove"})]},r)):e.jsx("div",{className:"text-muted",children:"No modes assigned"})})]})]}),e.jsxs("div",{className:"position-relative",children:[e.jsx("span",{style:{position:"relative",top:"3px",left:"0",backgroundColor:"white",paddingRight:"8px",color:"#0d6efd",fontWeight:"600"},children:"Operators detail"}),e.jsx("hr",{style:{marginTop:"0.5rem",border:"none",borderTop:"2px solid #0d6efd"}})]}),e.jsxs("div",{className:"row align-items-start",children:[e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs(M,{className:"mt-2",defaultValue:"",onChange:J,label:"Add Operator",children:[e.jsx("option",{value:"",children:"-- Select Operator --"}),j.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:e.jsx("strong",{children:"Assigned Operators"})}),e.jsx("div",{className:"p-2 border rounded bg-light",style:{maxHeight:"250px",overflowY:"auto"},children:n.operator_id.length>0?n.operator_id.map(s=>{const r=j.find(i=>String(i.id)===String(s));return e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsxs("span",{children:[e.jsx("span",{style:{display:"inline-block",width:"10px",height:"10px",borderRadius:"50%",backgroundColor:"#0d6efd",marginRight:"8px"}}),r?r.name:`Operator ID ${s}`]}),e.jsx(h,{color:"danger",size:"sm",onClick:()=>G(s),children:"Remove"})]},s)}):e.jsx("div",{className:"text-muted",children:"No operators assigned"})})]})]})]}),e.jsxs(xe,{children:[e.jsx(h,{color:"secondary",onClick:()=>x(!1),children:"Cancel"}),e.jsx(h,{color:"primary",onClick:W,children:"Save Changes"})]})]}),e.jsx(te,{visible:U,setVisible:y,onYes:L,resource:"Delete Machinery",message:"Do you want to delete this Machinery?"})]})}export{Ae as default};

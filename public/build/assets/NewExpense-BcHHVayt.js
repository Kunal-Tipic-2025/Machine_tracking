import{r as l,u as pe,b as ue,i as R,j as s}from"./index-WEbTLRLZ.js";import{g as w,a as v,c as he,p as _e}from"./api-Ba1wfMeh.js";import{S as N}from"./react-select.esm-tOfyDdog.js";import{u as xe,a as ge,b as je,e as ye,c as fe,d as be}from"./DefaultLayout-CnBEfSKd.js";import{a as H,b as P,d as h}from"./index.esm-CZeMoYDH.js";import{C as U,a as z}from"./CCardBody-CtNgr8m7.js";import{C as W}from"./CCardHeader-LFhc_ZAM.js";import{C as Se}from"./CForm-J01-VhG4.js";import{C as _}from"./CFormLabel-D964ZFYD.js";import{C as y}from"./CFormInput-D3dwui72.js";import{C as Le,a as ve,b as V,c as x,d as Ce,e as g}from"./CTable-DcVbcKI_.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./emotion-react.browser.esm-Dj9ObznP.js";import"./floating-ui.dom-ByRZgDQ1.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-Cd7YjP3x.js";import"./CNavItem-u5MAKPdZ.js";import"./CFormControlWrapper-DljGJ9Vz.js";const Je=()=>{l.useRef({});const[K,C]=l.useState(!1),[Z,J]=l.useState([]),[m,B]=l.useState([]),[Q,f]=l.useState(!1),[d,b]=l.useState(null),[Ee,X]=l.useState([]),[Ae,M]=l.useState({name:"",id:null}),[E,A]=l.useState([]),[F,Y]=l.useState([]),[we,O]=l.useState([]),ee=async()=>{var a;const e=(a=w())==null?void 0:a.company_id;if(!e){c("danger","Unable to determine company. Please log in again."),A([]);return}try{const t=await v(`/api/machine-operators?company_id=${e}`),o=Array.isArray(t)?t.filter(p=>p.company_id===e):[];A(o)}catch(t){console.error("Error fetching machineries:",t),c("danger","Error fetching machineries: "+((t==null?void 0:t.message)||"")),A([])}},se=async()=>{var a;const e=(a=w())==null?void 0:a.company_id;if(e)try{const t=await v(`/api/projects?company_id=${e}`);Y(t||[])}catch(t){console.error("Error fetching projects:",t)}},ae=async()=>{try{const e=await v("/api/operatorsByCompanyIdOperator");O(e)}catch(e){console.error("Error fetching Users:",e),c("danger","Error fetching Users")}};pe();const{showToast:c}=ue(),{t:n}=xe("global"),[r,u]=l.useState({project_id:"",name:"",desc:"",expense_id:void 0,typeNotSet:!0,qty:1,price:0,total_price:0,expense_date:new Date().toISOString().split("T")[0],contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,isGst:!1,company_id:"",photoAvailable:!0,photo_url:null,photo_remark:"",bank_name:"",acc_number:"",ifsc:"",aadhar:"",pan:"",transaction_id:"",machine_id:"",customer_id:""}),q=()=>{const e=localStorage.getItem("i18nextLng"),a=R.language;return e||a||"en"},ne=(e,a=null)=>(a||q())==="mr"&&e.localName||e.name,G=async()=>{try{const e=await v("/api/expenseType");J(e.filter(a=>a.show===1))}catch(e){c("danger","Error occurred "+e)}};l.useEffect(()=>{G(),ee(),se(),ae();const e=w();e!=null&&e.company_id&&u(a=>({...a,company_id:e.company_id}))},[]),l.useEffect(()=>{G()},[R.language]);const te=e=>{const a=parseFloat(e.qty)||0,t=parseFloat(e.price)||0;e.total_price=Math.round(a*t)},j=e=>{const{name:a,value:t,type:o,checked:p,files:I}=e.target;u($=>{const i={...$};return o==="checkbox"&&a==="isGst"?(i.isGst=p,i):a==="price"||a==="qty"?(i[a]=t,te(i),i):a==="expense_id"?(i.expense_id=t,i.typeNotSet=!t,i):a==="name"?(/^[a-zA-Z0-9\u0900-\u097F ]*$/.test(t)&&(i.name=t),i):a==="photoAvailable"?(i.photoAvailable=p,p?i.photo_remark="":i.photo_url=null,i):o==="file"&&a==="photo_url"?(i.photo_url=I[0]||null,i):(i[a]=o==="checkbox"?p:t,i)})},re=e=>{u({project_id:e.project_id,company_id:e.company_id,name:e.name,desc:e.desc||"",expense_id:e.expense_id,typeNotSet:!1,qty:e.qty,price:e.price,total_price:e.total_price,expense_date:e.expense_date,contact:e.contact,payment_by:e.payment_by,payment_type:e.payment_type,pending_amount:e.pending_amount,show:e.show,isGst:e.isGst}),M({name:e.customer_name,id:e.project_id}),b(e),C(!1),window.scrollTo({top:0,behavior:"smooth"}),c("info",n("MSG.expense_loaded_for_editing"))},ie=()=>{b(null),L(),c("info",n("MSG.edit_cancelled"))},oe=e=>{const a=m.filter(t=>t.id!==e);B(a),d&&d.id===e&&(b(null),L()),c("info",n("MSG.expense_removed_from_list"))},ce=async e=>{if(e.preventDefault(),e.stopPropagation(),C(!0),!r.company_id){c("danger","Company is required for expense submission.");return}const a=new FormData;if(console.log("state"),console.log(r),a.append("company_id",r.company_id),r.project_id&&a.append("project_id",r.project_id),r.expense_id&&a.append("expense_id",r.expense_id),r.desc&&a.append("desc",r.desc),a.append("price",r.price),a.append("qty",r.qty),a.append("total_price",r.total_price),a.append("expense_date",r.expense_date),r.show!==void 0&&a.append("show",r.show?1:0),a.append("isGst",r.isGst?1:0),r.machine_id&&a.append("machine_id",r.machine_id),a.append("photoAvailable",r.photoAvailable?1:0),r.customer_id&&a.append("customer_id",r.customer_id),r.photo_url instanceof File&&a.append("photo_url",r.photo_url),r.expense_id&&r.price>0&&r.qty>0)try{const t=await he("/api/expense",a);console.log("response",t),t?c("success",n("MSG.new_expense_added_successfully_msg")):c("danger",n("MSG.error_occured_please_try_again_later_msg")),L()}catch(t){c("danger","Error occurred "+t)}else u(t=>({...t,typeNotSet:t.expense_id===void 0}))},le=async()=>{if(m.length===0){c("warning",n("MSG.add_atleast_one_expense"));return}f(!0)},de=async()=>{try{const e=m.map(o=>{const{id:p,expense_type_name:I,customer_name:$,...i}=o;return _e("/api/expense",i)}),t=(await Promise.all(e)).filter(o=>o).length;if(t===m.length){const o=n("MSG.expenses_submitted_successfully",{count:t})||`${t} expenses submitted successfully`;c("success",o),B([]),b(null)}else{const o=n("MSG.partial_expenses_submitted",{successCount:t,totalCount:m.length})||`${t} out of ${m.length} expenses submitted`;c("warning",o)}}catch(e){const a=n("MSG.error_occurred")||"Error occurred";c("danger",`${a}: ${e}`)}f(!1)},k=()=>{const e=m.reduce((a,t)=>{const o=parseFloat(t.qty)||0,p=parseFloat(t.price)||0;return a+o*p},0);return Number(e.toFixed(2))},S=e=>`₹${parseFloat(e).toFixed(2)}`,T=new Date().toISOString().split("T")[0],L=async()=>{u({project_id:"",company_id:"",name:"",desc:"",expense_id:"",open:!1,qty:"",price:0,total_price:0,expense_date:T,contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,typeNotSet:!1,isGst:!1,photo_remark:"",bank_name:"",acc_number:"",ifsc:"",transaction_id:"",customer_id:""}),M({name:"",id:null}),X([]),C(!1)},me=q();setTimeout(()=>{console.log("Machines",E)},2e3);const D=Z.map(e=>({value:e.id,expense_category:e.expense_category,label:ne(e,me)}));return s.jsxs(s.Fragment,{children:[s.jsx(H,{children:s.jsx(P,{xs:12,children:s.jsxs(U,{className:"mb-4",children:[s.jsx(W,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[n(d?"LABELS.edit_expense":"LABELS.new_expense"),d&&s.jsx("span",{className:"ms-2 badge bg-warning text-dark",children:n("LABELS.editing_mode")})]}),s.jsx(h,{color:"danger",size:"sm",onClick:()=>window.location.href="/#/expense/new-type",children:n("LABELS.new_expense_type")})]})}),s.jsx(z,{children:s.jsxs(Se,{noValidate:!0,validated:K,onSubmit:ce,children:[s.jsxs("div",{className:"row",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"expense_id",children:s.jsx("b",{children:n("LABELS.expense_type")})}),s.jsx(N,{id:"expense_id",name:"expense_id",value:D.find(e=>String(e.value)===String(r.expense_id))||null,onChange:e=>{const a=String((e==null?void 0:e.expense_category)||"").toLowerCase(),t=String((e==null?void 0:e.label)||"").toLowerCase(),o=a.includes("machine")||t.includes("machine")||a.includes("मशीन")||t.includes("मशीन");u(p=>({...p,expense_id:e?e.value:"",open:o}))},options:D,placeholder:n("MSG.select_expense_type_msg"),isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),r.open&&s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"machine_id",children:s.jsx("b",{children:n("LABELS.machine")})}),s.jsx(N,{id:"machine_id",name:"machine_id",value:E.map(e=>({value:e.id,label:e.machine_name})).find(e=>String(e.value)===String(r.machine_id))||null,onChange:e=>u(a=>({...a,machine_id:e?e.value:""})),options:E.map(e=>({value:e.id,label:e.machine_name})),placeholder:"Select Machine",isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"customer_id",children:s.jsx("b",{children:n("LABELS.customer_name")})}),s.jsx(N,{id:"customer_id",name:"customer_id",value:F.map(e=>({value:e.id,label:e.customer_name})).find(e=>String(e.value)===String(r.customer_id))||null,onChange:e=>u(a=>({...a,customer_id:e?e.value:"",project_id:e?e.value:""})),options:F.map(e=>({value:e.id,label:e.customer_name})),placeholder:"Select Customer",isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"name",children:s.jsx("b",{children:n("LABELS.about_expense")})}),s.jsx(y,{type:"text",id:"desc",placeholder:n("LABELS.enter_expense_description"),name:"desc",value:r.desc,onChange:j})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"expense_date",children:s.jsx("b",{children:n("LABELS.expense_date")})}),s.jsx(y,{type:"date",id:"expense_date",name:"expense_date",max:T,value:r.expense_date,onChange:j,required:!0,feedbackInvalid:n("MSG.select_date_validation")})]})})]}),s.jsxs("div",{className:"row align-items-end",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"price",children:s.jsx("b",{children:n("LABELS.price_per_unit")})}),s.jsx(y,{type:"number",min:"0",id:"price",onWheel:e=>e.target.blur(),placeholder:"0.00",step:"0.01",name:"price",onFocus:()=>u(e=>({...e,price:""})),value:r.price,onChange:j,required:!0,feedbackInvalid:n("MSG.price_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"qty",children:s.jsx("b",{children:n("LABELS.total_units")})}),s.jsx(y,{type:"number",id:"qty",step:"0.01",min:"0",placeholder:" ",name:"qty",value:r.qty,onWheel:e=>e.target.blur(),onKeyDown:e=>{["e","+","-",","].includes(e.key)&&e.preventDefault()},onChange:e=>{const a=e.target.value;(a===""||/^\d+(\.\d{0,2})?$/.test(a))&&j(e)},required:!0,feedbackInvalid:n("MSG.quantity_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"total_price",children:s.jsx("b",{children:n("LABELS.total_price")})}),s.jsx(y,{type:"number",min:"0",onWheel:e=>e.target.blur(),id:"total_price",placeholder:"",name:"total_price",value:r.total_price,onChange:j,readOnly:!0})]})})]}),s.jsx("div",{className:"row"}),s.jsxs("div",{className:"mb-3 mt-3",children:[s.jsx(h,{color:"success",type:"submit",children:n("LABELS.submit")})," ",d&&s.jsxs(s.Fragment,{children:[s.jsx(h,{color:"warning",type:"button",onClick:ie,children:n("LABELS.cancel_edit")})," "]}),s.jsx(h,{color:"secondary",onClick:L,children:n("LABELS.clear")})]})]})})]})})}),m.length>0&&s.jsx(H,{children:s.jsx(P,{xs:12,children:s.jsxs(U,{className:"mb-4",children:[s.jsx(W,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[n("LABELS.expenses_list")," (",m.length,")"]}),s.jsxs("span",{children:[n("LABELS.total_amount"),": ",s.jsx("strong",{children:S(k())})]})]})}),s.jsxs(z,{children:[s.jsx("div",{className:"table-responsive",children:s.jsxs(Le,{striped:!0,hover:!0,children:[s.jsx(ve,{children:s.jsxs(V,{children:[s.jsx(x,{children:n("LABELS.customer_name")}),s.jsx(x,{children:n("LABELS.expense_type")}),s.jsx(x,{children:n("LABELS.description")}),s.jsx(x,{children:n("LABELS.date")}),s.jsx(x,{children:n("LABELS.price")}),s.jsx(x,{children:n("LABELS.quantity")}),s.jsx(x,{children:n("LABELS.total")}),s.jsx(x,{children:n("LABELS.actions")})]})}),s.jsx(Ce,{children:m.map(e=>s.jsxs(V,{className:d&&d.id===e.id?"table-warning":"",children:[s.jsx(g,{children:e.customer_name}),s.jsx(g,{children:e.expense_type_name}),s.jsx(g,{children:e.name||"-"}),s.jsx(g,{children:e.expense_date}),s.jsx(g,{children:S(e.price)}),s.jsx(g,{children:e.qty}),s.jsx(g,{children:S(e.total_price)}),s.jsxs(g,{children:[s.jsx(h,{color:"info",size:"sm",onClick:()=>re(e),className:"me-1",disabled:d&&d.id===e.id,children:d&&d.id===e.id?n("LABELS.editing"):n("LABELS.edit")}),s.jsx(h,{color:"danger",size:"sm",onClick:()=>oe(e.id),children:n("LABELS.remove")})]})]},e.id))})]})}),s.jsxs("div",{className:"mt-3",children:[s.jsxs(h,{color:"success",size:"lg",onClick:le,disabled:d!==null,children:[n("LABELS.submit_all_expenses")," (",m.length,")"]}),d&&s.jsx("div",{className:"mt-2",children:s.jsxs("small",{className:"text-warning",children:[s.jsx("i",{className:"fas fa-exclamation-triangle me-1"}),n("MSG.complete_edit_before_submit")]})})]})]})]})})}),s.jsxs(ge,{visible:Q,onClose:()=>f(!1),children:[s.jsx(je,{children:s.jsx(ye,{children:n("LABELS.confirm_submission")})}),s.jsxs(fe,{children:[s.jsx("p",{children:n("MSG.confirm_submit_expenses",{count:m.length})}),s.jsx("p",{children:s.jsxs("strong",{children:[n("LABELS.total_amount"),": ",S(k().toFixed(2))]})})]}),s.jsxs(be,{children:[s.jsx(h,{color:"secondary",onClick:()=>f(!1),children:n("LABELS.cancel")}),s.jsx(h,{color:"primary",onClick:de,children:n("LABELS.confirm_submit")})]})]})]})};export{Je as default};

import{r as a,R as Ns,j as e,C as le,b as ys}from"./index-BGxqQxQJ.js";import{d as N,c as de,a as X,b}from"./index.esm-C022RvEN.js";import{a as S,g as Oe,h as Je}from"./api-BUyL__Lx.js";import{g as ls,h as vs}from"./InvoiceMulPdf-CvoDDLi7.js";import{C as ze,a as Be}from"./CCardBody-D-98gfs-.js";import{C as Le}from"./CCardHeader-DrFBPpLI.js";import{C as be,j as _s,a as ne,b as re,e as ie,c as ce,d as Ke}from"./DefaultLayout-CJqyOSiB.js";import{C as ws}from"./RawMaterial-D0BUKRzG.js";import{C as pe,a as ge,b as g,c as o,d as fe,e as n}from"./CTable-CrWc4d5e.js";import{C as Cs}from"./CInputGroup-DS0YxTA0.js";import{C as Ps}from"./CInputGroupText-D7wAdK2Y.js";import{C as ke}from"./CFormInput-BTypOiNL.js";import{C as Qe}from"./CTooltip-B0y5ndPM.js";import{c as Fs}from"./cil-money-Dk3vHnQB.js";import{c as ks}from"./cil-history-D-FQjjfl.js";import"./jspdf.es.min-kqEr2Fax.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-BkPyVptB.js";import"./CFormControlWrapper-BLBktZ5v.js";import"./CFormControlValidation-C-pgsv8A.js";import"./CFormLabel-D2dR9F1X.js";import"./getTransitionDurationFromElement-Cpu4p4hx.js";var We=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='272 434.744 272 209.176 240 209.176 240 434.744 188.118 382.862 165.49 405.489 256 496 346.51 405.489 323.882 382.862 272 434.744' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M400,161.176c0-79.4-64.6-144-144-144s-144,64.6-144,144a96,96,0,0,0,0,192h80v-32H112a64,64,0,0,1,0-128h32v-32a112,112,0,0,1,224,0v32h32a64,64,0,0,1,0,128H320v32h80a96,96,0,0,0,0-192Z' class='ci-primary'/>"];const As=({projectId:h,inModal:i=!1})=>{const[l,Ne]=a.useState([]),[z,Z]=a.useState(!0),[I,oe]=a.useState([]),[M,U]=a.useState({show:!1,message:"",type:"success"}),[f,D]=a.useState([]),[T,G]=a.useState(!1),[J,me]=a.useState(!1),[B,K]=a.useState([]),[_,V]=a.useState(!1);a.useState(null),a.useState(null),a.useState(!1);const[k,ye]=a.useState([]),[Q,Ae]=a.useState([]),[L,Ue]=a.useState([]),[Se,ee]=a.useState(!1),[m,Ge]=a.useState([]),[$,xe]=a.useState([]);a.useEffect(()=>{(async()=>{try{const u=await S("/api/workingType");xe(u||[])}catch(u){console.error("Error fetching work types",u)}})()},[]);const Ve=Ns.useMemo(()=>{const t={};return $.forEach(u=>{t[u.id]=u.type_of_work}),t},[$]),De=async()=>{try{const t=await S("/api/machine-operators");console.log("machineries",t),ye(t||[])}catch(t){console.error("Error fetching machineries:",t)}},Ye=async()=>{try{const t=await S("/api/machineLog");Ae(t||[])}catch(t){console.error("Error fetching machine logs:",t)}};a.useEffect(()=>{if(l!=null&&l.worklog_ids&&Q.length>0){const t=Q.filter(u=>l.worklog_ids.includes(u.id));Ue(t),console.log("Filtered Logs:",t)}},[l,Q]);const ve=async()=>{try{Z(!0);const t=await S(`/api/project-payments/${h}`);if(console.log(t),Ne(t),t!=null&&t.invoice_number){const u=await S(`/api/invoice-additional-charges/${t.invoice_number}`);Ge(u||[]),console.log("Additional Charges:",u)}}catch(t){console.error("Error fetching orders:",t),Y("Failed to fetch orders","danger")}finally{Z(!1)}},_e=()=>{S("/api/operatorsByCompanyIdOperator").then(t=>{console.log(t),K(t)}).catch(t=>{console.log(t.message)})};a.useEffect(()=>{ve()},[h]),a.useEffect(()=>{Ye(),_e(),De(),y()},[]);const Y=(t,u="success")=>{U({show:!0,message:t,type:u}),setTimeout(()=>U({show:!1,message:"",type:"success"}),5e3)},y=async()=>{try{const t=await S("/api/machine-price");oe(t)}catch(t){console.error("Error fetching machine price:",t)}},w=async()=>{if(f.length===0){Y("Please select at least one work order to download","warning");return}G(!0);try{await generateWorkOrdersPDF(f),Y(`PDF generated successfully for ${f.length} work order(s)`,"success"),D([])}catch(t){console.error("Error generating PDF:",t),Y("Failed to generate PDF. Please try again.","danger")}finally{G(!1)}},Ie=()=>{V(!0)},we=async()=>{var t,u,H,te,ae;if(!(!l||Object.keys(l).length===0))try{ee(!0);const p=(t=Oe())==null?void 0:t.company_info;if(!p){M("Company information not found. Please log in again.");return}const Re=Me(l.created_at),Ce={invoice_number:l.invoice_number,date:Re,customer:{name:((u=l.project)==null?void 0:u.customer_name)||"N/A",address:((H=l.project)==null?void 0:H.work_place)||"",mobile:((te=l.project)==null?void 0:te.mobile_number)||"",gst_number:((ae=l.project)==null?void 0:ae.gst_number)||""},consignee:{name:p.company_name,address:`${p.land_mark||""}, ${p.Tal||""}, ${p.Dist||""}, ${p.pincode||""}`,phone_no:p.phone_no,gst_number:p.gst_number,email_id:p.email_id},totalAmount:E,amountPaid:ue,finalAmount:E,baseTotal:j,additionalChargesTotal:A,additionalCharges:m,paymentMode:l.payment_mode,transaction_id:l.transaction_id,is_fixed_bid:l.is_fixed_bid==1,is_advance:l.is_advance==1,remark:l.remark},Ee=L.map(Pe=>({id:Pe.id,data:Pe}));await ls(Ce,Ee,B,k,I,Ee,"english","save",Ve)}catch(p){console.error("Error generating PDF:",p),M("Failed to generate PDF. Please try again.")}finally{ee(!1)}},Me=t=>t?new Date(t).toLocaleDateString("en-GB"):"",Te=t=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[t]||t;if(z)return e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})});if(!l||Object.keys(l).length===0)return e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No invoice data found."})});const A=m.reduce((t,u)=>t+Number(u.amount||0),0),he=m.reduce((t,u)=>t+Number(u.paid_amount||0),0),j=Number((l==null?void 0:l.base_total)||0),R=Number((l==null?void 0:l.paid_amount)||0),E=j+A,ue=R+he,se=E-ue,$e=se<=0;return e.jsx("div",{className:"p-4",children:e.jsxs(ze,{children:[e.jsx(Le,{className:"bg-primary text-white",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Details"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(be,{color:$e?"success":"warning",className:"fs-6 px-3 py-2 rounded-pill",children:$e?"✔️ Completed":"⏳ Pending"}),e.jsx(N,{color:"success",size:"sm",onClick:we,disabled:Se||!l,children:Se?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:We,className:"me-1"}),"Download PDF"]})})]})]})}),e.jsxs(Be,{children:[e.jsxs(X,{className:"mb-4",children:[e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Invoice Number:"}),e.jsx("div",{className:"text-muted",children:l.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Date:"}),e.jsx("div",{className:"text-muted",children:Me(l.created_at)})]})]}),e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Payment Mode:"}),e.jsx("div",{className:"text-muted",children:l.payment_mode||"-"})]}),l.transaction_id&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Transaction ID:"}),e.jsx("div",{className:"text-muted",children:l.transaction_id})]}),l.project&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Customer:"}),e.jsx("div",{className:"text-muted",children:l.project.customer_name||"-"})]})]})]}),!i&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:f.length>0&&e.jsxs("span",{className:"text-muted small",children:[f.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(N,{color:"primary",onClick:w,disabled:f.length===0||T,className:"d-flex align-items-center",size:"sm",children:T?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:We,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),f.length>0&&` (${f.length})`]})}),e.jsx(N,{color:"success",onClick:Ie,disabled:J,className:"d-flex align-items-center",size:"sm",children:J?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:_s,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),M.show&&e.jsx(ws,{color:M.type,dismissible:!0,onClose:()=>U({show:!1,message:"",type:"success"}),children:M.message}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto",overflowX:"auto",borderRadius:"6px"},children:e.jsxs(pe,{striped:!0,bordered:!0,hover:!0,className:"mb-0",children:[e.jsx(ge,{style:{position:"sticky",top:0,zIndex:2,backgroundColor:"#f8f9fa",boxShadow:"0 2px 3px rgba(0,0,0,0.05)"},children:e.jsxs(g,{children:[e.jsx(o,{children:"Sr no."}),e.jsx(o,{children:"Work Date"}),e.jsx(o,{children:"Machine"}),e.jsx(o,{children:"Mode"}),e.jsx(o,{children:"Operator"}),e.jsx(o,{children:"Work Type"}),e.jsx(o,{children:"Start Reading"}),e.jsx(o,{children:"End Reading"}),e.jsx(o,{children:"Net Reading"}),e.jsx(o,{children:"Price Per Hour"}),e.jsx(o,{className:"text-end",children:"Total Price"})]})}),e.jsxs(fe,{children:[L.length>0?L.map((t,u)=>{var H,te,ae;return e.jsxs(g,{children:[e.jsx(n,{children:u+1}),e.jsx(n,{children:(t==null?void 0:t.work_date)||"-"}),e.jsx(n,{children:((H=k.find(p=>String(p.id)===String(t==null?void 0:t.machine_id)))==null?void 0:H.machine_name)||"N/A"}),e.jsx(n,{children:((te=I.find(p=>p.id===Number(t.mode_id)))==null?void 0:te.mode)||"-"}),e.jsx(n,{children:((ae=B.find(p=>p.id===Number(t==null?void 0:t.operator_id)))==null?void 0:ae.name)||"Unknown Operator"}),e.jsx(n,{children:Ve[t==null?void 0:t.work_type_id]||"—"}),e.jsx(n,{children:(t==null?void 0:t.start_reading)||"-"}),e.jsx(n,{children:(t==null?void 0:t.end_reading)||"-"}),e.jsx(n,{children:t!=null&&t.end_reading&&(t!=null&&t.start_reading)?t.end_reading-t.start_reading:"-"}),e.jsxs(n,{children:["₹",(t==null?void 0:t.price_per_hour)||"0"]}),e.jsxs(n,{className:"text-end",children:["₹",t!=null&&t.end_reading&&(t!=null&&t.start_reading)&&(t!=null&&t.price_per_hour)?((t.end_reading-t.start_reading)*t.price_per_hour).toFixed(2):"0.00"]})]},t.id)}):e.jsx(g,{children:e.jsx(n,{colSpan:10,className:"text-center text-muted py-4",children:"No work orders found for this invoice."})}),m&&m.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(g,{style:{backgroundColor:"#f0f8ff"},children:e.jsx(n,{colSpan:11,className:"fw-bold text-primary",children:"Additional Charges"})}),m.map((t,u)=>e.jsxs(g,{style:{backgroundColor:"#f8f9fa"},children:[e.jsx(n,{children:L.length+u+1}),e.jsx(n,{children:t.date?new Date(t.date).toLocaleDateString("en-GB"):"-"}),e.jsxs(n,{colSpan:7,children:[e.jsx("strong",{children:Te(t.charge_type)}),t.remark&&e.jsxs("div",{className:"small text-muted mt-1",children:["Note: ",t.remark]})]}),e.jsx(n,{className:"text-center",children:e.jsx(be,{color:t.is_paid?"success":"warning",children:t.is_paid?"Paid":"Pending"})}),e.jsxs(n,{className:"text-end fw-bold",children:["₹",Number(t.amount).toFixed(2)]})]},`charge-${t.id}`))]}),m.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{className:"bg-light",children:[e.jsx(n,{colSpan:10,className:"text-end",children:"Work Orders Subtotal"}),e.jsxs(n,{className:"text-end",children:["₹",j.toFixed(2)]})]}),e.jsxs(g,{className:"bg-light",children:[e.jsx(n,{colSpan:10,className:"text-end",children:"Additional Charges Total"}),e.jsxs(n,{className:"text-end",children:["₹",A.toFixed(2)]})]})]}),e.jsxs(g,{className:"fw-bold bg-primary text-white",children:[e.jsx(n,{colSpan:10,className:"text-end",children:"Grand Total"}),e.jsxs(n,{className:"text-end",children:["₹",E.toFixed(2)]})]}),e.jsxs(g,{className:"bg-light",children:[e.jsx(n,{colSpan:10,className:"text-end",children:"Paid Amount"}),e.jsxs(n,{className:"text-end text-success",children:["₹",ue.toFixed(2)]})]}),e.jsxs(g,{className:"fw-bold bg-light",children:[e.jsx(n,{colSpan:10,className:"text-end",children:"Remaining Amount"}),e.jsxs(n,{className:`text-end ${se>0?"text-danger":"text-success"}`,children:["₹",se.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"mt-4 p-3 bg-light rounded",children:[e.jsxs(X,{className:"w-100",children:[e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Total Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold",children:["₹",E.toFixed(2)]})]})}),e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Paid Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold text-success",children:["₹",ue.toFixed(2)]})]})}),e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Remaining:"}),e.jsxs("span",{className:`fs-5 fw-bold ${se>0?"text-danger":"text-success"}`,children:["₹",se.toFixed(2)]})]})})]}),l.payment_mode&&e.jsx("div",{className:"mt-2 pt-2 border-top",children:e.jsxs("div",{className:"",children:[e.jsx("span",{className:"fw-bold me-2",children:"Payment Mode:"}),e.jsx(be,{color:"info",className:"fs-6",children:l.payment_mode})]})})]})]})]})})},Ss=({paymentId:h})=>{const[i,l]=a.useState(null),[Ne,z]=a.useState(!0),[Z,I]=a.useState(!1);a.useEffect(()=>{h&&oe()},[h]);const oe=async()=>{try{z(!0);const f=await S(`/api/project-payments/${h}`);l(f)}catch(f){console.error("Error fetching advance payment:",f)}finally{z(!1)}},M=f=>f?new Date(f).toLocaleDateString("en-GB"):"",U=async()=>{var f,D,T,G,J,me,B,K;if(i)try{I(!0);const _=(f=Oe())==null?void 0:f.company_info;if(!_){alert("Company information not found. Please log in again.");return}const V=M(i.created_at),k=i.is_fixed_bid==1,ye=!k,Q={invoice_number:i.invoice_number,date:V,customer:{name:((D=i.project)==null?void 0:D.customer_name)||"N/A",address:((T=i.project)==null?void 0:T.work_place)||"",mobile:((G=i.project)==null?void 0:G.mobile_number)||"",gst_number:((J=i.project)==null?void 0:J.gst_number)||""},consignee:{name:_.company_name,address:`${_.land_mark||""}, ${_.Tal||""}, ${_.Dist||""}, ${_.pincode||""}`,phone_no:_.phone_no,gst_number:_.gst_number,email_id:_.email_id},totalAmount:i.total,amountPaid:i.paid_amount,finalAmount:i.total,paymentMode:i.payment_mode||(k?"Fixed Bid":"Advance"),transaction_id:i.transaction_id,is_fixed_bid:k,is_advance:ye,remark:i.remark,name:((me=i.project)==null?void 0:me.customer_name)||"N/A",address:((B=i.project)==null?void 0:B.work_place)||"",mobile:((K=i.project)==null?void 0:K.mobile_number)||"",total:i.total};await ls(Q,[],[],[],[],[],"english","save")}catch(_){console.error("Error generating PDF:",_),alert("Failed to generate PDF. Please try again.")}finally{I(!1)}};return Ne?e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})}):i?e.jsx("div",{className:"p-4",children:e.jsxs(ze,{children:[e.jsxs(Le,{className:"bg-warning text-dark d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:i.is_fixed_bid==1?"Fixed Bid Invoice":"Advance Payment Invoice"}),e.jsx(N,{color:"success",size:"sm",onClick:U,disabled:Z||!i,children:Z?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:We,className:"me-1"}),"Download PDF"]})})]}),e.jsxs(Be,{children:[e.jsxs(X,{className:"mb-4",children:[e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Invoice Number:"})," ",e.jsx("span",{className:"text-muted",children:i.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Date:"})," ",e.jsx("span",{className:"text-muted",children:M(i.created_at)})]})]}),e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Payment Mode:"})," ",e.jsx("span",{className:"text-muted",children:i.payment_mode||(i.is_fixed_bid==1?"Fixed Bid":"Advance")})]}),i.transaction_id&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Transaction ID:"})," ",e.jsx("span",{className:"text-muted",children:i.transaction_id})]})]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(pe,{striped:!0,bordered:!0,children:[e.jsx(ge,{children:e.jsxs(g,{children:[e.jsx(o,{children:"Description"}),e.jsx(o,{className:"text-end",children:"Amount"}),e.jsx(o,{className:"text-end",children:"Remaining"})]})}),e.jsxs(fe,{children:[e.jsxs(g,{children:[e.jsxs(n,{children:[e.jsx("strong",{children:i.is_fixed_bid==1?"Fixed Bid Work":"Advance Payment"}),i.remark&&e.jsx("div",{className:"text-muted small mt-1",children:i.remark})]}),e.jsx(n,{className:"text-end",children:e.jsxs("strong",{className:"text-success",children:["₹",Number(i.total||0).toFixed(2)]})}),e.jsx(n,{className:"text-end",children:e.jsxs("strong",{className:"text-danger",children:["₹",(Number(i.total||0)-Number(i.paid_amount||0)).toFixed(2)]})})]}),e.jsxs(g,{children:[e.jsx(n,{colSpan:2,children:e.jsx("strong",{children:"Total Paid Amount"})}),e.jsx(n,{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["₹",Number(i.paid_amount||0).toFixed(2)]})})]})]})]})}),e.jsx("div",{className:"mt-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Payment Mode:"}),e.jsx("span",{className:"badge bg-info fs-6 ms-2",children:i.payment_mode||(i.is_fixed_bid==1?"Fixed Bid":"Advance")})]})}),i.project&&e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Cust. Name :"}),e.jsx("span",{className:"text-muted ms-2",children:i.project.customer_name||"-"})]})})]})})]})]})}):e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No payment data found."})})},Ds=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-eye",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}),e.jsx("path",{d:"M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"})]}),tt=()=>{var ss,ts;const{showToast:h}=ys(),i=(ss=Oe())==null?void 0:ss.company_id;if(!i)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[l,Ne]=a.useState([]),[z,Z]=a.useState(""),[I,oe]=a.useState(""),[M,U]=a.useState(""),[f,D]=a.useState(!1),[T,G]=a.useState(null),[J,me]=a.useState(!1),[B,K]=a.useState(null),[_,V]=a.useState(!1);a.useState("");const[k,ye]=a.useState(null),[Q,Ae]=a.useState(!1),[L,Ue]=a.useState([]),[Se,ee]=a.useState(!1),[m,Ge]=a.useState(null),[$,xe]=a.useState(""),[Ve,De]=a.useState(""),[Ye,ve]=a.useState(!1),[_e,Y]=a.useState(""),[y,w]=a.useState(""),[Ie,we]=a.useState([]);a.useState(!1);const[Me,Te]=a.useState(!1),[A,he]=a.useState(""),[j,R]=a.useState(!1);a.useState(""),a.useState([]);const[E,ue]=a.useState([]),[se,$e]=a.useState(!1),[t,u]=a.useState(null),H=async()=>{D(!0);try{const s=await S(`/api/project-payments?company_id=${i}`);Ne(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{D(!1)}},te=async()=>{D(!0);try{const s=await S("/api/project-wise-hours");ue(s.project_wise_hours||[]),console.log("machine hourse",s.project_wise_hours)}catch(s){h("danger","Error fetching Hours: "+((s==null?void 0:s.message)||s))}finally{D(!1)}},ae=async()=>{try{const s=await S("/api/projects");if(!Array.isArray(s)){we([]);return}const r={};s.forEach(c=>{var x;if(c.company_id!==i)return;const d=(x=c.customer_name)==null?void 0:x.trim();d&&(r[d]||(r[d]={name:d,mobile:c.mobile_number||"",projects:[]}),r[d].projects.push({id:c.id,company_id:c.company_id}))}),we(Object.values(r))}catch(s){console.error(s),we([])}},p=async()=>{if(k){D(!0);try{const s=await S(`/api/repayments?company_id=${i}&project_id=${k}`);Ue(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching history: "+((s==null?void 0:s.message)||s))}finally{D(!1)}}};a.useEffect(()=>{H(),ae(),te()},[i]),a.useEffect(()=>{k&&p()},[k,i]);const Re=s=>s?new Date(s).toLocaleDateString("en-GB"):"",Ce=s=>`₹${Number(s||0).toFixed(2)}`,Ee=s=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[s]||s,Pe=a.useMemo(()=>l.filter(s=>s.company_id===i),[l,i]),ds=a.useMemo(()=>{const s={};return E.forEach(r=>{s[Number(r.project_id)]=Number(r.total_hours||0)}),s},[E]),os=a.useMemo(()=>E.reduce((s,r)=>s+Number(r.total_hours||0),0),[E]),ms=s=>[...new Set(s.map(c=>{var d;return(d=c.project)==null?void 0:d.id}).filter(Boolean))].reduce((c,d)=>c+(ds[d]||0),0),He=a.useMemo(()=>{const s={};if(Pe.forEach(r=>{var d;const c=((d=r.project)==null?void 0:d.customer_name)||"Unknown";s[c]||(s[c]=[]),s[c].push(r)}),I){const r=I.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([c])=>c.toLowerCase().includes(r)))}return s},[Pe,I]),Fe=a.useMemo(()=>{const s=Object.values(He),r=s.flat(),c=r.filter(P=>!P.is_advance),d=s.length,x=r.length,v=c.reduce((P,W)=>P+Number(W.total||0),0),q=c.reduce((P,W)=>P+Number(W.paid_amount||0),0),je=v-q;return{customerCount:d,totalInvoices:x,totalBilled:v,totalPaid:q,totalOutstanding:je}},[He]);if(f&&!l.length)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(le,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading project payments..."})]});const xs=async()=>{if(!m)return;const s=Number($)||0,r=j&&Number(y)||0,c=s+r,d=Number(m.total)-Number(m.paid_amount);if(c<=0)return h("danger","Total payment must be greater than 0");if(c>d+.01)return h("danger","Total amount exceeds remaining balance");if(j&&r>C)return h("danger","Advance amount exceeds available balance");try{const x={company_id:i,project_id:m.project_id,invoice_id:m.invoice_number,payment:s,advance_used:r,payment_mode:"Cash"};await Je("/api/repayments",x),h("success","Payment recorded successfully"),ee(!1),xe(""),De(""),w(""),R(!1),H(),k&&p()}catch(x){console.error("Payment update error:",x),h("danger","Failed to update payment: "+((x==null?void 0:x.message)||x))}};if(!T)return e.jsxs(e.Fragment,{children:[e.jsx(X,{children:e.jsx(b,{xs:12,children:e.jsxs(ze,{className:"shadow-sm",children:[e.jsx(Le,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Customers Payment Report"}),e.jsxs(be,{color:"info",className:"ms-2",children:[Fe.customerCount," customers"]})]})}),e.jsxs(Be,{children:[e.jsxs(X,{className:"mb-2",children:[e.jsx(b,{xs:12,md:6,children:e.jsxs(Cs,{children:[e.jsx(Ps,{children:"Search"}),e.jsx(ke,{placeholder:"Search by customer name...",value:M,onChange:s=>{U(s.target.value),oe(s.target.value)}})]})}),I&&e.jsx(b,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(N,{color:"light",size:"sm",onClick:()=>{U(""),oe("")},children:"Clear"})})]}),e.jsxs(X,{className:"g-2 mb-3",children:[e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:Fe.totalInvoices})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsxs("small",{className:"d-block",children:["Total Billed (",os,"hrs.)"]}),e.jsx("strong",{className:"fs-6",children:Ce(Fe.totalBilled)})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:Ce(Fe.totalPaid)})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:Ce(Fe.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(pe,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(ge,{children:e.jsxs(g,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(o,{className:"text-center align-middle",children:"Hours"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(fe,{children:Object.entries(He).map(([s,r],c)=>{const d=r.filter(P=>!P.is_advance),x=d.reduce((P,W)=>P+Number(W.total||0),0),v=d.reduce((P,W)=>P+Number(W.paid_amount||0),0),q=x-v,je=ms(r);return e.jsxs(g,{children:[e.jsx(n,{children:c+1}),e.jsx(n,{children:s}),e.jsx(n,{style:{color:je<0?"red":"blue",fontWeight:600},children:je}),e.jsxs(n,{className:"text-end",children:["₹",x.toFixed(2)]}),e.jsxs(n,{className:"text-success fw-bold text-end",children:["₹",v.toFixed(2)]}),e.jsxs(n,{className:"text-danger fw-bold text-end",children:["₹",q.toFixed(2)]}),e.jsx(n,{className:"text-center",children:e.jsx(N,{size:"sm",color:"info",onClick:()=>{G(s),ye(r[0].project_id)},children:"View Invoices"})})]},s)})})]})})]})]})})}),e.jsxs(ne,{visible:Ye,onClose:()=>{ve(!1),Y(""),w("")},children:[e.jsx(re,{children:e.jsx(ie,{children:"Advance Payment"})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Customer"}),e.jsxs("select",{className:"form-select",value:_e,onChange:s=>Y(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select --"}),Ie.map(s=>e.jsxs("option",{value:s.name,children:[s.name," ",s.mobile?`(${s.mobile})`:""]},s.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(ke,{type:"number",placeholder:"Enter amount",value:y,onChange:s=>w(s.target.value),min:"0"})]})]}),e.jsxs(Ke,{children:[e.jsx(N,{color:"secondary",onClick:()=>ve(!1),children:"Cancel"}),e.jsx(N,{color:"primary",onClick:async()=>{var x;if(!_e)return h("danger","Select a customer");const s=Number(y);if(!s||s<=0)return h("danger","Enter a valid amount");const r=Ie.find(v=>v.name===_e);if(!((x=r==null?void 0:r.projects)!=null&&x.length))return h("danger","No project for this customer");const{id:c,company_id:d}=r.projects[0];try{await Je("/api/advance-payment",{company_id:d,project_id:c,amount:s}),h("success","Advance payment recorded"),ve(!1),Y(""),w(""),H()}catch(v){h("danger","Failed: "+((v==null?void 0:v.message)||"Unknown error"))}},children:"Submit"})]})]})]});const qe=He[T]||[],es=qe.filter(s=>!s.is_advance),Xe=es.reduce((s,r)=>s+Number(r.total||0),0),Ze=es.reduce((s,r)=>s+Number(r.paid_amount||0),0),O=Xe-Ze,C=(L||[]).filter(s=>s.is_advance&&!s.advance_taken).reduce((s,r)=>s+Number(r.payment||0),0),hs=async()=>{const s=Number(A)||0,r=j&&Number(y)||0,c=s+r;if(c<=0)return h("danger","Total payment must be greater than 0");if(c>O)return h("danger","Total amount exceeds remaining balance");if(j&&r>C)return h("danger","Advance amount exceeds available balance");try{await Je("/api/repayments",{company_id:i,project_id:k,invoice_id:null,payment:s,advance_used:r}),h("success","Payment recorded successfully"),V(!1),he(""),w(""),R(!1),H(),p()}catch(d){console.error("Repayment error:",d),h("danger","Error: "+((d==null?void 0:d.message)||d))}},us=async()=>{var ns,rs,is,cs;const s=l.find(F=>F.invoice_number===z);if(!s)return;const r=L.filter(F=>(F==null?void 0:F.invoice_id)===z);if(r.length===0){h("warning","No history to download");return}const c=(ns=Oe())==null?void 0:ns.company_info;if(!c){alert("Company information not found. Please log in again.");return}const d=((rs=s.project)==null?void 0:rs.customer_name)||"N/A",x=s.is_fixed_bid==1?"FIXED BID INVOICE":"INVOICE",v=Number(s.total||0).toFixed(2),q=Number(s.paid_amount||0).toFixed(2),je=(Number(s.total)-Number(s.paid_amount)).toFixed(2);let P=0;const W=Number(s.total||0),js=r.map((F,fs)=>{P+=Number(F.payment||0);const bs=W-P;return`
            <tr>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${fs+1}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    ${F!=null&&F.date?F.date.slice(0,10).split("-").reverse().join("-"):"-"}
                </td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(F.payment).toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${bs.toFixed(2)}</td>
            </tr>
        `}).join(""),ps=`
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <!-- Header Section -->
            <div style="border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        ${c.logo?`<img src="/img/${c.logo}" alt="Logo" style="max-width: 120px; height: auto;" />`:""}
                    </div>
                    <div style="text-align: right; flex: 1;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">${c.company_name||""}</h2>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${c.land_mark||""}, ${c.Tal||""}, ${c.Dist||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Pincode: ${c.pincode||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Phone: ${c.phone_no||""}</p>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div style="text-align: center; background-color: #0d6efd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <h2 style="margin: 0; color: #fff; font-size: 20px;">PAYMENT HISTORY - ${x}</h2>
            </div>

            <!-- Invoice & Customer Details -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Invoice Details</h3>
                    <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${s.invoice_number}</p>
                    <p style="margin: 5px 0;"><strong>Date:</strong> ${Re(s.created_at)}</p>
                    <p style="margin: 5px 0;"><strong>Total Amount:</strong> ₹${v}</p>
                    <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ₹${q}</p>
                    <p style="margin: 5px 0;"><strong>Remaining:</strong> ₹${je}</p>
                </div>
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Customer Details</h3>
                    <p style="margin: 5px 0;"><strong>Customer Name:</strong> ${d}</p>
                    <p style="margin: 5px 0;"><strong>Mobile:</strong> ${((is=s.project)==null?void 0:is.mobile_number)||"-"}</p>
                    <p style="margin: 5px 0;"><strong>Site:</strong> ${((cs=s.project)==null?void 0:cs.work_place)||"-"}</p>
                </div>
            </div>

            <!-- History Table -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Sr. No.</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Date</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Paid Amount</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    ${js}
                </tbody>
            </table>

            <!-- Footer -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 12px;">
                <p>This is a computer-generated document and is valid without signature.</p>
            </div>
        </div>
    `,as=document.createElement("div");as.innerHTML=ps;const gs={margin:[10,10,10,10],filename:`History-${s.invoice_number}-${d}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};try{await vs().set(gs).from(as).save(),h("success","History PDF downloaded successfully")}catch(F){console.error("PDF generation error:",F),h("danger","Failed to generate PDF")}};return e.jsxs(e.Fragment,{children:[e.jsx(X,{children:e.jsx(b,{xs:12,children:e.jsxs(ze,{className:"shadow-sm",children:[e.jsxs(Le,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"fs-5",children:["Invoices for ",T]}),e.jsxs(be,{color:"info",className:"ms-2",children:[qe.length," entries"]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(N,{color:"success",onClick:()=>{V(!0);const s=C>0&&C<=O;R(s),he("")},children:"Record Payment"}),e.jsx(N,{color:"secondary",size:"sm",onClick:()=>G(null),children:"Back"})]})]}),e.jsxs(Be,{children:[e.jsxs(X,{className:"g-2 mb-2",children:[e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-primary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Total"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Xe.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-success text-center text-white shadow-sm",children:[e.jsx("small",{children:"Paid"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Ze.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-danger text-center text-white shadow-sm",children:[e.jsx("small",{children:"Remaining"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",O.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-secondary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Advance"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",C.toFixed(2)]})]})})]}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"500px",overflowY:"auto"},children:e.jsxs(pe,{hover:!0,bordered:!0,children:[e.jsx(ge,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa"},children:e.jsxs(g,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Invoice"}),e.jsx(o,{className:"text-center align-middle",children:"Date"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Mode"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(fe,{children:qe.sort((s,r)=>new Date(r.created_at)-new Date(s.created_at)).map((s,r)=>{const c=(Number(s.total)-Number(s.paid_amount)).toFixed(2);return e.jsxs(g,{className:s.is_advance==1?"table-primary":s.is_fixed_bid==1?"table-warning":"",children:[e.jsx(n,{children:r+1}),e.jsx(n,{children:s.is_advance==1?"Advance Payment":s.invoice_number}),e.jsx(n,{className:"text-center align-middle",children:Re(s.created_at)}),e.jsxs(n,{className:"text-end fw-bold",children:["₹",Number(s.total).toFixed(2)]}),e.jsxs(n,{className:"text-success fw-bold text-end",children:["₹",Number(s.paid_amount).toFixed(2)]}),e.jsxs(n,{className:"text-danger fw-bold text-end",children:["₹",c]}),e.jsx(n,{children:s.payment_mode||"-"}),e.jsx(n,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-1",children:[s.is_advance==0&&e.jsx(Qe,{content:"Add Payment",placement:"top",children:e.jsx(N,{color:"success",size:"sm",onClick:()=>{Ge(s),ee(!0)},children:e.jsx(de,{icon:Fs})})}),s.is_advance==0&&e.jsx(Qe,{content:"Payment History",placement:"top",children:e.jsx(N,{color:"info",size:"sm",onClick:()=>{Z(s.invoice_number),Ae(!0)},children:e.jsx(de,{icon:ks})})}),e.jsx(Qe,{content:s.is_advance==1?"View Advance Invoice":s.is_fixed_bid==1?"View Fixed Bid Invoice":"View Invoice",placement:"top",children:e.jsx(N,{color:s.is_advance==1||s.is_fixed_bid==1?"warning":"secondary",size:"sm",onClick:()=>{s.is_advance==1||s.is_fixed_bid==1?(K(s.id),Te(!0)):(K(s.id),me(!0))},children:e.jsx(Ds,{})})})]})})]},s.id)})})]})})]})]})})}),e.jsxs(ne,{visible:Me,onClose:()=>Te(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:((ts=l.find(s=>s.id===B))==null?void 0:ts.is_fixed_bid)==1?"Fixed Bid Invoice":"Advance Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(Ss,{paymentId:B})})]}),e.jsxs(ne,{visible:_,onClose:()=>V(!1),children:[e.jsx(re,{children:e.jsxs(ie,{children:["Add Repayment - ",T]})}),e.jsxs(ce,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total :"})," ₹",Xe.toFixed(2)]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Advance Paid:"})," ",e.jsxs("span",{className:"text-success",children:["₹",C.toFixed(2)]})]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Paid :"})," ",e.jsxs("span",{className:"text-success",children:["₹",Ze.toFixed(2)]})]}),e.jsxs("p",{className:"mb-3",children:[e.jsx("strong",{children:"Remaining :"})," ",e.jsxs("span",{className:"text-danger",children:["₹",O.toFixed(2)]})]}),e.jsx("hr",{}),O>0?e.jsxs(e.Fragment,{children:[C>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheck",checked:j,onChange:s=>{R(s.target.checked),s.target.checked}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheck",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("label",{className:"form-label small",children:["Advance to Use (Max: ₹",Math.min(O,C).toFixed(2),")"]}),e.jsx(ke,{type:"number",placeholder:"Enter advance amount",value:y,onChange:s=>{parseFloat(s.target.value),w(s.target.value)},onBlur:s=>{let r=parseFloat(s.target.value)||0;const c=Math.min(O,C);r>c&&w(c)},min:"0",max:Math.min(O,C)})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Amount (Cash/Online)"}),e.jsx(ke,{type:"number",placeholder:"Enter amount to pay",value:A,onChange:s=>he(s.target.value),min:"0"}),Number(A)===0&&A!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-3 text-end",children:[e.jsxs("div",{children:[e.jsx("small",{children:"Advance Used:"})," ₹",Number(j?y:0).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("small",{children:"Cash/Online:"})," ₹",Number(A||0).toFixed(2)]}),e.jsxs("div",{className:"fw-bold fs-5 mt-1 text-primary",children:["Total Payment: ₹",((j?Number(y):0)+(Number(A)||0)).toFixed(2)]}),(j?Number(y):0)+(Number(A)||0)>O&&e.jsx("div",{className:"text-danger small mt-1",children:"Total exceeds remaining balance!"})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]}),e.jsxs(Ke,{children:[e.jsx(N,{color:"secondary",onClick:()=>{V(!1),R(!1),he(""),w("")},children:"Cancel"}),e.jsx(N,{color:"primary",onClick:hs,disabled:O<=0||(Number(A)||0)+(j&&Number(y)||0)<=0,children:"Submit"})]})]}),e.jsxs(ne,{visible:Q,onClose:()=>Ae(!1),size:"lg",children:[e.jsx(re,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx(ie,{children:"Payment History"}),e.jsxs(N,{color:"success",size:"sm",className:"me-4",onClick:us,title:"Download History PDF",children:[e.jsx(de,{icon:We,className:"me-1"}),"Download PDF"]})]})}),e.jsx(ce,{children:L.filter(s=>(s==null?void 0:s.invoice_id)===z).length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(pe,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(ge,{color:"dark",children:e.jsxs(g,{children:[e.jsx(o,{children:"Date"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Remaining"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(fe,{children:(()=>{var d;const s=L.filter(x=>(x==null?void 0:x.invoice_id)===z),r=((d=s[0])==null?void 0:d.total)||0;let c=0;return s.map((x,v)=>{c+=Number(x.payment||0);const q=Number(r)-c;return e.jsxs(g,{children:[e.jsx(n,{children:x!=null&&x.date?x.date.slice(0,10).split("-").reverse().join("-"):""}),e.jsxs(n,{children:["₹",x.payment]}),e.jsxs(n,{children:["₹",q.toFixed(2)]}),e.jsx(n,{children:x.remark})]},v)})})()})]})}):e.jsx("div",{className:"text-center py-4 text-muted",children:e.jsx("p",{className:"mb-0",children:"No payment history found for this invoice."})})})]}),e.jsxs(ne,{visible:Se,onClose:()=>{ee(!1),xe(""),w(""),R(!1),De("")},children:[e.jsx(re,{closeButton:!0,children:e.jsx(ie,{children:"Make Payment"})}),e.jsx(ce,{children:m&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice:"})," ",m.invoice_number]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Total:"}),e.jsxs("strong",{children:["₹",Number(m.total).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Paid:"}),e.jsxs("span",{className:"text-success",children:["₹",Number(m.paid_amount).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Remaining:"}),e.jsxs("span",{className:"text-danger",children:["₹",(Number(m.total)-Number(m.paid_amount)).toFixed(2)]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"d-flex justify-content-between mb-3",children:[e.jsx("span",{children:"Available Advance:"}),e.jsxs("span",{className:"text-primary fw-bold",children:["₹",C.toFixed(2)]})]}),Number(m.total)-Number(m.paid_amount)>0?e.jsxs(e.Fragment,{children:[C>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheckInvoice",checked:j,onChange:s=>{R(s.target.checked)}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheckInvoice",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label small",children:"Advance to Use"}),e.jsx(ke,{type:"number",placeholder:"Enter advance amount",value:y,onChange:s=>{Number(m.total)-Number(m.paid_amount),parseFloat(s.target.value),w(s.target.value)},onBlur:s=>{const r=Number(m.total)-Number(m.paid_amount);let c=parseFloat(s.target.value)||0;const d=Math.min(r,C);c>d&&w(d)},min:"0"}),e.jsxs("small",{className:"text-muted",children:["Max: ₹",Math.min(Number(m.total)-Number(m.paid_amount),C).toFixed(2)]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label fw-semibold",children:"Amount (Cash/Online)"}),e.jsx("input",{type:"number",className:"form-control",value:$,onChange:s=>xe(s.target.value),min:"0",placeholder:"Enter amount"}),Number($)===0&&$!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-2 text-end",children:[e.jsx("strong",{children:"Total Payment: "}),e.jsxs("span",{className:(j?Number(y):0)+(Number($)||0)>Number(m.total)-Number(m.paid_amount)?"text-danger":"text-success",children:["₹",((j?Number(y):0)+(Number($)||0)).toFixed(2)]})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]})}),e.jsxs(Ke,{children:[e.jsx(N,{color:"secondary",onClick:()=>{ee(!1),R(!1),xe(""),w("")},children:"Cancel"}),e.jsx(N,{color:"success",disabled:!m||Number(m.total)-Number(m.paid_amount)<=0||(Number($)||0)+(j&&Number(y)||0)<=0,onClick:xs,children:"Confirm"})]})]}),e.jsxs(ne,{visible:J,onClose:()=>me(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:"Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(As,{projectId:B,inModal:!0})})]}),e.jsxs(ne,{visible:se,onClose:()=>{$e(!1),u(null)},size:"lg",children:[e.jsx(re,{children:e.jsxs(ie,{children:["Additional Charges - ",t==null?void 0:t.invoice_number]})}),e.jsx(ce,{children:t!=null&&t.additionalCharges&&t.additionalCharges.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(pe,{striped:!0,bordered:!0,children:[e.jsx(ge,{children:e.jsxs(g,{children:[e.jsx(o,{children:"Charge Type"}),e.jsx(o,{children:"Amount"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(fe,{children:t.additionalCharges.map((s,r)=>e.jsxs(g,{children:[e.jsx(n,{children:Ee(s.charge_type)}),e.jsxs(n,{className:"text-end",children:["₹",Number(s.amount).toFixed(2)]}),e.jsxs(n,{className:"text-end text-success fw-bold",children:["₹",Number(s.paid_amount||0).toFixed(2)]}),e.jsx(n,{children:e.jsx(be,{color:s.is_paid?"success":"warning",children:s.is_paid?"Paid":"Pending"})}),e.jsx(n,{children:s.remark||"-"})]},s.id))})]})}):e.jsx("p",{className:"text-muted text-center",children:"No additional charges"})})]})]})};export{tt as default};

import{c as le,r as i,b as de,u as he,j as e}from"./index-BGxqQxQJ.js";import{g as L}from"./InvoiceMulPdf-CvoDDLi7.js";import{g as me,a as v,c as xe}from"./api-BUyL__Lx.js";import{C as pe,a as ue}from"./CCardBody-D-98gfs-.js";import{C as je}from"./CCardHeader-DrFBPpLI.js";import{C as ge,d as j}from"./index.esm-C022RvEN.js";import{C as fe}from"./CFormSelect-H31wP_hu.js";import"./jspdf.es.min-kqEr2Fax.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./CFormControlWrapper-BLBktZ5v.js";import"./CFormControlValidation-C-pgsv8A.js";import"./CFormLabel-D2dR9F1X.js";const Ie=()=>{var D;const s=(D=me())==null?void 0:D.company_info,{id:b}=le(),[B,ye]=i.useState(0);i.useRef(null),i.useState(null);const[N,O]=i.useState("english"),[be,Q]=i.useState(""),[ve,G]=i.useState(0),{showToast:x}=de(),H=he(),[u,z]=i.useState([]),[Ne,S]=i.useState([]),[w,J]=i.useState([]),[_,V]=i.useState([]),[g,A]=i.useState([]),[l,X]=i.useState(null),[Z,E]=i.useState(!0),[P,q]=i.useState(null),[f,k]=i.useState(!1),[n,T]=i.useState({project_name:"",gst_number:"",customer:{name:"",address:"",mobile:""},date:"",items:[],selectedMachines:[],discount:0,amountPaid:0,paymentMode:"Cash",invoiceStatus:"",finalAmount:0,totalAmount:0,invoice_number:"",status:"",deliveryDate:"",invoiceType:""}),K=async()=>{try{const t=await v("/api/machine-operators");console.log("machineries",t),z(t||[])}catch(t){console.error("Error fetching machineries:",t),x("danger","Error fetching machineries")}},Y=async()=>{try{const t=await v("/api/operatorsByCompanyIdOperator");J(t||[])}catch(t){console.error("Error fetching operators:",t),x("danger","Error fetching operators")}},ee=async()=>{try{const t=await v("/api/machine-price");console.log("prices",t),V(t||[])}catch(t){console.error("Error fetching machine prices:",t),x("danger","Error fetching machine prices")}},F=async()=>{E(!0);try{const t=await v(`/api/project-payments/${b}`);if(!t)throw new Error("No data returned from server");console.log("payment response",t),X(t),T(r=>{var a,o,h,m,d;return{...r,amountPaid:t.paid_amount||0,paymentMode:t.payment_mode||"Cash",invoice_number:t.invoice_number||"N/A",project_name:((a=t.project)==null?void 0:a.project_name)||"N/A",gst_number:((o=t.project)==null?void 0:o.gst_number)||"N/A",customer:{name:((h=t.project)==null?void 0:h.customer_name)||"N/A",address:((m=t.project)==null?void 0:m.work_place)||"N/A",mobile:((d=t.project)==null?void 0:d.mobile_number)||"N/A"},date:t.created_at?t.created_at.slice(0,10).split("-").reverse().join("-"):""}}),G(t.total||0),Q(se(t.total||0)),x("success","Payment data loaded successfully")}catch(t){console.error("Error fetching payment data:",t),q("Failed to load payment data"),x("danger","Failed to load payment data")}finally{E(!1)}},te=async()=>{if(!(l!=null&&l.worklog_ids)||l.worklog_ids.length===0){A([]);return}try{const t=await Promise.all(l.worklog_ids.map(async r=>{const a=await fetch(`/api/machine-logs/${r}`);if(!a.ok)throw new Error(`Failed to fetch log with id ${r}`);return await a.json()}));console.log("machine logs",t),A(t)}catch(t){console.error("Error fetching machine logs:",t),x("danger","Error fetching machine logs")}};i.useEffect(()=>{K(),Y(),ee(),F()},[b]),i.useEffect(()=>{te()},[l==null?void 0:l.worklog_ids]),i.useEffect(()=>{if(n.selectedMachines.length>0&&u.length>0){const t=u.filter(r=>n.selectedMachines.includes(r.id));S(t),console.log("Filtered machines:",t)}else S([])},[n.selectedMachines,u]);const se=t=>{if(t===0)return"Zero";const r=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"],a=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],o=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"],h=c=>{let p="";return c>=100&&(p+=r[Math.floor(c/100)]+" Hundred ",c%=100),c>=20?(p+=o[Math.floor(c/10)],c%10>0&&(p+=" "+r[c%10])):c>=10?p+=a[c-10]:c>0&&(p+=r[c]),p.trim()};let m="",d=Math.floor(t);if(d>=1e7){const c=Math.floor(d/1e7);m+=h(c)+" Crore ",d%=1e7}if(d>=1e5){const c=Math.floor(d/1e5);m+=h(c)+" Lakh ",d%=1e5}if(d>=1e3){const c=Math.floor(d/1e3);m+=h(c)+" Thousand ",d%=1e3}return d>0&&(m+=h(d)),m.trim()+" Rupees Only"},M=t=>{const{name:r,value:a}=t.target;T(o=>({...o,[r]:a}))},ne=async()=>{try{k(!1);const t={paid_amount:n.amountPaid,payment_mode:n.paymentMode||"Cash"},r=await fetch(`/api/project-payments/${b}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error("Failed to update payment");const a=await r.json();console.log("Payment updated:",a),x("success","Invoice saved successfully"),F()}catch(t){console.error("Error updating payment:",t),x("error","Failed to save invoice")}},re=()=>{H(`/edit-order/${b}`)},ae=()=>{window.print()},oe=async()=>{try{const t=await L(n,g,w,u,_,[],N,"blob"),r=new FormData;r.append("file",t,`${n.invoice_number}_${n.customer.name}.pdf`);const o=(await xe("/api/upload",r)).fileUrl,h=encodeURIComponent(`*Invoice from ${(s==null?void 0:s.company_name)||"Company"}*

      Project: ${n.project_name}
      Invoice Number: ${n.invoice_number}
      Total Amount: ₹${n.finalAmount}
      Amount Paid: ₹${n.amountPaid}
      Remaining: ₹${B}

      View Invoice: ${o}

      Thank you!`),m=`https://wa.me/${n.customer.mobile}?text=${h}`;window.open(m,"_blank")}catch(t){x("danger","Error sharing on WhatsApp: "+t.message)}},ce=async t=>{try{const r=await L(n,g,w,u,_,[],t,"blob");if(r){const a=URL.createObjectURL(r),o=document.createElement("a");o.href=a,o.download=`${n.invoice_number}-${n.customer.name}.pdf`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),x("success","PDF downloaded successfully!")}else throw new Error("Failed to generate PDF Blob")}catch(r){console.error("Error generating/downloading PDF:",r),x("danger","Error downloading PDF: "+r.message)}},ie=t=>{if(!t||u.length===0)return"N/A";const r=u.find(a=>String(a.id)===String(t));return(r==null?void 0:r.machine_name)||"N/A"};return Z?e.jsx("div",{className:"min-h-screen bg-gray-100 p-4 flex items-center justify-center",children:e.jsx("div",{children:"Loading..."})}):P?e.jsx("div",{className:"min-h-screen bg-gray-100 p-4 flex items-center justify-center",children:e.jsx("div",{className:"text-red-600",children:P})}):e.jsxs(pe,{style:{maxWidth:"1200px",margin:"0 auto"},children:[e.jsx(je,{children:e.jsxs("h5",{children:["Invoice #",n.invoice_number]})}),e.jsx(ue,{children:e.jsxs(ge,{fluid:!0,children:[e.jsxs("div",{className:"row section",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Customer Name:"})," ",n.customer.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Customer Address:"})," ",n.customer.address]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Mobile Number:"})," ",n.customer.mobile]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice Number:"})," ",n.invoice_number]}),n.gst_number&&e.jsxs("p",{children:[e.jsx("strong",{children:"GST Number:"})," ",n.gst_number]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice Date:"})," ",n.date]})]})]}),g.length>0&&e.jsx("div",{className:"section",style:{marginTop:"2rem"},children:e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{className:"table table-bordered",style:{width:"100%",borderCollapse:"collapse",border:"1px solid #ccc"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#f4f4f4"},children:[e.jsx("th",{style:{width:"60px",border:"1px solid #ccc"},children:"Sr No"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Work Date"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Machine"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Operator"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Start Reading"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"End Reading"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Net Reading"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Mode"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Price Per Hour"}),e.jsx("th",{style:{border:"1px solid #ccc"},children:"Total Price"})]})}),e.jsxs("tbody",{children:[g.map((t,r)=>{var h,m,d,c,p,R,I,$,U,W;const a=(((h=t.data)==null?void 0:h.end_reading)||0)-(((m=t.data)==null?void 0:m.start_reading)||0),o=a*(((d=t.data)==null?void 0:d.price_per_hour)||0);return e.jsxs("tr",{children:[e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:r+1}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:(c=t.data)==null?void 0:c.work_date}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:ie((p=t.data)==null?void 0:p.machine_id)}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:((R=w.find(C=>{var y;return String(C.id)===String((y=t.data)==null?void 0:y.operator_id)}))==null?void 0:R.name)||"Unknown"}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:(I=t.data)==null?void 0:I.start_reading}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:($=t.data)==null?void 0:$.end_reading}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:a}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:((U=_.find(C=>{var y;return C.id===((y=t.data)==null?void 0:y.mode_id)}))==null?void 0:U.mode)||"Unknown"}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:(W=t.data)==null?void 0:W.price_per_hour}),e.jsx("td",{style:{textAlign:"center",border:"1px solid #ccc"},children:o})]},t.id)}),(()=>{const t=g.reduce((r,a)=>{var o,h;return r+((((o=a.data)==null?void 0:o.end_reading)||0)-(((h=a.data)==null?void 0:h.start_reading)||0))},0);return e.jsxs("tr",{className:"table-secondary",style:{fontWeight:"bold",background:"#f9f9f9",borderTop:"2px solid #999"},children:[e.jsx("td",{colSpan:"6",style:{textAlign:"right",border:"1px solid #ccc"},children:"Grand Total:"}),e.jsx("td",{style:{border:"1px solid #ccc"},children:t}),e.jsx("td",{style:{border:"1px solid #ccc"}}),e.jsx("td",{style:{border:"1px solid #ccc"}}),e.jsx("td",{style:{border:"1px solid #ccc"},children:l==null?void 0:l.total})]})})()]})]})})}),n.discount>0&&e.jsx("div",{className:"row section",children:e.jsx("div",{className:"col-md-12",children:e.jsx("table",{className:"table table-bordered border-black",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Total Amount:"}),e.jsxs("td",{className:"text-center",children:["₹",n.totalAmount]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Discount:"}),e.jsxs("td",{className:"text-center",children:["₹",n.discount]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Final Amount:"}),e.jsxs("td",{className:"text-center",children:["₹",n.finalAmount]})]})]})})})}),e.jsx("div",{className:"row section",children:e.jsx("div",{className:"col-md-12",children:e.jsx("table",{className:"table table-bordered border-black",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Total Amount:"}),e.jsxs("td",{children:["₹",l==null?void 0:l.total]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Amount Paid:"}),e.jsx("td",{children:f?e.jsx("input",{type:"number",name:"amountPaid",value:n.amountPaid,onChange:M,className:"form-control",style:{maxWidth:"150px"}}):`₹${n.amountPaid}`})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Balance Amount:"}),e.jsxs("td",{children:["₹",(l==null?void 0:l.total)-n.amountPaid]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Payment Mode:"}),e.jsx("td",{children:f?e.jsxs("select",{name:"paymentMode",value:n.paymentMode,onChange:M,className:"form-control",style:{maxWidth:"150px"},children:[e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"Credit Card",children:"Credit Card"}),e.jsx("option",{value:"Debit Card",children:"Debit Card"}),e.jsx("option",{value:"UPI",children:"UPI"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"})]}):n.paymentMode})]})]})})})}),e.jsxs("div",{className:"d-flex flex-column flex-md-row border p-3 border-black",children:[((s==null?void 0:s.bank_name)||(s==null?void 0:s.account_no)||(s==null?void 0:s.IFSC_code))&&e.jsx("div",{className:"flex-fill mb-3 mb-md-0",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("h6",{children:"Bank Details"}),(s==null?void 0:s.bank_name)&&e.jsx("p",{className:"mb-1",children:s.bank_name}),(s==null?void 0:s.account_no)&&e.jsxs("p",{className:"mb-1",children:["Account No: ",s.account_no]}),(s==null?void 0:s.IFSC_code)&&e.jsxs("p",{className:"mb-0",children:["IFSC code: ",s.IFSC_code]})]})}),(s==null?void 0:s.paymentQRCode)&&e.jsx("div",{className:"flex-fill mb-3 mb-md-0",children:e.jsxs("div",{className:"d-flex flex-column align-items-center text-center",children:[e.jsx("h6",{children:"QR CODE"}),e.jsx("img",{height:"120",width:"120",src:"img/"+s.paymentQRCode,alt:"QR Code",className:"img-fluid",style:{maxWidth:"120px",height:"auto"}}),e.jsx("p",{className:"mb-0 mt-2",children:"Scan to Pay"})]})}),(s==null?void 0:s.sign)&&e.jsx("div",{className:"flex-fill",children:e.jsxs("div",{className:"d-flex flex-column align-items-center text-center",children:[e.jsx("h6",{children:"E-SIGNATURE"}),e.jsx("img",{height:"25",width:"100",src:"img/"+s.sign,alt:"signature",className:"img-fluid",style:{maxWidth:"200px",height:"auto"}}),e.jsx("p",{className:"mb-0 mt-2",children:"Authorized Signature"})]})}),!(s!=null&&s.bank_name||s!=null&&s.account_no||s!=null&&s.IFSC_code||s!=null&&s.paymentQRCode||s!=null&&s.sign)&&e.jsx("div",{className:"flex-fill text-center",children:e.jsx("p",{className:"mb-0 text-muted",children:"No payment or signature details available"})})]}),e.jsx("div",{className:"row section mt-3",children:e.jsx("div",{className:"col-md-12 text-center",children:e.jsx("p",{children:"This bill has been computer-generated and is authorized."})})}),e.jsxs("div",{className:"d-flex justify-content-center flex-wrap gap-2",children:[e.jsx(j,{color:"danger",variant:"outline",className:"d-print-none flex-fill",onClick:re,children:"Edit Order"}),e.jsx(j,{color:"primary",variant:"outline",onClick:()=>k(!f),className:"d-print-none flex-fill",children:f?"Cancel Edit":"Edit Payment"}),e.jsx(j,{color:"primary",variant:"outline",onClick:ae,className:"d-print-none flex-fill",children:"Print"}),e.jsxs(fe,{className:"mb-2 d-print-none flex-fill",value:N,onChange:t=>O(t.target.value),style:{maxWidth:"200px"},children:[e.jsx("option",{value:"english",children:"English"}),e.jsx("option",{value:"marathi",children:"Marathi"}),e.jsx("option",{value:"tamil",children:"Tamil"}),e.jsx("option",{value:"bengali",children:"Bengali"})]}),e.jsx(j,{color:"success",variant:"outline",onClick:()=>ce(N),className:"d-print-none flex-fill",children:"Download PDF"}),e.jsx(j,{color:"success",variant:"outline",onClick:()=>oe(),className:"d-print-none flex-fill",children:"Share on WhatsApp"}),f&&e.jsx(j,{color:"success",variant:"outline",onClick:ne,className:"d-print-none flex-fill",children:"Save Changes"})]})]})})]})};export{Ie as default};

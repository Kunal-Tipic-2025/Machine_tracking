import{u as ee,r as s,j as e,C as F}from"./index-BaFO0fBD.js";import{a as W,b as te}from"./api-BUyL__Lx.js";import{d as g,c as P,a as u,b as i}from"./index.esm-6sS0QU7y.js";import{g as se}from"./Feilds-DKJTpBq7.js";import{C as ne,a as re}from"./CCardBody-C_DcNhkI.js";import{C as ae}from"./CCardHeader-uQH1AYuq.js";import{c as le}from"./cil-search-CDkY_4k-.js";import{C as ie}from"./CFormSelect-CKz9M81i.js";import{c as oe}from"./cil-pencil-m516yCOw.js";import{c as ce}from"./cil-wallet-BrU51gCv.js";import{a as de,b as me,c as he,d as xe,e as ge}from"./DefaultLayout-CO5Zw0Z5.js";import{C as ue}from"./CForm-aAQP41oT.js";import{C as b}from"./CFormLabel-zcG2lLqz.js";import{C as v}from"./CFormInput-Bf1zI-co.js";import"./CFormControlWrapper-DiPXZd7c.js";import"./CFormControlValidation-D0XpqgJc.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-D7bfBri4.js";import"./CNavItem-BYh17SIg.js";const r=C=>new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(C),Me=()=>{const C=ee(),[d,_]=s.useState([]),[p,S]=s.useState(!1),[N,I]=s.useState(1),[w,T]=s.useState(!0),[E,D]=s.useState({total_amount:0,pending_amount:0}),[m,H]=s.useState(""),[O,k]=s.useState([]),[V,j]=s.useState(!1),[a,q]=s.useState(null),[M,R]=s.useState(""),[B,L]=s.useState(!1),[G,h]=s.useState(""),y=s.useRef(),J=10,$=s.useCallback(async()=>{try{const t=await W("/api/projects");k(t||[])}catch(t){console.error("Error fetching projects:",t),k([])}},[]),x=s.useCallback(async(t=1,n=!1)=>{var l,f,A;S(!0);try{let o=`/api/income?per_page=${J}&page=${t}`;m&&(o+=`&project_id=${m}`);const c=await W(o);console.log("API Response:",c);const U=((l=c.incomes)==null?void 0:l.data)||[];_(Z=>n?U:[...Z,...U]),T((((f=c.incomes)==null?void 0:f.current_page)||1)<(((A=c.incomes)==null?void 0:A.last_page)||1)),D(c.summary||{total_amount:0,pending_amount:0})}catch(o){console.error("Error fetching incomes:",o),_(c=>n?[]:c),D({total_amount:0,pending_amount:0}),T(!1)}finally{S(!1)}},[m]);s.useEffect(()=>{$(),x(1,!0)},[$,m]);const K=s.useCallback(t=>{p||!w||(y.current&&y.current.disconnect(),y.current=new IntersectionObserver(n=>{n[0].isIntersecting&&I(l=>l+1)}),t&&y.current.observe(t))},[p,w]);s.useEffect(()=>{N>1&&x(N)},[N,x]);const Q=t=>{H(t.target.value),I(1),_([])},X=t=>{C("/projectIncome",{state:{income:t}})},Y=t=>{q(t),R(""),h(""),j(!0)},z=async t=>{if(t.preventDefault(),!a)return;const n=parseFloat(M)||0;if(n<=0){h("Please enter a valid amount");return}const l=parseFloat(a.pending_amount);if(n>l){h(`Amount to be paid cannot exceed pending amount of ₹${r(l)}`);return}const f=parseFloat(a.received_amount)+n,A=l-n;L(!0);try{(await te(`/api/income/${a.id}`,{received_amount:f.toFixed(2),pending_amount:A.toFixed(2)})).message?(j(!1),x(1,!0)):h("Error updating payment")}catch(o){console.error("Error updating payment:",o),h("Error updating payment")}finally{L(!1)}};return e.jsxs("div",{className:"container-fluid py-4",children:[e.jsxs(ne,{children:[e.jsxs(ae,{className:"bg-success text-white d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Income Details"}),e.jsxs(g,{color:"light",size:"sm",onClick:()=>x(1,!0),children:[e.jsx(P,{icon:le,className:"me-1"}),"Refresh"]})]}),e.jsxs(re,{children:[e.jsx(u,{className:"mb-3",children:e.jsx(i,{md:4,children:e.jsxs(ie,{value:m,onChange:Q,children:[e.jsx("option",{value:"",children:"All Projects"}),O.map(t=>e.jsx("option",{value:t.id,children:t.project_name},t.id))]})})}),e.jsxs(u,{className:"mb-3",children:[e.jsx(i,{md:6,children:e.jsxs("div",{className:"alert alert-info",children:["Total Amount With GST: ₹",e.jsx("strong",{children:r(parseFloat(E.total_amount))})]})}),e.jsx(i,{md:6,children:e.jsxs("div",{className:"alert alert-warning",children:["Total Pending Amount: ₹",e.jsx("strong",{children:r(parseFloat(E.pending_amount))})]})})]}),p&&d.length===0?e.jsxs("div",{className:"text-center py-4",children:[e.jsx(F,{}),e.jsx("div",{className:"mt-2",children:"Loading income records..."})]}):d.length>0?e.jsxs("div",{className:"table-responsive",children:[e.jsxs("table",{className:"table table-striped table-bordered",children:[e.jsx("thead",{className:"table-success",children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"right"},children:"ID"}),e.jsx("th",{style:{textAlign:"right"},children:"Project Name"}),e.jsx("th",{style:{textAlign:"right"},children:"PO No"}),e.jsx("th",{style:{textAlign:"right"},children:"PO Date"}),e.jsx("th",{style:{textAlign:"right"},children:"Invoice No"}),e.jsx("th",{style:{textAlign:"right"},children:"Invoice Date"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount Before GST"}),e.jsxs("th",{style:{textAlign:"right"},children:["GST ",se,"%"]}),e.jsx("th",{style:{textAlign:"right"},children:"Amount With GST"}),e.jsx("th",{style:{textAlign:"right"},children:"Received Amount"}),e.jsx("th",{style:{textAlign:"right"},children:"Pending Amount"}),e.jsx("th",{style:{textAlign:"right"},children:"Sent By"}),e.jsx("th",{style:{textAlign:"right"},children:"Payment Type"}),e.jsx("th",{style:{textAlign:"right"},children:"Transaction ID"}),e.jsx("th",{style:{textAlign:"right"},children:"Received Bank"}),e.jsx("th",{style:{textAlign:"right"},children:"Actions"})]})}),e.jsx("tbody",{children:d.map((t,n)=>e.jsxs("tr",{ref:n===d.length-1?K:null,children:[e.jsx("td",{style:{textAlign:"right"},children:t.id}),e.jsx("td",{style:{textAlign:"right"},children:t.project_name||"N/A"}),e.jsx("td",{style:{textAlign:"right"},children:t.po_no}),e.jsx("td",{style:{textAlign:"right"},children:new Date(t.po_date).toLocaleDateString()}),e.jsx("td",{style:{textAlign:"right"},children:t.invoice_no}),e.jsx("td",{style:{textAlign:"right"},children:new Date(t.invoice_date).toLocaleDateString()}),e.jsx("td",{style:{textAlign:"right"},children:r(parseFloat(t.basic_amount))}),e.jsx("td",{style:{textAlign:"right"},children:r(parseFloat(t.gst_amount))}),e.jsx("td",{style:{textAlign:"right"},children:r(parseFloat(t.billing_amount))}),e.jsx("td",{style:{textAlign:"right"},children:r(parseFloat(t.received_amount))}),e.jsx("td",{style:{textAlign:"right"},children:parseFloat(t.pending_amount)>0?e.jsx("span",{className:"badge bg-danger",children:r(parseFloat(t.pending_amount))}):"NA"}),e.jsx("td",{style:{textAlign:"right"},children:t.received_by}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx("span",{className:"badge bg-primary",children:t.payment_type.toUpperCase()})}),e.jsx("td",{style:{textAlign:"right"},children:t.remark||"N/A"}),e.jsx("td",{style:{textAlign:"right"},children:t.receivers_bank}),e.jsxs("td",{style:{textAlign:"right"},className:"d-flex gap-2",children:[e.jsx(g,{color:"warning",size:"sm",onClick:()=>X(t),children:e.jsx(P,{icon:oe})}),parseFloat(t.pending_amount)>0&&e.jsx(g,{color:"success",size:"sm",onClick:()=>Y(t),children:e.jsx(P,{icon:ce})})]})]},t.id))})]}),p&&d.length>0&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(F,{}),e.jsx("div",{className:"mt-2",children:"Loading more records..."})]})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("div",{className:"text-muted",children:"No income records found"})})]})]}),a&&e.jsxs(de,{visible:V,onClose:()=>j(!1),children:[e.jsx(me,{children:e.jsxs(he,{children:["Update Payment for Invoice ",a.invoice_no]})}),e.jsx(xe,{children:e.jsxs(ue,{onSubmit:z,children:[e.jsxs(u,{className:"mb-3",children:[e.jsxs(i,{md:6,children:[e.jsx(b,{htmlFor:"billing_amount",children:"Amount With GST ₹"}),e.jsx(v,{step:"0.01",value:r(parseFloat(a.billing_amount)),disabled:!0})]}),e.jsxs(i,{md:6,children:[e.jsx(b,{htmlFor:"received_amount",children:"Received Amount ₹"}),e.jsx(v,{step:"0.01",value:r(parseFloat(a.received_amount)),disabled:!0})]})]}),e.jsxs(u,{className:"mb-3",children:[e.jsxs(i,{md:6,children:[e.jsx(b,{htmlFor:"pending_amount",children:"Pending Amount ₹"}),e.jsx(v,{step:"0.01",value:r(parseFloat(a.pending_amount)),disabled:!0})]}),e.jsxs(i,{md:6,children:[e.jsx(b,{htmlFor:"amount_to_be_paid",children:"Amount To Be Paid ₹ *"})," ",e.jsx(v,{type:"number",step:"0.01",value:M,onChange:t=>R(t.target.value),placeholder:"Enter amount to be paid",required:!0})]})]}),G&&e.jsx(u,{children:e.jsx(i,{children:e.jsx("div",{className:"alert alert-danger",role:"alert",children:G})})})]})}),e.jsxs(ge,{children:[e.jsx(g,{color:"secondary",onClick:()=>j(!1),children:"Cancel"}),e.jsx(g,{color:"primary",onClick:z,disabled:B,children:B?e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"sm",className:"me-2"}),"Updating..."]}):"Update Payment"})]})]})]})};export{Me as default};

import{r as n,R as gs,j as e,C as ce,b as fs}from"./index-Cr-4waUE.js";import{d as f,c as oe,a as V,b as g}from"./index.esm-B75P6HjL.js";import{a as P,g as ze,h as cs,b as ys}from"./api-BUyL__Lx.js";import{g as os,h as bs}from"./InvoiceMulPdf-DDqxWKzU.js";import{C as Be,a as Le}from"./CCardBody-DpPesGF7.js";import{C as We}from"./CCardHeader-CC-r8sJV.js";import{C as je,j as Ns,a as ne,b as ae,e as re,c as ie,d as Ze}from"./DefaultLayout-B8rErgo7.js";import{C as vs}from"./RawMaterial-21BlczCs.js";import{C as he,a as ue,b as p,c as d,d as pe,e as a}from"./CTable-DlHDa5oY.js";import{C as _s}from"./CInputGroup-6t6wGJL1.js";import{C as ws}from"./CInputGroupText-DA8HLXzB.js";import{C as He}from"./CFormInput-KPF1mpuU.js";import{C as Ke}from"./CTooltip-RhTrps7A.js";import{c as Cs}from"./cil-money-Dk3vHnQB.js";import{c as Ps}from"./cil-history-D-FQjjfl.js";import"./jspdf.es.min-CKSaNYP6.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-Bkuvlzpx.js";import"./CFormControlWrapper-BYXowQRV.js";import"./CFormControlValidation-CByzp8AE.js";import"./CFormLabel-C33rygdk.js";import"./getTransitionDurationFromElement-Cpu4p4hx.js";var Ge=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='272 434.744 272 209.176 240 209.176 240 434.744 188.118 382.862 165.49 405.489 256 496 346.51 405.489 323.882 382.862 272 434.744' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M400,161.176c0-79.4-64.6-144-144-144s-144,64.6-144,144a96,96,0,0,0,0,192h80v-32H112a64,64,0,0,1,0-128h32v-32a112,112,0,0,1,224,0v32h32a64,64,0,0,1,0,128H320v32h80a96,96,0,0,0,0-192Z' class='ci-primary'/>"];const Ss=({projectId:m,inModal:r=!1})=>{const[c,ge]=n.useState([]),[$,Y]=n.useState(!0),[A,de]=n.useState([]),[F,z]=n.useState({show:!1,message:"",type:"success"}),[j,S]=n.useState([]),[D,B]=n.useState(!1),[q,le]=n.useState(!1),[R,J]=n.useState([]),[N,L]=n.useState(!1);n.useState(null),n.useState(null),n.useState(!1);const[v,fe]=n.useState([]),[X,Se]=n.useState([]),[E,Ue]=n.useState([]),[ke,Z]=n.useState(!1),[h,Ve]=n.useState([]),[T,Ae]=n.useState([]);n.useEffect(()=>{(async()=>{try{const x=await P("/api/workingType");Ae(x||[])}catch(x){console.error("Error fetching work types",x)}})()},[]);const ye=gs.useMemo(()=>{const t={};return T.forEach(x=>{t[x.id]=x.type_of_work}),t},[T]),Fe=async()=>{try{const t=await P("/api/machine-operators");console.log("machineries",t),fe(t||[])}catch(t){console.error("Error fetching machineries:",t)}},Ye=async()=>{try{const t=await P("/api/machineLog");Se(t||[])}catch(t){console.error("Error fetching machine logs:",t)}};n.useEffect(()=>{if(c!=null&&c.worklog_ids&&X.length>0){const t=X.filter(x=>c.worklog_ids.includes(x.id));Ue(t),console.log("Filtered Logs:",t)}},[c,X]);const be=async()=>{try{Y(!0);const t=await P(`/api/project-payments/${m}`);if(console.log(t),ge(t),t!=null&&t.invoice_number){const x=await P(`/api/invoice-additional-charges/${t.invoice_number}`);Ve(x||[]),console.log("Additional Charges:",x)}}catch(t){console.error("Error fetching orders:",t),W("Failed to fetch orders","danger")}finally{Y(!1)}},Ne=()=>{P("/api/operatorsByCompanyIdOperator").then(t=>{console.log(t),J(t)}).catch(t=>{console.log(t.message)})};n.useEffect(()=>{be()},[m]),n.useEffect(()=>{Ye(),Ne(),Fe(),De()},[]);const W=(t,x="success")=>{z({show:!0,message:t,type:x}),setTimeout(()=>z({show:!1,message:"",type:"success"}),5e3)},De=async()=>{try{const t=await P("/api/machine-price");de(t)}catch(t){console.error("Error fetching machine price:",t)}},ve=async()=>{if(j.length===0){W("Please select at least one work order to download","warning");return}B(!0);try{await generateWorkOrdersPDF(j),W(`PDF generated successfully for ${j.length} work order(s)`,"success"),S([])}catch(t){console.error("Error generating PDF:",t),W("Failed to generate PDF. Please try again.","danger")}finally{B(!1)}},Te=()=>{L(!0)},_e=async()=>{var t,x,M,ee,se;if(!(!c||Object.keys(c).length===0))try{Z(!0);const u=(t=ze())==null?void 0:t.company_info;if(!u){F("Company information not found. Please log in again.");return}const Re=Ie(c.created_at),we={invoice_number:c.invoice_number,date:Re,customer:{name:((x=c.project)==null?void 0:x.customer_name)||"N/A",address:((M=c.project)==null?void 0:M.work_place)||"",mobile:((ee=c.project)==null?void 0:ee.mobile_number)||"",gst_number:((se=c.project)==null?void 0:se.gst_number)||""},consignee:{name:u.company_name,address:`${u.land_mark||""}, ${u.Tal||""}, ${u.Dist||""}, ${u.pincode||""}`,phone_no:u.phone_no,gst_number:u.gst_number,email_id:u.email_id},totalAmount:I,amountPaid:xe,finalAmount:I,baseTotal:U,additionalChargesTotal:G,additionalCharges:h,paymentMode:c.payment_mode,transaction_id:c.transaction_id,is_fixed_bid:c.is_fixed_bid==1,is_advance:c.is_advance==1,remark:c.remark},Ee=E.map(Ce=>({id:Ce.id,data:Ce}));await os(we,Ee,R,v,A,Ee,"english","save",ye)}catch(u){console.error("Error generating PDF:",u),F("Failed to generate PDF. Please try again.")}finally{Z(!1)}},Ie=t=>t?new Date(t).toLocaleDateString("en-GB"):"",Me=t=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[t]||t;if($)return e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(ce,{color:"primary"})});if(!c||Object.keys(c).length===0)return e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No invoice data found."})});const G=h.reduce((t,x)=>t+Number(x.amount||0),0),K=h.reduce((t,x)=>t+Number(x.paid_amount||0),0),U=Number((c==null?void 0:c.base_total)||0),me=Number((c==null?void 0:c.paid_amount)||0),I=U+G,xe=me+K,Q=I-xe,$e=Q<=0;return e.jsx("div",{className:"p-4",children:e.jsxs(Be,{children:[e.jsx(We,{className:"bg-primary text-white",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Details"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(je,{color:$e?"success":"warning",className:"fs-6 px-3 py-2 rounded-pill",children:$e?"✔️ Completed":"⏳ Pending"}),e.jsx(f,{color:"success",size:"sm",onClick:_e,disabled:ke||!c,children:ke?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})})]})]})}),e.jsxs(Le,{children:[e.jsxs(V,{className:"mb-4",children:[e.jsxs(g,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Invoice Number:"}),e.jsx("div",{className:"text-muted",children:c.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Date:"}),e.jsx("div",{className:"text-muted",children:Ie(c.created_at)})]})]}),e.jsxs(g,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Payment Mode:"}),e.jsx("div",{className:"text-muted",children:c.payment_mode||"-"})]}),c.transaction_id&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Transaction ID:"}),e.jsx("div",{className:"text-muted",children:c.transaction_id})]}),c.project&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Customer:"}),e.jsx("div",{className:"text-muted",children:c.project.customer_name||"-"})]})]})]}),!r&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:j.length>0&&e.jsxs("span",{className:"text-muted small",children:[j.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(f,{color:"primary",onClick:ve,disabled:j.length===0||D,className:"d-flex align-items-center",size:"sm",children:D?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),j.length>0&&` (${j.length})`]})}),e.jsx(f,{color:"success",onClick:Te,disabled:q,className:"d-flex align-items-center",size:"sm",children:q?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ns,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),F.show&&e.jsx(vs,{color:F.type,dismissible:!0,onClose:()=>z({show:!1,message:"",type:"success"}),children:F.message}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto",overflowX:"auto",borderRadius:"6px"},children:e.jsxs(he,{striped:!0,bordered:!0,hover:!0,className:"mb-0",children:[e.jsx(ue,{style:{position:"sticky",top:0,zIndex:2,backgroundColor:"#f8f9fa",boxShadow:"0 2px 3px rgba(0,0,0,0.05)"},children:e.jsxs(p,{children:[e.jsx(d,{children:"Sr no."}),e.jsx(d,{children:"Work Date"}),e.jsx(d,{children:"Machine"}),e.jsx(d,{children:"Mode"}),e.jsx(d,{children:"Operator"}),e.jsx(d,{children:"Work Type"}),e.jsx(d,{children:"Start Reading"}),e.jsx(d,{children:"End Reading"}),e.jsx(d,{children:"Net Reading"}),e.jsx(d,{children:"Price Per Hour"}),e.jsx(d,{className:"text-end",children:"Total Price"})]})}),e.jsxs(pe,{children:[E.length>0?E.map((t,x)=>{var M,ee,se;return e.jsxs(p,{children:[e.jsx(a,{children:x+1}),e.jsx(a,{children:(t==null?void 0:t.work_date)||"-"}),e.jsx(a,{children:((M=v.find(u=>String(u.id)===String(t==null?void 0:t.machine_id)))==null?void 0:M.machine_name)||"N/A"}),e.jsx(a,{children:((ee=A.find(u=>u.id===Number(t.mode_id)))==null?void 0:ee.mode)||"-"}),e.jsx(a,{children:((se=R.find(u=>u.id===Number(t==null?void 0:t.operator_id)))==null?void 0:se.name)||"Unknown Operator"}),e.jsx(a,{children:ye[t==null?void 0:t.work_type_id]||"—"}),e.jsx(a,{children:(t==null?void 0:t.start_reading)||"-"}),e.jsx(a,{children:(t==null?void 0:t.end_reading)||"-"}),e.jsx(a,{children:t!=null&&t.end_reading&&(t!=null&&t.start_reading)?t.end_reading-t.start_reading:"-"}),e.jsxs(a,{children:["₹",(t==null?void 0:t.price_per_hour)||"0"]}),e.jsxs(a,{className:"text-end",children:["₹",t!=null&&t.end_reading&&(t!=null&&t.start_reading)&&(t!=null&&t.price_per_hour)?((t.end_reading-t.start_reading)*t.price_per_hour).toFixed(2):"0.00"]})]},t.id)}):e.jsx(p,{children:e.jsx(a,{colSpan:10,className:"text-center text-muted py-4",children:"No work orders found for this invoice."})}),h&&h.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(p,{style:{backgroundColor:"#f0f8ff"},children:e.jsx(a,{colSpan:11,className:"fw-bold text-primary",children:"Additional Charges"})}),h.map((t,x)=>e.jsxs(p,{style:{backgroundColor:"#f8f9fa"},children:[e.jsx(a,{children:E.length+x+1}),e.jsx(a,{children:t.date?new Date(t.date).toLocaleDateString("en-GB"):"-"}),e.jsxs(a,{colSpan:7,children:[e.jsx("strong",{children:Me(t.charge_type)}),t.remark&&e.jsxs("div",{className:"small text-muted mt-1",children:["Note: ",t.remark]})]}),e.jsx(a,{className:"text-center",children:e.jsx(je,{color:t.is_paid?"success":"warning",children:t.is_paid?"Paid":"Pending"})}),e.jsxs(a,{className:"text-end fw-bold",children:["₹",Number(t.amount).toFixed(2)]})]},`charge-${t.id}`))]}),h.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(p,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Work Orders Subtotal"}),e.jsxs(a,{className:"text-end",children:["₹",U.toFixed(2)]})]}),e.jsxs(p,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Additional Charges Total"}),e.jsxs(a,{className:"text-end",children:["₹",G.toFixed(2)]})]})]}),e.jsxs(p,{className:"fw-bold bg-primary text-white",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Grand Total"}),e.jsxs(a,{className:"text-end",children:["₹",I.toFixed(2)]})]}),e.jsxs(p,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Paid Amount"}),e.jsxs(a,{className:"text-end text-success",children:["₹",xe.toFixed(2)]})]}),e.jsxs(p,{className:"fw-bold bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Remaining Amount"}),e.jsxs(a,{className:`text-end ${Q>0?"text-danger":"text-success"}`,children:["₹",Q.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"mt-4 p-3 bg-light rounded",children:[e.jsxs(V,{className:"w-100",children:[e.jsx(g,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Total Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold",children:["₹",I.toFixed(2)]})]})}),e.jsx(g,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Paid Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold text-success",children:["₹",xe.toFixed(2)]})]})}),e.jsx(g,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Remaining:"}),e.jsxs("span",{className:`fs-5 fw-bold ${Q>0?"text-danger":"text-success"}`,children:["₹",Q.toFixed(2)]})]})})]}),c.payment_mode&&e.jsx("div",{className:"mt-2 pt-2 border-top",children:e.jsxs("div",{className:"",children:[e.jsx("span",{className:"fw-bold me-2",children:"Payment Mode:"}),e.jsx(je,{color:"info",className:"fs-6",children:c.payment_mode})]})})]})]})]})})},ks=({paymentId:m})=>{const[r,c]=n.useState(null),[ge,$]=n.useState(!0),[Y,A]=n.useState(!1);n.useEffect(()=>{m&&de()},[m]);const de=async()=>{try{$(!0);const j=await P(`/api/project-payments/${m}`);c(j)}catch(j){console.error("Error fetching advance payment:",j)}finally{$(!1)}},F=j=>j?new Date(j).toLocaleDateString("en-GB"):"",z=async()=>{var j,S,D,B,q,le,R,J;if(r)try{A(!0);const N=(j=ze())==null?void 0:j.company_info;if(!N){alert("Company information not found. Please log in again.");return}const L=F(r.created_at),v=r.is_fixed_bid==1,fe=!v,X={invoice_number:r.invoice_number,date:L,customer:{name:((S=r.project)==null?void 0:S.customer_name)||"N/A",address:((D=r.project)==null?void 0:D.work_place)||"",mobile:((B=r.project)==null?void 0:B.mobile_number)||"",gst_number:((q=r.project)==null?void 0:q.gst_number)||""},consignee:{name:N.company_name,address:`${N.land_mark||""}, ${N.Tal||""}, ${N.Dist||""}, ${N.pincode||""}`,phone_no:N.phone_no,gst_number:N.gst_number,email_id:N.email_id},totalAmount:r.total,amountPaid:r.paid_amount,finalAmount:r.total,paymentMode:r.payment_mode||(v?"Fixed Bid":"Advance"),transaction_id:r.transaction_id,is_fixed_bid:v,is_advance:fe,remark:r.remark,name:((le=r.project)==null?void 0:le.customer_name)||"N/A",address:((R=r.project)==null?void 0:R.work_place)||"",mobile:((J=r.project)==null?void 0:J.mobile_number)||"",total:r.total};await os(X,[],[],[],[],[],"english","save")}catch(N){console.error("Error generating PDF:",N),alert("Failed to generate PDF. Please try again.")}finally{A(!1)}};return ge?e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(ce,{color:"primary"})}):r?e.jsx("div",{className:"p-4",children:e.jsxs(Be,{children:[e.jsxs(We,{className:"bg-warning text-dark d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:r.is_fixed_bid==1?"Fixed Bid Invoice":"Advance Payment Invoice"}),e.jsx(f,{color:"success",size:"sm",onClick:z,disabled:Y||!r,children:Y?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})})]}),e.jsxs(Le,{children:[e.jsxs(V,{className:"mb-4",children:[e.jsxs(g,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Invoice Number:"})," ",e.jsx("span",{className:"text-muted",children:r.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Date:"})," ",e.jsx("span",{className:"text-muted",children:F(r.created_at)})]})]}),e.jsxs(g,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Payment Mode:"})," ",e.jsx("span",{className:"text-muted",children:r.payment_mode||(r.is_fixed_bid==1?"Fixed Bid":"Advance")})]}),r.transaction_id&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Transaction ID:"})," ",e.jsx("span",{className:"text-muted",children:r.transaction_id})]})]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(he,{striped:!0,bordered:!0,children:[e.jsx(ue,{children:e.jsxs(p,{children:[e.jsx(d,{children:"Description"}),e.jsx(d,{className:"text-end",children:"Amount"}),e.jsx(d,{className:"text-end",children:"Remaining"})]})}),e.jsxs(pe,{children:[e.jsxs(p,{children:[e.jsxs(a,{children:[e.jsx("strong",{children:r.is_fixed_bid==1?"Fixed Bid Work":"Advance Payment"}),r.remark&&e.jsx("div",{className:"text-muted small mt-1",children:r.remark})]}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-success",children:["₹",Number(r.total||0).toFixed(2)]})}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-danger",children:["₹",(Number(r.total||0)-Number(r.paid_amount||0)).toFixed(2)]})})]}),e.jsxs(p,{children:[e.jsx(a,{colSpan:2,children:e.jsx("strong",{children:"Total Paid Amount"})}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["₹",Number(r.paid_amount||0).toFixed(2)]})})]})]})]})}),e.jsx("div",{className:"mt-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Payment Mode:"}),e.jsx("span",{className:"badge bg-info fs-6 ms-2",children:r.payment_mode||(r.is_fixed_bid==1?"Fixed Bid":"Advance")})]})}),r.project&&e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Cust. Name :"}),e.jsx("span",{className:"text-muted ms-2",children:r.project.customer_name||"-"})]})})]})})]})]})}):e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No payment data found."})})},As=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-eye",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}),e.jsx("path",{d:"M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"})]}),et=()=>{var es,ss;const{showToast:m}=fs(),r=(es=ze())==null?void 0:es.company_id;if(!r)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[c,ge]=n.useState([]),[$,Y]=n.useState(""),[A,de]=n.useState(""),[F,z]=n.useState(""),[j,S]=n.useState(!1),[D,B]=n.useState(null),[q,le]=n.useState(!1),[R,J]=n.useState(null),[N,L]=n.useState(!1);n.useState("");const[v,fe]=n.useState(null),[X,Se]=n.useState(!1),[E,Ue]=n.useState([]),[ke,Z]=n.useState(!1),[h,Ve]=n.useState(null),[T,Ae]=n.useState(""),[ye,Fe]=n.useState(""),[Ye,be]=n.useState(!1),[Ne,W]=n.useState(""),[De,ve]=n.useState(""),[Te,_e]=n.useState([]);n.useState(!1);const[Ie,Me]=n.useState(!1),[G,K]=n.useState(""),[U,me]=n.useState(!1);n.useState(""),n.useState([]);const[I,xe]=n.useState([]),[Q,$e]=n.useState(!1),[t,x]=n.useState(null),M=async()=>{S(!0);try{const s=await P(`/api/project-payments?company_id=${r}`);ge(Array.isArray(s)?s:[])}catch(s){m("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{S(!1)}},ee=async()=>{S(!0);try{const s=await P("/api/project-wise-hours");xe(s.project_wise_hours||[]),console.log("machine hourse",s.project_wise_hours)}catch(s){m("danger","Error fetching Hours: "+((s==null?void 0:s.message)||s))}finally{S(!1)}},se=async()=>{try{const s=await P("/api/projects");if(!Array.isArray(s)){_e([]);return}const i={};s.forEach(o=>{var _;if(o.company_id!==r)return;const l=(_=o.customer_name)==null?void 0:_.trim();l&&(i[l]||(i[l]={name:l,mobile:o.mobile_number||"",projects:[]}),i[l].projects.push({id:o.id,company_id:o.company_id}))}),_e(Object.values(i))}catch(s){console.error(s),_e([])}},u=async()=>{if(v){S(!0);try{const s=await P(`/api/repayments?company_id=${r}&project_id=${v}`);Ue(Array.isArray(s)?s:[])}catch(s){m("danger","Error fetching history: "+((s==null?void 0:s.message)||s))}finally{S(!1)}}};n.useEffect(()=>{M(),se(),ee()},[r]),n.useEffect(()=>{v&&u()},[v,r]);const Re=s=>s?new Date(s).toLocaleDateString("en-GB"):"",we=s=>`₹${Number(s||0).toFixed(2)}`,Ee=s=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[s]||s,Ce=n.useMemo(()=>c.filter(s=>s.company_id===r),[c,r]),ds=n.useMemo(()=>{const s={};return I.forEach(i=>{s[Number(i.project_id)]=Number(i.total_hours||0)}),s},[I]),ls=n.useMemo(()=>I.reduce((s,i)=>s+Number(i.total_hours||0),0),[I]),ms=s=>[...new Set(s.map(o=>{var l;return(l=o.project)==null?void 0:l.id}).filter(Boolean))].reduce((o,l)=>o+(ds[l]||0),0),Oe=n.useMemo(()=>{const s={};if(Ce.forEach(i=>{var l;const o=((l=i.project)==null?void 0:l.customer_name)||"Unknown";s[o]||(s[o]=[]),s[o].push(i)}),A){const i=A.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([o])=>o.toLowerCase().includes(i)))}return s},[Ce,A]),Pe=n.useMemo(()=>{const s=Object.values(Oe),i=s.flat(),o=i.filter(y=>!y.is_advance),l=s.length,_=i.length,b=o.reduce((y,k)=>y+Number(k.total||0),0),H=o.reduce((y,k)=>y+Number(k.paid_amount||0),0),C=b-H;return{customerCount:l,totalInvoices:_,totalBilled:b,totalPaid:H,totalOutstanding:C}},[Oe]);if(j&&!c.length)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(ce,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading project payments..."})]});const xs=async()=>{var H;if(!h||!T||Number(T)<=0)return;const s=Number(T),i=s,o=Number(h.total)-i,l=ye;try{const C={paid_amount:i,payment_mode:h.payment_mode||null},y=await fetch(`/api/project-payments/${h.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!y.ok){const k=await y.text();throw new Error(`Failed to update payment: ${k}`)}m("success","Payment updated successfully")}catch(C){console.error("Payment update error:",C),m("danger","Failed to update payment: "+C.message);return}const _=new Date().toISOString().split("T")[0],b={company_id:r,project_id:(H=h.project)==null?void 0:H.id,invoice_id:h.invoice_number,payment:s,total:h.total,remaining:o,is_completed:o<=0,date:_,remark:l};try{await fetch("/api/repayment/single",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}),Ae(""),Fe(""),Z(!1),M(),v&&u()}catch(C){console.error("Repayment recording error:",C),m("danger","Payment recorded but history failed to save.")}};if(!D)return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsx(g,{xs:12,children:e.jsxs(Be,{className:"shadow-sm",children:[e.jsx(We,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Customers Payment Report"}),e.jsxs(je,{color:"info",className:"ms-2",children:[Pe.customerCount," customers"]})]})}),e.jsxs(Le,{children:[e.jsxs(V,{className:"mb-2",children:[e.jsx(g,{xs:12,md:6,children:e.jsxs(_s,{children:[e.jsx(ws,{children:"Search"}),e.jsx(He,{placeholder:"Search by customer name...",value:F,onChange:s=>{z(s.target.value),de(s.target.value)}})]})}),A&&e.jsx(g,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(f,{color:"light",size:"sm",onClick:()=>{z(""),de("")},children:"Clear"})})]}),e.jsxs(V,{className:"g-2 mb-3",children:[e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:Pe.totalInvoices})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsxs("small",{className:"d-block",children:["Total Billed (",ls,"hrs.)"]}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalBilled)})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalPaid)})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(he,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(ue,{children:e.jsxs(p,{children:[e.jsx(d,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(d,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(d,{className:"text-center align-middle",children:"Hours"}),e.jsx(d,{className:"text-center align-middle",children:"Total"}),e.jsx(d,{className:"text-center align-middle",children:"Paid"}),e.jsx(d,{className:"text-center align-middle",children:"Remaining"}),e.jsx(d,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(pe,{children:Object.entries(Oe).map(([s,i],o)=>{const l=i.filter(y=>!y.is_advance),_=l.reduce((y,k)=>y+Number(k.total||0),0),b=l.reduce((y,k)=>y+Number(k.paid_amount||0),0),H=_-b,C=ms(i);return e.jsxs(p,{children:[e.jsx(a,{children:o+1}),e.jsx(a,{children:s}),e.jsx(a,{style:{color:C<0?"red":"blue",fontWeight:600},children:C}),e.jsxs(a,{className:"text-end",children:["₹",_.toFixed(2)]}),e.jsxs(a,{className:"text-success fw-bold text-end",children:["₹",b.toFixed(2)]}),e.jsxs(a,{className:"text-danger fw-bold text-end",children:["₹",H.toFixed(2)]}),e.jsx(a,{className:"text-center",children:e.jsx(f,{size:"sm",color:"info",onClick:()=>{B(s),fe(i[0].project_id)},children:"View Invoices"})})]},s)})})]})})]})]})})}),e.jsxs(ne,{visible:Ye,onClose:()=>{be(!1),W(""),ve("")},children:[e.jsx(ae,{children:e.jsx(re,{children:"Advance Payment"})}),e.jsxs(ie,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Customer"}),e.jsxs("select",{className:"form-select",value:Ne,onChange:s=>W(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select --"}),Te.map(s=>e.jsxs("option",{value:s.name,children:[s.name," ",s.mobile?`(${s.mobile})`:""]},s.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(He,{type:"number",placeholder:"Enter amount",value:De,onChange:s=>ve(s.target.value),min:"0"})]})]}),e.jsxs(Ze,{children:[e.jsx(f,{color:"secondary",onClick:()=>be(!1),children:"Cancel"}),e.jsx(f,{color:"primary",onClick:async()=>{var _;if(!Ne)return m("danger","Select a customer");const s=Number(De);if(!s||s<=0)return m("danger","Enter a valid amount");const i=Te.find(b=>b.name===Ne);if(!((_=i==null?void 0:i.projects)!=null&&_.length))return m("danger","No project for this customer");const{id:o,company_id:l}=i.projects[0];try{await cs("/api/advance-payment",{company_id:l,project_id:o,amount:s}),m("success","Advance payment recorded"),be(!1),W(""),ve(""),M()}catch(b){m("danger","Failed: "+((b==null?void 0:b.message)||"Unknown error"))}},children:"Submit"})]})]})]});const qe=Oe[D]||[],Qe=qe.filter(s=>!s.is_advance),Je=Qe.reduce((s,i)=>s+Number(i.total||0),0),Xe=Qe.reduce((s,i)=>s+Number(i.paid_amount||0),0),te=Je-Xe,O=(E||[]).filter(s=>s.is_advance&&!s.advance_taken).reduce((s,i)=>s+Number(i.payment||0),0),hs=async()=>{const o=(Number(G)||0)+(U?O:0);if(o<=0)return m("danger","Total payment must be greater than 0");if(o>te)return m("danger","Total amount exceeds remaining balance");try{if(await cs("/api/repayments",{project_id:v,payment:o}),U)try{const l=await ys("/api/repayments/mark-advance-taken",{company_id:r,project_id:v});l.success?m("success",l.message||"Advance payments marked as cleared"):m("warning",l.message||"Advance status update failed")}catch(l){console.error("Advance clear update failed:",l),m("warning","Repayment saved, but advance status update failed: "+(l.message||"Unknown error"))}m("success","Payment recorded successfully"),L(!1),K(""),me(!1),M(),u()}catch(l){m("danger","Error: "+((l==null?void 0:l.message)||l))}},us=async()=>{var ns,as,rs,is;const s=c.find(w=>w.invoice_number===$);if(!s)return;const i=E.filter(w=>(w==null?void 0:w.invoice_id)===$);if(i.length===0){m("warning","No history to download");return}const o=(ns=ze())==null?void 0:ns.company_info;if(!o){alert("Company information not found. Please log in again.");return}const l=((as=s.project)==null?void 0:as.customer_name)||"N/A",_=s.is_fixed_bid==1?"FIXED BID INVOICE":"INVOICE",b=Number(s.total||0).toFixed(2),H=Number(s.paid_amount||0).toFixed(2),C=(Number(s.total)-Number(s.paid_amount)).toFixed(2),y=i.map((w,js)=>`
            <tr>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${js+1}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    ${w!=null&&w.date?w.date.slice(0,10).split("-").reverse().join("-"):"-"}
                </td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(w.payment).toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(w.remaining).toFixed(2)}</td>
            </tr>
        `).join(""),k=`
            <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                <!-- Header Section -->
                <div style="border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            ${o.logo?`<img src="/img/${o.logo}" alt="Logo" style="max-width: 120px; height: auto;" />`:""}
                        </div>
                        <div style="text-align: right; flex: 1;">
                            <h2 style="margin: 0; color: #333; font-size: 24px;">${o.company_name||""}</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">${o.land_mark||""}, ${o.Tal||""}, ${o.Dist||""}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Pincode: ${o.pincode||""}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Phone: ${o.phone_no||""}</p>
                        </div>
                    </div>
                </div>

                <!-- Title -->
                <div style="text-align: center; background-color: #0d6efd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                    <h2 style="margin: 0; color: #fff; font-size: 20px;">PAYMENT HISTORY - ${_}</h2>
                </div>

                <!-- Invoice & Customer Details -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                    <div style="flex: 1;">
                        <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Invoice Details</h3>
                        <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${s.invoice_number}</p>
                        <p style="margin: 5px 0;"><strong>Date:</strong> ${Re(s.created_at)}</p>
                        <p style="margin: 5px 0;"><strong>Total Amount:</strong> ₹${b}</p>
                        <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ₹${H}</p>
                        <p style="margin: 5px 0;"><strong>Remaining:</strong> ₹${C}</p>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Customer Details</h3>
                        <p style="margin: 5px 0;"><strong>Customer Name:</strong> ${l}</p>
                        <p style="margin: 5px 0;"><strong>Mobile:</strong> ${((rs=s.project)==null?void 0:rs.mobile_number)||"-"}</p>
                        <p style="margin: 5px 0;"><strong>Site:</strong> ${((is=s.project)==null?void 0:is.work_place)||"-"}</p>
                    </div>
                </div>

                <!-- History Table -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Sr. No.</th>
                            <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Date</th>
                            <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Paid Amount</th>
                            <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${y}
                    </tbody>
                </table>

                <!-- Footer -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 12px;">
                    <p>This is a computer-generated document and is valid without signature.</p>
                </div>
            </div>
        `,ts=document.createElement("div");ts.innerHTML=k;const ps={margin:[10,10,10,10],filename:`History-${s.invoice_number}-${l}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};try{await bs().set(ps).from(ts).save(),m("success","History PDF downloaded successfully")}catch(w){console.error("PDF generation error:",w),m("danger","Failed to generate PDF")}};return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsx(g,{xs:12,children:e.jsxs(Be,{className:"shadow-sm",children:[e.jsxs(We,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"fs-5",children:["Invoices for ",D]}),e.jsxs(je,{color:"info",className:"ms-2",children:[qe.length," entries"]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(f,{color:"success",onClick:()=>{L(!0);const s=O>0&&O<=te;me(s),K("")},children:"Record Payment"}),e.jsx(f,{color:"secondary",size:"sm",onClick:()=>B(null),children:"Back"})]})]}),e.jsxs(Le,{children:[e.jsxs(V,{className:"g-2 mb-2",children:[e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-primary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Total"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Je.toFixed(2)]})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-success text-center text-white shadow-sm",children:[e.jsx("small",{children:"Paid"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Xe.toFixed(2)]})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-danger text-center text-white shadow-sm",children:[e.jsx("small",{children:"Remaining"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",te.toFixed(2)]})]})}),e.jsx(g,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-secondary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Advance"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",O.toFixed(2)]})]})})]}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"500px",overflowY:"auto"},children:e.jsxs(he,{hover:!0,bordered:!0,children:[e.jsx(ue,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa"},children:e.jsxs(p,{children:[e.jsx(d,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(d,{className:"text-center align-middle",children:"Invoice"}),e.jsx(d,{className:"text-center align-middle",children:"Date"}),e.jsx(d,{className:"text-center align-middle",children:"Total"}),e.jsx(d,{className:"text-center align-middle",children:"Paid"}),e.jsx(d,{className:"text-center align-middle",children:"Remaining"}),e.jsx(d,{className:"text-center align-middle",children:"Mode"}),e.jsx(d,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(pe,{children:qe.sort((s,i)=>new Date(i.created_at)-new Date(s.created_at)).map((s,i)=>{const o=(Number(s.total)-Number(s.paid_amount)).toFixed(2);return e.jsxs(p,{className:s.is_advance==1?"table-primary":s.is_fixed_bid==1?"table-warning":"",children:[e.jsx(a,{children:i+1}),e.jsx(a,{children:s.is_advance==1?"Advance Payment":s.invoice_number}),e.jsx(a,{className:"text-center align-middle",children:Re(s.created_at)}),e.jsxs(a,{className:"text-end fw-bold",children:["₹",Number(s.total).toFixed(2)]}),e.jsxs(a,{className:"text-success fw-bold text-end",children:["₹",Number(s.paid_amount).toFixed(2)]}),e.jsxs(a,{className:"text-danger fw-bold text-end",children:["₹",o]}),e.jsx(a,{children:s.payment_mode||"-"}),e.jsx(a,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-1",children:[s.is_advance==0&&e.jsx(Ke,{content:"Add Payment",placement:"top",children:e.jsx(f,{color:"success",size:"sm",onClick:()=>{Ve(s),Z(!0)},children:e.jsx(oe,{icon:Cs})})}),s.is_advance==0&&e.jsx(Ke,{content:"Payment History",placement:"top",children:e.jsx(f,{color:"info",size:"sm",onClick:()=>{Y(s.invoice_number),Se(!0)},children:e.jsx(oe,{icon:Ps})})}),e.jsx(Ke,{content:s.is_advance==1?"View Advance Invoice":s.is_fixed_bid==1?"View Fixed Bid Invoice":"View Invoice",placement:"top",children:e.jsx(f,{color:s.is_advance==1||s.is_fixed_bid==1?"warning":"secondary",size:"sm",onClick:()=>{s.is_advance==1||s.is_fixed_bid==1?(J(s.id),Me(!0)):(J(s.id),le(!0))},children:e.jsx(As,{})})})]})})]},s.id)})})]})})]})]})})}),e.jsxs(ne,{visible:Ie,onClose:()=>Me(!1),size:"xl",backdrop:"static",children:[e.jsx(ae,{children:e.jsx(re,{children:((ss=c.find(s=>s.id===R))==null?void 0:ss.is_fixed_bid)==1?"Fixed Bid Invoice":"Advance Invoice"})}),e.jsx(ie,{style:{overflowY:"visible",padding:0},children:e.jsx(ks,{paymentId:R})})]}),e.jsxs(ne,{visible:N,onClose:()=>L(!1),children:[e.jsx(ae,{children:e.jsxs(re,{children:["Add Repayment - ",D]})}),e.jsxs(ie,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total :"})," ₹",Je.toFixed(2)]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Advance Paid:"})," ",e.jsxs("span",{className:"text-success",children:["₹",O.toFixed(2)]})]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Paid :"})," ",e.jsxs("span",{className:"text-success",children:["₹",Xe.toFixed(2)]})]}),e.jsxs("p",{className:"mb-3",children:[e.jsx("strong",{children:"Remaining :"})," ",e.jsxs("span",{className:"text-danger",children:["₹",te.toFixed(2)]})]}),e.jsx("hr",{}),te>0?e.jsx(e.Fragment,{children:O>0&&O<=te?e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheck",checked:U,onChange:s=>me(s.target.checked)}),e.jsxs("label",{className:"form-check-label",htmlFor:"useAdvanceCheck",children:["Clear from Advance (₹",O.toFixed(2),")"]})]}),e.jsx("label",{className:"form-label",children:"Additional Amount"}),e.jsx(He,{type:"number",placeholder:"Enter additional amount",value:G,onChange:s=>K(s.target.value),min:"0"}),e.jsxs("div",{className:"mt-2 text-end",children:[e.jsx("strong",{children:"Total Payment: "}),"₹",((U?O:0)+(Number(G)||0)).toFixed(2)]})]}):e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(He,{type:"number",placeholder:"Enter amount to pay",value:G,onChange:s=>K(s.target.value),min:"0"})]})}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]}),e.jsxs(Ze,{children:[e.jsx(f,{color:"secondary",onClick:()=>{L(!1),me(!1),K("")},children:"Cancel"}),e.jsx(f,{color:"primary",onClick:hs,disabled:te<=0,children:"Submit"})]})]}),e.jsxs(ne,{visible:X,onClose:()=>Se(!1),size:"lg",children:[e.jsx(ae,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx(re,{children:"Payment History"}),e.jsxs(f,{color:"success",size:"sm",className:"me-4",onClick:us,title:"Download History PDF",children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})]})}),e.jsx(ie,{children:E.filter(s=>(s==null?void 0:s.invoice_id)===$).length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(he,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(ue,{color:"dark",children:e.jsxs(p,{children:[e.jsx(d,{children:"Date"}),e.jsx(d,{children:"Paid"}),e.jsx(d,{children:"Remaining"}),e.jsx(d,{children:"Remark"})]})}),e.jsx(pe,{children:E.filter(s=>(s==null?void 0:s.invoice_id)===$).map((s,i)=>e.jsxs(p,{children:[e.jsx(a,{children:s!=null&&s.date?s.date.slice(0,10).split("-").reverse().join("-"):""}),e.jsxs(a,{children:["₹",s.payment]}),e.jsxs(a,{children:["₹",s.remaining]}),e.jsx(a,{children:s.remark})]},i))})]})}):e.jsx("div",{className:"text-center py-4 text-muted",children:e.jsx("p",{className:"mb-0",children:"No payment history found for this invoice."})})})]}),e.jsxs(ne,{visible:ke,onClose:()=>Z(!1),children:[e.jsx(ae,{closeButton:!0,children:e.jsx(re,{children:"Make Payment"})}),e.jsx(ie,{children:h&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice:"})," ",h.invoice_number]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Total:"})," ₹",h.total]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Remaining:"})," ₹",h.total-h.paid_amount]}),h.total-h.paid_amount>0?e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"form-label fw-semibold",children:"Amount to Pay"}),e.jsx("input",{type:"number",className:"form-control",value:T,onChange:s=>Ae(s.target.value),min:"1",max:h.total-h.paid_amount}),e.jsx("label",{className:"form-label fw-semibold",children:"Remark"}),e.jsx("input",{type:"text",className:"form-control",value:ye,onChange:s=>Fe(s.target.value)})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]})}),e.jsxs(Ze,{children:[e.jsx(f,{color:"secondary",onClick:()=>Z(!1),children:"Cancel"}),e.jsx(f,{color:"success",onClick:()=>{if(!T||Number(T)<=0)return m("danger","Enter a valid amount");const s=Number(h.total)-Number(h.paid_amount);if(Number(T)>s)return m("danger","Amount cannot be greater than remaining amount");xs()},children:"Confirm"})]})]}),e.jsxs(ne,{visible:q,onClose:()=>le(!1),size:"xl",backdrop:"static",children:[e.jsx(ae,{children:e.jsx(re,{children:"Invoice"})}),e.jsx(ie,{style:{overflowY:"visible",padding:0},children:e.jsx(Ss,{projectId:R,inModal:!0})})]}),e.jsxs(ne,{visible:Q,onClose:()=>{$e(!1),x(null)},size:"lg",children:[e.jsx(ae,{children:e.jsxs(re,{children:["Additional Charges - ",t==null?void 0:t.invoice_number]})}),e.jsx(ie,{children:t!=null&&t.additionalCharges&&t.additionalCharges.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(he,{striped:!0,bordered:!0,children:[e.jsx(ue,{children:e.jsxs(p,{children:[e.jsx(d,{children:"Charge Type"}),e.jsx(d,{children:"Amount"}),e.jsx(d,{children:"Paid"}),e.jsx(d,{children:"Status"}),e.jsx(d,{children:"Remark"})]})}),e.jsx(pe,{children:t.additionalCharges.map((s,i)=>e.jsxs(p,{children:[e.jsx(a,{children:Ee(s.charge_type)}),e.jsxs(a,{className:"text-end",children:["₹",Number(s.amount).toFixed(2)]}),e.jsxs(a,{className:"text-end text-success fw-bold",children:["₹",Number(s.paid_amount||0).toFixed(2)]}),e.jsx(a,{children:e.jsx(je,{color:s.is_paid?"success":"warning",children:s.is_paid?"Paid":"Pending"})}),e.jsx(a,{children:s.remark||"-"})]},s.id))})]})}):e.jsx("p",{className:"text-muted text-center",children:"No additional charges"})})]})]})};export{et as default};

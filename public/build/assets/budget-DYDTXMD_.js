import{r as n,j as e,C as K}from"./index-BaKPF3hP.js";import{a as C,p as q}from"./api-BUyL__Lx.js";import{w as X}from"./Feilds-DKJTpBq7.js";import{C as Z}from"./RawMaterial-DIyWLHr3.js";import{C as ee,a as re}from"./CCardBody-Bpstl35x.js";import{C as te}from"./CCardHeader-OSRubUci.js";import{C as se}from"./CForm-BXYYZIho.js";import{a as D,b as i,d as k}from"./index.esm-CRoUjgbY.js";import{C as h}from"./CFormLabel-iZrPyIV3.js";import{C as N}from"./CInputGroup-c1sy1IOI.js";import{C as p}from"./CFormInput-CSQWz8L4.js";import{C as A}from"./CInputGroupText-BhGEeTBd.js";import{C as z}from"./CFormSelect-C8xzhP0i.js";import"./CFormControlWrapper-Cr88R6Rg.js";import"./CFormControlValidation-D8zRnrfC.js";const ye=()=>{const[ae,B]=n.useState([]),[Q,I]=n.useState([]),[oe,E]=n.useState(!1),[F,W]=n.useState(!1),[v,P]=n.useState({show:!1,message:"",color:""}),[j,b]=n.useState(null),[o,f]=n.useState({projectName:"",projectId:"",budget:"",projectAmount:"",startDate:"",endDate:"",workPlace:""}),[V,w]=n.useState([]),[g,S]=n.useState(""),[G,_]=n.useState(!1),[l,u]=n.useState([{operator:"",workType:"",points:0,rate:0}]),d=(r,t="success")=>{P({show:!0,message:r,color:t}),setTimeout(()=>P({show:!1,message:"",color:""}),5e3)},T=n.useCallback(async()=>{try{E(!0);const r=await C("/api/budgets");B(r||[])}catch(r){console.error("Error fetching budgets:",r),d("Failed to fetch budgets","danger"),B([])}finally{E(!1)}},[]),L=n.useCallback(async r=>{try{const t=await C(`/api/projects?searchQuery=${r}`);w(t||[])}catch(t){console.error("Error fetching projects:",t),w([])}},[]),O=n.useCallback(async()=>{try{const r=await C("/api/vendors");if(!r)throw new Error("Failed to fetch vendors");I(r)}catch(r){console.error("Error fetching vendors:",r),I([])}},[]);n.useEffect(()=>{O(),T()},[O,T]),n.useEffect(()=>{const r=setTimeout(()=>{g&&g.length>2?L(g):w([])},300);return()=>clearTimeout(r)},[g,L]),n.useEffect(()=>{const r=l.reduce((t,s)=>t+Number(s.points||0)*Number(s.rate||0),0);f(t=>({...t,budget:r.toString()}))},[l]);const R=(V||[]).filter(r=>((r==null?void 0:r.project_name)||"").toLowerCase().includes(g.toLowerCase())),x=r=>{f({...o,[r.target.name]:r.target.value})},H=async r=>{try{const t=[{operator:"",workType:"",points:0,rate:0}];u(t),f(a=>({...a,projectId:r.id,projectName:r.project_name,projectAmount:r.project_cost||"",startDate:r.start_date?r.start_date.split("T")[0]:"",endDate:r.end_date?r.end_date.split("T")[0]:"",workPlace:r.work_place||""}));const s=await C(`/api/budgets?project_id=${r.id}`);if(s&&s.length>0){const a=s[0];if(b(a.id),a.works&&a.works.length>0){const m=a.works.map(c=>{var $;return{operator:(($=c.operator_id)==null?void 0:$.toString())||"",workType:c.work_type||"",points:c.points||0,rate:c.rate||0}});u(m)}f(m=>{var c;return{...m,budget:((c=a.budget)==null?void 0:c.toString())||""}})}else b(null),u(t)}catch(t){console.error("Error fetching project budget:",t),b(null),u([{operator:"",workType:"",points:0,rate:0}])}S(r.project_name),w([]),_(!1)},U=()=>{f({projectName:"",projectId:"",budget:"",projectAmount:"",startDate:"",endDate:"",workPlace:""}),S(""),_(!1),b(null),u([{operator:"",workType:"",points:0,rate:0}])},y=(r,t,s)=>{const a=[...l];a[r][t]=s,u(a)},M=()=>{u([...l,{operator:"",workType:"",points:0,rate:0}])},Y=r=>{if(l.length>1){const t=[...l];t.splice(r,1),u(t)}},J=async()=>{var t,s;if(!o.projectName.trim()){d("Project name is required.","warning");return}if(!o.budget){d("Budget is required.","warning");return}if(!o.projectAmount){d("Project amount is required.","warning");return}if(l.some(a=>!a.operator)){d("Please select a vendor for all work entries.","warning");return}if(l.some(a=>!a.workType)){d("Please select a work type for all work entries.","warning");return}if(l.some(a=>!a.points||a.points<=0)){d("Points must be greater than 0 for all work entries.","warning");return}if(l.some(a=>!a.rate||a.rate<=0)){d("Rate must be greater than 0 for all work entries.","warning");return}if(l.reduce((a,m)=>a+Number(m.points||0)*Number(m.rate||0),0)>Number(o.projectAmount)){d("Total work cost cannot exceed the project amount.","danger");return}try{W(!0);const a={project_id:o.projectId||null,project_name:o.projectName,budget:parseFloat(o.budget),project_amount:parseFloat(o.projectAmount),start_date:o.startDate||null,end_date:o.endDate||null,work_place:o.workPlace||null,works:l.map(c=>({operator:parseInt(c.operator),workType:c.workType,points:parseInt(c.points),rate:parseFloat(c.rate)}))};let m;j?(m=await q(`/api/budgets/${j}`,a,"PUT"),d("Budget updated successfully!","success")):(m=await q("/api/budgets",a),d("Budget created successfully!","success")),U(),T()}catch(a){console.error("Error saving budget:",a),d(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to save budget. Please try again.","danger")}finally{W(!1)}};return e.jsxs("div",{className:"",children:[v.show&&e.jsx(Z,{color:v.color,dismissible:!0,onClose:()=>P({show:!1,message:"",color:""}),children:v.message}),e.jsxs(ee,{className:"border-grey rounded-3",children:[e.jsx(te,{className:"bg-primary bg-gradient text-white fw-semibold fs-5 rounded-top-3 p-2",children:j?"Update Budget":"Budget"}),e.jsx(re,{className:"p-4",children:e.jsxs(se,{children:[e.jsxs(D,{className:"g-3 mb-4",children:[e.jsxs(i,{md:6,children:[e.jsx(h,{className:"fw-medium text-dark",children:"Project Name *"}),e.jsxs(N,{children:[e.jsx(p,{type:"text",value:g,onChange:r=>{S(r.target.value),_(!0)},placeholder:"Search for a project...",className:"rounded-2 border-grey"}),o.projectName&&e.jsx(k,{type:"button",color:"danger",variant:"outline",onClick:U,className:"rounded-2",children:"✕"})]}),G&&R.length>0&&e.jsx("div",{className:"border rounded bg-white mt-1 shadow-sm",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,width:"calc(100% - 30px)"},children:R.map(r=>e.jsxs("div",{className:"p-2 border-bottom cursor-pointer hover-bg-light",style:{cursor:"pointer"},onClick:()=>H(r),onMouseEnter:t=>t.target.style.backgroundColor="#f8f9fa",onMouseLeave:t=>t.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium",children:r.project_name}),r.project_cost&&e.jsxs("small",{className:"text-muted",children:["Amount: ₹",r.project_cost]})]},r.id))})]}),e.jsxs(i,{md:3,children:[e.jsx(h,{className:"fw-medium text-dark",children:"Project Amount *"}),e.jsxs(N,{children:[e.jsx(A,{children:"₹"}),e.jsx(p,{name:"projectAmount",type:"number",value:o.projectAmount,onChange:x,className:"rounded-2 border-grey",readOnly:!!o.projectId})]})]}),e.jsxs(i,{md:3,children:[e.jsx(h,{className:"fw-medium text-dark",children:"Budget *"}),e.jsxs(N,{children:[e.jsx(A,{children:"₹"}),e.jsx(p,{name:"budget",type:"number",value:o.budget,onChange:x,className:"rounded-2 border-grey",readOnly:!0})]})]})]}),e.jsxs(D,{className:"g-3 mb-4",children:[e.jsxs(i,{md:4,children:[e.jsx(h,{className:"fw-medium text-dark",children:"Work Place"}),e.jsx(p,{name:"workPlace",value:o.workPlace,onChange:x,className:"rounded-2 border-grey",readOnly:!!o.projectId})]}),e.jsxs(i,{md:4,children:[e.jsx(h,{className:"fw-medium text-dark",children:"Start Date"}),e.jsx(p,{type:"date",name:"startDate",value:o.startDate,onChange:x,className:"rounded-2 border-grey",readOnly:!!o.projectId})]}),e.jsxs(i,{md:4,children:[e.jsx(h,{className:"fw-medium text-dark",children:"End Date"}),e.jsx(p,{type:"date",name:"endDate",value:o.endDate,onChange:x,className:"rounded-2 border-grey",readOnly:!!o.projectId})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),l.map((r,t)=>e.jsxs(D,{className:"g-3 mb-3 align-items-center",children:[e.jsx(i,{md:3,children:e.jsxs(z,{value:r.operator,onChange:s=>y(t,"operator",s.target.value),className:"rounded-2 border-grey",children:[e.jsx("option",{value:"",children:"Select Vendor"}),Q.map(s=>e.jsxs("option",{value:s.id,children:[s.name," ",s.gst_no?`(${s.gst_no})`:""]},s.id))]})}),e.jsx(i,{md:3,children:e.jsxs(z,{value:r.workType,onChange:s=>y(t,"workType",s.target.value),className:"rounded-2 border-grey",children:[e.jsx("option",{value:"",children:"Select Work Type"}),X.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]})}),e.jsx(i,{md:2,children:e.jsx(p,{type:"number",value:r.points,onChange:s=>y(t,"points",s.target.value),placeholder:"Points",className:"rounded-2 border-grey",min:"1"})}),e.jsx(i,{md:2,children:e.jsxs(N,{children:[e.jsx(A,{children:"₹"}),e.jsx(p,{type:"number",value:r.rate,onChange:s=>y(t,"rate",s.target.value),placeholder:"Rate",className:"rounded-2 border-grey",min:"0.01",step:"0.01"})]})}),e.jsx(i,{md:1,className:"d-flex align-items-center",children:e.jsxs("span",{className:"text-success fw-medium",children:["₹",(r.points||0)*(r.rate||0)]})}),e.jsx(i,{md:1,className:"d-flex align-items-center",children:e.jsx(k,{color:"danger",size:"sm",shape:"rounded-pill",className:"shadow-sm",onClick:()=>Y(t),disabled:l.length===1,children:"×"})})]},t)),e.jsx(k,{color:"warning",variant:"outline",className:"mb-4 rounded-pill shadow-sm px-4",onClick:M,children:"+ Add Work"}),e.jsx("div",{className:"mt-3",children:e.jsx(k,{color:"primary",className:"bg-gradient rounded-pill shadow-sm px-5 py-2 me-2",onClick:J,disabled:F,children:F?e.jsxs(e.Fragment,{children:[e.jsx(K,{size:"sm",className:"me-2"}),j?"Updating...":"Creating..."]}):j?"Update Budget":"Create Budget"})})]})})]})]})};export{ye as default};

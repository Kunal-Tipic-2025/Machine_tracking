import{r as n,R as Ns,j as e,C as le,b as ys}from"./index-Cn-F0xzs.js";import{d as N,c as de,a as J,b}from"./index.esm-7oL-v0Yv.js";import{a as I,g as Re,h as Xe}from"./api-BUyL__Lx.js";import{g as cs,h as vs}from"./InvoiceMulPdf-CBAT1nm_.js";import{C as Ee,a as He}from"./CCardBody-OOd8gb1I.js";import{C as Oe}from"./CCardHeader-NWf5yg3Z.js";import{C as fe,j as _s,a as ae,b as re,e as ie,c as ce,d as Ze}from"./DefaultLayout-pwnRm339.js";import{C as ws}from"./RawMaterial-BsLkniud.js";import{C as je,a as pe,b as p,c as o,d as ge,e as r}from"./CTable-9p6lbBYR.js";import{C as Cs}from"./CInputGroup-DPH3SzoJ.js";import{C as Ps}from"./CInputGroupText-BvWBaOqj.js";import{C as Fe}from"./CFormInput-CwIxlT0b.js";import{C as Je}from"./CTooltip-Cau8QI0S.js";import{c as Fs}from"./cil-money-Dk3vHnQB.js";import{c as ks}from"./cil-history-D-FQjjfl.js";import"./jspdf.es.min-C3mgcsZZ.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-8JWznpb2.js";import"./CFormControlWrapper-CeeeRFXe.js";import"./CFormControlValidation-P5rV7dKb.js";import"./CFormLabel-Dk6nlh4k.js";import"./getTransitionDurationFromElement-Cpu4p4hx.js";var ze=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='272 434.744 272 209.176 240 209.176 240 434.744 188.118 382.862 165.49 405.489 256 496 346.51 405.489 323.882 382.862 272 434.744' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M400,161.176c0-79.4-64.6-144-144-144s-144,64.6-144,144a96,96,0,0,0,0,192h80v-32H112a64,64,0,0,1,0-128h32v-32a112,112,0,0,1,224,0v32h32a64,64,0,0,1,0,128H320v32h80a96,96,0,0,0,0-192Z' class='ci-primary'/>"];const As=({projectId:h,inModal:c=!1})=>{const[a,be]=n.useState([]),[B,K]=n.useState(!0),[T,oe]=n.useState([]),[$,G]=n.useState({show:!1,message:"",type:"success"}),[g,M]=n.useState([]),[R,V]=n.useState(!1),[Q,me]=n.useState(!1),[L,ee]=n.useState([]),[_,Y]=n.useState(!1);n.useState(null),n.useState(null),n.useState(!1);const[A,Ne]=n.useState([]),[se,ke]=n.useState([]),[W,Be]=n.useState([]),[Ae,te]=n.useState(!1),[x,Le]=n.useState([]),[E,xe]=n.useState([]);n.useEffect(()=>{(async()=>{try{const u=await I("/api/workingType");xe(u||[])}catch(u){console.error("Error fetching work types",u)}})()},[]);const We=Ns.useMemo(()=>{const t={};return E.forEach(u=>{t[u.id]=u.type_of_work}),t},[E]),Se=async()=>{try{const t=await I("/api/machine-operators");console.log("machineries",t),Ne(t||[])}catch(t){console.error("Error fetching machineries:",t)}},Ue=async()=>{try{const t=await I("/api/machineLog");ke(t||[])}catch(t){console.error("Error fetching machine logs:",t)}};n.useEffect(()=>{if(a!=null&&a.worklog_ids&&se.length>0){const t=se.filter(u=>a.worklog_ids.includes(u.id));Be(t),console.log("Filtered Logs:",t)}},[a,se]);const ye=async()=>{try{K(!0);const t=await I(`/api/project-payments/${h}`);if(console.log(t),be(t),t!=null&&t.invoice_number){const u=await I(`/api/invoice-additional-charges/${t.invoice_number}`);Le(u||[]),console.log("Additional Charges:",u)}}catch(t){console.error("Error fetching orders:",t),q("Failed to fetch orders","danger")}finally{K(!1)}},ve=()=>{I("/api/operatorsByCompanyIdOperator").then(t=>{console.log(t),ee(t)}).catch(t=>{console.log(t.message)})};n.useEffect(()=>{ye()},[h]),n.useEffect(()=>{Ue(),ve(),Se(),y()},[]);const q=(t,u="success")=>{G({show:!0,message:t,type:u}),setTimeout(()=>G({show:!1,message:"",type:"success"}),5e3)},y=async()=>{try{const t=await I("/api/machine-price");oe(t)}catch(t){console.error("Error fetching machine price:",t)}},w=async()=>{if(g.length===0){q("Please select at least one work order to download","warning");return}V(!0);try{await generateWorkOrdersPDF(g),q(`PDF generated successfully for ${g.length} work order(s)`,"success"),M([])}catch(t){console.error("Error generating PDF:",t),q("Failed to generate PDF. Please try again.","danger")}finally{V(!1)}},De=()=>{Y(!0)},_e=async()=>{var t,u,C,ne,O;if(!(!a||Object.keys(a).length===0))try{te(!0);const f=(t=Re())==null?void 0:t.company_info;if(!f){$("Company information not found. Please log in again.");return}const Ge=Ie(a.created_at),we={invoice_number:a.invoice_number,date:Ge,name:((u=a.project)==null?void 0:u.customer_name)||"N/A",address:((C=a.project)==null?void 0:C.work_place)||"",mobile:((ne=a.project)==null?void 0:ne.mobile_number)||"",gst_number:((O=a.project)==null?void 0:O.gst_number)||"",consignee:{name:f.company_name,address:`${f.land_mark||""}, ${f.Tal||""}, ${f.Dist||""}, ${f.pincode||""}`,phone_no:f.phone_no,gst_number:f.gst_number,email_id:f.email_id},totalAmount:j,amountPaid:S,finalAmount:j,baseTotal:X,additionalChargesTotal:D,additionalCharges:x,paymentMode:a.payment_mode,transaction_id:a.transaction_id,is_fixed_bid:a.is_fixed_bid==1,is_advance:a.is_advance==1,remark:a.remark},Ce=W.map(he=>({id:he.id,data:he}));await cs(we,Ce,L,A,T,Ce,"english","save",We)}catch(f){console.error("Error generating PDF:",f),$("Failed to generate PDF. Please try again.")}finally{te(!1)}},Ie=t=>t?new Date(t).toLocaleDateString("en-GB"):"",Me=t=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[t]||t;if(B)return e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})});if(!a||Object.keys(a).length===0)return e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No invoice data found."})});const D=x.reduce((t,u)=>t+Number(u.amount||0),0),X=Number((a==null?void 0:a.work_order_amount)||(a==null?void 0:a.base_total)||0),j=Number((a==null?void 0:a.grand_total)||(a==null?void 0:a.total)||X+D),S=Number((a==null?void 0:a.paid_amount)||0),H=Number((a==null?void 0:a.remaining)!==void 0?a.remaining:j-S),Te=H<=.01;return e.jsx("div",{className:"p-4",children:e.jsxs(Ee,{children:[e.jsx(Oe,{className:"bg-primary text-white",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Details"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(fe,{color:Te?"success":"warning",className:"fs-6 px-3 py-2 rounded-pill",children:Te?"✔️ Completed":"⏳ Pending"}),e.jsx(N,{color:"success",size:"sm",onClick:_e,disabled:Ae||!a,children:Ae?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})})]})]})}),e.jsxs(He,{children:[e.jsxs(J,{className:"mb-4",children:[e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Invoice Number:"}),e.jsx("div",{className:"text-muted",children:a.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Date:"}),e.jsx("div",{className:"text-muted",children:Ie(a.created_at)})]})]}),e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Payment Mode:"}),e.jsx("div",{className:"text-muted",children:a.payment_mode||"-"})]}),a.transaction_id&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Transaction ID:"}),e.jsx("div",{className:"text-muted",children:a.transaction_id})]}),a.project&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Customer:"}),e.jsx("div",{className:"text-muted",children:a.project.customer_name||"-"})]})]})]}),!c&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:g.length>0&&e.jsxs("span",{className:"text-muted small",children:[g.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(N,{color:"primary",onClick:w,disabled:g.length===0||R,className:"d-flex align-items-center",size:"sm",children:R?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),g.length>0&&` (${g.length})`]})}),e.jsx(N,{color:"success",onClick:De,disabled:Q,className:"d-flex align-items-center",size:"sm",children:Q?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:_s,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),$.show&&e.jsx(ws,{color:$.type,dismissible:!0,onClose:()=>G({show:!1,message:"",type:"success"}),children:$.message}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto",overflowX:"auto",borderRadius:"6px"},children:e.jsxs(je,{striped:!0,bordered:!0,hover:!0,className:"mb-0",children:[e.jsx(pe,{style:{position:"sticky",top:0,zIndex:2,backgroundColor:"#f8f9fa",boxShadow:"0 2px 3px rgba(0,0,0,0.05)"},children:e.jsxs(p,{children:[e.jsx(o,{children:"Sr no."}),e.jsx(o,{children:"Work Date"}),e.jsx(o,{children:"Machine"}),e.jsx(o,{children:"Mode"}),e.jsx(o,{children:"Operator"}),e.jsx(o,{children:"Work Type"}),e.jsx(o,{children:"Start Reading"}),e.jsx(o,{children:"End Reading"}),e.jsx(o,{children:"Net Reading"}),e.jsx(o,{children:"Price Per Hour"}),e.jsx(o,{className:"text-end",children:"Total Price"})]})}),e.jsxs(ge,{children:[W.length>0?W.map((t,u)=>{var C,ne,O;return e.jsxs(p,{children:[e.jsx(r,{children:u+1}),e.jsx(r,{children:(t==null?void 0:t.work_date)||"-"}),e.jsx(r,{children:((C=A.find(f=>String(f.id)===String(t==null?void 0:t.machine_id)))==null?void 0:C.machine_name)||"N/A"}),e.jsx(r,{children:((ne=T.find(f=>f.id===Number(t.mode_id)))==null?void 0:ne.mode)||"-"}),e.jsx(r,{children:((O=L.find(f=>f.id===Number(t==null?void 0:t.operator_id)))==null?void 0:O.name)||"Unknown Operator"}),e.jsx(r,{children:We[t==null?void 0:t.work_type_id]||"—"}),e.jsx(r,{children:(t==null?void 0:t.start_reading)||"-"}),e.jsx(r,{children:(t==null?void 0:t.end_reading)||"-"}),e.jsx(r,{children:t!=null&&t.end_reading&&(t!=null&&t.start_reading)?t.end_reading-t.start_reading:"-"}),e.jsxs(r,{children:["₹",(t==null?void 0:t.price_per_hour)||"0"]}),e.jsxs(r,{className:"text-end",children:["₹",t!=null&&t.end_reading&&(t!=null&&t.start_reading)&&(t!=null&&t.price_per_hour)?((t.end_reading-t.start_reading)*t.price_per_hour).toFixed(2):"0.00"]})]},t.id)}):e.jsx(p,{children:e.jsx(r,{colSpan:10,className:"text-center text-muted py-4",children:"No work orders found for this invoice."})}),x&&x.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(p,{style:{backgroundColor:"#f0f8ff"},children:e.jsx(r,{colSpan:11,className:"fw-bold text-primary",children:"Additional Charges"})}),x.map((t,u)=>e.jsxs(p,{style:{backgroundColor:"#f8f9fa"},children:[e.jsx(r,{children:W.length+u+1}),e.jsx(r,{children:t.date?new Date(t.date).toLocaleDateString("en-GB"):"-"}),e.jsxs(r,{colSpan:7,children:[e.jsx("strong",{children:Me(t.charge_type)}),t.remark&&e.jsxs("div",{className:"small text-muted mt-1",children:["Note: ",t.remark]})]}),e.jsx(r,{className:"text-center",children:e.jsx(fe,{color:t.is_paid?"success":"warning",children:t.is_paid?"Paid":"Pending"})}),e.jsxs(r,{className:"text-end fw-bold",children:["₹",Number(t.amount).toFixed(2)]})]},`charge-${t.id}`))]}),x.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(p,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Work Orders Subtotal"}),e.jsxs(r,{className:"text-end",children:["₹",X.toFixed(2)]})]}),e.jsxs(p,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Additional Charges Total"}),e.jsxs(r,{className:"text-end",children:["₹",D.toFixed(2)]})]})]}),e.jsxs(p,{className:"fw-bold bg-primary text-white",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Grand Total"}),e.jsxs(r,{className:"text-end",children:["₹",j.toFixed(2)]})]}),e.jsxs(p,{className:"bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Paid Amount"}),e.jsxs(r,{className:"text-end text-success",children:["₹",S.toFixed(2)]})]}),e.jsxs(p,{className:"fw-bold bg-light",children:[e.jsx(r,{colSpan:10,className:"text-end",children:"Remaining Amount"}),e.jsxs(r,{className:`text-end ${H>0?"text-danger":"text-success"}`,children:["₹",H.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"mt-4 p-3 bg-light rounded",children:[e.jsxs(J,{className:"w-100",children:[e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Total Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold",children:["₹",j.toFixed(2)]})]})}),e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Paid Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold text-success",children:["₹",S.toFixed(2)]})]})}),e.jsx(b,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Remaining:"}),e.jsxs("span",{className:`fs-5 fw-bold ${H>0?"text-danger":"text-success"}`,children:["₹",H.toFixed(2)]})]})})]}),a.payment_mode&&e.jsx("div",{className:"mt-2 pt-2 border-top",children:e.jsxs("div",{className:"",children:[e.jsx("span",{className:"fw-bold me-2",children:"Payment Mode:"}),e.jsx(fe,{color:"info",className:"fs-6",children:a.payment_mode})]})})]})]})]})})},Ss=({paymentId:h})=>{const[c,a]=n.useState(null),[be,B]=n.useState(!0),[K,T]=n.useState(!1);n.useEffect(()=>{h&&oe()},[h]);const oe=async()=>{try{B(!0);const g=await I(`/api/project-payments/${h}`);a(g)}catch(g){console.error("Error fetching advance payment:",g)}finally{B(!1)}},$=g=>g?new Date(g).toLocaleDateString("en-GB"):"",G=async()=>{var g,M,R,V,Q,me,L,ee;if(c)try{T(!0);const _=(g=Re())==null?void 0:g.company_info;if(!_){alert("Company information not found. Please log in again.");return}const Y=$(c.created_at),A=c.is_fixed_bid==1,Ne=!A,se={invoice_number:c.invoice_number,date:Y,customer:{name:((M=c.project)==null?void 0:M.customer_name)||"N/A",address:((R=c.project)==null?void 0:R.work_place)||"",mobile:((V=c.project)==null?void 0:V.mobile_number)||"",gst_number:((Q=c.project)==null?void 0:Q.gst_number)||""},consignee:{name:_.company_name,address:`${_.land_mark||""}, ${_.Tal||""}, ${_.Dist||""}, ${_.pincode||""}`,phone_no:_.phone_no,gst_number:_.gst_number,email_id:_.email_id},totalAmount:c.total,amountPaid:c.paid_amount,finalAmount:c.total,paymentMode:c.payment_mode||(A?"Fixed Bid":"Advance"),transaction_id:c.transaction_id,is_fixed_bid:A,is_advance:Ne,remark:c.remark,name:((me=c.project)==null?void 0:me.customer_name)||"N/A",address:((L=c.project)==null?void 0:L.work_place)||"",mobile:((ee=c.project)==null?void 0:ee.mobile_number)||"",total:c.total};await cs(se,[],[],[],[],[],"english","save")}catch(_){console.error("Error generating PDF:",_),alert("Failed to generate PDF. Please try again.")}finally{T(!1)}};return be?e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(le,{color:"primary"})}):c?e.jsx("div",{className:"p-4",children:e.jsxs(Ee,{children:[e.jsxs(Oe,{className:"bg-warning text-dark d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:c.is_fixed_bid==1?"Fixed Bid Invoice":"Advance Payment Invoice"}),e.jsx(N,{color:"success",size:"sm",onClick:G,disabled:K||!c,children:K?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})})]}),e.jsxs(He,{children:[e.jsxs(J,{className:"mb-4",children:[e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Invoice Number:"})," ",e.jsx("span",{className:"text-muted",children:c.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Date:"})," ",e.jsx("span",{className:"text-muted",children:$(c.created_at)})]})]}),e.jsxs(b,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Payment Mode:"})," ",e.jsx("span",{className:"text-muted",children:c.payment_mode||(c.is_fixed_bid==1?"Fixed Bid":"Advance")})]}),c.transaction_id&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Transaction ID:"})," ",e.jsx("span",{className:"text-muted",children:c.transaction_id})]})]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(p,{children:[e.jsx(o,{children:"Description"}),e.jsx(o,{className:"text-end",children:"Amount"}),e.jsx(o,{className:"text-end",children:"Remaining"})]})}),e.jsxs(ge,{children:[e.jsxs(p,{children:[e.jsxs(r,{children:[e.jsx("strong",{children:c.is_fixed_bid==1?"Fixed Bid Work":"Advance Payment"}),c.remark&&e.jsx("div",{className:"text-muted small mt-1",children:c.remark})]}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-success",children:["₹",Number(c.total||0).toFixed(2)]})}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-danger",children:["₹",(Number(c.total||0)-Number(c.paid_amount||0)).toFixed(2)]})})]}),e.jsxs(p,{children:[e.jsx(r,{colSpan:2,children:e.jsx("strong",{children:"Total Paid Amount"})}),e.jsx(r,{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["₹",Number(c.paid_amount||0).toFixed(2)]})})]})]})]})}),e.jsx("div",{className:"mt-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Payment Mode:"}),e.jsx("span",{className:"badge bg-info fs-6 ms-2",children:c.payment_mode||(c.is_fixed_bid==1?"Fixed Bid":"Advance")})]})}),c.project&&e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Cust. Name :"}),e.jsx("span",{className:"text-muted ms-2",children:c.project.customer_name||"-"})]})})]})})]})]})}):e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No payment data found."})})},Ds=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-eye",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}),e.jsx("path",{d:"M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"})]}),tt=()=>{var es,ss;const{showToast:h}=ys(),c=(es=Re())==null?void 0:es.company_id;if(!c)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[a,be]=n.useState([]),[B,K]=n.useState(""),[T,oe]=n.useState(""),[$,G]=n.useState(""),[g,M]=n.useState(!1),[R,V]=n.useState(null),[Q,me]=n.useState(!1),[L,ee]=n.useState(null),[_,Y]=n.useState(!1);n.useState("");const[A,Ne]=n.useState(null),[se,ke]=n.useState(!1),[W,Be]=n.useState([]),[Ae,te]=n.useState(!1),[x,Le]=n.useState(null),[E,xe]=n.useState(""),[We,Se]=n.useState(""),[Ue,ye]=n.useState(!1),[ve,q]=n.useState(""),[y,w]=n.useState(""),[De,_e]=n.useState([]);n.useState(!1);const[Ie,Me]=n.useState(!1),[D,X]=n.useState(""),[j,S]=n.useState(!1);n.useState(""),n.useState([]);const[H,Te]=n.useState([]),[t,u]=n.useState(!1),[C,ne]=n.useState(null),O=async()=>{M(!0);try{const s=await I(`/api/project-payments?company_id=${c}`);be(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{M(!1)}},f=async()=>{M(!0);try{const s=await I("/api/project-wise-hours");Te(s.project_wise_hours||[]),console.log("machine hourse",s.project_wise_hours)}catch(s){h("danger","Error fetching Hours: "+((s==null?void 0:s.message)||s))}finally{M(!1)}},Ge=async()=>{try{const s=await I("/api/projects");if(!Array.isArray(s)){_e([]);return}const i={};s.forEach(l=>{var m;if(l.company_id!==c)return;const d=(m=l.customer_name)==null?void 0:m.trim();d&&(i[d]||(i[d]={name:d,mobile:l.mobile_number||"",projects:[]}),i[d].projects.push({id:l.id,company_id:l.company_id}))}),_e(Object.values(i))}catch(s){console.error(s),_e([])}},we=async()=>{if(A){M(!0);try{const s=await I(`/api/repayments?company_id=${c}&project_id=${A}`);Be(Array.isArray(s)?s:[])}catch(s){h("danger","Error fetching history: "+((s==null?void 0:s.message)||s))}finally{M(!1)}}};n.useEffect(()=>{O(),Ge(),f()},[c]),n.useEffect(()=>{A&&we()},[A,c]);const Ce=s=>s?new Date(s).toLocaleDateString("en-GB"):"",he=s=>`₹${Number(s||0).toFixed(2)}`,ls=s=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[s]||s,Ke=n.useMemo(()=>a.filter(s=>s.company_id===c),[a,c]),ds=n.useMemo(()=>{const s={};return H.forEach(i=>{s[Number(i.project_id)]=Number(i.total_hours||0)}),s},[H]),os=n.useMemo(()=>H.reduce((s,i)=>s+Number(i.total_hours||0),0),[H]),ms=s=>[...new Set(s.map(l=>{var d;return(d=l.project)==null?void 0:d.id}).filter(Boolean))].reduce((l,d)=>l+(ds[d]||0),0),$e=n.useMemo(()=>{const s={};if(Ke.forEach(i=>{var d;const l=((d=i.project)==null?void 0:d.customer_name)||"Unknown";s[l]||(s[l]=[]),s[l].push(i)}),T){const i=T.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([l])=>l.toLowerCase().includes(i)))}return s},[Ke,T]),Pe=n.useMemo(()=>{const s=Object.values($e),i=s.flat(),l=i.filter(F=>!F.is_advance),d=s.length,m=i.length,v=l.reduce((F,U)=>F+Number(U.total||0),0),Z=l.reduce((F,U)=>F+Number(U.paid_amount||0),0),ue=v-Z;return{customerCount:d,totalInvoices:m,totalBilled:v,totalPaid:Z,totalOutstanding:ue}},[$e]);if(g&&!a.length)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(le,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading project payments..."})]});const xs=async()=>{if(!x)return;const s=Number(E)||0,i=j&&Number(y)||0,l=s+i,d=Number(x.total)-Number(x.paid_amount);if(l<=0)return h("danger","Total payment must be greater than 0");if(l>d+.01)return h("danger","Total amount exceeds remaining balance");if(j&&i>P)return h("danger","Advance amount exceeds available balance");try{const m={company_id:c,project_id:x.project_id,invoice_id:x.invoice_number,payment:s,advance_used:i,payment_mode:"Cash"};await Xe("/api/repayments",m),h("success","Payment recorded successfully"),te(!1),xe(""),Se(""),w(""),S(!1),O(),A&&we()}catch(m){console.error("Payment update error:",m),h("danger","Failed to update payment: "+((m==null?void 0:m.message)||m))}};if(!R)return e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsx(b,{xs:12,children:e.jsxs(Ee,{className:"shadow-sm",children:[e.jsx(Oe,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Customers Payment Report"}),e.jsxs(fe,{color:"info",className:"ms-2",children:[Pe.customerCount," customers"]})]})}),e.jsxs(He,{children:[e.jsxs(J,{className:"mb-2",children:[e.jsx(b,{xs:12,md:6,children:e.jsxs(Cs,{children:[e.jsx(Ps,{children:"Search"}),e.jsx(Fe,{placeholder:"Search by customer name...",value:$,onChange:s=>{G(s.target.value),oe(s.target.value)}})]})}),T&&e.jsx(b,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(N,{color:"light",size:"sm",onClick:()=>{G(""),oe("")},children:"Clear"})})]}),e.jsxs(J,{className:"g-2 mb-3",children:[e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:Pe.totalInvoices})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsxs("small",{className:"d-block",children:["Total Billed (",os,"hrs.)"]}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalBilled)})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalPaid)})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:he(Pe.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(p,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(o,{className:"text-center align-middle",children:"Hours"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ge,{children:Object.entries($e).map(([s,i],l)=>{const d=i.filter(F=>!F.is_advance),m=d.reduce((F,U)=>F+Number(U.total||0),0),v=d.reduce((F,U)=>F+Number(U.paid_amount||0),0),Z=m-v,ue=ms(i);return e.jsxs(p,{children:[e.jsx(r,{children:l+1}),e.jsx(r,{children:s}),e.jsx(r,{style:{color:ue<0?"red":"blue",fontWeight:600},children:ue}),e.jsxs(r,{className:"text-end",children:["₹",m.toFixed(2)]}),e.jsxs(r,{className:"text-success fw-bold text-end",children:["₹",v.toFixed(2)]}),e.jsxs(r,{className:"text-danger fw-bold text-end",children:["₹",Z.toFixed(2)]}),e.jsx(r,{className:"text-center",children:e.jsx(N,{size:"sm",color:"info",onClick:()=>{V(s),Ne(i[0].project_id)},children:"View Invoices"})})]},s)})})]})})]})]})})}),e.jsxs(ae,{visible:Ue,onClose:()=>{ye(!1),q(""),w("")},children:[e.jsx(re,{children:e.jsx(ie,{children:"Advance Payment"})}),e.jsxs(ce,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Customer"}),e.jsxs("select",{className:"form-select",value:ve,onChange:s=>q(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select --"}),De.map(s=>e.jsxs("option",{value:s.name,children:[s.name," ",s.mobile?`(${s.mobile})`:""]},s.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(Fe,{type:"number",placeholder:"Enter amount",value:y,onChange:s=>w(s.target.value),min:"0"})]})]}),e.jsxs(Ze,{children:[e.jsx(N,{color:"secondary",onClick:()=>ye(!1),children:"Cancel"}),e.jsx(N,{color:"primary",onClick:async()=>{var m;if(!ve)return h("danger","Select a customer");const s=Number(y);if(!s||s<=0)return h("danger","Enter a valid amount");const i=De.find(v=>v.name===ve);if(!((m=i==null?void 0:i.projects)!=null&&m.length))return h("danger","No project for this customer");const{id:l,company_id:d}=i.projects[0];try{await Xe("/api/advance-payment",{company_id:d,project_id:l,amount:s}),h("success","Advance payment recorded"),ye(!1),q(""),w(""),O()}catch(v){h("danger","Failed: "+((v==null?void 0:v.message)||"Unknown error"))}},children:"Submit"})]})]})]});const Ve=$e[R]||[],Qe=Ve.filter(s=>!s.is_advance),Ye=Qe.reduce((s,i)=>s+Number(i.total||0),0),qe=Qe.reduce((s,i)=>s+Number(i.paid_amount||0),0),z=Ye-qe,P=(W||[]).filter(s=>s.is_advance&&!s.advance_taken).reduce((s,i)=>s+Number(i.payment||0),0),hs=async()=>{const s=Number(D)||0,i=j&&Number(y)||0,l=s+i;if(l<=0)return h("danger","Total payment must be greater than 0");if(l>z)return h("danger","Total amount exceeds remaining balance");if(j&&i>P)return h("danger","Advance amount exceeds available balance");try{await Xe("/api/repayments",{company_id:c,project_id:A,invoice_id:null,payment:s,advance_used:i}),h("success","Payment recorded successfully"),Y(!1),X(""),w(""),S(!1),O(),we()}catch(d){console.error("Repayment error:",d),h("danger","Error: "+((d==null?void 0:d.message)||d))}},us=async()=>{var ns,as,rs,is;const s=a.find(k=>k.invoice_number===B);if(!s)return;const i=W.filter(k=>(k==null?void 0:k.invoice_id)===B);if(i.length===0){h("warning","No history to download");return}const l=(ns=Re())==null?void 0:ns.company_info;if(!l){alert("Company information not found. Please log in again.");return}const d=((as=s.project)==null?void 0:as.customer_name)||"N/A",m=s.is_fixed_bid==1?"FIXED BID INVOICE":"INVOICE",v=Number(s.total||0).toFixed(2),Z=Number(s.paid_amount||0).toFixed(2),ue=(Number(s.total)-Number(s.paid_amount)).toFixed(2);let F=0;const U=Number(s.total||0),js=i.map((k,fs)=>{F+=Number(k.payment||0);const bs=U-F;return`
            <tr>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${fs+1}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    ${k!=null&&k.date?k.date.slice(0,10).split("-").reverse().join("-"):"-"}
                </td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(k.payment).toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${bs.toFixed(2)}</td>
            </tr>
        `}).join(""),ps=`
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <!-- Header Section -->
            <div style="border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        ${l.logo?`<img src="/img/${l.logo}" alt="Logo" style="max-width: 120px; height: auto;" />`:""}
                    </div>
                    <div style="text-align: right; flex: 1;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">${l.company_name||""}</h2>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${l.land_mark||""}, ${l.Tal||""}, ${l.Dist||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Pincode: ${l.pincode||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Phone: ${l.phone_no||""}</p>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div style="text-align: center; background-color: #0d6efd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <h2 style="margin: 0; color: #fff; font-size: 20px;">PAYMENT HISTORY - ${m}</h2>
            </div>

            <!-- Invoice & Customer Details -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Invoice Details</h3>
                    <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${s.invoice_number}</p>
                    <p style="margin: 5px 0;"><strong>Date:</strong> ${Ce(s.created_at)}</p>
                    <p style="margin: 5px 0;"><strong>Total Amount:</strong> ₹${v}</p>
                    <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ₹${Z}</p>
                    <p style="margin: 5px 0;"><strong>Remaining:</strong> ₹${ue}</p>
                </div>
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Customer Details</h3>
                    <p style="margin: 5px 0;"><strong>Customer Name:</strong> ${d}</p>
                    <p style="margin: 5px 0;"><strong>Mobile:</strong> ${((rs=s.project)==null?void 0:rs.mobile_number)||"-"}</p>
                    <p style="margin: 5px 0;"><strong>Site:</strong> ${((is=s.project)==null?void 0:is.work_place)||"-"}</p>
                </div>
            </div>

            <!-- History Table -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Sr. No.</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Date</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Paid Amount</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    ${js}
                </tbody>
            </table>

            <!-- Footer -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 12px;">
                <p>This is a computer-generated document and is valid without signature.</p>
            </div>
        </div>
    `,ts=document.createElement("div");ts.innerHTML=ps;const gs={margin:[10,10,10,10],filename:`History-${s.invoice_number}-${d}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};try{await vs().set(gs).from(ts).save(),h("success","History PDF downloaded successfully")}catch(k){console.error("PDF generation error:",k),h("danger","Failed to generate PDF")}};return e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsx(b,{xs:12,children:e.jsxs(Ee,{className:"shadow-sm",children:[e.jsxs(Oe,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"fs-5",children:["Invoices for ",R]}),e.jsxs(fe,{color:"info",className:"ms-2",children:[Ve.length," entries"]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(N,{color:"success",onClick:()=>{Y(!0);const s=P>0&&P<=z;S(s),X("")},children:"Record Payment"}),e.jsx(N,{color:"secondary",size:"sm",onClick:()=>V(null),children:"Back"})]})]}),e.jsxs(He,{children:[e.jsxs(J,{className:"g-2 mb-2",children:[e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-primary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Total"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Ye.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-success text-center text-white shadow-sm",children:[e.jsx("small",{children:"Paid"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",qe.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-danger text-center text-white shadow-sm",children:[e.jsx("small",{children:"Remaining"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",z.toFixed(2)]})]})}),e.jsx(b,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-secondary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Advance"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",P.toFixed(2)]})]})})]}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"500px",overflowY:"auto"},children:e.jsxs(je,{hover:!0,bordered:!0,children:[e.jsx(pe,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa"},children:e.jsxs(p,{children:[e.jsx(o,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(o,{className:"text-center align-middle",children:"Invoice"}),e.jsx(o,{className:"text-center align-middle",children:"Date"}),e.jsx(o,{className:"text-center align-middle",children:"Total"}),e.jsx(o,{className:"text-center align-middle",children:"Paid"}),e.jsx(o,{className:"text-center align-middle",children:"Remaining"}),e.jsx(o,{className:"text-center align-middle",children:"Mode"}),e.jsx(o,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ge,{children:Ve.sort((s,i)=>new Date(i.created_at)-new Date(s.created_at)).map((s,i)=>{const l=(Number(s.total)-Number(s.paid_amount)).toFixed(2);return e.jsxs(p,{className:s.is_advance==1?"table-primary":s.is_fixed_bid==1?"table-warning":"",children:[e.jsx(r,{children:i+1}),e.jsx(r,{children:s.is_advance==1?"Advance Payment":s.invoice_number}),e.jsx(r,{className:"text-center align-middle",children:Ce(s.created_at)}),e.jsxs(r,{className:"text-end fw-bold",children:["₹",Number(s.total).toFixed(2)]}),e.jsxs(r,{className:"text-success fw-bold text-end",children:["₹",Number(s.paid_amount).toFixed(2)]}),e.jsxs(r,{className:"text-danger fw-bold text-end",children:["₹",l]}),e.jsx(r,{children:s.payment_mode||"-"}),e.jsx(r,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-1",children:[s.is_advance==0&&e.jsx(Je,{content:"Add Payment",placement:"top",children:e.jsx(N,{color:"success",size:"sm",onClick:()=>{Le(s),te(!0)},children:e.jsx(de,{icon:Fs})})}),s.is_advance==0&&e.jsx(Je,{content:"Payment History",placement:"top",children:e.jsx(N,{color:"info",size:"sm",onClick:()=>{K(s.invoice_number),ke(!0)},children:e.jsx(de,{icon:ks})})}),e.jsx(Je,{content:s.is_advance==1?"View Advance Invoice":s.is_fixed_bid==1?"View Fixed Bid Invoice":"View Invoice",placement:"top",children:e.jsx(N,{color:s.is_advance==1||s.is_fixed_bid==1?"warning":"secondary",size:"sm",onClick:()=>{s.is_advance==1||s.is_fixed_bid==1?(ee(s.id),Me(!0)):(ee(s.id),me(!0))},children:e.jsx(Ds,{})})})]})})]},s.id)})})]})})]})]})})}),e.jsxs(ae,{visible:Ie,onClose:()=>Me(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:((ss=a.find(s=>s.id===L))==null?void 0:ss.is_fixed_bid)==1?"Fixed Bid Invoice":"Advance Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(Ss,{paymentId:L})})]}),e.jsxs(ae,{visible:_,onClose:()=>Y(!1),children:[e.jsx(re,{children:e.jsxs(ie,{children:["Add Repayment - ",R]})}),e.jsxs(ce,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total :"})," ₹",Ye.toFixed(2)]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Advance Paid:"})," ",e.jsxs("span",{className:"text-success",children:["₹",P.toFixed(2)]})]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Paid :"})," ",e.jsxs("span",{className:"text-success",children:["₹",qe.toFixed(2)]})]}),e.jsxs("p",{className:"mb-3",children:[e.jsx("strong",{children:"Remaining :"})," ",e.jsxs("span",{className:"text-danger",children:["₹",z.toFixed(2)]})]}),e.jsx("hr",{}),z>0?e.jsxs(e.Fragment,{children:[P>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheck",checked:j,onChange:s=>{S(s.target.checked),s.target.checked}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheck",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("label",{className:"form-label small",children:["Advance to Use (Max: ₹",Math.min(z,P).toFixed(2),")"]}),e.jsx(Fe,{type:"number",placeholder:"Enter advance amount",value:y,onChange:s=>{parseFloat(s.target.value),w(s.target.value)},onBlur:s=>{let i=parseFloat(s.target.value)||0;const l=Math.min(z,P);i>l&&w(l)},min:"0",max:Math.min(z,P)})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Amount (Cash/Online)"}),e.jsx(Fe,{type:"number",placeholder:"Enter amount to pay",value:D,onChange:s=>X(s.target.value),min:"0"}),Number(D)===0&&D!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-3 text-end",children:[e.jsxs("div",{children:[e.jsx("small",{children:"Advance Used:"})," ₹",Number(j?y:0).toFixed(2)]}),e.jsxs("div",{children:[e.jsx("small",{children:"Cash/Online:"})," ₹",Number(D||0).toFixed(2)]}),e.jsxs("div",{className:"fw-bold fs-5 mt-1 text-primary",children:["Total Payment: ₹",((j?Number(y):0)+(Number(D)||0)).toFixed(2)]}),(j?Number(y):0)+(Number(D)||0)>z&&e.jsx("div",{className:"text-danger small mt-1",children:"Total exceeds remaining balance!"})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]}),e.jsxs(Ze,{children:[e.jsx(N,{color:"secondary",onClick:()=>{Y(!1),S(!1),X(""),w("")},children:"Cancel"}),e.jsx(N,{color:"primary",onClick:hs,disabled:z<=0||(Number(D)||0)+(j&&Number(y)||0)<=0,children:"Submit"})]})]}),e.jsxs(ae,{visible:se,onClose:()=>ke(!1),size:"lg",children:[e.jsx(re,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx(ie,{children:"Payment History"}),e.jsxs(N,{color:"success",size:"sm",className:"me-4",onClick:us,title:"Download History PDF",children:[e.jsx(de,{icon:ze,className:"me-1"}),"Download PDF"]})]})}),e.jsx(ce,{children:W.filter(s=>(s==null?void 0:s.invoice_id)===B).length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(pe,{color:"dark",children:e.jsxs(p,{children:[e.jsx(o,{children:"Date"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Remaining"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(ge,{children:(()=>{var d;const s=W.filter(m=>(m==null?void 0:m.invoice_id)===B),i=((d=s[0])==null?void 0:d.total)||0;let l=0;return s.map((m,v)=>{l+=Number(m.payment||0);const Z=Number(i)-l;return e.jsxs(p,{children:[e.jsx(r,{children:m!=null&&m.date?m.date.slice(0,10).split("-").reverse().join("-"):""}),e.jsxs(r,{children:["₹",m.payment]}),e.jsxs(r,{children:["₹",Z.toFixed(2)]}),e.jsx(r,{children:m.remark})]},v)})})()})]})}):e.jsx("div",{className:"text-center py-4 text-muted",children:e.jsx("p",{className:"mb-0",children:"No payment history found for this invoice."})})})]}),e.jsxs(ae,{visible:Ae,onClose:()=>{te(!1),xe(""),w(""),S(!1),Se("")},children:[e.jsx(re,{closeButton:!0,children:e.jsx(ie,{children:"Make Payment"})}),e.jsx(ce,{children:x&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice:"})," ",x.invoice_number]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Total:"}),e.jsxs("strong",{children:["₹",Number(x.total).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Paid:"}),e.jsxs("span",{className:"text-success",children:["₹",Number(x.paid_amount).toFixed(2)]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Remaining:"}),e.jsxs("span",{className:"text-danger",children:["₹",(Number(x.total)-Number(x.paid_amount)).toFixed(2)]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"d-flex justify-content-between mb-3",children:[e.jsx("span",{children:"Available Advance:"}),e.jsxs("span",{className:"text-primary fw-bold",children:["₹",P.toFixed(2)]})]}),Number(x.total)-Number(x.paid_amount)>0?e.jsxs(e.Fragment,{children:[P>0&&e.jsxs("div",{className:"mb-3 bg-light p-3 rounded",children:[e.jsxs("div",{className:"form-check mb-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"useAdvanceCheckInvoice",checked:j,onChange:s=>{S(s.target.checked)}}),e.jsx("label",{className:"form-check-label fw-semibold",htmlFor:"useAdvanceCheckInvoice",children:"Use Advance Payment"})]}),j&&e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"form-label small",children:"Advance to Use"}),e.jsx(Fe,{type:"number",placeholder:"Enter advance amount",value:y,onChange:s=>{Number(x.total)-Number(x.paid_amount),parseFloat(s.target.value),w(s.target.value)},onBlur:s=>{const i=Number(x.total)-Number(x.paid_amount);let l=parseFloat(s.target.value)||0;const d=Math.min(i,P);l>d&&w(d)},min:"0"}),e.jsxs("small",{className:"text-muted",children:["Max: ₹",Math.min(Number(x.total)-Number(x.paid_amount),P).toFixed(2)]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label fw-semibold",children:"Amount (Cash/Online)"}),e.jsx("input",{type:"number",className:"form-control",value:E,onChange:s=>xe(s.target.value),min:"0",placeholder:"Enter amount"}),Number(E)===0&&E!==""&&!j&&e.jsx("div",{className:"text-danger small mt-1",children:"Payment amount must be greater than 0"})]}),e.jsxs("div",{className:"mt-2 text-end",children:[e.jsx("strong",{children:"Total Payment: "}),e.jsxs("span",{className:(j?Number(y):0)+(Number(E)||0)>Number(x.total)-Number(x.paid_amount)?"text-danger":"text-success",children:["₹",((j?Number(y):0)+(Number(E)||0)).toFixed(2)]})]})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]})}),e.jsxs(Ze,{children:[e.jsx(N,{color:"secondary",onClick:()=>{te(!1),S(!1),xe(""),w("")},children:"Cancel"}),e.jsx(N,{color:"success",disabled:!x||Number(x.total)-Number(x.paid_amount)<=0||(Number(E)||0)+(j&&Number(y)||0)<=0,onClick:xs,children:"Confirm"})]})]}),e.jsxs(ae,{visible:Q,onClose:()=>me(!1),size:"xl",backdrop:"static",children:[e.jsx(re,{children:e.jsx(ie,{children:"Invoice"})}),e.jsx(ce,{style:{overflowY:"visible",padding:0},children:e.jsx(As,{projectId:L,inModal:!0})})]}),e.jsxs(ae,{visible:t,onClose:()=>{u(!1),ne(null)},size:"lg",children:[e.jsx(re,{children:e.jsxs(ie,{children:["Additional Charges - ",C==null?void 0:C.invoice_number]})}),e.jsx(ce,{children:C!=null&&C.additionalCharges&&C.additionalCharges.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(je,{striped:!0,bordered:!0,children:[e.jsx(pe,{children:e.jsxs(p,{children:[e.jsx(o,{children:"Charge Type"}),e.jsx(o,{children:"Amount"}),e.jsx(o,{children:"Paid"}),e.jsx(o,{children:"Status"}),e.jsx(o,{children:"Remark"})]})}),e.jsx(ge,{children:C.additionalCharges.map((s,i)=>e.jsxs(p,{children:[e.jsx(r,{children:ls(s.charge_type)}),e.jsxs(r,{className:"text-end",children:["₹",Number(s.amount).toFixed(2)]}),e.jsxs(r,{className:"text-end text-success fw-bold",children:["₹",Number(s.paid_amount||0).toFixed(2)]}),e.jsx(r,{children:e.jsx(fe,{color:s.is_paid?"success":"warning",children:s.is_paid?"Paid":"Pending"})}),e.jsx(r,{children:s.remark||"-"})]},s.id))})]})}):e.jsx("p",{className:"text-muted text-center",children:"No additional charges"})})]})]})};export{tt as default};

import{r as d,u as ye,b as fe,i as z,j as s}from"./index-Cr-4waUE.js";import{g as y,a as S,c as be,p as Se}from"./api-BUyL__Lx.js";import{S as A}from"./react-select.esm-CzoKIuj1.js";import{u as Le,a as ve,b as Ce,e as Ee,c as Ae,d as Ne}from"./DefaultLayout-B8rErgo7.js";import{a as O,b as V,d as x}from"./index.esm-B75P6HjL.js";import{C as W,a as K}from"./CCardBody-DpPesGF7.js";import{C as Z}from"./CCardHeader-CC-r8sJV.js";import{C as we}from"./CForm-BOPMc5UW.js";import{C as h}from"./CFormLabel-C33rygdk.js";import{C as f}from"./CFormInput-KPF1mpuU.js";import{C as Be,a as Fe,b as J,c as g,d as Me,e as j}from"./CTable-DlHDa5oY.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./emotion-react.browser.esm-C9aOzpPl.js";import"./floating-ui.dom-ByRZgDQ1.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-21BlczCs.js";import"./CNavItem-Bkuvlzpx.js";import"./CFormControlWrapper-BYXowQRV.js";import"./CFormControlValidation-CByzp8AE.js";const as=()=>{var H;d.useRef({});const[Q,N]=d.useState(!1),[X,Y]=d.useState([]),[u,q]=d.useState([]),[ee,L]=d.useState(!1),[p,v]=d.useState(null),[qe,se]=d.useState([]),[Ge,G]=d.useState({name:"",id:null}),[w,B]=d.useState([]),[k,te]=d.useState([]),[ke,ae]=d.useState([]),[F,ne]=d.useState([]),[_,re]=d.useState(!1),ie=async()=>{var t;const e=(t=y())==null?void 0:t.company_id;if(!e){l("danger","Unable to determine company. Please log in again."),B([]);return}try{const r=await S(`/api/machine-operators?company_id=${e}`),o=Array.isArray(r)?r.filter(c=>c.company_id===e):[];B(o)}catch(r){console.error("Error fetching machineries:",r),l("danger","Error fetching machineries: "+((r==null?void 0:r.message)||"")),B([])}},oe=async()=>{var t;const e=(t=y())==null?void 0:t.company_id;if(e)try{const r=await S(`/api/projects?company_id=${e}`);te(r||[])}catch(r){console.error("Error fetching projects:",r)}},ce=async()=>{try{const e=await S("/api/operatorsByCompanyIdOperator");ae(e)}catch(e){console.error("Error fetching Users:",e),l("danger","Error fetching Users")}};ye();const{showToast:l}=fe(),{t:a}=Le("global"),M=y(),[n,m]=d.useState({project_id:"",name:"",desc:"",expense_id:void 0,typeNotSet:!0,qty:1,price:0,total_price:0,expense_date:new Date().toISOString().split("T")[0],contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,isGst:!1,company_id:(M==null?void 0:M.company_id)||"",photoAvailable:!0,photo_url:null,photo_remark:"",operator_id:"",bank_name:"",acc_number:"",ifsc:"",aadhar:"",pan:"",transaction_id:"",machine_id:"",customer_id:""}),T=()=>{const e=localStorage.getItem("i18nextLng"),t=z.language;return e||t||"en"},le=(e,t=null)=>(t||T())==="mr"&&e.localName||e.name,I=async()=>{try{const e=await S("/api/expenseType");Y(e.filter(t=>t.show===1))}catch(e){l("danger","Error occurred "+e)}};d.useEffect(()=>{I(),ie(),oe(),ce(),de();const e=y();e!=null&&e.company_id&&m(t=>({...t,company_id:e.company_id}))},[]),d.useEffect(()=>{I()},[z.language]),d.useEffect(()=>{if(!_)return;const e=y();(e==null?void 0:e.type)===2&&m(t=>({...t,operator_id:e.id}))},[_]);const de=async()=>{var e;try{const t=(e=y())==null?void 0:e.company_id,r=await S("/api/operatorsByCompanyIdOperator");console.log("setOperator",F),ne(r||[])}catch{l("danger","Error fetching operators")}},pe=e=>{const t=parseFloat(e.qty)||0,r=parseFloat(e.price)||0;e.total_price=Math.round(t*r)},b=e=>{const{name:t,value:r,type:o,checked:c,files:P}=e.target;m(U=>{const i={...U};return o==="checkbox"&&t==="isGst"?(i.isGst=c,i):t==="price"||t==="qty"?(i[t]=r,pe(i),i):t==="expense_id"?(i.expense_id=r,i.typeNotSet=!r,i):t==="name"?(/^[a-zA-Z0-9\u0900-\u097F ]*$/.test(r)&&(i.name=r),i):t==="photoAvailable"?(i.photoAvailable=c,c?i.photo_remark="":i.photo_url=null,i):o==="file"&&t==="photo_url"?(i.photo_url=P[0]||null,i):(i[t]=o==="checkbox"?c:r,i)})},me=e=>{m({project_id:e.project_id,company_id:e.company_id,name:e.name,desc:e.desc||"",expense_id:e.expense_id,typeNotSet:!1,qty:e.qty,price:e.price,total_price:e.total_price,expense_date:e.expense_date,contact:e.contact,payment_by:e.payment_by,payment_type:e.payment_type,pending_amount:e.pending_amount,show:e.show,isGst:e.isGst}),G({name:e.customer_name,id:e.project_id}),v(e),N(!1),window.scrollTo({top:0,behavior:"smooth"}),l("info",a("MSG.expense_loaded_for_editing"))},ue=()=>{v(null),E(),l("info",a("MSG.edit_cancelled"))},he=e=>{const t=u.filter(r=>r.id!==e);q(t),p&&p.id===e&&(v(null),E()),l("info",a("MSG.expense_removed_from_list"))},_e=async e=>{if(e.preventDefault(),e.stopPropagation(),N(!0),!n.company_id){l("danger","Company is required for expense submission.");return}const t=new FormData;if(console.log("state"),console.log(n),t.append("company_id",n.company_id),n.project_id&&t.append("project_id",n.project_id),n.expense_id&&t.append("expense_id",n.expense_id),n.desc&&t.append("desc",n.desc),t.append("price",n.price),t.append("qty",n.qty),t.append("total_price",n.total_price),t.append("expense_date",n.expense_date),n.show!==void 0&&t.append("show",n.show?1:0),t.append("isGst",n.isGst?1:0),n.machine_id&&t.append("machine_id",n.machine_id),t.append("photoAvailable",n.photoAvailable?1:0),n.customer_id&&t.append("customer_id",n.customer_id),n.photo_url instanceof File&&t.append("photo_url",n.photo_url),_&&!n.operator_id){l("danger","Operator is required");return}_&&t.append("operator_id",n.operator_id);const r=!_&&n.expense_id&&n.price>0&&n.qty>0,o=_&&n.expense_id&&n.total_price>0&&n.operator_id;if(r||o)try{const c=await be("/api/expense",t);console.log("response",c),c?l("success",a("MSG.new_expense_added_successfully_msg")):l("danger",a("MSG.error_occured_please_try_again_later_msg")),E()}catch(c){l("danger","Error occurred "+c)}else m(c=>({...c,typeNotSet:c.expense_id===void 0}))},xe=async()=>{if(u.length===0){l("warning",a("MSG.add_atleast_one_expense"));return}L(!0)},ge=async()=>{try{const e=u.map(o=>{const{id:c,expense_type_name:P,customer_name:U,...i}=o;return Se("/api/expense",i)}),r=(await Promise.all(e)).filter(o=>o).length;if(r===u.length){const o=a("MSG.expenses_submitted_successfully",{count:r})||`${r} expenses submitted successfully`;l("success",o),q([]),v(null)}else{const o=a("MSG.partial_expenses_submitted",{successCount:r,totalCount:u.length})||`${r} out of ${u.length} expenses submitted`;l("warning",o)}}catch(e){const t=a("MSG.error_occurred")||"Error occurred";l("danger",`${t}: ${e}`)}L(!1)},D=()=>{const e=u.reduce((t,r)=>{const o=parseFloat(r.qty)||0,c=parseFloat(r.price)||0;return t+o*c},0);return Number(e.toFixed(2))},C=e=>`₹${parseFloat(e).toFixed(2)}`,$=new Date().toISOString().split("T")[0],E=async()=>{m({project_id:"",company_id:"",name:"",desc:"",expense_id:"",open:!1,qty:"",price:0,total_price:0,expense_date:$,contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,typeNotSet:!1,isGst:!1,photo_remark:"",bank_name:"",acc_number:"",ifsc:"",transaction_id:"",customer_id:""}),G({name:"",id:null}),se([]),N(!1)},je=T();setTimeout(()=>{console.log("Machines",w)},2e3);const R=X.map(e=>({value:e.id,expense_category:e.expense_category,label:le(e,je)}));return s.jsxs(s.Fragment,{children:[s.jsx(O,{children:s.jsx(V,{xs:12,children:s.jsxs(W,{className:"mb-4",children:[s.jsx(Z,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[a(p?"LABELS.edit_expense":"LABELS.new_expense"),p&&s.jsx("span",{className:"ms-2 badge bg-warning text-dark",children:a("LABELS.editing_mode")})]}),s.jsx(x,{color:"danger",size:"sm",onClick:()=>window.location.href="/#/expense/new-type",children:a("LABELS.new_expense_type")})]})}),s.jsx(K,{children:s.jsxs(we,{noValidate:!0,validated:Q,onSubmit:_e,children:[s.jsxs("div",{className:"row",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(h,{htmlFor:"expense_id",children:s.jsx("b",{children:a("LABELS.expense_type")})}),s.jsx(A,{id:"expense_id",name:"expense_id",value:R.find(e=>String(e.value)===String(n.expense_id))||null,onChange:e=>{console.log("selectedOption",e);const t=String((e==null?void 0:e.label)||"").toLowerCase(),r=t==="operator",o=t.includes("machine");re(r),m(c=>({...c,expense_id:e?e.value:"",open:o,customer_id:"",project_id:"",operator_id:""}))},options:R,placeholder:a("MSG.select_expense_type_msg"),isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),n.open&&s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(h,{htmlFor:"machine_id",children:s.jsx("b",{children:a("LABELS.machine")})}),s.jsx(A,{id:"machine_id",name:"machine_id",value:w.map(e=>({value:e.id,label:e.machine_name})).find(e=>String(e.value)===String(n.machine_id))||null,onChange:e=>m(t=>({...t,machine_id:e?e.value:""})),options:w.map(e=>({value:e.id,label:e.machine_name})),placeholder:"Select Machine",isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),s.jsx("div",{className:"col-sm-4",children:_?s.jsxs(s.Fragment,{children:[s.jsx(h,{children:s.jsx("b",{children:a("LABELS.operator_name")})}),s.jsx(A,{value:F.map(e=>({value:e.id,label:e.name})).find(e=>String(e.value)===String(n.operator_id))||null,onChange:e=>m(t=>({...t,operator_id:e?e.value:""})),options:F.map(e=>({value:e.id,label:e.name})),isDisabled:((H=y())==null?void 0:H.type)===2,placeholder:"Select Operator"})]}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"",children:[s.jsx(h,{htmlFor:"customer_id",children:s.jsx("b",{children:a("LABELS.customer_name")})}),s.jsx(A,{id:"customer_id",name:"customer_id",value:k.map(e=>({value:e.id,label:e.customer_name})).find(e=>String(e.value)===String(n.customer_id))||null,onChange:e=>m(t=>({...t,customer_id:e?e.value:"",project_id:e?e.value:""})),options:k.map(e=>({value:e.id,label:e.customer_name})),placeholder:a("LABELS.customer_name"),isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(h,{htmlFor:"name",children:s.jsx("b",{children:a("LABELS.about_expense")})}),s.jsx(f,{type:"text",id:"desc",placeholder:a("LABELS.enter_expense_description"),name:"desc",value:n.desc,onChange:b})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(h,{htmlFor:"expense_date",children:s.jsx("b",{children:a("LABELS.expense_date")})}),s.jsx(f,{type:"date",id:"expense_date",name:"expense_date",max:$,value:n.expense_date,onChange:b,required:!0,feedbackInvalid:a("MSG.select_date_validation")})]})})]}),!_&&s.jsxs("div",{className:"row align-items-end",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(h,{htmlFor:"price",children:s.jsx("b",{children:a("LABELS.price_per_unit")})}),s.jsx(f,{type:"number",min:"0",id:"price",onWheel:e=>e.target.blur(),placeholder:"0.00",step:"0.01",name:"price",onFocus:()=>m(e=>({...e,price:""})),value:n.price,onChange:b,required:!0,feedbackInvalid:a("MSG.price_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(h,{htmlFor:"qty",children:s.jsx("b",{children:a("LABELS.total_units")})}),s.jsx(f,{type:"number",id:"qty",step:"0.01",min:"0",placeholder:" ",name:"qty",value:n.qty,onWheel:e=>e.target.blur(),onKeyDown:e=>{["e","+","-",","].includes(e.key)&&e.preventDefault()},onChange:e=>{const t=e.target.value;(t===""||/^\d+(\.\d{0,2})?$/.test(t))&&b(e)},required:!0,feedbackInvalid:a("MSG.quantity_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(h,{htmlFor:"total_price",children:s.jsx("b",{children:a("LABELS.total_price")})}),s.jsx(f,{type:"number",min:"0",onWheel:e=>e.target.blur(),id:"total_price",placeholder:"",name:"total_price",value:n.total_price,onChange:b,readOnly:!0})]})})]}),_&&s.jsxs("div",{className:"col-sm-4",children:[s.jsx(h,{children:s.jsx("b",{children:"Total Amount"})}),s.jsx(f,{type:"number",value:n.total_price,onFocus:()=>m(e=>({...e,total_price:""})),onChange:e=>m(t=>({...t,total_price:e.target.value})),required:!0})]}),s.jsx("div",{className:"row"}),s.jsxs("div",{className:"mb-3 mt-3",children:[s.jsx(x,{color:"success",type:"submit",children:a("LABELS.submit")})," ",p&&s.jsxs(s.Fragment,{children:[s.jsx(x,{color:"warning",type:"button",onClick:ue,children:a("LABELS.cancel_edit")})," "]}),s.jsx(x,{color:"secondary",onClick:E,children:a("LABELS.clear")})]})]})})]})})}),u.length>0&&s.jsx(O,{children:s.jsx(V,{xs:12,children:s.jsxs(W,{className:"mb-4",children:[s.jsx(Z,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[a("LABELS.expenses_list")," (",u.length,")"]}),s.jsxs("span",{children:[a("LABELS.total_amount"),": ",s.jsx("strong",{children:C(D())})]})]})}),s.jsxs(K,{children:[s.jsx("div",{className:"table-responsive",children:s.jsxs(Be,{striped:!0,hover:!0,children:[s.jsx(Fe,{children:s.jsxs(J,{children:[s.jsx(g,{children:a("LABELS.customer_name")}),s.jsx(g,{children:a("LABELS.expense_type")}),s.jsx(g,{children:a("LABELS.description")}),s.jsx(g,{children:a("LABELS.date")}),s.jsx(g,{children:a("LABELS.price")}),s.jsx(g,{children:a("LABELS.quantity")}),s.jsx(g,{children:a("LABELS.total")}),s.jsx(g,{children:a("LABELS.actions")})]})}),s.jsx(Me,{children:u.map(e=>s.jsxs(J,{className:p&&p.id===e.id?"table-warning":"",children:[s.jsx(j,{children:e.customer_name}),s.jsx(j,{children:e.expense_type_name}),s.jsx(j,{children:e.name||"-"}),s.jsx(j,{children:e.expense_date}),s.jsx(j,{children:C(e.price)}),s.jsx(j,{children:e.qty}),s.jsx(j,{children:C(e.total_price)}),s.jsxs(j,{children:[s.jsx(x,{color:"info",size:"sm",onClick:()=>me(e),className:"me-1",disabled:p&&p.id===e.id,children:p&&p.id===e.id?a("LABELS.editing"):a("LABELS.edit")}),s.jsx(x,{color:"danger",size:"sm",onClick:()=>he(e.id),children:a("LABELS.remove")})]})]},e.id))})]})}),s.jsxs("div",{className:"mt-3",children:[s.jsxs(x,{color:"success",size:"lg",onClick:xe,disabled:p!==null,children:[a("LABELS.submit_all_expenses")," (",u.length,")"]}),p&&s.jsx("div",{className:"mt-2",children:s.jsxs("small",{className:"text-warning",children:[s.jsx("i",{className:"fas fa-exclamation-triangle me-1"}),a("MSG.complete_edit_before_submit")]})})]})]})]})})}),s.jsxs(ve,{visible:ee,onClose:()=>L(!1),children:[s.jsx(Ce,{children:s.jsx(Ee,{children:a("LABELS.confirm_submission")})}),s.jsxs(Ae,{children:[s.jsx("p",{children:a("MSG.confirm_submit_expenses",{count:u.length})}),s.jsx("p",{children:s.jsxs("strong",{children:[a("LABELS.total_amount"),": ",C(D().toFixed(2))]})})]}),s.jsxs(Ne,{children:[s.jsx(x,{color:"secondary",onClick:()=>L(!1),children:a("LABELS.cancel")}),s.jsx(x,{color:"primary",onClick:ge,children:a("LABELS.confirm_submit")})]})]})]})};export{as as default};

import{u as fe,b as je,r as i,j as e,C as be}from"./index-Cn-F0xzs.js";import{e as Ne,g as ye,a as W}from"./api-BUyL__Lx.js";import{u as H,w as Ce}from"./xlsx-DjuO7_Ju.js";import{E as Se}from"./jspdf.es.min-C3mgcsZZ.js";import"./jspdf.plugin.autotable-DnWYCd_c.js";import{u as we,C as v}from"./DefaultLayout-pwnRm339.js";import{a as R,b as m,d as T}from"./index.esm-7oL-v0Yv.js";import{C as G,a as U}from"./CCardBody-OOd8gb1I.js";import{C as _e}from"./CCardHeader-NWf5yg3Z.js";import{C as Ee}from"./CFormInput-CwIxlT0b.js";import{C as ve,a as Te,b as P,c as u,d as ke,e as p}from"./CTable-9p6lbBYR.js";import"./typeof-QjJsDpFa.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-BsLkniud.js";import"./CNavItem-8JWznpb2.js";import"./CFormControlWrapper-CeeeRFXe.js";import"./CFormControlValidation-P5rV7dKb.js";import"./CFormLabel-Dk6nlh4k.js";const qe=()=>{const I=fe(),{showToast:j}=je(),{t:X}=we("global");Ne();const x=ye(),[k,q]=i.useState([]),[C,J]=i.useState([]),[M,K]=i.useState([]),[d,$]=i.useState(""),[B,A]=i.useState(""),[b,Me]=i.useState({key:null,direction:"asc"}),[Q,Z]=i.useState(!0),[ee,te]=i.useState(window.innerWidth<=768),se=async()=>{try{const t=await W("/api/machineries1");q(t)}catch(t){j("danger","Error fetching machines: "+t)}},ne=async()=>{try{const t=await W(`/api/machineLog?company_id=${x.company_id}`);J(t)}catch(t){j("danger","Error fetching machine logs: "+t)}},re=async()=>{try{const t=await W(`/api/expense1?company_id=${x.company_id}`);K(t[0]||[])}catch(t){j("danger","Error fetching expenses: "+t)}};i.useEffect(()=>{x!=null&&x.company_id&&(se(),ne(),re().finally(()=>Z(!1)))},[x==null?void 0:x.company_id]);const D=(t,n)=>n.filter(r=>Number(r.machine_id)===Number(t)).reduce((r,s)=>{const a=parseFloat(s.start_reading)||0,l=parseFloat(s.end_reading)||0,f=parseFloat(s.price_per_hour)||0;return r+(l>a&&f>0?(l-a)*f:0)},0),ae=(t,n)=>n.filter(r=>Number(r.machine_id)===Number(t)).reduce((r,s)=>{const a=parseFloat(s.start_reading),l=parseFloat(s.end_reading);return!isNaN(a)&&!isNaN(l)&&l>a?r+(l-a):r},0),V=(t,n)=>n.filter(r=>{var S,w;const s=Number(r.machine_id)===Number(t),a=String(((S=r.expense_type)==null?void 0:S.expense_category)||"").toLowerCase(),l=String(((w=r.expense_type)==null?void 0:w.name)||"").toLowerCase(),L=["machine","diesel","desile","maintenance","repair"].some(h=>a.includes(h)||l.includes(h));return s&&L}).reduce((r,s)=>r+(parseFloat(s.total_price)||0),0),oe=(t,n,r)=>{const s=D(t,n),a=V(t,r);return s-a},Y=t=>I(`/machineprofits/${t}`),O=t=>I(`/machineloss/${t}`);i.useEffect(()=>{const t=()=>te(window.innerWidth<=768);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const ie=i.useCallback(t=>{const n=setTimeout(()=>$(t),300);return()=>clearTimeout(n)},[]),ce=t=>{const n=t.target.value;A(n),ie(n)},z=()=>{A(""),$("")},c=t=>{const n=parseFloat(t)||0;if(isNaN(n))return"0.00";const[r,s="00"]=n.toFixed(2).split("."),a=r.slice(-3),l=r.slice(0,-3);return`${l?l.replace(/\B(?=(\d{2})+(?!\d))/g,",")+","+a:a}.${s}`},F=t=>`INR ${c(t)}`,o=i.useMemo(()=>{let t=k.map((n,r)=>({...n,sr_no:r+1,profit:D(n.id,C),totalHours:ae(n.id,C),expense:V(n.id,M),net:oe(n.id,C,M)}));if(d.trim()){const n=d.toLowerCase();t=t.filter(r=>{var s,a;return((s=r.machine_name)==null?void 0:s.toLowerCase().includes(n))||((a=r.register_number)==null?void 0:a.toLowerCase().includes(n))||r.profit.toString().includes(d)||r.expense.toString().includes(d)||r.net.toString().includes(d)})}return b.key&&(t=[...t].sort((n,r)=>{let s=n[b.key],a=r[b.key];return typeof s=="string"&&(s=s.toLowerCase()),typeof a=="string"&&(a=a.toLowerCase()),(s<a?-1:1)*(b.direction==="asc"?1:-1)})),t},[k,C,M,d,b]),g=i.useMemo(()=>o.reduce((t,n)=>(t.machineCount+=1,t.totalProfit+=Number(n.profit)||0,t.totalExpense+=Number(n.expense)||0,t.totalNet+=Number(n.net)||0,t),{machineCount:0,totalProfit:0,totalExpense:0,totalNet:0}),[o]),le=i.useMemo(()=>o.reduce((t,n)=>t+Number(n.totalHours||0),0),[o]),de=()=>{const t=o.map(s=>({"Sr No":s.sr_no,"Machine Name":s.machine_name||"-","Registration Number":s.register_number||"-",Profit:s.profit,Expense:s.expense,Net:s.net,Hours:s.totalHours})),n=H.json_to_sheet(t),r=H.book_new();H.book_append_sheet(r,n,"Machine Report"),Ce(r,`Machine_Report_${new Date().toISOString().split("T")[0]}.xlsx`),j("success","Excel file downloaded successfully!")},xe=()=>{const t=new Se({orientation:"landscape",unit:"pt",format:"a4"}),n=t.internal.pageSize.getWidth(),r=t.internal.pageSize.getHeight(),s=40,a=n-2*s;t.setFont("helvetica","bold"),t.setFontSize(18),t.setTextColor(22,160,133),t.text("Machine Expense Report",s,50),t.setFontSize(11),t.setTextColor(100),t.setFont("helvetica","normal");const l=(x==null?void 0:x.company_name)||"Your Company",f=new Date().toLocaleDateString("en-GB");t.text(`${l} â€¢ Generated on ${f}`,s,70);const L=[["Sr No","Machine Name","Reg No","Earning (Rs.)","Expense (Rs.)","Net (Rs.)"]],S=o.map(h=>[h.sr_no.toString(),h.machine_name||"-",h.register_number||"-",c(h.profit),c(h.expense),c(h.net)]);t.autoTable({head:L,body:S,startY:100,theme:"striped",border:{lineWidth:.5,color:200},styles:{fontSize:9,cellPadding:6,overflow:"linebreak",halign:"center"},headStyles:{fillColor:[22,160,133],textColor:255,fontStyle:"bold",fontSize:10},columnStyles:{0:{cellWidth:a*.08},1:{cellWidth:a*.28},2:{cellWidth:a*.16},3:{cellWidth:a*.16},4:{cellWidth:a*.16},5:{cellWidth:a*.16}},didDrawPage:h=>{const _=h.cursor.y+20,me=o.reduce((N,y)=>N+y.profit,0),ue=o.reduce((N,y)=>N+y.expense,0),ge=o.reduce((N,y)=>N+y.net,0);t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(34,34,34);const E=a/6;t.text("TOTAL",s+E*2,_),t.text(c(me),s+E*3,_,{align:"center"}),t.text(c(ue),s+E*4,_,{align:"center"}),t.text(c(ge),s+E*5,_,{align:"center"}),t.setFontSize(9),t.setTextColor(150),t.text(`Page ${t.internal.getCurrentPageInfo().pageNumber}`,n-s-50,r-20)}});const w=`Machine_Report_${new Date().toISOString().split("T")[0]}.pdf`;t.save(w),j("success","PDF downloaded successfully!")},he=t=>e.jsx(G,{className:"mb-3 expense-card",style:pe,children:e.jsxs(U,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:"1em"},children:t.machine_name||"N/A"}),e.jsx("div",{style:{color:"#666",fontSize:"0.8em"},children:t.register_number||"-"})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontWeight:600,color:t.net>=0?"#28a745":"#dc3545"},children:F(t.net)}),e.jsx("div",{style:{fontSize:"0.7em",color:"#666"},children:"Net"})]})]}),e.jsxs("div",{style:{marginBottom:8,paddingTop:8,borderTop:"1px solid #f0f0f0",display:"flex",justifyContent:"space-between"},children:[e.jsxs("span",{style:{color:"#28a745"},children:["Earning: ",F(t.profit)]}),e.jsxs("span",{style:{color:"blue"},children:["Hours: ",t.totalHours]})]}),e.jsx("div",{style:{marginBottom:8,paddingTop:8,borderTop:"1px solid #f0f0f0"},children:e.jsxs("span",{style:{color:"#dc3545"},children:["Expense: ",F(t.expense)]})}),e.jsxs("div",{style:{paddingTop:8,borderTop:"1px solid #f0f0f0",display:"flex",gap:"8px",justifyContent:"center"},children:[e.jsx(v,{color:"success",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>Y(t.id),children:"View Earnings"}),e.jsx(v,{color:"danger",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>O(t.id),children:"View Expenses"})]})]})},t.id),pe={border:"1px solid #dee2e6",borderRadius:8,boxShadow:"0 1px 4px rgba(0,0,0,0.1)",transition:"all 0.3s ease"};return Q?e.jsxs("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:400},children:[e.jsx(be,{color:"primary",size:"lg"}),e.jsx("p",{style:{marginTop:12,color:"#6c757d"},children:"Loading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("style",{jsx:!0,global:!0,children:`
        .table-container {
          height: 350px;
          overflow: auto;
          border: 1px solid #dee2e6;
          border-radius: 0.375rem;
        }
        .expenses-table thead th {
          position: sticky;
          top: 0;
          background: #f8f9fa;
          z-index: 10;
        }
        .search-container { position: relative; }
        .search-input { padding-left: 40px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; }
        .clear-search { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; }
        @media (max-width: 768px) { .expenses-table { display: none; } }
        .expense-card .badge {
          min-width: 44px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
      `}),e.jsx(R,{children:e.jsx(m,{xs:12,children:e.jsxs(G,{className:"mb-4",children:[e.jsxs(_e,{children:[e.jsx("strong",{className:"fs-5",children:"Machine Expense Report"}),e.jsxs("span",{className:"ms-2 text-muted",children:[X("LABELS.total")||"Total"," ",k.length," machines"]})]}),e.jsxs(U,{children:[e.jsxs(R,{className:"mb-3 align-items-center",children:[e.jsx(m,{xs:12,md:6,children:e.jsxs("div",{className:"search-container",children:[e.jsx(Ee,{type:"text",className:"search-input",placeholder:"Search machines...",value:B,onChange:ce}),B&&e.jsx("button",{className:"clear-search",onClick:z,title:"Clear",children:"X"})]})}),e.jsxs(m,{xs:12,md:6,className:"mt-2 mt-md-0 text-md-end",children:[e.jsx(T,{color:"success",size:"sm",className:"me-2",onClick:de,children:"Export Excel"}),e.jsx(T,{color:"danger",size:"sm",onClick:xe,children:"Export PDF"})]})]}),d&&e.jsx(m,{xs:12,className:"mb-2",children:e.jsxs("small",{className:"text-muted",children:[o.length,' machine(s) found for "',d,'"']})}),e.jsxs(R,{className:"g-2 mb-3",children:[e.jsx(m,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Machines "}),e.jsxs("strong",{className:"fs-6",children:[g.machineCount," "]}),e.jsxs("small",{children:[" (",le,"hrs.)"]})]})}),e.jsx(m,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Total Earning "}),e.jsx("strong",{className:"fs-6",children:c(g.totalProfit)})]})}),e.jsx(m,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-black shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Total Expense"}),e.jsx("strong",{className:"fs-6",children:c(g.totalExpense)})]})}),e.jsx(m,{xs:6,md:3,children:e.jsxs("div",{className:`rounded p-2 text-center shadow-sm ${g.totalNet>=0?"bg-info text-white":"bg-warning text-dark"}`,children:[e.jsx("small",{className:"d-block",children:"Net"}),e.jsxs("strong",{className:"fs-6",children:[g.totalNet>=0?"":"-",c(Math.abs(g.totalNet))]})]})})]}),ee?e.jsx("div",{children:o.length===0?e.jsx("div",{className:"text-center text-muted py-4",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:['No machines found for "',d,'"']}),e.jsx(T,{color:"primary",onClick:z,size:"sm",children:"Clear Search"})]}):e.jsx("p",{children:"No machine data available."})}):o.map(he)}):e.jsx("div",{className:"table-container",children:e.jsxs(ve,{hover:!0,striped:!0,bordered:!0,className:"mb-0 expenses-table",children:[e.jsx(Te,{children:e.jsxs(P,{children:[e.jsx(u,{className:"text-center",children:"Sr. No."}),e.jsx(u,{className:"text-center",children:"Machine Name"}),e.jsx(u,{className:"text-center",children:"Reg No"}),e.jsx(u,{className:"text-center",children:"Earning"}),e.jsx(u,{className:"text-center",children:"Hours"}),e.jsx(u,{className:"text-center",children:"Expense"}),e.jsx(u,{className:"text-center",children:"Net"}),e.jsx(u,{className:"text-center",children:"Actions"})]})}),e.jsx(ke,{children:o.length===0?e.jsx(P,{children:e.jsx(p,{colSpan:7,className:"text-center py-4 text-muted",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:['No machines found for "',d,'"']}),e.jsx(T,{color:"primary",onClick:z,size:"sm",children:"Clear Search"})]}):e.jsx("p",{children:"No machine data available."})})}):e.jsx(e.Fragment,{children:o.map(t=>e.jsxs(P,{children:[e.jsx(p,{children:t.sr_no}),e.jsx(p,{children:t.machine_name||"-"}),e.jsx(p,{children:t.register_number||"-"}),e.jsx(p,{className:"text-end",children:e.jsx("span",{style:{color:"#28a745"},children:c(t.profit)})}),e.jsx(p,{className:"text-end",children:e.jsx("span",{className:"text-primary",children:t.totalHours})}),e.jsx(p,{className:"text-end",children:e.jsx("span",{style:{color:"#dc3545"},children:c(t.expense)})}),e.jsx(p,{className:"text-end",children:e.jsx("span",{style:{fontWeight:500,color:t.net>=0?"#28a745":"#dc3545"},children:c(Math.abs(t.net))})}),e.jsx(p,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[e.jsx(v,{color:"success",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>Y(t.id),children:"View Earnings"}),e.jsx(v,{color:"danger",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>O(t.id),children:"View Expenses"})]})})]},t.id))})})]})})]})]})})})]})};export{qe as default};

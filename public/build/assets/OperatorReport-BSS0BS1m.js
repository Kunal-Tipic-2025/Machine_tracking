import{r as n,j as e,C as X}from"./index-BaFO0fBD.js";import{a as Z,p as je}from"./api-BUyL__Lx.js";import{d,a as ye,b as f,c as ee}from"./index.esm-6sS0QU7y.js";import{r as fe,p as ge}from"./Feilds-DKJTpBq7.js";import{C as Ce,a as ve}from"./CCardBody-C_DcNhkI.js";import{C as be}from"./CCardHeader-uQH1AYuq.js";import{C as se}from"./RawMaterial-D7bfBri4.js";import{C as Se}from"./CInputGroup-jXSXCS9j.js";import{C as te}from"./CFormInput-Bf1zI-co.js";import{c as ae}from"./cil-search-CDkY_4k-.js";import{C as g}from"./CFormSelect-CKz9M81i.js";import{a as Pe,b as Ne,c as _e,d as Me,e as Te}from"./DefaultLayout-CO5Zw0Z5.js";import"./CFormControlWrapper-DiPXZd7c.js";import"./CFormControlValidation-D0XpqgJc.js";import"./CFormLabel-zcG2lLqz.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-BYh17SIg.js";const Ue=()=>{const[A,C]=n.useState([]),[O,v]=n.useState([]),[m,E]=n.useState(!1),[r,R]=n.useState(""),[b,p]=n.useState([]),[l,D]=n.useState(""),[h,Y]=n.useState(""),[S,z]=n.useState("2025"),[ne,c]=n.useState(!1),[u,B]=n.useState(null),[re,oe]=n.useState(""),[le,ce]=n.useState(""),[ie,P]=n.useState(!1),[L,N]=n.useState(""),[i,_]=n.useState([]),[M,$]=n.useState(""),[T,H]=n.useState(""),[w,J]=n.useState(""),[Q,U]=n.useState(!1),k=n.useRef(null),F=n.useRef(null),G=["January","February","March","April","May","June","July","August","September","October","November","December"],W=new Date().getFullYear(),q=[];for(let s=W-5;s<=W+5;s++)q.push(s);const x=(s,t)=>{oe(s),ce(t),P(!0),setTimeout(()=>P(!1),5e3)},K=n.useCallback(async s=>{try{const t=await Z(`/api/projects?searchQuery=${s}`);p(t||[]),c(!0)}catch(t){console.error("Error fetching projects:",t),p([]),c(!1)}},[]);n.useEffect(()=>{const s=setTimeout(()=>{r&&r.length>2?K(r):(p([]),c(!1))},300);return()=>clearTimeout(s)},[r,K]),n.useEffect(()=>{const s=t=>{k.current&&!k.current.contains(t.target)&&c(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const de=s=>{R(s.project_name),D(s.id),p([]),c(!1),F.current&&F.current.blur()},me=()=>{b.length>0&&c(!0)},pe=s=>{const t=s.target.value;R(t),l&&t!==r&&D("")},I=async(s=null,t=null)=>{const a=s||h,y=t||S;if(!l||!a){alert("Please select a project and month");return}E(!0);try{const o=await Z(`/api/operators-by-product?product_id=${l}&month=${a}&year=${y}`);o.success?(C(o.operators||[]),v(o.supervisors||[]),N(o.previous_payment_msg||""),_(o.previous_pending_months||[])):(C([]),v([]),N(""),_([]))}catch(o){console.error("API Error:",o),C([]),v([]),N(""),_([])}finally{E(!1)}},he=s=>{B(s),$(""),H(""),J("")},j=()=>{B(null)},ue=async()=>{if(!M||!T||!w){x("Please fill all payment details","danger");return}U(!0);const s=u,t={id:s.id,payment:s.payment,total_commission:s.total_commission,total_work_point:s.total_work_point,month:h,year:parseInt(S),project_id:l,payment_by:M,payment_type:T,transaction_id:w};try{const a=await je("/api/transactions/pay",t);a.success?(await I(),x("Payment Successfully Done!","success"),j()):x(a.message||"Payment failed","danger")}catch(a){console.error("Payment error:",a),x("Payment failed. Please try again.","danger")}finally{U(!1)}},xe=()=>{if(!i||i.length===0)return;const s=i.sort()[0],[t,a]=s.split("-"),y=G[parseInt(a,10)-1];z(t),Y(y),I(y,t)},V=(s,t=!1)=>e.jsxs("div",{className:"table-responsive mb-5",children:[e.jsx("h6",{className:"mb-3",children:t?"Supervisors":"Oprators"}),e.jsxs("table",{className:"table table-striped table-bordered",children:[e.jsx("thead",{className:t?"table-info":"table-primary",children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Mobile"}),e.jsx("th",{children:"Address"}),t?null:e.jsx("th",{children:"Total Work Point"}),e.jsx("th",{children:"Salary"}),t?null:e.jsx("th",{children:"Commission"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Action"})]})}),e.jsx("tbody",{children:s.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.id}),e.jsx("td",{children:a.name}),e.jsx("td",{children:a.mobile}),e.jsx("td",{children:a.address}),t?null:e.jsx("td",{children:a.total_work_point}),e.jsx("td",{children:a.payment}),t?null:e.jsxs("td",{children:[a.commission," × ",a.total_work_point," = ",a.total_commission]}),e.jsx("td",{children:(parseFloat(a.payment||0)+parseFloat(a.total_commission||0)).toFixed(2)}),e.jsx("td",{children:e.jsx(d,{color:a.is_paid?"success":"warning",size:"sm",disabled:a.is_paid,onClick:()=>he(a),children:a.is_paid?"Paid":"Pay"})})]},a.id))})]})]});return e.jsx("div",{className:"container-fluid py-4",children:e.jsxs(Ce,{children:[e.jsx(be,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:e.jsx("h5",{className:"mb-0",children:"Oprator Salary and Commission Report"})}),e.jsxs(ve,{children:[ie&&e.jsx(se,{color:le,dismissible:!0,onClose:()=>P(!1),children:re}),L&&i.length>0&&e.jsxs(se,{color:"warning",className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("strong",{children:L}),"   (Pending Months: ",i.join(", "),")"]}),e.jsx(d,{color:"danger",size:"sm",onClick:xe,children:"Pay Previous"})]}),e.jsxs(ye,{className:"mb-4 d-flex flex-wrap gap-2",children:[e.jsx(f,{md:4,children:e.jsxs("div",{className:"position-relative",ref:k,children:[e.jsxs(Se,{children:[e.jsx(te,{ref:F,type:"text",value:r,onChange:pe,onFocus:me,placeholder:"Search for a project...",className:"border",autoComplete:"off"}),e.jsx(ee,{icon:ae,className:"position-absolute",style:{right:"10px",top:"50%",transform:"translateY(-50%)",zIndex:5,color:"#6c757d"}})]}),ne&&b.length>0&&e.jsx("div",{className:"dropdown-menu show w-100",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,marginTop:"2px"},children:b.map(s=>e.jsx("div",{className:"dropdown-item",style:{cursor:"pointer"},onClick:()=>de(s),children:s.project_name},s.id))}),l&&e.jsxs("div",{className:"text-success mt-1 small",children:["✓ Selected: ",r]})]})}),e.jsx(f,{md:3,children:e.jsxs(g,{value:h,onChange:s=>Y(s.target.value),className:"border",children:[e.jsx("option",{value:"",children:"Select Month"}),G.map((s,t)=>e.jsx("option",{value:s,children:s},t))]})}),e.jsx(f,{md:3,children:e.jsxs(g,{value:S,onChange:s=>z(s.target.value),className:"border",children:[e.jsx("option",{value:"",children:"Select Year"}),q.map(s=>e.jsx("option",{value:s,children:s},s))]})}),e.jsx(f,{md:2,children:e.jsx(d,{color:"primary",onClick:()=>I(),disabled:m||!l||!h,className:"w-100",children:m?e.jsxs(e.Fragment,{children:[e.jsx(X,{size:"sm",className:"me-2"})," Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{icon:ae,className:"me-2"})," Fetch"]})})})]}),!m&&A.length>0&&V(A),!m&&O.length>0&&V(O,!0),e.jsxs(Pe,{visible:!!u,onClose:j,backdrop:"static",children:[e.jsx(Ne,{onClose:j,children:e.jsx(_e,{children:"Make Payment"})}),e.jsx(Me,{children:u&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"fw-bold",children:["Oprator: ",u.name]}),e.jsxs(g,{className:"mb-3",value:M,onChange:s=>$(s.target.value),children:[e.jsx("option",{value:"",children:"Select Payment By"}),fe.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsxs(g,{className:"mb-3",value:T,onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"",children:"Select Payment Type"}),ge.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsx(te,{type:"text",placeholder:"Transaction Number",value:w,onChange:s=>J(s.target.value)})]})}),e.jsxs(Te,{children:[e.jsx(d,{color:"secondary",onClick:j,children:"Cancel"}),e.jsx(d,{color:"primary",disabled:Q,onClick:ue,children:Q?e.jsx(X,{size:"sm"}):"Submit"})]})]})]})]})})};export{Ue as default};

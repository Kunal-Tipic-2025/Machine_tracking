import{e as ie,u as ce,r,j as e,C as le}from"./index-BTeA492D.js";import{a as Y,b as me,p as de}from"./api-BUyL__Lx.js";import{p as ue,r as pe,g as he}from"./Feilds-DKJTpBq7.js";import{c as w,d as T,a as j,b as a}from"./index.esm-UVM2W3HN.js";import{C as _e,a as je}from"./CCardBody-BDPTx9XL.js";import{C as xe}from"./CCardHeader-7X8EpRUb.js";import{c as $}from"./cil-plus-D8mtC-W5.js";import{C as ge}from"./RawMaterial-DvMRSoFa.js";import{C as ve}from"./CForm-DLTIQo7N.js";import{C as c}from"./CFormLabel-N-ZSSVsb.js";import{C as be}from"./CInputGroup-CO3LbqLS.js";import{C as m}from"./CFormInput-C-f2xD8x.js";import{c as fe}from"./cil-search-CDkY_4k-.js";import{C as J}from"./CFormSelect-B_ay71cr.js";import{c as ye}from"./cil-pencil-m516yCOw.js";import"./CFormControlWrapper-B0MocaRk.js";import"./CFormControlValidation-CspEyxkQ.js";const Oe=()=>{const R=he,k=ie(),q=ce(),[s,d]=r.useState({project_id:"",po_no:"",po_date:"",invoice_no:"",invoice_date:"",basic_amount:"",gst_amount:"",billing_amount:"",received_amount:"",received_by:"",senders_bank:"",payment_type:"",receivers_bank:"",pending_amount:"",remark:""}),[B,x]=r.useState([]),[p,D]=r.useState([]),[G,f]=r.useState(""),[L,y]=r.useState(""),[C,g]=r.useState(!1),[K,V]=r.useState(""),[X,Z]=r.useState(""),[ee,N]=r.useState(!1),[u,O]=r.useState(!1),[te,z]=r.useState(null),[M,Q]=r.useState(!1),[S,F]=r.useState(""),I=r.useRef(null),E=r.useRef(null),h=(t,n)=>{V(t),Z(n),N(!0),setTimeout(()=>N(!1),5e3)};r.useEffect(()=>{var t;if((t=k.state)!=null&&t.income){const n=k.state.income;d({project_id:n.project_id,po_no:n.po_no,po_date:U(n.po_date),invoice_no:n.invoice_no,invoice_date:U(n.invoice_date),basic_amount:n.basic_amount.toString(),gst_amount:n.gst_amount.toString(),billing_amount:n.billing_amount.toString(),received_amount:n.received_amount.toString(),received_by:n.received_by,senders_bank:n.senders_bank,payment_type:n.payment_type,receivers_bank:n.receivers_bank,pending_amount:n.pending_amount.toString(),remark:n.remark||""});const i=p.find(o=>o.id===n.project_id);i&&(F(i.project_name),f(i.id),y(i.project_name)),O(!0),z(n.id)}},[k.state,p]);const W=r.useCallback(async()=>{try{const t=await Y("/api/projects");D(t||[])}catch(t){console.error("Error fetching all projects:",t),D([])}},[]),H=r.useCallback(async(t="")=>{try{const n=t?`/api/projects?searchQuery=${t}`:"/api/projects",i=await Y(n);x(i||[])}catch(n){console.error("Error fetching projects:",n),x([])}},[]);r.useEffect(()=>{W()},[W]),r.useEffect(()=>{const t=setTimeout(()=>{S.length>0&&C?H(S):C&&x(p)},300);return()=>clearTimeout(t)},[S,H,p,C]),r.useEffect(()=>{const t=n=>{I.current&&!I.current.contains(n.target)&&g(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const ne=t=>{F(t.project_name),f(t.id),y(t.project_name),d(n=>({...n,project_id:t.id})),x([]),g(!1),E.current&&E.current.blur()},se=()=>{p.length>0&&(x(p),g(!0))},re=t=>{const n=t.target.value;F(n),g(!0),G&&n!==L&&(f(""),y(""),d(i=>({...i,project_id:""})))},l=t=>{const{name:n,value:i}=t.target;if(d(o=>({...o,[n]:i})),n==="basic_amount"){const o=parseFloat(i)||0,v=o*R/100,b=o+v;d(A=>({...A,[n]:i,gst_amount:v.toFixed(2),billing_amount:b.toFixed(2)}));const _=parseFloat(s.received_amount)||0;if(_>0){const A=b-_;d(ae=>({...ae,pending_amount:A>0?A.toFixed(2):"0.00"}))}}else if(n==="received_amount"){const o=parseFloat(s.billing_amount)||0,v=parseFloat(i)||0;if(v>o){h("Received Amount cannot exceed Amount With GST","danger"),d(_=>({..._,[n]:o.toString()}));return}const b=o-v;d(_=>({..._,[n]:i,pending_amount:b>0?b.toFixed(2):"0.00"}))}},P=()=>{q("/incomeTable",{state:{}}),d({project_id:"",po_no:"",po_date:"",invoice_no:"",invoice_date:"",basic_amount:"",gst_amount:"",billing_amount:"",received_amount:"",received_by:"",senders_bank:"",payment_type:"",receivers_bank:"",pending_amount:"",remark:""}),F(""),f(""),y(""),g(!1),O(!1),z(null)},oe=async t=>{t.preventDefault();const n=parseFloat(s.billing_amount)||0;if((parseFloat(s.received_amount)||0)>n){h("Received Amount cannot exceed Amount With GST","danger");return}if(!s.project_id){h("Please select a project","danger");return}Q(!0);try{let o;u?o=await me(`/api/income/${te}`,s):o=await de("/api/income",s),o.message?(h(u?"Income updated successfully!":"Income stored successfully!","success"),P(),q("/incomeTable")):h("Error saving income data","danger")}catch(o){console.error("Error submitting form:",o),h("Error saving income data","danger")}finally{Q(!1)}},U=t=>t?new Date(t).toISOString().split("T")[0]:"";return e.jsx("div",{className:"container-fluid py-4",children:e.jsxs(_e,{className:"mb-4",children:[e.jsxs(xe,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:[e.jsx(w,{icon:$,className:"me-2"}),u?"Edit Project Income":"Add Project Income"]}),u&&e.jsx(T,{color:"light",size:"sm",onClick:P,children:"Cancel Edit"})]}),e.jsxs(je,{children:[ee&&e.jsx(ge,{color:X,dismissible:!0,onClose:()=>N(!1),children:K}),e.jsxs(ve,{onSubmit:oe,children:[e.jsxs(j,{className:"mb-3",children:[e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"project",children:"Project *"}),e.jsxs("div",{className:"position-relative",ref:I,children:[e.jsxs(be,{children:[e.jsx(m,{ref:E,type:"text",value:S,onChange:re,onFocus:se,placeholder:"Search and select project...",className:"border",autoComplete:"off",required:!0}),e.jsx(w,{icon:fe,className:"position-absolute",style:{right:"10px",top:"50%",transform:"translateY(-50%)",zIndex:5,color:"#6c757d"}})]}),C&&B.length>0&&e.jsx("div",{className:"dropdown-menu show w-100",style:{maxHeight:"200px",overflowY:"auto",position:"absolute",zIndex:1e3,marginTop:"2px"},children:B.map(t=>e.jsx("div",{className:"dropdown-item cursor-pointer",style:{cursor:"pointer"},onClick:()=>ne(t),children:t.project_name},t.id))}),G&&e.jsxs("div",{className:"text-success mt-1 small",children:["âœ“ Selected: ",L]})]})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"po_no",children:"PO Number *"}),e.jsx(m,{type:"text",name:"po_no",value:s.po_no,onChange:l,placeholder:"Enter PO Number",required:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"po_date",children:"PO Date *"}),e.jsx(m,{type:"date",name:"po_date",value:s.po_date,onChange:l,required:!0})]})]}),e.jsxs(j,{className:"mb-3",children:[e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"invoice_no",children:"Invoice Number *"}),e.jsx(m,{type:"text",name:"invoice_no",value:s.invoice_no,onChange:l,placeholder:"Enter Invoice Number",required:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"invoice_date",children:"Invoice Date *"}),e.jsx(m,{type:"date",name:"invoice_date",value:s.invoice_date,onChange:l,required:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"basic_amount",children:"Amount Before GST*"}),e.jsx(m,{type:"number",step:"0.01",name:"basic_amount",value:s.basic_amount,onChange:l,placeholder:"Enter Basic Amount",required:!0})]})]}),e.jsxs(j,{className:"mb-3",children:[e.jsxs(a,{md:4,children:[e.jsxs(c,{htmlFor:"gst_amount",children:["GST Amount (",R,"%)"]}),e.jsx(m,{type:"number",step:"0.01",name:"gst_amount",value:s.gst_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"billing_amount",children:"Amount With GST"}),e.jsx(m,{type:"number",step:"0.01",name:"billing_amount",value:s.billing_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"received_amount",children:"Received Amount *"}),e.jsx(m,{type:"number",step:"0.01",name:"received_amount",value:s.received_amount,onChange:l,placeholder:"Enter Received Amount",required:!0})]})]}),e.jsxs(j,{className:"mb-3",children:[e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"pending_amount",children:"Pending Amount"}),e.jsx(m,{type:"number",step:"0.01",name:"pending_amount",value:s.pending_amount,onChange:l,placeholder:"Auto-calculated",disabled:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"received_by",children:"Sent By *"}),e.jsx(m,{type:"text",name:"received_by",value:s.received_by,onChange:l,placeholder:"Enter Receiver Name",required:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"payment_type",children:"Payment Type *"}),e.jsxs(J,{name:"payment_type",value:s.payment_type,onChange:l,required:!0,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),ue.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]})]}),e.jsxs(j,{className:"mb-3",children:[e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"senders_bank",children:"Sender's Bank *"}),e.jsx(m,{type:"text",name:"senders_bank",value:s.senders_bank,onChange:l,placeholder:"Enter Sender's Bank",required:!0})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"receivers_bank",children:"Receiver's Bank *"}),e.jsxs(J,{name:"receivers_bank",value:s.receivers_bank,onChange:l,required:!0,children:[e.jsx("option",{value:"",children:"Select Receiver's Bank"}),pe.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]})]}),e.jsxs(a,{md:4,children:[e.jsx(c,{htmlFor:"remark",children:"Transaction Number"}),e.jsx(m,{type:"text",name:"remark",value:s.remark,onChange:l,placeholder:"Enter Transaction Number (optional)"})]})]}),e.jsx(j,{children:e.jsxs(a,{md:12,className:"d-flex gap-2",children:[e.jsx(T,{type:"submit",color:"primary",disabled:M,children:M?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:"sm",className:"me-2"}),u?"Updating...":"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{icon:u?ye:$,className:"me-2"}),u?"Update Income":"Save Income"]})}),e.jsx(T,{type:"button",color:"secondary",onClick:P,children:"Reset"})]})})]})]})]})})};export{Oe as default};

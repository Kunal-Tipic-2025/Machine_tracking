import{r as n,u as Rt,b as Dt,j as e,C as rt}from"./index-Cn-27-TL.js";/* empty css                */import{a as Y,b as y,c as P,d as v}from"./index.esm-2RRpQEeO.js";import{a as B,b as oe,p as X}from"./api-BUyL__Lx.js";import{C as zt}from"./ChargeTypeModal-DSTpi0mu.js";import{N as Wt}from"./NewCustomerModal-Dntmdr8v.js";import{u as $t}from"./DefaultLayout-Vrb03iJh.js";import{C as Ce,a as de}from"./CCardBody-Bfh-O-BQ.js";import{C as nt}from"./CCardHeader-DyQDv_BY.js";import{C as Ot}from"./CForm-D5S3-WLx.js";import{C as _}from"./CFormLabel-CFBomnnz.js";import{C as ct}from"./CInputGroup-DlnfNMD-.js";import{C as w}from"./CFormInput-CL8d5WGe.js";import{C as it}from"./CInputGroupText-D1PL96Mo.js";import{c as ot}from"./cil-search-CDkY_4k-.js";import{c as ke}from"./cil-x-0440B5Ce.js";import{c as Ut}from"./cil-check-circle-BlU9eaow.js";import{c as Ht}from"./cil-location-pin-CQr6GRP7.js";import{C as Se}from"./CFormSelect-BzqPV41T.js";import"./CFormCheck-Drk7w5bS.js";import"./CFormControlValidation-BvfkKe2L.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-O4w4bCVl.js";import"./CNavItem-EvCITOBp.js";import"./CFormControlWrapper-CPiMjLs0.js";const ja=({editMode:W=!1,initialData:x=null,onSubmit:Ae=null})=>{const[dt,lt]=n.useState(!1),[Ie,R]=n.useState(!1),[Te,Fe]=n.useState(!0),[J,mt]=n.useState([]),ut=Rt();$t();const{showToast:u}=Dt(),[$,E]=n.useState([]),[C,ht]=n.useState([]),[Qt,le]=n.useState([]),[g,K]=n.useState(""),[O,D]=n.useState(!1),[me,ue]=n.useState([]),[he,pe]=n.useState([]),[Z,pt]=n.useState([]),[S,ee]=n.useState([]),[m,te]=n.useState([]),xe=n.useRef(null),ae=n.useRef(null),[A,Ee]=n.useState(!1),[I,Le]=n.useState(""),[ge,Me]=n.useState(""),[fe,Pe]=n.useState(""),[_e,Be]=n.useState(""),[T,Re]=n.useState(!1),[L,De]=n.useState(""),[z,ze]=n.useState(""),[We,$e]=n.useState(""),[Oe,Ue]=n.useState(""),[He,Qe]=n.useState(""),[qe,xt]=n.useState([]),[U,Ge]=n.useState(""),[d,se]=n.useState({projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},invoiceType:3,invoiceDate:new Date().toISOString().split("T")[0],discount:0,paidAmount:0,finalAmount:0,projectCost:0,payed:0,start_date:"",end_date:"",selectedMachines:[],company_id:null}),[qt,gt]=n.useState([{work_type:"",qty:0,price:0,total_price:0,remark:""}]),[F,je]=n.useState(null),[H,Q]=n.useState(""),[ft,be]=n.useState(!1),[_t,jt]=n.useState(""),[q,bt]=n.useState([]),[Gt,Nt]=n.useState({}),[yt,G]=n.useState({}),[wt,Ve]=n.useState(!1),[Ye,vt]=n.useState(null),[Xe,Ct]=n.useState({name:"",local_name:"",amount_deduct:!1}),[k,Ne]=n.useState([{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}]),Je=async()=>{try{const t=await B("/api/charge-types");Array.isArray(t)&&bt(t)}catch(t){console.error("Error fetching charge types:",t)}};n.useEffect(()=>{Je()},[]);const re=(t,r,a)=>{const s=[...k];if(r==="charge_type"){const c=q.find(i=>String(i.name)===String(a)||String(i.id)===String(a));s[t].charge_type=a,c?(s[t].charge_type_id=c.id,s[t].amount_deduct=!!c.amount_deduct,s[t].local_name=c.local_name):(s[t].charge_type_id=null,s[t].amount_deduct=!1)}else s[t][r]=a;Ne(s)},kt=()=>{Ne([...k,{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}])},St=t=>{Ne(k.filter((r,a)=>a!==t))};n.useEffect(()=>{(async()=>{try{const r=await B("/api/workingType");xt(r||[])}catch(r){console.error("Error fetching work types",r)}})()},[]);const ne=n.useMemo(()=>{const t={};return qe.forEach(r=>{t[r.id]=r.type_of_work}),t},[qe]),ce=n.useCallback(async(t="")=>{Fe(!0);try{const r=t?`/api/projects?searchQuery=${encodeURIComponent(t)}`:"/api/projects",a=await B(r),s=Array.isArray(a)?a:a==null?void 0:a.data;if(!s||!Array.isArray(s)){E([]),t||u("warning","No projects data available from server");return}const c=s.map(i=>({id:i.id,project_name:i.project_name||"Unknown Project",customer_name:i.customer_name||"Unknown Customer",work_place:i.work_place||"",project_cost:i.project_cost||"0",mobile_number:i.mobile_number||"",gst_number:i.gst_number||"",remark:i.remark||"",paidamount:i.paidamount||0,customer_id:i.customer_id||i.id,company_id:i.company_id,machine_id:i.machine_id||[],customer:{name:i.customer_name||"Unknown",address:i.work_place||"N/A",mobile:i.mobile_number||"N/A"},start_date:i.start_date,end_date:i.end_date})).filter(i=>i.project_name&&i.customer_id);E(c)}catch(r){console.error("Error fetching projects:",r),E([]),t||u("danger","Failed to fetch projects")}finally{Fe(!1)}},[]);n.useEffect(()=>{var t,r,a,s;W&&x&&(se({projectId:x.projectId,customer_id:x.customer_id,customer_name:((t=x.customer)==null?void 0:t.name)||"",address:((r=x.customer)==null?void 0:r.address)||"",mobile_number:((a=x.customer)==null?void 0:a.mobile)||"",customer:x.customer,invoiceType:x.invoiceType,invoiceDate:x.invoiceDate,discount:x.discount||0,payed:x.paidamount||0,finalAmount:x.finalAmount||0,start_date:x.start_date||"",end_date:x.end_date||""}),gt(x.items||[{work_type:"",qty:0,price:0,total_price:0,remark:""}]),K(((s=x.customer)==null?void 0:s.name)||""))},[W,x]),n.useEffect(()=>{ce()},[ce]),n.useEffect(()=>{const t=setTimeout(()=>{g&&g.length>0?ce(g):g.length===0&&(E([]),D(!1))},100);return()=>clearTimeout(t)},[g,ce]),n.useEffect(()=>{if(g&&$.length>0){const t=g.toLowerCase(),r=$.filter(a=>a.project_name&&a.project_name.toLowerCase().includes(t)||a.customer_name&&a.customer_name.toLowerCase().includes(t)||a.work_place&&a.work_place.toLowerCase().includes(t)||a.mobile_number&&a.mobile_number.includes(t)||a.remark&&a.remark.toLowerCase().includes(t));console.log("Filtered projects:",r,"Query:",g),ue(r)}else ue([])},[g,$]);const At=async()=>{try{const t=await B("/api/machineLog");pe(t||[])}catch(t){u("danger","Error fetching machine logs: "+t)}},It=()=>{B("/api/operatorsByCompanyIdOperator").then(t=>{mt(t||[]),R(!1)}).catch(t=>{console.log(t.message),R(!1)})};n.useEffect(()=>{At(),It()},[]),n.useEffect(()=>{const t=r=>{xe.current&&!xe.current.contains(r.target)&&ae.current&&!ae.current.contains(r.target)&&D(!1)};return O&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[O]);const Tt=async()=>{try{const t=await B("/api/machine-operators");ht(t)}catch(t){console.error("Error fetching machineries:",t),u("danger","Error fetching machineries")}},Ft=async()=>{try{const t=await B("/api/machine-price");pt(t)}catch(t){console.error("Error fetching machineries:",t),u("danger","Error fetching machineries")}};n.useEffect(()=>{Tt(),Ft()},[]);const ye=n.useCallback(t=>{if(!t||!t.machine_id||!Array.isArray(t.machine_id)||C.length===0){le([]);return}const r=C.filter(a=>t.machine_id.includes(String(a.id)));le(r)},[C]);n.useEffect(()=>{if(C.length>0&&d.projectId){const t=$.find(r=>r.id===d.projectId);t&&ye(t)}},[C,d.projectId,$,ye]),n.useEffect(()=>{if(!d.projectId)return;const t=setTimeout(async()=>{try{const r=Number(d.payed)||0;await oe(`/api/projects/${d.projectId}/paidamount`,{paidamount:r})}catch(r){console.error("Failed updating project paidamount:",r)}},500);return()=>clearTimeout(t)},[d.projectId,d.payed]),n.useEffect(()=>{if(!d.projectId||he.length===0){ee([]);return}const r=he.filter(a=>String(a.project_id)===String(d.projectId)).filter(a=>a.isPaid==0);ee(r)},[he,d.projectId]);const V=n.useCallback(t=>{if(!t||C.length===0)return"N/A";const r=C.find(a=>String(a.id)===String(t));return(r==null?void 0:r.machine_name)||"N/A"},[C]),Ke=t=>{const r=parseFloat(t.project_cost)||0,a=parseFloat(d.discount)||0,s=Math.max(0,r-a);se(c=>({...c,projectId:t.id,payed:t.paidamount,customer_id:t.customer_id,customer_name:t.customer_name,address:t.work_place,mobile_number:t.mobile_number,start_date:t.start_date,end_date:t.end_date,projectCost:r,finalAmount:s,company_id:t.company_id,customer:{name:t.customer_name,address:t.customer.address,mobile:t.customer.mobile},selectedMachines:[]})),D(!1),K(t.customer_name),E([]),ye(t),we("")},[ie,we]=n.useState(""),f=n.useMemo(()=>{let t=S;if(ie&&(t=t.filter(a=>String(a.machine_id)===String(ie))),!U.trim())return t;const r=U.toLowerCase();return t.filter(a=>{var j,p,M;const s=((j=ne[a.work_type_id])==null?void 0:j.toLowerCase())||"",c=J.find(N=>N.id==a.operator_id),i=((p=c==null?void 0:c.name)==null?void 0:p.toLowerCase())||"",l=V(a.machine_id).toLowerCase(),o=Z.find(N=>N.id===Number(a.mode_id)),h=((M=o==null?void 0:o.mode)==null?void 0:M.toLowerCase())||"",b=String(a.work_date).slice(0,10);return s.includes(r)||i.includes(r)||l.includes(r)||h.includes(r)||b.includes(r)})},[S,U,ne,J,V,Z,ie]),Et=()=>{se(t=>({...t,projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},projectCost:0,payed:0,finalAmount:0,selectedMachines:[]})),K(""),D(!1),E([]),le([]),we("")},Ze=()=>{D(!1),jt(g||""),be(!0)},Lt=t=>{t?(Ke(t),u("success","Customer added and selected successfully")):u("success","Customer added successfully, please search to select"),be(!1),E([]),ue([])},Mt=t=>{const{name:r,value:a}=t.target,s=r==="discount"||r==="paidAmount"?parseFloat(a)||0:a;se(c=>{const i={...c,[r]:s};if(r==="discount"){const l=parseFloat(c.projectCost)||0,o=parseFloat(s)||0;i.finalAmount=Math.max(0,l-o)}return i})},et=t=>{je(t.id),Q(String(t.price_per_hour??0))},tt=()=>{je(null),Q("")},at=async t=>{const r=Number(H);if(isNaN(r)||r<0){u("danger","Enter a valid price");return}try{const a=await oe(`/api/machine-logs/${t.id}/price`,{price_per_hour:r});if(a&&a.error){u("danger","Failed to update price");return}ee(s=>s.map(c=>String(c.id)===String(F)?{...c,price_per_hour:r}:c)),typeof pe=="function"&&pe(s=>Array.isArray(s)?s.map(c=>String(c.id)===String(F)?{...c,price_per_hour:r}:c):s),je(null),Q(""),u("success","Price updated successfully")}catch(a){console.error("Error updating log price:",a),u("danger","Error updating price")}},st=t=>{te(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},Pt=async t=>{if(t.preventDefault(),!t.currentTarget.checkValidity()){lt(!0);return}if(!d.projectId||!d.customer_id){u("danger","Please select a customer");return}for(const s of k)if(Number(s.amount)>0){if(!s.charge_type){u("danger","Please select a charge type for the entered amount");return}if(!q.some(i=>i.name===s.charge_type||i.id===s.charge_type_id)&&!s.charge_type_id){u("danger",`Charge type "${s.charge_type}" is invalid. Please add it using the dropdown options.`);return}}const a=k.filter(s=>s.charge_type&&Number(s.amount)>0).map(s=>{var c;return{charge_type:s.charge_type,charge_type_id:s.charge_type_id??((c=q.find(i=>i.name===s.charge_type))==null?void 0:c.id)??null,amount:Number(s.amount),amount_deduct:s.amount_deduct??!1,remark:s.remark||null,is_paid:s.is_paid??!1,date:s.date}});try{if(R(!0),d.projectId){const o=Number(d.payed)||0;try{await oe(`/api/projects/${d.projectId}/paidamount`,{paidamount:o})}catch(h){console.error("Failed to update project paidamount on submit:",h)}}const s=S.filter(o=>m.includes(o.id));console.log("Selected Rows:",s);const c=s.length>0?s[0].company_id:d.company_id;if(s.length===0&&!(A&&Number(I)>0)&&!(T&&Number(L)>0)){u("warning","Select logs, enable Advance Payment, or enable Fixed Bid Work"),R(!1);return}const i=s.reduce((o,h)=>{const b=Number(h.machine_start??h.start_reading??0)||0,j=Number(h.machine_end??h.end_reading??0)||0,p=h.actual_machine_hr!=null&&!isNaN(Number(h.actual_machine_hr))?Number(h.actual_machine_hr):Math.max(0,j-b),M=Number(h.price_per_hour)||0;return o+p*M},0);let l=null;if(s.length>0){console.log("ðŸ”„ Updating isPaid=1 for logs:",m);const o=m.map(N=>oe(`/api/machine-logs/${N}/isPaid`,{isPaid:1}));await Promise.all(o),console.log("âœ… ALL selected logs updated to isPaid = 1"),ee(N=>N.map(ve=>m.includes(ve.id)?{...ve,isPaid:1}:ve)),te([]);let h=0,b=null,j=null,p=null;A&&Number(I)>0&&(h=Number(I),b=ge,j=fe,p=_e);const M={project_id:d.projectId,company_id:c,total:i,paid_amount:h,worklog_ids:m,payment_mode:b,transaction_id:j,remark:p};if(W&&Ae)await Ae(M),u("success",`${s.length} logs marked as paid`);else{const N=await X("/api/project-payments",M);N&&N.id&&(l=N.id,a.length>0&&await X("/api/invoice-additional-charges/bulk",{invoice_id:String(N.id),company_id:c,charges:a}),u("success",`Invoice created! ${s.length} logs marked as PAID âœ…`))}}if(s.length===0&&A&&Number(I)>0){const o=await X("/api/project-payments",{company_id:c,project_id:d.projectId,total:Number(I),paid_amount:Number(I),is_advance:!0,transaction_id:fe||null,mode:ge||null,remark:_e||null});o&&o.id&&(u("success","Advance payment invoice created"),l||(l=o.id))}if(T&&Number(L)>0){if(Number(z)>Number(L)){u("danger","Advance amount cannot be greater than Total amount"),R(!1);return}const o=await X("/api/project-payments",{company_id:c,project_id:d.projectId,total:Number(L),paid_amount:Number(z)||0,is_fixed_bid:!0,transaction_id:Number(z)>0?Oe:null,mode:Number(z)>0?We:"Fixed Bid",remark:He||null,date:d.invoiceDate});o&&o.id&&(l||(l=o.id),a.length>0&&await X("/api/invoice-additional-charges/bulk",{invoice_id:String(o.id),company_id:c,charges:a}),u("success","Fixed Bid Work invoice created"))}l&&setTimeout(()=>{ut(`/payment-page/${l}`)},1e3)}catch(s){console.error("Submit error:",s),u("danger","Failed to create invoice")}finally{R(!1)}},Bt=n.useMemo(()=>S.length?[...new Set(S.map(r=>String(r.machine_id)))].map(r=>{const a=C.find(s=>String(s.id)===String(r));return a?{id:a.id,machine_name:a.machine_name}:null}).filter(Boolean):[],[S,C]);return e.jsxs(Y,{children:[e.jsx(y,{xs:12,children:e.jsxs(Ce,{className:"mb-4",children:[e.jsx(nt,{children:e.jsx("strong",{children:W?"Edit Invoice":"Create Invoice"})}),e.jsxs(de,{children:[e.jsxs(Ot,{validated:dt,onSubmit:Pt,children:[e.jsxs(Y,{className:"mb-3",children:[e.jsxs(y,{md:4,children:[e.jsxs(_,{children:["Customer Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("div",{ref:xe,style:{position:"relative"},children:[e.jsxs(ct,{children:[e.jsx(w,{type:"text",value:g,onChange:t=>{K(t.target.value),D(!0)},placeholder:"Search...",required:!0}),e.jsx(it,{children:e.jsx(P,{icon:ot})}),g&&e.jsx(v,{color:"link",onClick:Et,className:"position-absolute end-0 me-5",children:e.jsx(P,{icon:ke})})]}),Te&&O&&g.length>0&&e.jsxs("div",{className:"dropdown-menu show p-2",children:[e.jsx(rt,{size:"sm"})," Loading customers..."]}),O&&me.length>0&&e.jsxs("div",{ref:ae,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:[me.map(t=>e.jsxs("div",{className:"dropdown-item cursor-pointer p-2 border-bottom",onClick:()=>Ke(t),onMouseEnter:r=>r.target.style.backgroundColor="#f8f9fa",onMouseLeave:r=>r.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium text-primary",children:t.customer_name}),t.work_place&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",t.work_place]}),t.mobile_number&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Mobile:"})," ",t.mobile_number]})]},t.id)),e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ze,children:['Add customer "',g,'"']})})]}),g.length>0&&me.length===0&&O&&e.jsx("div",{ref:ae,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ze,children:['Add customer "',g,'"']})})})]}),d.customer_name&&e.jsx("div",{className:"mt-1",children:e.jsxs("div",{className:"small text-success d-flex align-items-center flex-wrap",children:[e.jsxs("span",{className:"me-2",children:[e.jsxs("strong",{children:[e.jsx(P,{icon:Ut,size:"sm",className:"me-1"}),"Selected:"]})," ",d.customer_name]}),d.customer.address&&e.jsxs("span",{className:"text-muted ms-auto ms-md-2",style:{fontSize:"0.85em"},children:[e.jsx(P,{icon:Ht,size:"sm",className:"me-1"}),d.customer.address]})]})})]}),e.jsxs(y,{md:4,children:[e.jsx(_,{children:"Select Machine"}),e.jsxs(Se,{value:ie,onChange:t=>we(t.target.value),disabled:!d.projectId,children:[e.jsx("option",{value:"",children:"All Machines"}),Bt.map(t=>e.jsx("option",{value:t.id,children:t.machine_name},t.id))]})]}),e.jsxs(y,{md:4,children:[e.jsxs(_,{children:["Invoice Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(w,{type:"date",name:"invoiceDate",value:d.invoiceDate,onChange:Mt,required:!0})]})]}),S.length>0&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2",children:[e.jsxs("div",{className:"fw-semibold mb-0 d-flex flex-wrap align-items-center gap-2",children:[e.jsxs("span",{className:"text-nowrap",children:["Project Logs (Total: ",S.length,")"]}),e.jsx("span",{className:"d-none d-md-inline text-muted",children:"|"}),e.jsxs("span",{className:"text-primary text-nowrap",children:["Showing: ",f.length]}),e.jsx("span",{className:"d-none d-md-inline text-muted",children:"|"}),e.jsxs("span",{className:"text-success text-nowrap",children:["Selected: ",m.length]})]}),e.jsx("div",{className:"w-100",style:{maxWidth:"300px"},children:e.jsxs(ct,{size:"sm",children:[e.jsx(it,{children:e.jsx(P,{icon:ot})}),e.jsx(w,{type:"text",placeholder:"Search...",value:U,onChange:t=>Ge(t.target.value)}),U&&e.jsx(v,{color:"secondary",variant:"outline",onClick:()=>Ge(""),children:e.jsx(P,{icon:ke})})]})})]}),e.jsx("div",{className:"d-none d-md-block table-responsive",style:{border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff"},children:e.jsxs("table",{className:"table table-bordered align-middle mb-0",style:{minWidth:"1200px",width:"100%",tableLayout:"fixed"},children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&f.every(t=>m.includes(t.id)),onChange:t=>{const r=t.target.checked;te(r?[...new Set([...m,...f.map(a=>a.id)])]:m.filter(a=>!f.map(s=>s.id).includes(a)))}})}),e.jsx("th",{style:{width:"90px",minWidth:"90px"},className:"text-center align-middle",children:"Date"}),e.jsx("th",{style:{width:"110px",minWidth:"100px"},className:"text-center align-middle",children:"Machine"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Operator"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Work Type"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Start"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"End"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Net"}),e.jsx("th",{style:{width:"70px"},className:"text-center align-middle",children:"Mode"}),e.jsx("th",{style:{width:"90px"},className:"text-center align-middle",children:"Price/Hr"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Total"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Action"})]})}),e.jsxs("tbody",{children:[f.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,c=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),i=String(t.work_date).slice(0,10).split("-").reverse().join("-"),l=J.find(p=>p.id==t.operator_id)||{name:"N/A"},o=String(t.id)===String(F)?Number(H||0):Number(t.price_per_hour||0),h=c*o,b=Z.find(p=>p.id===Number(t.mode_id)),j=b?b.mode:"N/A";return e.jsxs("tr",{children:[e.jsx("td",{className:"text-center align-middle","data-label":"Select",children:e.jsx("input",{type:"checkbox",checked:m.includes(t.id),onChange:()=>st(t.id)})}),e.jsx("td",{className:"text-center small","data-label":"Date",children:i||"N/A"}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"110px"},title:V(t.machine_id),"data-label":"Machine",children:V(t.machine_id)}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"100px"},title:l.name,"data-label":"Operator",children:l.name}),e.jsx("td",{"data-label":"Work Type",children:ne[t.work_type_id]||"-"}),e.jsx("td",{className:"text-center","data-label":"Start",children:a}),e.jsx("td",{className:"text-center","data-label":"End",children:s}),e.jsx("td",{className:"text-center","data-label":"Net",children:c}),e.jsx("td",{className:"text-center small","data-label":"Mode",children:j}),e.jsx("td",{"data-label":"Price/Hr",children:String(t.id)===String(F)?e.jsx("input",{type:"number",value:H,min:0,step:"0.01",onChange:p=>Q(p.target.value),style:{width:"70px",fontSize:"0.875rem"},className:"form-control form-control-sm"}):e.jsxs("div",{className:"text-center small",children:["â‚¹",o]})}),e.jsxs("td",{className:"text-center small","data-label":"Total",children:["â‚¹",h.toFixed(2)]}),e.jsx("td",{className:"text-center","data-label":"Action",children:String(t.id)===String(F)?e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"sm",color:"success",className:"me-1",onClick:()=>at(t),children:"Save"}),e.jsx(v,{size:"sm",color:"secondary",variant:"outline",onClick:tt,children:"Cancel"})]}):e.jsx(v,{size:"sm",color:"info",className:"text-white",onClick:()=>et(t),children:"Edit"})})]},r)}),m.length>0&&(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,i=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,i-c);return a+l},0),r=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,i=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,i-c),o=Number(s.price_per_hour)||0;return a+l*o},0);return e.jsxs("tr",{className:"fw-bold table-success",children:[e.jsx("td",{className:"text-center align-middle","data-label":"Total Count",children:m.length}),e.jsx("td",{colSpan:"6",className:"text-end pe-3 d-none d-md-table-cell",children:"Grand Total:"}),e.jsx("td",{className:"d-md-none","data-label":"Grand Total Label",children:"Grand Total:"}),e.jsx("td",{className:"text-center","data-label":"Total Net",children:t.toFixed(2)}),e.jsx("td",{}),e.jsxs("td",{className:"text-center","data-label":"Grand Total Amount",children:["â‚¹",r.toFixed(2)]}),e.jsx("td",{})]})})()]})]})}),e.jsxs("div",{className:"d-md-none",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 p-2 bg-light rounded shadow-sm border",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",id:"selectAllMobile",checked:f.length>0&&f.every(t=>m.includes(t.id)),onChange:t=>{const r=t.target.checked;te(r?[...new Set([...m,...f.map(a=>a.id)])]:m.filter(a=>!f.map(s=>s.id).includes(a)))}}),e.jsx("label",{htmlFor:"selectAllMobile",className:"fw-semibold text-secondary mb-0",children:"Select All Logs"})]}),f.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,c=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),i=String(t.work_date).slice(0,10).split("-").reverse().join("-"),l=J.find(p=>p.id==t.operator_id)||{name:"N/A"},o=String(t.id)===String(F)?Number(H||0):Number(t.price_per_hour||0),h=c*o,b=Z.find(p=>p.id===Number(t.mode_id));b&&b.mode;const j=m.includes(t.id);return e.jsx(Ce,{className:`mb-3 shadow-sm border ${j?"border-primary":""}`,style:{backgroundColor:j?"#f8f9ff":"#fff"},children:e.jsxs(de,{className:"p-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2 border-bottom pb-2",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",style:{width:"1.2em",height:"1.2em"},checked:j,onChange:()=>st(t.id)}),e.jsx("h6",{className:"mb-0 fw-bold",children:i||"N/A"})]}),e.jsx("div",{className:"text-end",children:String(t.id)===String(F)?e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(v,{size:"sm",color:"success",className:"p-1 px-2 text-white",onClick:()=>at(t),children:"âœ“"}),e.jsx(v,{size:"sm",color:"secondary",variant:"outline",className:"p-1 px-2",onClick:tt,children:"âœ•"})]}):e.jsx(v,{size:"sm",color:"light",className:"text-primary p-1 px-2",onClick:()=>et(t),children:e.jsx("span",{className:"small fw-bold",children:"Edit Price"})})})]}),e.jsxs("div",{className:"row g-2 text-dark",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Machine"}),e.jsx("span",{className:"fw-medium",children:V(t.machine_id)})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Operator"}),e.jsx("span",{className:"fw-medium",children:l.name})]}),e.jsxs("div",{className:"col-6 text-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Work Type"}),e.jsx("span",{className:"fw-medium",children:ne[t.work_type_id]||"-"})]}),e.jsx("div",{className:"col-12 border-top my-1"}),e.jsxs("div",{className:"col-4 text-center",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Start"}),e.jsx("span",{className:"fw-bold",children:a})]}),e.jsxs("div",{className:"col-4 text-center border-start border-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"End"}),e.jsx("span",{className:"fw-bold",children:s})]}),e.jsxs("div",{className:"col-4 text-center",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Net Hr"}),e.jsx("span",{className:"fw-bold text-success",children:c})]}),e.jsx("div",{className:"col-12 border-top my-1"}),e.jsxs("div",{className:"col-6",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Rate / Hr"}),String(t.id)===String(F)?e.jsx("input",{type:"number",value:H,min:0,step:"0.01",onChange:p=>Q(p.target.value),className:"form-control form-control-sm"}):e.jsxs("span",{className:"fw-bold",children:["â‚¹",o]})]}),e.jsxs("div",{className:"col-6 text-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Total Price"}),e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",h.toFixed(2)]})]})]})]})},r)}),m.length>0&&(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,i=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,i-c);return a+l},0),r=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,i=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,i-c),o=Number(s.price_per_hour)||0;return a+l*o},0);return e.jsxs("div",{className:"position-sticky bottom-0 bg-white p-3 border-top shadow-lg rounded-top",style:{zIndex:1050},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-1",children:[e.jsxs("span",{className:"text-secondary fw-semibold",children:["Selected Logs (",m.length,")"]}),e.jsxs("span",{className:"badge bg-success",children:[t.toFixed(2)," Hrs"]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0 fw-bold",children:"Grand Total"}),e.jsxs("h4",{className:"mb-0 fw-bold text-primary",children:["â‚¹",r.toFixed(2)]})]})]})})()]})]}),S.length>0&&e.jsxs(Ce,{className:"mb-4 border-0 shadow-sm",children:[e.jsx(nt,{style:{background:"#f3f4f6"},children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges"})}),e.jsx(de,{children:k.map((t,r)=>e.jsxs(Y,{className:"align-items-end mb-3",style:{zIndex:1e3-r,position:"relative"},children:[e.jsxs(y,{xs:12,md:3,className:"mb-2 mb-md-0",children:[e.jsx(_,{children:"Charge Type"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx(w,{type:"text",placeholder:"Select or Search...",value:t.charge_type,onChange:a=>{re(r,"charge_type",a.target.value),Nt(s=>({...s,[r]:a.target.value})),G(s=>({...s,[r]:!0}))},onFocus:()=>G(a=>({...a,[r]:!0})),onBlur:()=>setTimeout(()=>G(a=>({...a,[r]:!1})),200)}),yt[r]&&e.jsxs("div",{className:"dropdown-menu show",style:{width:"100%",maxHeight:"200px",overflowY:"auto",position:"absolute",top:"100%",left:0,zIndex:1050},children:[q.filter(a=>!t.charge_type||a.name.toLowerCase().includes(t.charge_type.toLowerCase())||a.local_name&&a.local_name.toLowerCase().includes(t.charge_type.toLowerCase())).map(a=>e.jsxs("button",{className:"dropdown-item",type:"button",onMouseDown:s=>s.preventDefault(),onClick:()=>{re(r,"charge_type",a.name),G(s=>({...s,[r]:!1}))},children:[a.name," ",a.local_name?`(${a.local_name})`:""," ",a.amount_deduct?"(-)":"(+)"]},a.id)),q.every(a=>a.name.toLowerCase()!==(t.charge_type||"").toLowerCase())&&e.jsxs("button",{className:"dropdown-item text-primary fw-bold",type:"button",onMouseDown:a=>a.preventDefault(),onClick:()=>{Ct(a=>({...a,name:t.charge_type})),vt(r),Ve(!0),G(a=>({...a,[r]:!1}))},children:['+ Add "',t.charge_type,'"']})]})]})]}),e.jsxs(y,{xs:6,md:2,className:"mb-2 mb-md-0",children:[e.jsx(_,{children:"Amount"}),e.jsx(w,{type:"number",placeholder:"0",value:t.amount,onChange:a=>re(r,"amount",a.target.value)})]}),e.jsx(y,{xs:6,md:"auto",className:"mb-2 mb-md-0",children:e.jsx(v,{size:"sm",color:"primary",variant:"outline",onClick:kt,className:"w-100 w-md-auto",children:"+ Add"})}),e.jsx(y,{xs:12,md:1,className:"text-end text-md-start",children:k.length>1&&e.jsx(v,{color:"danger",variant:"ghost",onClick:()=>St(r),children:e.jsx(P,{icon:ke})})})]},r))}),k.some(t=>t.charge_type&&t.amount)&&e.jsx(de,{className:"border-top bg-light",children:e.jsxs(Y,{className:"align-items-center",children:[e.jsx(y,{xs:6,md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges Net:"})}),e.jsx(y,{xs:6,md:3,className:"text-end text-md-start",children:e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",k.filter(t=>t.charge_type&&t.amount).reduce((t,r)=>{const a=parseFloat(r.amount)||0;return r.amount_deduct?t-a:t+a},0).toFixed(2)]})})]})})]}),m.length>0&&e.jsxs(Y,{className:"align-items-center mt-3 pt-3 border-top",children:[e.jsx(y,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold text-success",children:"Actual Payable(Logs + Additional Charges):"})}),e.jsx(y,{md:3,children:e.jsxs("h4",{className:"mb-0 fw-bold text-success",children:["â‚¹",(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,i=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,i-c),o=Number(s.price_per_hour)||0;return a+l*o},0),r=k.filter(a=>a.charge_type&&a.amount).reduce((a,s)=>{const c=parseFloat(s.amount)||0;return s.amount_deduct?a-c:a+c},0);return(t+r).toFixed(2)})()]})})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${A?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${A?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"advanceSwitch",checked:A,disabled:T,onChange:t=>{const r=t.target.checked;Ee(r),r&&(Re(!1),De(""),ze(""),$e(""),Ue(""),Qe(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"advanceSwitch",children:"Advance Payment"})]}),A&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(_,{children:["Advance Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(w,{type:"number",min:"0",placeholder:"Enter amount",value:I,onChange:t=>Le(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Transaction ID"}),e.jsx(w,{type:"text",placeholder:"Enter transaction ID",value:fe,onChange:t=>Pe(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Mode"}),e.jsxs(Se,{value:ge,onChange:t=>Me(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Remark"}),e.jsx(w,{type:"text",placeholder:"Enter remark",value:_e,onChange:t=>Be(t.target.value)})]})]})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${T?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${T?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"fixedBidSwitch",checked:T,disabled:A,onChange:t=>{const r=t.target.checked;Re(r),r&&(Ee(!1),Le(""),Me(""),Pe(""),Be(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"fixedBidSwitch",children:"Fixed Bid Work"})]}),T&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(_,{children:["Total Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(w,{type:"number",min:"0",placeholder:"Enter total amount",value:L,onChange:t=>De(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Advance Amount"}),e.jsx(w,{type:"number",min:"0",placeholder:"Enter paid amount",value:z,onChange:t=>{const r=parseFloat(t.target.value)||0,a=parseFloat(L)||0;if(r>a){u("danger","Paid amount cannot be greater than Total amount");return}ze(t.target.value)}})]}),Number(z)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Transaction ID"}),e.jsx(w,{type:"text",placeholder:"Enter transaction ID",value:Oe,onChange:t=>Ue(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(_,{children:"Mode"}),e.jsxs(Se,{value:We,onChange:t=>$e(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx(_,{children:"Description"}),e.jsx(w,{type:"text",placeholder:"Enter description",value:He,onChange:t=>Qe(t.target.value)})]})]})]}),e.jsx(v,{color:"primary",type:"submit",disabled:Ie||!d.projectId||!d.customer_id||Te||m.length===0&&!(A&&Number(I)>0)&&!(T&&Number(L)>0),children:Ie?e.jsx(rt,{size:"sm"}):W?"Update Invoice":"Submit Invoice"})]}),e.jsx(Wt,{visible:ft,onClose:()=>be(!1),onSuccess:Lt,initialName:_t})]})]})}),wt&&e.jsx(zt,{visible:!0,onClose:()=>Ve(!1),onSuccess:t=>{Je(),Ye!==null&&re(Ye,"charge_type",t.name)},initialData:Xe.name?{name:Xe.name}:null})]})};export{ja as default};

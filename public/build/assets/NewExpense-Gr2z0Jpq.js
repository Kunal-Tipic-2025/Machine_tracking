import{r as d,u as Se,b as Le,i as K,j as s}from"./index-BTeA492D.js";import{g,a as L,c as ve,p as Ce}from"./api-BUyL__Lx.js";import{S as N}from"./react-select.esm-DEdRRhin.js";import{u as Ee,a as Ae,b as Ne,e as we,c as Be,d as Fe}from"./DefaultLayout-1THlq5Yf.js";import{a as Z,b as J,d as x}from"./index.esm-UVM2W3HN.js";import{C as Q,a as X}from"./CCardBody-BDPTx9XL.js";import{C as Y}from"./CCardHeader-7X8EpRUb.js";import{C as Me}from"./CForm-DLTIQo7N.js";import{C as _}from"./CFormLabel-N-ZSSVsb.js";import{C as f}from"./CFormInput-C-f2xD8x.js";import{C as qe,a as Ge,b as O,c as j,d as ke,e as y}from"./CTable-Dlaw-9GH.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./emotion-react.browser.esm-CfG45aL7.js";import"./floating-ui.dom-ByRZgDQ1.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-DvMRSoFa.js";import"./CNavItem-Dms8XRKU.js";import"./CFormControlWrapper-B0MocaRk.js";import"./CFormControlValidation-CspEyxkQ.js";const is=()=>{var P,U,z;d.useRef({});const[ee,w]=d.useState(!1),[se,ae]=d.useState([]),[u,G]=d.useState([]),[te,v]=d.useState(!1),[p,C]=d.useState(null),[Te,re]=d.useState([]),[Ie,k]=d.useState({name:"",id:null}),[B,F]=d.useState([]),[T,ne]=d.useState([]),[De,ie]=d.useState([]),[M,oe]=d.useState([]),[h,ce]=d.useState(!1),b=(P=g())==null?void 0:P.company_id,le=async()=>{if(!b){o("danger","Unable to determine company. Please log in again."),F([]);return}try{const e=await L(`/api/machine-operators?company_id=${b}`),a=Array.isArray(e)?e.filter(n=>n.company_id===b):[];F(a)}catch(e){console.error("Error fetching machineries:",e),o("danger","Error fetching machineries: "+((e==null?void 0:e.message)||"")),F([])}},de=async()=>{var a;const e=(a=g())==null?void 0:a.company_id;if(e)try{const n=await L(`/api/projects?company_id=${e}`);ne(n||[])}catch(n){console.error("Error fetching projects:",n)}},pe=async()=>{try{const e=await L("/api/operatorsByCompanyIdOperator");ie(e)}catch(e){console.error("Error fetching Users:",e),o("danger","Error fetching Users")}};Se();const{showToast:o}=Le(),{t}=Ee("global"),q=g(),[r,m]=d.useState({project_id:"",name:"",desc:"",expense_id:void 0,typeNotSet:!0,qty:1,price:0,total_price:0,expense_date:new Date().toISOString().split("T")[0],contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,isGst:!1,company_id:(q==null?void 0:q.company_id)||"",photoAvailable:!0,photo_url:null,photo_remark:"",operator_id:"",bank_name:"",acc_number:"",ifsc:"",aadhar:"",pan:"",transaction_id:"",machine_id:"",customer_id:""}),I=()=>{const e=localStorage.getItem("i18nextLng"),a=K.language;return e||a||"en"},me=(e,a=null)=>(a||I())==="mr"&&e.localName||e.name,D=async()=>{try{const e=await L("/api/expenseType");ae(e.filter(a=>a.show===1))}catch(e){o("danger","Error occurred "+e)}};d.useEffect(()=>{D(),le(),de(),pe(),ue();const e=g();e!=null&&e.company_id&&m(a=>({...a,company_id:e.company_id}))},[]),d.useEffect(()=>{D()},[K.language]),d.useEffect(()=>{if(!h)return;const e=g();((e==null?void 0:e.type)===2||(e==null?void 0:e.type)===4)&&m(a=>({...a,operator_id:e.id}))},[h]);const ue=async()=>{var e;try{const a=(e=g())==null?void 0:e.company_id,n=await L("/api/operatorsAnsHelperByCompanyIdOperator");console.log("setOperator",M),oe(n||[])}catch{o("danger","Error fetching operators")}},he=e=>{const a=parseFloat(e.qty)||0,n=parseFloat(e.price)||0;e.total_price=Math.round(a*n)},S=e=>{const{name:a,value:n,type:c,checked:l,files:V}=e.target;m(W=>{const i={...W};return c==="checkbox"&&a==="isGst"?(i.isGst=l,i):a==="price"||a==="qty"?(i[a]=n,he(i),i):a==="expense_id"?(i.expense_id=n,i.typeNotSet=!n,i):a==="name"?(/^[a-zA-Z0-9\u0900-\u097F ]*$/.test(n)&&(i.name=n),i):a==="photoAvailable"?(i.photoAvailable=l,l?i.photo_remark="":i.photo_url=null,i):c==="file"&&a==="photo_url"?(i.photo_url=V[0]||null,i):(i[a]=c==="checkbox"?l:n,i)})},_e=e=>{m({project_id:e.project_id,company_id:e.company_id,name:e.name,desc:e.desc||"",expense_id:e.expense_id,typeNotSet:!1,qty:e.qty,price:e.price,total_price:e.total_price,expense_date:e.expense_date,contact:e.contact,payment_by:e.payment_by,payment_type:e.payment_type,pending_amount:e.pending_amount,show:e.show,isGst:e.isGst}),k({name:e.customer_name,id:e.project_id}),C(e),w(!1),window.scrollTo({top:0,behavior:"smooth"}),o("info",t("MSG.expense_loaded_for_editing"))},xe=()=>{C(null),A(),o("info",t("MSG.edit_cancelled"))},ge=e=>{const a=u.filter(n=>n.id!==e);G(a),p&&p.id===e&&(C(null),A()),o("info",t("MSG.expense_removed_from_list"))},je=async e=>{if(e.preventDefault(),e.stopPropagation(),w(!0),!b){o("danger","Company is required for expense submission.");return}const a=new FormData;if(console.log("state"),console.log(r),a.append("company_id",b),r.project_id&&a.append("project_id",r.project_id),r.expense_id&&a.append("expense_id",r.expense_id),r.desc&&a.append("desc",r.desc),a.append("price",r.price),a.append("qty",r.qty),a.append("total_price",r.total_price),a.append("expense_date",r.expense_date),r.show!==void 0&&a.append("show",r.show?1:0),a.append("isGst",r.isGst?1:0),r.machine_id&&a.append("machine_id",r.machine_id),a.append("photoAvailable",r.photoAvailable?1:0),r.customer_id&&a.append("customer_id",r.customer_id),r.photo_url instanceof File&&a.append("photo_url",r.photo_url),r.open&&!h&&!r.machine_id){o("danger","Machine is required");return}if(h&&!r.operator_id){o("danger","Operator is required");return}h&&a.append("operator_id",r.operator_id);const n=!h&&r.expense_id&&r.price>0&&r.qty>0,c=h&&r.expense_id&&r.total_price>0&&r.operator_id;if(n||c)try{const l=await ve("/api/expense",a);console.log("response",l),l?o("success",t("MSG.new_expense_added_successfully_msg")):o("danger",t("MSG.error_occured_please_try_again_later_msg")),A()}catch(l){o("danger","Error occurred "+l)}else m(l=>({...l,typeNotSet:l.expense_id===void 0}))},ye=async()=>{if(u.length===0){o("warning",t("MSG.add_atleast_one_expense"));return}v(!0)},fe=async()=>{try{const e=u.map(c=>{const{id:l,expense_type_name:V,customer_name:W,...i}=c;return Ce("/api/expense",i)}),n=(await Promise.all(e)).filter(c=>c).length;if(n===u.length){const c=t("MSG.expenses_submitted_successfully",{count:n})||`${n} expenses submitted successfully`;o("success",c),G([]),C(null)}else{const c=t("MSG.partial_expenses_submitted",{successCount:n,totalCount:u.length})||`${n} out of ${u.length} expenses submitted`;o("warning",c)}}catch(e){const a=t("MSG.error_occurred")||"Error occurred";o("danger",`${a}: ${e}`)}v(!1)},$=()=>{const e=u.reduce((a,n)=>{const c=parseFloat(n.qty)||0,l=parseFloat(n.price)||0;return a+c*l},0);return Number(e.toFixed(2))},E=e=>`₹${parseFloat(e).toFixed(2)}`,H=new Date().toISOString().split("T")[0],A=async()=>{m({project_id:"",name:"",desc:"",expense_id:"",open:!1,qty:1,price:0,total_price:0,expense_date:H,contact:"",payment_by:"",payment_type:"",pending_amount:"",show:!0,typeNotSet:!1,isGst:!1,photo_remark:"",bank_name:"",acc_number:"",ifsc:"",transaction_id:"",customer_id:""}),k({name:"",id:null}),re([]),w(!1)},be=I();setTimeout(()=>{console.log("Machines",B)},2e3);const R=se.map(e=>({value:e.id,expense_category:e.expense_category,label:me(e,be)}));return s.jsxs(s.Fragment,{children:[s.jsx(Z,{children:s.jsx(J,{xs:12,children:s.jsxs(Q,{className:"mb-4",children:[s.jsx(Y,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[t(p?"LABELS.edit_expense":"LABELS.new_expense"),p&&s.jsx("span",{className:"ms-2 badge bg-warning text-dark",children:t("LABELS.editing_mode")})]}),s.jsx(x,{color:"danger",size:"sm",onClick:()=>window.location.href="/#/expense/new-type",children:t("LABELS.new_expense_type")})]})}),s.jsx(X,{children:s.jsxs(Me,{noValidate:!0,validated:ee,onSubmit:je,children:[s.jsxs("div",{className:"row",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"expense_id",children:s.jsx("b",{children:t("LABELS.expense_type")})}),s.jsx(N,{id:"expense_id",name:"expense_id",value:R.find(e=>String(e.value)===String(r.expense_id))||null,onChange:e=>{console.log("selectedOption",e);const a=String((e==null?void 0:e.expense_category)||"").toLowerCase();String((e==null?void 0:e.label)||"").toLowerCase();const n=a.includes("operator")||a.includes("helper")||a.includes("driver"),c=a.includes("machine")||a.includes("operator")||a.includes("helper")||a.includes("capital")||a.includes("operational");ce(n),m(l=>({...l,expense_id:e?e.value:"",open:c,customer_id:"",project_id:"",operator_id:""}))},options:R,placeholder:t("MSG.select_expense_type_msg"),isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),r.open&&s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"machine_id",children:s.jsx("b",{children:t("LABELS.machine")})}),s.jsx(N,{id:"machine_id",name:"machine_id",value:B.map(e=>({value:e.id,label:e.machine_name})).find(e=>String(e.value)===String(r.machine_id))||null,onChange:e=>m(a=>({...a,machine_id:e?e.value:""})),options:B.map(e=>({value:e.id,label:e.machine_name})),placeholder:"Select Machine",isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})}),r.expense_id&&s.jsx("div",{className:"col-sm-4",children:h?s.jsxs(s.Fragment,{children:[s.jsx(_,{children:s.jsx("b",{children:t("LABELS.operator_helper_name")})}),s.jsx(N,{value:M.map(e=>({value:e.id,label:e.name})).find(e=>String(e.value)===String(r.operator_id))||null,onChange:e=>m(a=>({...a,operator_id:e?e.value:""})),options:M.map(e=>({value:e.id,label:e.name})),isDisabled:((U=g())==null?void 0:U.type)===2||((z=g())==null?void 0:z.type)===4,placeholder:"Select Operator"})]}):s.jsx(s.Fragment,{children:s.jsxs("div",{className:"",children:[s.jsx(_,{htmlFor:"customer_id",children:s.jsx("b",{children:t("LABELS.customer_name")})}),s.jsx(N,{id:"customer_id",name:"customer_id",value:T.map(e=>({value:e.id,label:e.customer_name})).find(e=>String(e.value)===String(r.customer_id))||null,onChange:e=>m(a=>({...a,customer_id:e?e.value:"",project_id:e?e.value:""})),options:T.map(e=>({value:e.id,label:e.customer_name})),placeholder:t("LABELS.customer_name"),isClearable:!0,isSearchable:!0,styles:{control:e=>({...e,borderRadius:"0.5rem",borderColor:"#ced4da",minHeight:"38px"})}})]})})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"name",children:s.jsx("b",{children:t("LABELS.about_expense")})}),s.jsx(f,{type:"text",id:"desc",placeholder:t("LABELS.enter_expense_description"),name:"desc",value:r.desc,onChange:S})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"expense_date",children:s.jsx("b",{children:t("LABELS.expense_date")})}),s.jsx(f,{type:"date",id:"expense_date",name:"expense_date",max:H,value:r.expense_date,onChange:S,required:!0,feedbackInvalid:t("MSG.select_date_validation")})]})})]}),!h&&s.jsxs("div",{className:"row align-items-end",children:[s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"price",children:s.jsx("b",{children:t("LABELS.price_per_unit")})}),s.jsx(f,{type:"number",min:"0",id:"price",onWheel:e=>e.target.blur(),placeholder:"0.00",step:"0.01",name:"price",onFocus:()=>m(e=>({...e,price:""})),value:r.price,onChange:S,required:!0,feedbackInvalid:t("MSG.price_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"qty",children:s.jsx("b",{children:t("LABELS.total_units")})}),s.jsx(f,{type:"number",id:"qty",step:"0.01",min:"0",placeholder:" ",name:"qty",value:r.qty,onWheel:e=>e.target.blur(),onKeyDown:e=>{["e","+","-",","].includes(e.key)&&e.preventDefault()},onChange:e=>{const a=e.target.value;(a===""||/^\d+(\.\d{0,2})?$/.test(a))&&S(e)},required:!0,feedbackInvalid:t("MSG.quantity_validation")})]})}),s.jsx("div",{className:"col-sm-4",children:s.jsxs("div",{className:"mb-3",children:[s.jsx(_,{htmlFor:"total_price",children:s.jsx("b",{children:t("LABELS.total_price")})}),s.jsx(f,{type:"number",min:"0",onWheel:e=>e.target.blur(),id:"total_price",placeholder:"",name:"total_price",value:r.total_price,onChange:S,readOnly:!0})]})})]}),h&&s.jsxs("div",{className:"col-sm-4",children:[s.jsx(_,{children:s.jsx("b",{children:"Total Amount"})}),s.jsx(f,{type:"number",value:r.total_price,onFocus:()=>m(e=>({...e,total_price:""})),onChange:e=>m(a=>({...a,total_price:e.target.value})),required:!0})]}),s.jsx("div",{className:"row"}),s.jsxs("div",{className:"mb-3 mt-3",children:[s.jsx(x,{color:"success",type:"submit",children:t("LABELS.submit")})," ",p&&s.jsxs(s.Fragment,{children:[s.jsx(x,{color:"warning",type:"button",onClick:xe,children:t("LABELS.cancel_edit")})," "]}),s.jsx(x,{color:"secondary",onClick:A,children:t("LABELS.clear")})]})]})})]})})}),u.length>0&&s.jsx(Z,{children:s.jsx(J,{xs:12,children:s.jsxs(Q,{className:"mb-4",children:[s.jsx(Y,{children:s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("strong",{children:[t("LABELS.expenses_list")," (",u.length,")"]}),s.jsxs("span",{children:[t("LABELS.total_amount"),": ",s.jsx("strong",{children:E($())})]})]})}),s.jsxs(X,{children:[s.jsx("div",{className:"table-responsive",children:s.jsxs(qe,{striped:!0,hover:!0,children:[s.jsx(Ge,{children:s.jsxs(O,{children:[s.jsx(j,{children:t("LABELS.customer_name")}),s.jsx(j,{children:t("LABELS.expense_type")}),s.jsx(j,{children:t("LABELS.description")}),s.jsx(j,{children:t("LABELS.date")}),s.jsx(j,{children:t("LABELS.price")}),s.jsx(j,{children:t("LABELS.quantity")}),s.jsx(j,{children:t("LABELS.total")}),s.jsx(j,{children:t("LABELS.actions")})]})}),s.jsx(ke,{children:u.map(e=>s.jsxs(O,{className:p&&p.id===e.id?"table-warning":"",children:[s.jsx(y,{children:e.customer_name}),s.jsx(y,{children:e.expense_type_name}),s.jsx(y,{children:e.name||"-"}),s.jsx(y,{children:e.expense_date}),s.jsx(y,{children:E(e.price)}),s.jsx(y,{children:e.qty}),s.jsx(y,{children:E(e.total_price)}),s.jsxs(y,{children:[s.jsx(x,{color:"info",size:"sm",onClick:()=>_e(e),className:"me-1",disabled:p&&p.id===e.id,children:p&&p.id===e.id?t("LABELS.editing"):t("LABELS.edit")}),s.jsx(x,{color:"danger",size:"sm",onClick:()=>ge(e.id),children:t("LABELS.remove")})]})]},e.id))})]})}),s.jsxs("div",{className:"mt-3",children:[s.jsxs(x,{color:"success",size:"lg",onClick:ye,disabled:p!==null,children:[t("LABELS.submit_all_expenses")," (",u.length,")"]}),p&&s.jsx("div",{className:"mt-2",children:s.jsxs("small",{className:"text-warning",children:[s.jsx("i",{className:"fas fa-exclamation-triangle me-1"}),t("MSG.complete_edit_before_submit")]})})]})]})]})})}),s.jsxs(Ae,{visible:te,onClose:()=>v(!1),children:[s.jsx(Ne,{children:s.jsx(we,{children:t("LABELS.confirm_submission")})}),s.jsxs(Be,{children:[s.jsx("p",{children:t("MSG.confirm_submit_expenses",{count:u.length})}),s.jsx("p",{children:s.jsxs("strong",{children:[t("LABELS.total_amount"),": ",E($().toFixed(2))]})})]}),s.jsxs(Fe,{children:[s.jsx(x,{color:"secondary",onClick:()=>v(!1),children:t("LABELS.cancel")}),s.jsx(x,{color:"primary",onClick:fe,children:t("LABELS.confirm_submit")})]})]})]})};export{is as default};

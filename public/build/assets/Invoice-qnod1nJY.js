import{r as n,u as Nt,b as wt,j as e,C as Fe}from"./index-BM-84WYk.js";/* empty css                */import{a as M,b as _,c as Q,d as w}from"./index.esm-CTbBYC_z.js";import{a as F,b as se,p as B}from"./api-BUyL__Lx.js";import{u as vt,a as Ct,b as kt,c as St,d as At}from"./DefaultLayout-DWs0eMK8.js";import{C as Pe,a as fe}from"./CCardBody-CaiSzWxA.js";import{C as Te}from"./CCardHeader-BQ0n1MDF.js";import{C as Me}from"./CForm-B41EQLwC.js";import{C as j}from"./CFormLabel-BSmkn9I7.js";import{C as Be}from"./CInputGroup-CjoHj6nu.js";import{C as b}from"./CFormInput-BRkWGjKH.js";import{C as Re}from"./CInputGroupText-4d8tVeae.js";import{c as We}from"./cil-search-CDkY_4k-.js";import{c as je}from"./cil-x-0440B5Ce.js";import{C as Oe}from"./CFormSelect-sGLx-yuQ.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-CaWWu20M.js";import"./CNavItem-B_dTsj2G.js";import"./CFormControlWrapper-D5n2fvDj.js";import"./CFormControlValidation-lQ4ZFYm7.js";const Jt=({editMode:R=!1,initialData:u=null,onSubmit:be=null})=>{const[Ue,$e]=n.useState(!1),[G,k]=n.useState(!1),[ye,Ne]=n.useState(!0),[ae,ze]=n.useState([]),De=Nt();vt();const{showToast:m}=wt(),[W,A]=n.useState([]),[S,qe]=n.useState([]),[It,ne]=n.useState([]),[x,H]=n.useState(""),[O,P]=n.useState(!1),[oe,ce]=n.useState([]),[ie,de]=n.useState([]),[le,Qe]=n.useState([]),[I,V]=n.useState([]),[h,me]=n.useState([]),ue=n.useRef(null),Y=n.useRef(null),[X,Ge]=n.useState(!1),[U,He]=n.useState(""),[Ve,Ye]=n.useState(""),[Xe,Je]=n.useState(""),[Ke,Ze]=n.useState(""),[E,et]=n.useState(!1),[L,tt]=n.useState(""),[T,rt]=n.useState(""),[we,st]=n.useState(""),[ve,at]=n.useState(""),[Ce,nt]=n.useState(""),[ke,ot]=n.useState([]),[$,Se]=n.useState(""),[d,J]=n.useState({projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},invoiceType:3,invoiceDate:new Date().toISOString().split("T")[0],discount:0,paidAmount:0,finalAmount:0,projectCost:0,payed:0,start_date:"",end_date:"",selectedMachines:[],company_id:null}),[Et,ct]=n.useState([{work_type:"",qty:0,price:0,total_price:0,remark:""}]),[z,he]=n.useState(null),[pe,K]=n.useState(""),[it,Z]=n.useState(!1),[f,D]=n.useState({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),[v,xe]=n.useState([{charge_type:"",amount:"",remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}]),Ae=(t,r,a)=>{const s=[...v];s[t][r]=a,xe(s)},dt=()=>{xe([...v,{charge_type:"",amount:"",remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}])},lt=t=>{xe(v.filter((r,a)=>a!==t))};n.useEffect(()=>{(async()=>{try{const r=await F("/api/workingType");ot(r||[])}catch(r){console.error("Error fetching work types",r)}})()},[]);const ge=n.useMemo(()=>{const t={};return ke.forEach(r=>{t[r.id]=r.type_of_work}),t},[ke]),ee=n.useCallback(async(t="")=>{Ne(!0);try{const r=t?`/api/projects?searchQuery=${encodeURIComponent(t)}`:"/api/projects",a=await F(r),s=Array.isArray(a)?a:a==null?void 0:a.data;if(!s||!Array.isArray(s)){A([]),t||m("warning","No projects data available from server");return}const i=s.map(c=>({id:c.id,project_name:c.project_name||"Unknown Project",customer_name:c.customer_name||"Unknown Customer",work_place:c.work_place||"",project_cost:c.project_cost||"0",mobile_number:c.mobile_number||"",gst_number:c.gst_number||"",remark:c.remark||"",paidamount:c.paidamount||0,customer_id:c.customer_id||c.id,company_id:c.company_id,machine_id:c.machine_id||[],customer:{name:c.customer_name||"Unknown",address:c.work_place||"N/A",mobile:c.mobile_number||"N/A"},start_date:c.start_date,end_date:c.end_date})).filter(c=>c.project_name&&c.customer_id);A(i)}catch(r){console.error("Error fetching projects:",r),A([]),t||m("danger","Failed to fetch projects")}finally{Ne(!1)}},[]);n.useEffect(()=>{var t,r,a,s;R&&u&&(J({projectId:u.projectId,customer_id:u.customer_id,customer_name:((t=u.customer)==null?void 0:t.name)||"",address:((r=u.customer)==null?void 0:r.address)||"",mobile_number:((a=u.customer)==null?void 0:a.mobile)||"",customer:u.customer,invoiceType:u.invoiceType,invoiceDate:u.invoiceDate,discount:u.discount||0,payed:u.paidamount||0,finalAmount:u.finalAmount||0,start_date:u.start_date||"",end_date:u.end_date||""}),ct(u.items||[{work_type:"",qty:0,price:0,total_price:0,remark:""}]),H(((s=u.customer)==null?void 0:s.name)||""))},[R,u]),n.useEffect(()=>{ee()},[ee]),n.useEffect(()=>{const t=setTimeout(()=>{x&&x.length>0?ee(x):x.length===0&&(A([]),P(!1))},100);return()=>clearTimeout(t)},[x,ee]),n.useEffect(()=>{if(x&&W.length>0){const t=x.toLowerCase(),r=W.filter(a=>a.project_name&&a.project_name.toLowerCase().includes(t)||a.customer_name&&a.customer_name.toLowerCase().includes(t)||a.work_place&&a.work_place.toLowerCase().includes(t)||a.mobile_number&&a.mobile_number.includes(t)||a.remark&&a.remark.toLowerCase().includes(t));console.log("Filtered projects:",r,"Query:",x),ce(r)}else ce([])},[x,W]);const mt=async()=>{try{const t=await F("/api/machineLog");de(t||[])}catch(t){m("danger","Error fetching machine logs: "+t)}},ut=()=>{F("/api/operatorsByCompanyIdOperator").then(t=>{ze(t||[]),k(!1)}).catch(t=>{console.log(t.message),k(!1)})};n.useEffect(()=>{mt(),ut()},[]),n.useEffect(()=>{const t=r=>{ue.current&&!ue.current.contains(r.target)&&Y.current&&!Y.current.contains(r.target)&&P(!1)};return O&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[O]);const ht=async()=>{try{const t=await F("/api/machine-operators");qe(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}},pt=async()=>{try{const t=await F("/api/machine-price");Qe(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}};n.useEffect(()=>{ht(),pt()},[]);const _e=n.useCallback(t=>{if(!t||!t.machine_id||!Array.isArray(t.machine_id)||S.length===0){ne([]);return}const r=S.filter(a=>t.machine_id.includes(String(a.id)));ne(r)},[S]);n.useEffect(()=>{if(S.length>0&&d.projectId){const t=W.find(r=>r.id===d.projectId);t&&_e(t)}},[S,d.projectId,W,_e]),n.useEffect(()=>{if(!d.projectId)return;const t=setTimeout(async()=>{try{const r=Number(d.payed)||0;await se(`/api/projects/${d.projectId}/paidamount`,{paidamount:r})}catch(r){console.error("Failed updating project paidamount:",r)}},500);return()=>clearTimeout(t)},[d.projectId,d.payed]),n.useEffect(()=>{if(!d.projectId||ie.length===0){V([]);return}const r=ie.filter(a=>String(a.project_id)===String(d.projectId)).filter(a=>a.isPaid==0);V(r)},[ie,d.projectId]);const te=n.useCallback(t=>{if(!t||S.length===0)return"N/A";const r=S.find(a=>String(a.id)===String(t));return(r==null?void 0:r.machine_name)||"N/A"},[S]),Ie=t=>{const r=parseFloat(t.project_cost)||0,a=parseFloat(d.discount)||0,s=Math.max(0,r-a);J(i=>({...i,projectId:t.id,payed:t.paidamount,customer_id:t.customer_id,customer_name:t.customer_name,address:t.work_place,mobile_number:t.mobile_number,start_date:t.start_date,end_date:t.end_date,projectCost:r,finalAmount:s,company_id:t.company_id,customer:{name:t.customer_name,address:t.customer.address,mobile:t.customer.mobile},selectedMachines:[]})),P(!1),H(t.customer_name),A([]),_e(t)},C=n.useMemo(()=>{if(!$.trim())return I;const t=$.toLowerCase();return I.filter(r=>{var g,y,N;const a=((g=ge[r.work_type_id])==null?void 0:g.toLowerCase())||"",s=ae.find(q=>q.id==r.operator_id),i=((y=s==null?void 0:s.name)==null?void 0:y.toLowerCase())||"",c=te(r.machine_id).toLowerCase(),o=le.find(q=>q.id===Number(r.mode_id)),l=((N=o==null?void 0:o.mode)==null?void 0:N.toLowerCase())||"",p=String(r.work_date).slice(0,10);return a.includes(t)||i.includes(t)||c.includes(t)||l.includes(t)||p.includes(t)})},[I,$,ge,ae,te,le]),xt=()=>{J(t=>({...t,projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},projectCost:0,payed:0,finalAmount:0,selectedMachines:[]})),H(""),P(!1),A([]),ne([])},Ee=()=>{P(!1),D(t=>({...t,customer_name:x||""})),Z(!0)},re=t=>{const{name:r,value:a}=t.target;if(r==="mobile_number"){const s=a.replace(/\D/g,"");if(s.length>10)return;D(i=>({...i,mobile_number:s}));return}if(r==="gst_number"){if(a.length>15)return;D(s=>({...s,gst_number:a}));return}D(s=>({...s,[r]:a}))},Le=async t=>{if(t.preventDefault(),!f.customer_name.trim()){m("danger","Customer name is required");return}if(!f.mobile_number||!/^[6-9]\d{9}$/.test(f.mobile_number)){m("danger","Please enter a valid 10-digit mobile number");return}try{k(!0);const r={customer_name:f.customer_name,mobile_number:f.mobile_number,gst_number:f.gst_number||"",work_place:f.work_place||"",project_name:"",project_cost:"",supervisor_id:"",commission:"",start_date:"",end_date:"",is_visible:!0,remark:"",operator_id:[""],machine_id:[]};await B("/api/projects",r);let a=null;try{const s=await F(`/api/projects?searchQuery=${encodeURIComponent(f.customer_name)}`),i=Array.isArray(s)?s:s==null?void 0:s.data;if(i&&Array.isArray(i)){const c=i.map(o=>({id:o.id,project_name:o.project_name||"Unknown Project",customer_name:o.customer_name||"Unknown Customer",work_place:o.work_place||"",project_cost:o.project_cost||"0",mobile_number:o.mobile_number||"",gst_number:o.gst_number||"",remark:o.remark||"",paidamount:o.paidamount||0,customer_id:o.customer_id||o.id,company_id:o.company_id,machine_id:o.machine_id||[],customer:{name:o.customer_name||"Unknown",address:o.work_place||"N/A",mobile:o.mobile_number||"N/A"},start_date:o.start_date,end_date:o.end_date})).filter(o=>o.project_name&&o.customer_id);a=c.find(o=>o.customer_name.toLowerCase()===f.customer_name.toLowerCase()&&o.mobile_number===f.mobile_number)||c[0]||null}}catch(s){console.error("Error fetching newly created customer project:",s)}a?(Ie(a),m("success","Customer added and selected successfully")):m("success","Customer added successfully, please search to select"),Z(!1),D({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),A([]),ce([])}catch(r){console.error("Error adding customer from invoice:",r),m("danger","Failed to add customer")}finally{k(!1)}},gt=t=>{const{name:r,value:a}=t.target,s=r==="discount"||r==="paidAmount"?parseFloat(a)||0:a;J(i=>{const c={...i,[r]:s};if(r==="discount"){const o=parseFloat(i.projectCost)||0,l=parseFloat(s)||0;c.finalAmount=Math.max(0,o-l)}return c})},_t=t=>{he(t.id),K(String(t.price_per_hour??0))},ft=()=>{he(null),K("")},jt=async t=>{const r=Number(pe);if(isNaN(r)||r<0){m("danger","Enter a valid price");return}try{const a=await se(`/api/machine-logs/${t.id}/price`,{price_per_hour:r});if(a&&a.error){m("danger","Failed to update price");return}V(s=>s.map(i=>String(i.id)===String(z)?{...i,price_per_hour:r}:i)),typeof de=="function"&&de(s=>Array.isArray(s)?s.map(i=>String(i.id)===String(z)?{...i,price_per_hour:r}:i):s),he(null),K(""),m("success","Price updated successfully")}catch(a){console.error("Error updating log price:",a),m("danger","Error updating price")}},bt=t=>{me(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},yt=async t=>{if(t.preventDefault(),!t.currentTarget.checkValidity()){$e(!0);return}if(!d.projectId||!d.customer_id){m("danger","Please select a customer");return}const a=v.filter(s=>s.charge_type&&Number(s.amount)>0).map(s=>({charge_type:s.charge_type,amount:Number(s.amount),remark:s.remark||null,is_paid:s.is_paid??!1,date:s.date}));try{if(k(!0),d.projectId){const l=Number(d.payed)||0;try{await se(`/api/projects/${d.projectId}/paidamount`,{paidamount:l})}catch(p){console.error("Failed to update project paidamount on submit:",p)}}const s=I.filter(l=>h.includes(l.id));console.log("Selected Rows:",s);const i=s.length>0?s[0].company_id:d.company_id;if(s.length===0&&!(X&&Number(U)>0)&&!(E&&Number(L)>0)){m("warning","Select logs, enable Advance Payment, or enable Fixed Bid Work"),k(!1);return}const c=s.reduce((l,p)=>{const g=Number(p.machine_start??p.start_reading??0)||0,y=Number(p.machine_end??p.end_reading??0)||0,N=p.actual_machine_hr!=null&&!isNaN(Number(p.actual_machine_hr))?Number(p.actual_machine_hr):Math.max(0,y-g),q=Number(p.price_per_hour)||0;return l+N*q},0);let o=null;if(s.length>0){console.log("ðŸ”„ Updating isPaid=1 for logs:",h);const l=h.map(g=>se(`/api/machine-logs/${g}/isPaid`,{isPaid:1}));await Promise.all(l),console.log("âœ… ALL selected logs updated to isPaid = 1"),V(g=>g.map(y=>h.includes(y.id)?{...y,isPaid:1}:y)),me([]);const p={project_id:d.projectId,company_id:i,total:c,paid_amount:0,worklog_ids:h};if(R&&be)await be(p),m("success",`${s.length} logs marked as paid`);else{const g=await B("/api/project-payments",p);g&&g.id&&(o=g.id,a.length>0&&await B("/api/invoice-additional-charges/bulk",{invoice_id:String(g.invoice_number),company_id:i,charges:a}),m("success",`Invoice created! ${s.length} logs marked as PAID âœ…`))}}if(X&&Number(U)>0){const l=await B("/api/project-payments",{company_id:i,project_id:d.projectId,total:Number(U),paid_amount:Number(U),is_advance:!0,transaction_id:Xe||null,mode:Ve||null,remark:Ke||null});l&&l.id&&(m("success","Advance payment invoice created"),o||(o=l.id))}if(E&&Number(L)>0){if(Number(T)>Number(L)){m("danger","Advance amount cannot be greater than Total amount"),k(!1);return}const l=await B("/api/project-payments",{company_id:i,project_id:d.projectId,total:Number(L),paid_amount:Number(T)||0,is_fixed_bid:!0,transaction_id:Number(T)>0?ve:null,mode:Number(T)>0?we:"Fixed Bid",remark:Ce||null,date:d.invoiceDate});l&&l.id&&(o||(o=l.id),a.length>0&&await B("/api/invoice-additional-charges/bulk",{invoice_id:String(l.id),company_id:i,charges:a}),m("success","Fixed Bid Work invoice created"))}o&&setTimeout(()=>{De(`/payment-page/${o}`)},1e3)}catch(s){console.error("Submit error:",s),m("danger","Failed to create invoice")}finally{k(!1)}};return e.jsx(M,{children:e.jsx(_,{xs:12,children:e.jsxs(Pe,{className:"mb-4",children:[e.jsx(Te,{children:e.jsx("strong",{children:R?"Edit Invoice":"Create Invoice"})}),e.jsxs(fe,{children:[e.jsxs(Me,{validated:Ue,onSubmit:yt,children:[e.jsxs(M,{className:"mb-3",children:[e.jsxs(_,{md:6,children:[e.jsxs(j,{children:["Customer Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("div",{ref:ue,style:{position:"relative"},children:[e.jsxs(Be,{children:[e.jsx(b,{type:"text",value:x,onChange:t=>{H(t.target.value),P(!0)},placeholder:"Search by customer name, location, mobile...",required:!0}),e.jsx(Re,{children:e.jsx(Q,{icon:We})}),x&&e.jsx(w,{color:"link",onClick:xt,className:"position-absolute end-0 me-5",children:e.jsx(Q,{icon:je})})]}),ye&&O&&x.length>0&&e.jsxs("div",{className:"dropdown-menu show p-2",children:[e.jsx(Fe,{size:"sm"})," Loading customers..."]}),O&&oe.length>0&&e.jsxs("div",{ref:Y,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:[oe.map(t=>e.jsxs("div",{className:"dropdown-item cursor-pointer p-2 border-bottom",onClick:()=>Ie(t),onMouseEnter:r=>r.target.style.backgroundColor="#f8f9fa",onMouseLeave:r=>r.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium text-primary",children:t.customer_name}),t.work_place&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",t.work_place]}),t.mobile_number&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Mobile:"})," ",t.mobile_number]})]},t.id)),e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ee,children:['Add customer "',x,'"']})})]}),x.length>0&&oe.length===0&&O&&e.jsx("div",{ref:Y,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ee,children:['Add customer "',x,'"']})})})]}),d.customer_name&&e.jsxs("div",{className:"mt-1 p-2 bg-light rounded border",children:[e.jsxs("div",{className:"small text-success",children:[e.jsx("strong",{children:"Selected:"})," ",d.customer_name]}),d.customer.address&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",d.customer.address]})]})]}),e.jsxs(_,{md:6,children:[e.jsxs(j,{children:["Invoice Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(b,{type:"date",name:"invoiceDate",value:d.invoiceDate,onChange:gt,required:!0})]})]}),I.length>0&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"fw-semibold mb-0",children:["Project Logs (Total: ",I.length,") |",e.jsxs("span",{className:"text-primary ms-2",children:["Showing: ",C.length]})," |",e.jsxs("span",{className:"text-success ms-2",children:["Selected: ",h.length]})]}),e.jsx("div",{style:{width:"300px"},children:e.jsxs(Be,{size:"sm",children:[e.jsx(Re,{children:e.jsx(Q,{icon:We})}),e.jsx(b,{type:"text",placeholder:"Search by operator, work type, machine, mode...",value:$,onChange:t=>Se(t.target.value)}),$&&e.jsx(w,{color:"secondary",variant:"outline",onClick:()=>Se(""),children:e.jsx(Q,{icon:je})})]})})]}),e.jsx("div",{className:"table-container",style:{width:"100%",overflowX:"auto",overflowY:"auto",border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff",WebkitOverflowScrolling:"touch"},children:e.jsxs("table",{className:"table table-bordered align-middle",style:{minWidth:"1200px",width:"100%",tableLayout:"fixed",margin:0},children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:C.length>0&&C.every(t=>h.includes(t.id)),onChange:t=>{const r=t.target.checked;me(r?[...new Set([...h,...C.map(a=>a.id)])]:h.filter(a=>!C.map(s=>s.id).includes(a)))}})}),e.jsx("th",{style:{width:"90px",minWidth:"90px"},className:"text-center align-middle",children:"Date"}),e.jsx("th",{style:{width:"110px",minWidth:"100px"},className:"text-center align-middle",children:"Machine"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Operator"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Work Type"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Start"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"End"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Net"}),e.jsx("th",{style:{width:"70px"},className:"text-center align-middle",children:"Mode"}),e.jsx("th",{style:{width:"90px"},className:"text-center align-middle",children:"Price/Hr"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Total"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Action"})]})}),e.jsxs("tbody",{children:[C.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,i=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),c=String(t.work_date).slice(0,10).split("-").reverse().join("-"),o=ae.find(N=>N.id==t.operator_id)||{name:"N/A"},l=String(t.id)===String(z)?Number(pe||0):Number(t.price_per_hour||0),p=i*l,g=le.find(N=>N.id===Number(t.mode_id)),y=g?g.mode:"N/A";return e.jsxs("tr",{children:[e.jsx("td",{className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:h.includes(t.id),onChange:()=>bt(t.id)})}),e.jsx("td",{className:"text-center small",children:c||"N/A"}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"110px"},title:te(t.machine_id),children:te(t.machine_id)}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"100px"},title:o.name,children:o.name}),e.jsx("td",{children:ge[t.work_type_id]||"-"}),e.jsx("td",{className:"text-center",children:a}),e.jsx("td",{className:"text-center",children:s}),e.jsx("td",{className:"text-center",children:i}),e.jsx("td",{className:"text-center small",children:y}),e.jsx("td",{children:String(t.id)===String(z)?e.jsx("input",{type:"number",value:pe,min:0,step:"0.01",onChange:N=>K(N.target.value),style:{width:"70px",fontSize:"0.875rem"},className:"form-control form-control-sm"}):e.jsxs("div",{className:"text-center small",children:["â‚¹",l]})}),e.jsxs("td",{className:"text-center small",children:["â‚¹",p.toFixed(2)]}),e.jsx("td",{className:"text-center",children:String(t.id)===String(z)?e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"sm",color:"success",className:"me-1",onClick:()=>jt(t),children:"Save"}),e.jsx(w,{size:"sm",color:"secondary",variant:"outline",onClick:ft,children:"Cancel"})]}):e.jsx(w,{size:"sm",color:"info",className:"text-white",onClick:()=>_t(t),children:"Edit"})})]},r)}),h.length>0&&(()=>{const t=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i);return a+o},0),r=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i),l=Number(s.price_per_hour)||0;return a+o*l},0);return e.jsxs("tr",{className:"fw-bold table-success",children:[e.jsx("td",{className:"text-center align-middle",children:h.length}),e.jsx("td",{colSpan:"6",className:"text-end pe-3",children:"Grand Total:"}),e.jsx("td",{className:"text-center",children:t.toFixed(2)}),e.jsx("td",{}),e.jsxs("td",{className:"text-end pe-3",children:["â‚¹",r.toFixed(2)]}),e.jsx("td",{})]})})()]})]})})]}),I.length>0&&e.jsxs(Pe,{className:"mb-4 border-0 shadow-sm",children:[e.jsx(Te,{style:{background:"#f3f4f6"},children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges"})}),e.jsx(fe,{children:v.map((t,r)=>e.jsxs(M,{className:"align-items-end mb-3",children:[e.jsxs(_,{md:3,children:[e.jsx(j,{children:"Charge Type"}),e.jsxs(Oe,{value:t.charge_type,onChange:a=>Ae(r,"charge_type",a.target.value),children:[e.jsx("option",{value:"",children:"Select charge type"}),e.jsx("option",{value:"service_charge",children:"Service Charge"}),e.jsx("option",{value:"travelling_charge",children:"Travelling Charge"}),e.jsx("option",{value:"other_charge",children:"Other Charge"})]})]}),e.jsxs(_,{md:2,children:[e.jsx(j,{children:"Amount"}),e.jsx(b,{type:"number",placeholder:"0",value:t.amount,onChange:a=>Ae(r,"amount",a.target.value)})]}),e.jsxs(_,{children:[" ",e.jsx(w,{size:"sm",color:"primary",variant:"outline",onClick:dt,children:"+ Add Additional Charge"})]}),e.jsx(_,{md:1,children:v.length>1&&e.jsx(w,{color:"danger",variant:"ghost",onClick:()=>lt(r),children:e.jsx(Q,{icon:je})})})]},r))}),v.some(t=>t.charge_type&&t.amount)&&e.jsx(fe,{className:"border-top bg-light",children:e.jsxs(M,{className:"align-items-center",children:[e.jsx(_,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges:"})}),e.jsx(_,{md:3,children:e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",v.filter(t=>t.charge_type&&t.amount).reduce((t,r)=>t+(parseFloat(r.amount)||0),0).toFixed(2)]})})]})})]}),h.length>0&&e.jsxs(M,{className:"align-items-center mt-3 pt-3 border-top",children:[e.jsx(_,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold text-success",children:"Actual Payable(Logs + Additional Charges):"})}),e.jsx(_,{md:3,children:e.jsxs("h4",{className:"mb-0 fw-bold text-success",children:["â‚¹",(()=>{const t=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i),l=Number(s.price_per_hour)||0;return a+o*l},0),r=v.filter(a=>a.charge_type&&a.amount).reduce((a,s)=>a+(parseFloat(s.amount)||0),0);return(t+r).toFixed(2)})()]})})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${E?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${E?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"fixedBidSwitch",checked:E,disabled:X,onChange:t=>{const r=t.target.checked;et(r),r&&(Ge(!1),He(""),Ye(""),Je(""),Ze(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"fixedBidSwitch",children:"Fixed Bid Work"})]}),E&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(j,{children:["Total Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(b,{type:"number",min:"0",placeholder:"Enter total amount",value:L,onChange:t=>tt(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Advance Amount"}),e.jsx(b,{type:"number",min:"0",placeholder:"Enter paid amount",value:T,onChange:t=>{const r=parseFloat(t.target.value)||0,a=parseFloat(L)||0;if(r>a){m("danger","Paid amount cannot be greater than Total amount");return}rt(t.target.value)}})]}),Number(T)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Transaction ID"}),e.jsx(b,{type:"text",placeholder:"Enter transaction ID",value:ve,onChange:t=>at(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Mode"}),e.jsxs(Oe,{value:we,onChange:t=>st(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx(j,{children:"Description"}),e.jsx(b,{type:"text",placeholder:"Enter description",value:Ce,onChange:t=>nt(t.target.value)})]})]})]}),e.jsx(w,{color:"primary",type:"submit",disabled:G||!d.projectId||!d.customer_id||ye||h.length===0&&!(X&&Number(U)>0)&&!(E&&Number(L)>0),children:G?e.jsx(Fe,{size:"sm"}):R?"Update Invoice":"Submit Invoice"})]}),e.jsxs(Ct,{visible:it,onClose:()=>Z(!1),children:[e.jsx(kt,{closeButton:!0,children:"Add New Customer"}),e.jsx(St,{children:e.jsx(Me,{onSubmit:Le,children:e.jsxs(M,{className:"g-3",children:[e.jsxs(_,{md:12,children:[e.jsx(j,{children:"Customer Name"}),e.jsx(b,{type:"text",name:"customer_name",value:f.customer_name,onChange:re,placeholder:"Enter Customer Name...",required:!0})]}),e.jsxs(_,{md:12,children:[e.jsx(j,{children:"Mobile Number"}),e.jsx(b,{type:"text",name:"mobile_number",value:f.mobile_number,onChange:re,placeholder:"Enter Customer Mobile...",maxLength:10,required:!0})]}),e.jsxs(_,{md:12,children:[e.jsx(j,{children:"GST Number (Optional)"}),e.jsx(b,{type:"text",name:"gst_number",value:f.gst_number,onChange:re,placeholder:"Enter GST number...",maxLength:15})]}),e.jsxs(_,{md:12,children:[e.jsx(j,{children:"Location"}),e.jsx(b,{type:"text",name:"work_place",value:f.work_place,onChange:re,placeholder:"Enter Location..."})]})]})})}),e.jsxs(At,{children:[e.jsx(w,{color:"secondary",variant:"outline",onClick:()=>Z(!1),children:"Cancel"}),e.jsx(w,{color:"primary",onClick:Le,disabled:G,children:G?"Saving...":"Save Customer"})]})]})]})]})})})};export{Jt as default};

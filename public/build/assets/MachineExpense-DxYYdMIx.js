import{u as ue,b as ge,r as i,j as e,C as fe}from"./index-WEbTLRLZ.js";import{e as je,g as be,a as L}from"./api-Ba1wfMeh.js";import{u as R,w as ye}from"./xlsx-DjuO7_Ju.js";import{E as Ne}from"./jspdf.es.min-CO5AHh_Y.js";import"./jspdf.plugin.autotable-DeXDhVya.js";import{u as Ce,C as E}from"./DefaultLayout-CnBEfSKd.js";import{a as W,b as p,d as v}from"./index.esm-CZeMoYDH.js";import{C as O,a as G}from"./CCardBody-CtNgr8m7.js";import{C as Se}from"./CCardHeader-LFhc_ZAM.js";import{C as we}from"./CFormInput-D3dwui72.js";import{C as _e,a as Ee,b as P,c as g,d as ve,e as m}from"./CTable-DcVbcKI_.js";import"./typeof-QjJsDpFa.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-Cd7YjP3x.js";import"./CNavItem-u5MAKPdZ.js";import"./CFormControlWrapper-DljGJ9Vz.js";import"./CFormLabel-D964ZFYD.js";const Ge=()=>{const I=ue(),{showToast:j}=ge(),{t:U}=Ce("global");je();const d=be(),[T,X]=i.useState([]),[k,q]=i.useState([]),[M,J]=i.useState([]),[c,$]=i.useState(""),[B,A]=i.useState(""),[b,Te]=i.useState({key:null,direction:"asc"}),[K,Q]=i.useState(!0),[Z,ee]=i.useState(window.innerWidth<=768),te=async()=>{try{const t=await L("/api/machineries1");X(t)}catch(t){j("danger","Error fetching machines: "+t)}},se=async()=>{try{const t=await L(`/api/machineLog?company_id=${d.company_id}`);q(t)}catch(t){j("danger","Error fetching machine logs: "+t)}},ne=async()=>{try{const t=await L(`/api/expense1?company_id=${d.company_id}`);J(t[0]||[])}catch(t){j("danger","Error fetching expenses: "+t)}};i.useEffect(()=>{d!=null&&d.company_id&&(te(),se(),ne().finally(()=>Q(!1)))},[d==null?void 0:d.company_id]);const D=(t,n)=>n.filter(r=>Number(r.machine_id)===Number(t)).reduce((r,s)=>{const o=parseFloat(s.start_reading)||0,x=parseFloat(s.end_reading)||0,u=parseFloat(s.price_per_hour)||0;return r+(x>o&&u>0?(x-o)*u:0)},0),H=(t,n)=>n.filter(r=>{var C,S;const s=Number(r.machine_id)===Number(t),o=String(((C=r.expense_type)==null?void 0:C.expense_category)||"").toLowerCase(),x=String(((S=r.expense_type)==null?void 0:S.name)||"").toLowerCase(),u=o.includes("machine")||x.includes("machine");return s&&u}).reduce((r,s)=>r+(parseFloat(s.total_price)||0),0),re=(t,n,r)=>{const s=D(t,n),o=H(t,r);return s-o},V=t=>I(`/machineprofits/${t}`),Y=t=>I(`/machineloss/${t}`);i.useEffect(()=>{const t=()=>ee(window.innerWidth<=768);return t(),window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const oe=i.useCallback(t=>{const n=setTimeout(()=>$(t),300);return()=>clearTimeout(n)},[]),ae=t=>{const n=t.target.value;A(n),oe(n)},z=()=>{A(""),$("")},a=t=>{const n=parseFloat(t)||0;if(isNaN(n))return"0.00";const[r,s="00"]=n.toFixed(2).split("."),o=r.slice(-3),x=r.slice(0,-3);return`${x?x.replace(/\B(?=(\d{2})+(?!\d))/g,",")+","+o:o}.${s}`},F=t=>`INR ${a(t)}`,l=i.useMemo(()=>{let t=T.map((n,r)=>({...n,sr_no:r+1,profit:D(n.id,k),expense:H(n.id,M),net:re(n.id,k,M)}));if(c.trim()){const n=c.toLowerCase();t=t.filter(r=>{var s,o;return((s=r.machine_name)==null?void 0:s.toLowerCase().includes(n))||((o=r.register_number)==null?void 0:o.toLowerCase().includes(n))||r.profit.toString().includes(c)||r.expense.toString().includes(c)||r.net.toString().includes(c)})}return b.key&&(t=[...t].sort((n,r)=>{let s=n[b.key],o=r[b.key];return typeof s=="string"&&(s=s.toLowerCase()),typeof o=="string"&&(o=o.toLowerCase()),(s<o?-1:1)*(b.direction==="asc"?1:-1)})),t},[T,k,M,c,b]),f=i.useMemo(()=>l.reduce((t,n)=>(t.machineCount+=1,t.totalProfit+=Number(n.profit)||0,t.totalExpense+=Number(n.expense)||0,t.totalNet+=Number(n.net)||0,t),{machineCount:0,totalProfit:0,totalExpense:0,totalNet:0}),[l]),ie=()=>{const t=l.map(s=>({"Sr No":s.sr_no,"Machine Name":s.machine_name||"-","Registration Number":s.register_number||"-",Profit:s.profit,Expense:s.expense,Net:s.net})),n=R.json_to_sheet(t),r=R.book_new();R.book_append_sheet(r,n,"Machine Report"),ye(r,`Machine_Report_${new Date().toISOString().split("T")[0]}.xlsx`),j("success","Excel file downloaded successfully!")},ce=()=>{const t=new Ne({orientation:"landscape",unit:"pt",format:"a4"}),n=t.internal.pageSize.getWidth(),r=t.internal.pageSize.getHeight(),s=40,o=n-2*s;t.setFont("helvetica","bold"),t.setFontSize(18),t.setTextColor(22,160,133),t.text("Machine Expense Report",s,50),t.setFontSize(11),t.setTextColor(100),t.setFont("helvetica","normal");const x=(d==null?void 0:d.company_name)||"Your Company",u=new Date().toLocaleDateString("en-GB");t.text(`${x} â€¢ Generated on ${u}`,s,70);const C=[["Sr No","Machine Name","Reg No","Earning (Rs.)","Expense (Rs.)","Net (Rs.)"]],S=l.map(h=>[h.sr_no.toString(),h.machine_name||"-",h.register_number||"-",a(h.profit),a(h.expense),a(h.net)]);t.autoTable({head:C,body:S,startY:100,theme:"striped",border:{lineWidth:.5,color:200},styles:{fontSize:9,cellPadding:6,overflow:"linebreak",halign:"center"},headStyles:{fillColor:[22,160,133],textColor:255,fontStyle:"bold",fontSize:10},columnStyles:{0:{cellWidth:o*.08},1:{cellWidth:o*.28},2:{cellWidth:o*.16},3:{cellWidth:o*.16},4:{cellWidth:o*.16},5:{cellWidth:o*.16}},didDrawPage:h=>{const w=h.cursor.y+20,he=l.reduce((y,N)=>y+N.profit,0),pe=l.reduce((y,N)=>y+N.expense,0),me=l.reduce((y,N)=>y+N.net,0);t.setFontSize(11),t.setFont("helvetica","bold"),t.setTextColor(34,34,34);const _=o/6;t.text("TOTAL",s+_*2,w),t.text(a(he),s+_*3,w,{align:"center"}),t.text(a(pe),s+_*4,w,{align:"center"}),t.text(a(me),s+_*5,w,{align:"center"}),t.setFontSize(9),t.setTextColor(150),t.text(`Page ${t.internal.getCurrentPageInfo().pageNumber}`,n-s-50,r-20)}});const xe=`Machine_Report_${new Date().toISOString().split("T")[0]}.pdf`;t.save(xe),j("success","PDF downloaded successfully!")},le=t=>e.jsx(O,{className:"mb-3 expense-card",style:de,children:e.jsxs(G,{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600,fontSize:"1em"},children:t.machine_name||"N/A"}),e.jsx("div",{style:{color:"#666",fontSize:"0.8em"},children:t.register_number||"-"})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontWeight:600,color:t.net>=0?"#28a745":"#dc3545"},children:F(t.net)}),e.jsx("div",{style:{fontSize:"0.7em",color:"#666"},children:"Net"})]})]}),e.jsx("div",{style:{marginBottom:8,paddingTop:8,borderTop:"1px solid #f0f0f0"},children:e.jsxs("span",{style:{color:"#28a745"},children:["Earning: ",F(t.profit)]})}),e.jsx("div",{style:{marginBottom:8,paddingTop:8,borderTop:"1px solid #f0f0f0"},children:e.jsxs("span",{style:{color:"#dc3545"},children:["Expense: ",F(t.expense)]})}),e.jsxs("div",{style:{paddingTop:8,borderTop:"1px solid #f0f0f0",display:"flex",gap:"8px",justifyContent:"center"},children:[e.jsx(E,{color:"success",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>V(t.id),children:"View Earnings"}),e.jsx(E,{color:"danger",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>Y(t.id),children:"View Expenses"})]})]})},t.id),de={border:"1px solid #dee2e6",borderRadius:8,boxShadow:"0 1px 4px rgba(0,0,0,0.1)",transition:"all 0.3s ease"};return K?e.jsxs("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:400},children:[e.jsx(fe,{color:"primary",size:"lg"}),e.jsx("p",{style:{marginTop:12,color:"#6c757d"},children:"Loading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("style",{jsx:!0,global:!0,children:`
        .table-container {
          height: 350px;
          overflow: auto;
          border: 1px solid #dee2e6;
          border-radius: 0.375rem;
        }
        .expenses-table thead th {
          position: sticky;
          top: 0;
          background: #f8f9fa;
          z-index: 10;
        }
        .search-container { position: relative; }
        .search-input { padding-left: 40px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; }
        .clear-search { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; }
        @media (max-width: 768px) { .expenses-table { display: none; } }
        .expense-card .badge {
          min-width: 44px;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
      `}),e.jsx(W,{children:e.jsx(p,{xs:12,children:e.jsxs(O,{className:"mb-4",children:[e.jsxs(Se,{children:[e.jsx("strong",{className:"fs-5",children:"Machine Expense Report"}),e.jsxs("span",{className:"ms-2 text-muted",children:[U("LABELS.total")||"Total"," ",T.length," machines"]})]}),e.jsxs(G,{children:[e.jsxs(W,{className:"mb-3 align-items-center",children:[e.jsx(p,{xs:12,md:6,children:e.jsxs("div",{className:"search-container",children:[e.jsx(we,{type:"text",className:"search-input",placeholder:"Search machines...",value:B,onChange:ae}),B&&e.jsx("button",{className:"clear-search",onClick:z,title:"Clear",children:"X"})]})}),e.jsxs(p,{xs:12,md:6,className:"mt-2 mt-md-0 text-md-end",children:[e.jsx(v,{color:"success",size:"sm",className:"me-2",onClick:ie,children:"Export Excel"}),e.jsx(v,{color:"danger",size:"sm",onClick:ce,children:"Export PDF"})]})]}),c&&e.jsx(p,{xs:12,className:"mb-2",children:e.jsxs("small",{className:"text-muted",children:[l.length,' machine(s) found for "',c,'"']})}),e.jsxs(W,{className:"g-2 mb-3",children:[e.jsx(p,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Machines"}),e.jsx("strong",{className:"fs-6",children:f.machineCount})]})}),e.jsx(p,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Total Earning"}),e.jsx("strong",{className:"fs-6",children:a(f.totalProfit)})]})}),e.jsx(p,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-black shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Total Expense"}),e.jsx("strong",{className:"fs-6",children:a(f.totalExpense)})]})}),e.jsx(p,{xs:6,md:3,children:e.jsxs("div",{className:`rounded p-2 text-center shadow-sm ${f.totalNet>=0?"bg-info text-white":"bg-warning text-dark"}`,children:[e.jsx("small",{className:"d-block",children:"Net"}),e.jsxs("strong",{className:"fs-6",children:[f.totalNet>=0?"":"-",a(Math.abs(f.totalNet))]})]})})]}),Z?e.jsx("div",{children:l.length===0?e.jsx("div",{className:"text-center text-muted py-4",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:['No machines found for "',c,'"']}),e.jsx(v,{color:"primary",onClick:z,size:"sm",children:"Clear Search"})]}):e.jsx("p",{children:"No machine data available."})}):l.map(le)}):e.jsx("div",{className:"table-container",children:e.jsxs(_e,{hover:!0,striped:!0,bordered:!0,className:"mb-0 expenses-table",children:[e.jsx(Ee,{children:e.jsxs(P,{children:[e.jsx(g,{className:"text-center",children:"Sr. No."}),e.jsx(g,{className:"text-center",children:"Machine Name"}),e.jsx(g,{className:"text-center",children:"Reg No"}),e.jsx(g,{className:"text-center",children:"Earning"}),e.jsx(g,{className:"text-center",children:"Expense"}),e.jsx(g,{className:"text-center",children:"Net"}),e.jsx(g,{className:"text-center",children:"Actions"})]})}),e.jsx(ve,{children:l.length===0?e.jsx(P,{children:e.jsx(m,{colSpan:7,className:"text-center py-4 text-muted",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:['No machines found for "',c,'"']}),e.jsx(v,{color:"primary",onClick:z,size:"sm",children:"Clear Search"})]}):e.jsx("p",{children:"No machine data available."})})}):e.jsx(e.Fragment,{children:l.map(t=>e.jsxs(P,{children:[e.jsx(m,{children:t.sr_no}),e.jsx(m,{children:t.machine_name||"-"}),e.jsx(m,{children:t.register_number||"-"}),e.jsx(m,{className:"text-end",children:e.jsx("span",{style:{color:"#28a745"},children:a(t.profit)})}),e.jsx(m,{className:"text-end",children:e.jsx("span",{style:{color:"#dc3545"},children:a(t.expense)})}),e.jsx(m,{className:"text-end",children:e.jsx("span",{style:{fontWeight:500,color:t.net>=0?"#28a745":"#dc3545"},children:a(Math.abs(t.net))})}),e.jsx(m,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[e.jsx(E,{color:"success",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>V(t.id),children:"View Earnings"}),e.jsx(E,{color:"danger",role:"button",style:{cursor:"pointer",fontSize:"0.75em",padding:"6px 8px"},onClick:()=>Y(t.id),children:"View Expenses"})]})})]},t.id))})})]})})]})]})})})]})};export{Ge as default};

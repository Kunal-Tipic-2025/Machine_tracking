import{r as n,u as Pt,b as Mt,j as e,C as tt}from"./index-BaFO0fBD.js";/* empty css                */import{a as Y,b as y,c as M,d as w}from"./index.esm-6sS0QU7y.js";import{a as B,b as oe,p as X}from"./api-BUyL__Lx.js";import{C as Bt}from"./ChargeTypeModal-BB6dmhWa.js";import{N as Rt}from"./NewCustomerModal-Bn8IwF1H.js";import{u as Dt}from"./DefaultLayout-CO5Zw0Z5.js";import{C as we,a as ie}from"./CCardBody-C_DcNhkI.js";import{C as at}from"./CCardHeader-uQH1AYuq.js";import{C as zt}from"./CForm-aAQP41oT.js";import{C as j}from"./CFormLabel-zcG2lLqz.js";import{C as st}from"./CInputGroup-jXSXCS9j.js";import{C as N}from"./CFormInput-Bf1zI-co.js";import{C as rt}from"./CInputGroupText-DExXWOSE.js";import{c as nt}from"./cil-search-CDkY_4k-.js";import{c as ve}from"./cil-x-0440B5Ce.js";import{c as Wt}from"./cil-check-circle-BlU9eaow.js";import{c as $t}from"./cil-location-pin-CQr6GRP7.js";import{C as ct}from"./CFormSelect-CKz9M81i.js";import"./CFormCheck-D_Tx0DsR.js";import"./CFormControlValidation-D0XpqgJc.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-D7bfBri4.js";import"./CNavItem-BYh17SIg.js";import"./CFormControlWrapper-DiPXZd7c.js";const ga=({editMode:W=!1,initialData:x=null,onSubmit:Ce=null})=>{const[ot,it]=n.useState(!1),[ke,R]=n.useState(!1),[Se,Ae]=n.useState(!0),[J,dt]=n.useState([]),lt=Pt();Dt();const{showToast:u}=Mt(),[$,F]=n.useState([]),[k,mt]=n.useState([]),[Ot,de]=n.useState([]),[g,K]=n.useState(""),[O,D]=n.useState(!1),[le,me]=n.useState([]),[ue,he]=n.useState([]),[Z,ut]=n.useState([]),[L,ee]=n.useState([]),[m,te]=n.useState([]),pe=n.useRef(null),ae=n.useRef(null),[C,Ie]=n.useState(!1),[S,Te]=n.useState(""),[xe,Ee]=n.useState(""),[ge,Fe]=n.useState(""),[fe,Le]=n.useState(""),[A,Pe]=n.useState(!1),[P,Me]=n.useState(""),[z,Be]=n.useState(""),[Re,De]=n.useState(""),[ze,We]=n.useState(""),[$e,Oe]=n.useState(""),[Ue,ht]=n.useState([]),[U,He]=n.useState(""),[d,se]=n.useState({projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},invoiceType:3,invoiceDate:new Date().toISOString().split("T")[0],discount:0,paidAmount:0,finalAmount:0,projectCost:0,payed:0,start_date:"",end_date:"",selectedMachines:[],company_id:null}),[Ut,pt]=n.useState([{work_type:"",qty:0,price:0,total_price:0,remark:""}]),[I,be]=n.useState(null),[H,Q]=n.useState(""),[xt,_e]=n.useState(!1),[gt,ft]=n.useState(""),[G,bt]=n.useState([]),[Ht,_t]=n.useState({}),[jt,V]=n.useState({}),[Nt,Qe]=n.useState(!1),[Ge,yt]=n.useState(null),[Ve,wt]=n.useState({name:"",local_name:"",amount_deduct:!1}),[v,je]=n.useState([{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}]),qe=async()=>{try{const t=await B("/api/charge-types");Array.isArray(t)&&bt(t)}catch(t){console.error("Error fetching charge types:",t)}};n.useEffect(()=>{qe()},[]);const re=(t,r,a)=>{const s=[...v];if(r==="charge_type"){const c=G.find(o=>String(o.name)===String(a)||String(o.id)===String(a));s[t].charge_type=a,c?(s[t].charge_type_id=c.id,s[t].amount_deduct=!!c.amount_deduct,s[t].local_name=c.local_name):(s[t].charge_type_id=null,s[t].amount_deduct=!1)}else s[t][r]=a;je(s)},vt=()=>{je([...v,{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}])},Ct=t=>{je(v.filter((r,a)=>a!==t))};n.useEffect(()=>{(async()=>{try{const r=await B("/api/workingType");ht(r||[])}catch(r){console.error("Error fetching work types",r)}})()},[]);const ne=n.useMemo(()=>{const t={};return Ue.forEach(r=>{t[r.id]=r.type_of_work}),t},[Ue]),ce=n.useCallback(async(t="")=>{Ae(!0);try{const r=t?`/api/projects?searchQuery=${encodeURIComponent(t)}`:"/api/projects",a=await B(r),s=Array.isArray(a)?a:a==null?void 0:a.data;if(!s||!Array.isArray(s)){F([]),t||u("warning","No projects data available from server");return}const c=s.map(o=>({id:o.id,project_name:o.project_name||"Unknown Project",customer_name:o.customer_name||"Unknown Customer",work_place:o.work_place||"",project_cost:o.project_cost||"0",mobile_number:o.mobile_number||"",gst_number:o.gst_number||"",remark:o.remark||"",paidamount:o.paidamount||0,customer_id:o.customer_id||o.id,company_id:o.company_id,machine_id:o.machine_id||[],customer:{name:o.customer_name||"Unknown",address:o.work_place||"N/A",mobile:o.mobile_number||"N/A"},start_date:o.start_date,end_date:o.end_date})).filter(o=>o.project_name&&o.customer_id);F(c)}catch(r){console.error("Error fetching projects:",r),F([]),t||u("danger","Failed to fetch projects")}finally{Ae(!1)}},[]);n.useEffect(()=>{var t,r,a,s;W&&x&&(se({projectId:x.projectId,customer_id:x.customer_id,customer_name:((t=x.customer)==null?void 0:t.name)||"",address:((r=x.customer)==null?void 0:r.address)||"",mobile_number:((a=x.customer)==null?void 0:a.mobile)||"",customer:x.customer,invoiceType:x.invoiceType,invoiceDate:x.invoiceDate,discount:x.discount||0,payed:x.paidamount||0,finalAmount:x.finalAmount||0,start_date:x.start_date||"",end_date:x.end_date||""}),pt(x.items||[{work_type:"",qty:0,price:0,total_price:0,remark:""}]),K(((s=x.customer)==null?void 0:s.name)||""))},[W,x]),n.useEffect(()=>{ce()},[ce]),n.useEffect(()=>{const t=setTimeout(()=>{g&&g.length>0?ce(g):g.length===0&&(F([]),D(!1))},100);return()=>clearTimeout(t)},[g,ce]),n.useEffect(()=>{if(g&&$.length>0){const t=g.toLowerCase(),r=$.filter(a=>a.project_name&&a.project_name.toLowerCase().includes(t)||a.customer_name&&a.customer_name.toLowerCase().includes(t)||a.work_place&&a.work_place.toLowerCase().includes(t)||a.mobile_number&&a.mobile_number.includes(t)||a.remark&&a.remark.toLowerCase().includes(t));console.log("Filtered projects:",r,"Query:",g),me(r)}else me([])},[g,$]);const kt=async()=>{try{const t=await B("/api/machineLog");he(t||[])}catch(t){u("danger","Error fetching machine logs: "+t)}},St=()=>{B("/api/operatorsByCompanyIdOperator").then(t=>{dt(t||[]),R(!1)}).catch(t=>{console.log(t.message),R(!1)})};n.useEffect(()=>{kt(),St()},[]),n.useEffect(()=>{const t=r=>{pe.current&&!pe.current.contains(r.target)&&ae.current&&!ae.current.contains(r.target)&&D(!1)};return O&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[O]);const At=async()=>{try{const t=await B("/api/machine-operators");mt(t)}catch(t){console.error("Error fetching machineries:",t),u("danger","Error fetching machineries")}},It=async()=>{try{const t=await B("/api/machine-price");ut(t)}catch(t){console.error("Error fetching machineries:",t),u("danger","Error fetching machineries")}};n.useEffect(()=>{At(),It()},[]);const Ne=n.useCallback(t=>{if(!t||!t.machine_id||!Array.isArray(t.machine_id)||k.length===0){de([]);return}const r=k.filter(a=>t.machine_id.includes(String(a.id)));de(r)},[k]);n.useEffect(()=>{if(k.length>0&&d.projectId){const t=$.find(r=>r.id===d.projectId);t&&Ne(t)}},[k,d.projectId,$,Ne]),n.useEffect(()=>{if(!d.projectId)return;const t=setTimeout(async()=>{try{const r=Number(d.payed)||0;await oe(`/api/projects/${d.projectId}/paidamount`,{paidamount:r})}catch(r){console.error("Failed updating project paidamount:",r)}},500);return()=>clearTimeout(t)},[d.projectId,d.payed]),n.useEffect(()=>{if(!d.projectId||ue.length===0){ee([]);return}const r=ue.filter(a=>String(a.project_id)===String(d.projectId)).filter(a=>a.isPaid==0);ee(r)},[ue,d.projectId]);const q=n.useCallback(t=>{if(!t||k.length===0)return"N/A";const r=k.find(a=>String(a.id)===String(t));return(r==null?void 0:r.machine_name)||"N/A"},[k]),Ye=t=>{const r=parseFloat(t.project_cost)||0,a=parseFloat(d.discount)||0,s=Math.max(0,r-a);se(c=>({...c,projectId:t.id,payed:t.paidamount,customer_id:t.customer_id,customer_name:t.customer_name,address:t.work_place,mobile_number:t.mobile_number,start_date:t.start_date,end_date:t.end_date,projectCost:r,finalAmount:s,company_id:t.company_id,customer:{name:t.customer_name,address:t.customer.address,mobile:t.customer.mobile},selectedMachines:[]})),D(!1),K(t.customer_name),F([]),Ne(t)},f=n.useMemo(()=>{if(!U.trim())return L;const t=U.toLowerCase();return L.filter(r=>{var b,_,p;const a=((b=ne[r.work_type_id])==null?void 0:b.toLowerCase())||"",s=J.find(T=>T.id==r.operator_id),c=((_=s==null?void 0:s.name)==null?void 0:_.toLowerCase())||"",o=q(r.machine_id).toLowerCase(),l=Z.find(T=>T.id===Number(r.mode_id)),i=((p=l==null?void 0:l.mode)==null?void 0:p.toLowerCase())||"",h=String(r.work_date).slice(0,10);return a.includes(t)||c.includes(t)||o.includes(t)||i.includes(t)||h.includes(t)})},[L,U,ne,J,q,Z]),Tt=()=>{se(t=>({...t,projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},projectCost:0,payed:0,finalAmount:0,selectedMachines:[]})),K(""),D(!1),F([]),de([])},Xe=()=>{D(!1),ft(g||""),_e(!0)},Et=t=>{t?(Ye(t),u("success","Customer added and selected successfully")):u("success","Customer added successfully, please search to select"),_e(!1),F([]),me([])},Ft=t=>{const{name:r,value:a}=t.target,s=r==="discount"||r==="paidAmount"?parseFloat(a)||0:a;se(c=>{const o={...c,[r]:s};if(r==="discount"){const l=parseFloat(c.projectCost)||0,i=parseFloat(s)||0;o.finalAmount=Math.max(0,l-i)}return o})},Je=t=>{be(t.id),Q(String(t.price_per_hour??0))},Ke=()=>{be(null),Q("")},Ze=async t=>{const r=Number(H);if(isNaN(r)||r<0){u("danger","Enter a valid price");return}try{const a=await oe(`/api/machine-logs/${t.id}/price`,{price_per_hour:r});if(a&&a.error){u("danger","Failed to update price");return}ee(s=>s.map(c=>String(c.id)===String(I)?{...c,price_per_hour:r}:c)),typeof he=="function"&&he(s=>Array.isArray(s)?s.map(c=>String(c.id)===String(I)?{...c,price_per_hour:r}:c):s),be(null),Q(""),u("success","Price updated successfully")}catch(a){console.error("Error updating log price:",a),u("danger","Error updating price")}},et=t=>{te(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},Lt=async t=>{if(t.preventDefault(),!t.currentTarget.checkValidity()){it(!0);return}if(!d.projectId||!d.customer_id){u("danger","Please select a customer");return}for(const s of v)if(Number(s.amount)>0){if(!s.charge_type){u("danger","Please select a charge type for the entered amount");return}if(!G.some(o=>o.name===s.charge_type||o.id===s.charge_type_id)&&!s.charge_type_id){u("danger",`Charge type "${s.charge_type}" is invalid. Please add it using the dropdown options.`);return}}const a=v.filter(s=>s.charge_type&&Number(s.amount)>0).map(s=>{var c;return{charge_type:s.charge_type,charge_type_id:s.charge_type_id??((c=G.find(o=>o.name===s.charge_type))==null?void 0:c.id)??null,amount:Number(s.amount),amount_deduct:s.amount_deduct??!1,remark:s.remark||null,is_paid:s.is_paid??!1,date:s.date}});try{if(R(!0),d.projectId){const i=Number(d.payed)||0;try{await oe(`/api/projects/${d.projectId}/paidamount`,{paidamount:i})}catch(h){console.error("Failed to update project paidamount on submit:",h)}}const s=L.filter(i=>m.includes(i.id));console.log("Selected Rows:",s);const c=s.length>0?s[0].company_id:d.company_id;if(s.length===0&&!(C&&Number(S)>0)&&!(A&&Number(P)>0)){u("warning","Select logs, enable Advance Payment, or enable Fixed Bid Work"),R(!1);return}const o=s.reduce((i,h)=>{const b=Number(h.machine_start??h.start_reading??0)||0,_=Number(h.machine_end??h.end_reading??0)||0,p=h.actual_machine_hr!=null&&!isNaN(Number(h.actual_machine_hr))?Number(h.actual_machine_hr):Math.max(0,_-b),T=Number(h.price_per_hour)||0;return i+p*T},0);let l=null;if(s.length>0){console.log("ðŸ”„ Updating isPaid=1 for logs:",m);const i=m.map(E=>oe(`/api/machine-logs/${E}/isPaid`,{isPaid:1}));await Promise.all(i),console.log("âœ… ALL selected logs updated to isPaid = 1"),ee(E=>E.map(ye=>m.includes(ye.id)?{...ye,isPaid:1}:ye)),te([]);let h=0,b=null,_=null,p=null;C&&Number(S)>0&&(h=Number(S),b=xe,_=ge,p=fe);const T={project_id:d.projectId,company_id:c,total:o,paid_amount:h,worklog_ids:m,payment_mode:b,transaction_id:_,remark:p};if(W&&Ce)await Ce(T),u("success",`${s.length} logs marked as paid`);else{const E=await X("/api/project-payments",T);E&&E.id&&(l=E.id,a.length>0&&await X("/api/invoice-additional-charges/bulk",{invoice_id:String(E.invoice_number),company_id:c,charges:a}),u("success",`Invoice created! ${s.length} logs marked as PAID âœ…`))}}if(s.length===0&&C&&Number(S)>0){const i=await X("/api/project-payments",{company_id:c,project_id:d.projectId,total:Number(S),paid_amount:Number(S),is_advance:!0,transaction_id:ge||null,mode:xe||null,remark:fe||null});i&&i.id&&(u("success","Advance payment invoice created"),l||(l=i.id))}if(A&&Number(P)>0){if(Number(z)>Number(P)){u("danger","Advance amount cannot be greater than Total amount"),R(!1);return}const i=await X("/api/project-payments",{company_id:c,project_id:d.projectId,total:Number(P),paid_amount:Number(z)||0,is_fixed_bid:!0,transaction_id:Number(z)>0?ze:null,mode:Number(z)>0?Re:"Fixed Bid",remark:$e||null,date:d.invoiceDate});i&&i.id&&(l||(l=i.id),a.length>0&&await X("/api/invoice-additional-charges/bulk",{invoice_id:String(i.id),company_id:c,charges:a}),u("success","Fixed Bid Work invoice created"))}l&&setTimeout(()=>{lt(`/payment-page/${l}`)},1e3)}catch(s){console.error("Submit error:",s),u("danger","Failed to create invoice")}finally{R(!1)}};return e.jsxs(Y,{children:[e.jsx(y,{xs:12,children:e.jsxs(we,{className:"mb-4",children:[e.jsx(at,{children:e.jsx("strong",{children:W?"Edit Invoice":"Create Invoice"})}),e.jsxs(ie,{children:[e.jsxs(zt,{validated:ot,onSubmit:Lt,children:[e.jsxs(Y,{className:"mb-3",children:[e.jsxs(y,{md:6,children:[e.jsxs(j,{children:["Customer Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("div",{ref:pe,style:{position:"relative"},children:[e.jsxs(st,{children:[e.jsx(N,{type:"text",value:g,onChange:t=>{K(t.target.value),D(!0)},placeholder:"Search by customer name, location, mobile...",required:!0}),e.jsx(rt,{children:e.jsx(M,{icon:nt})}),g&&e.jsx(w,{color:"link",onClick:Tt,className:"position-absolute end-0 me-5",children:e.jsx(M,{icon:ve})})]}),Se&&O&&g.length>0&&e.jsxs("div",{className:"dropdown-menu show p-2",children:[e.jsx(tt,{size:"sm"})," Loading customers..."]}),O&&le.length>0&&e.jsxs("div",{ref:ae,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:[le.map(t=>e.jsxs("div",{className:"dropdown-item cursor-pointer p-2 border-bottom",onClick:()=>Ye(t),onMouseEnter:r=>r.target.style.backgroundColor="#f8f9fa",onMouseLeave:r=>r.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium text-primary",children:t.customer_name}),t.work_place&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",t.work_place]}),t.mobile_number&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Mobile:"})," ",t.mobile_number]})]},t.id)),e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Xe,children:['Add customer "',g,'"']})})]}),g.length>0&&le.length===0&&O&&e.jsx("div",{ref:ae,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Xe,children:['Add customer "',g,'"']})})})]}),d.customer_name&&e.jsx("div",{className:"mt-1",children:e.jsxs("div",{className:"small text-success d-flex align-items-center flex-wrap",children:[e.jsxs("span",{className:"me-2",children:[e.jsxs("strong",{children:[e.jsx(M,{icon:Wt,size:"sm",className:"me-1"}),"Selected:"]})," ",d.customer_name]}),d.customer.address&&e.jsxs("span",{className:"text-muted ms-auto ms-md-2",style:{fontSize:"0.85em"},children:[e.jsx(M,{icon:$t,size:"sm",className:"me-1"}),d.customer.address]})]})})]}),e.jsxs(y,{md:6,children:[e.jsxs(j,{children:["Invoice Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(N,{type:"date",name:"invoiceDate",value:d.invoiceDate,onChange:Ft,required:!0})]})]}),L.length>0&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2",children:[e.jsxs("div",{className:"fw-semibold mb-0 d-flex flex-wrap align-items-center gap-2",children:[e.jsxs("span",{className:"text-nowrap",children:["Project Logs (Total: ",L.length,")"]}),e.jsx("span",{className:"d-none d-md-inline text-muted",children:"|"}),e.jsxs("span",{className:"text-primary text-nowrap",children:["Showing: ",f.length]}),e.jsx("span",{className:"d-none d-md-inline text-muted",children:"|"}),e.jsxs("span",{className:"text-success text-nowrap",children:["Selected: ",m.length]})]}),e.jsx("div",{className:"w-100",style:{maxWidth:"300px"},children:e.jsxs(st,{size:"sm",children:[e.jsx(rt,{children:e.jsx(M,{icon:nt})}),e.jsx(N,{type:"text",placeholder:"Search...",value:U,onChange:t=>He(t.target.value)}),U&&e.jsx(w,{color:"secondary",variant:"outline",onClick:()=>He(""),children:e.jsx(M,{icon:ve})})]})})]}),e.jsx("div",{className:"d-none d-md-block table-responsive",style:{border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff"},children:e.jsxs("table",{className:"table table-bordered align-middle mb-0",style:{minWidth:"1200px",width:"100%",tableLayout:"fixed"},children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&f.every(t=>m.includes(t.id)),onChange:t=>{const r=t.target.checked;te(r?[...new Set([...m,...f.map(a=>a.id)])]:m.filter(a=>!f.map(s=>s.id).includes(a)))}})}),e.jsx("th",{style:{width:"90px",minWidth:"90px"},className:"text-center align-middle",children:"Date"}),e.jsx("th",{style:{width:"110px",minWidth:"100px"},className:"text-center align-middle",children:"Machine"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Operator"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Work Type"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Start"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"End"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Net"}),e.jsx("th",{style:{width:"70px"},className:"text-center align-middle",children:"Mode"}),e.jsx("th",{style:{width:"90px"},className:"text-center align-middle",children:"Price/Hr"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Total"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Action"})]})}),e.jsxs("tbody",{children:[f.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,c=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),o=String(t.work_date).slice(0,10).split("-").reverse().join("-"),l=J.find(p=>p.id==t.operator_id)||{name:"N/A"},i=String(t.id)===String(I)?Number(H||0):Number(t.price_per_hour||0),h=c*i,b=Z.find(p=>p.id===Number(t.mode_id)),_=b?b.mode:"N/A";return e.jsxs("tr",{children:[e.jsx("td",{className:"text-center align-middle","data-label":"Select",children:e.jsx("input",{type:"checkbox",checked:m.includes(t.id),onChange:()=>et(t.id)})}),e.jsx("td",{className:"text-center small","data-label":"Date",children:o||"N/A"}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"110px"},title:q(t.machine_id),"data-label":"Machine",children:q(t.machine_id)}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"100px"},title:l.name,"data-label":"Operator",children:l.name}),e.jsx("td",{"data-label":"Work Type",children:ne[t.work_type_id]||"-"}),e.jsx("td",{className:"text-center","data-label":"Start",children:a}),e.jsx("td",{className:"text-center","data-label":"End",children:s}),e.jsx("td",{className:"text-center","data-label":"Net",children:c}),e.jsx("td",{className:"text-center small","data-label":"Mode",children:_}),e.jsx("td",{"data-label":"Price/Hr",children:String(t.id)===String(I)?e.jsx("input",{type:"number",value:H,min:0,step:"0.01",onChange:p=>Q(p.target.value),style:{width:"70px",fontSize:"0.875rem"},className:"form-control form-control-sm"}):e.jsxs("div",{className:"text-center small",children:["â‚¹",i]})}),e.jsxs("td",{className:"text-center small","data-label":"Total",children:["â‚¹",h.toFixed(2)]}),e.jsx("td",{className:"text-center","data-label":"Action",children:String(t.id)===String(I)?e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"sm",color:"success",className:"me-1",onClick:()=>Ze(t),children:"Save"}),e.jsx(w,{size:"sm",color:"secondary",variant:"outline",onClick:Ke,children:"Cancel"})]}):e.jsx(w,{size:"sm",color:"info",className:"text-white",onClick:()=>Je(t),children:"Edit"})})]},r)}),m.length>0&&(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,o=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,o-c);return a+l},0),r=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,o=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,o-c),i=Number(s.price_per_hour)||0;return a+l*i},0);return e.jsxs("tr",{className:"fw-bold table-success",children:[e.jsx("td",{className:"text-center align-middle","data-label":"Total Count",children:m.length}),e.jsx("td",{colSpan:"6",className:"text-end pe-3 d-none d-md-table-cell",children:"Grand Total:"}),e.jsx("td",{className:"d-md-none","data-label":"Grand Total Label",children:"Grand Total:"}),e.jsx("td",{className:"text-center","data-label":"Total Net",children:t.toFixed(2)}),e.jsx("td",{}),e.jsxs("td",{className:"text-center","data-label":"Grand Total Amount",children:["â‚¹",r.toFixed(2)]}),e.jsx("td",{})]})})()]})]})}),e.jsxs("div",{className:"d-md-none",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2 p-2 bg-light rounded shadow-sm border",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",id:"selectAllMobile",checked:f.length>0&&f.every(t=>m.includes(t.id)),onChange:t=>{const r=t.target.checked;te(r?[...new Set([...m,...f.map(a=>a.id)])]:m.filter(a=>!f.map(s=>s.id).includes(a)))}}),e.jsx("label",{htmlFor:"selectAllMobile",className:"fw-semibold text-secondary mb-0",children:"Select All Logs"})]}),f.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,c=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),o=String(t.work_date).slice(0,10).split("-").reverse().join("-"),l=J.find(p=>p.id==t.operator_id)||{name:"N/A"},i=String(t.id)===String(I)?Number(H||0):Number(t.price_per_hour||0),h=c*i,b=Z.find(p=>p.id===Number(t.mode_id));b&&b.mode;const _=m.includes(t.id);return e.jsx(we,{className:`mb-3 shadow-sm border ${_?"border-primary":""}`,style:{backgroundColor:_?"#f8f9ff":"#fff"},children:e.jsxs(ie,{className:"p-3",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2 border-bottom pb-2",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",style:{width:"1.2em",height:"1.2em"},checked:_,onChange:()=>et(t.id)}),e.jsx("h6",{className:"mb-0 fw-bold",children:o||"N/A"})]}),e.jsx("div",{className:"text-end",children:String(t.id)===String(I)?e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(w,{size:"sm",color:"success",className:"p-1 px-2 text-white",onClick:()=>Ze(t),children:"âœ“"}),e.jsx(w,{size:"sm",color:"secondary",variant:"outline",className:"p-1 px-2",onClick:Ke,children:"âœ•"})]}):e.jsx(w,{size:"sm",color:"light",className:"text-primary p-1 px-2",onClick:()=>Je(t),children:e.jsx("span",{className:"small fw-bold",children:"Edit Price"})})})]}),e.jsxs("div",{className:"row g-2 text-dark",children:[e.jsxs("div",{className:"col-12",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Machine"}),e.jsx("span",{className:"fw-medium",children:q(t.machine_id)})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Operator"}),e.jsx("span",{className:"fw-medium",children:l.name})]}),e.jsxs("div",{className:"col-6 text-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Work Type"}),e.jsx("span",{className:"fw-medium",children:ne[t.work_type_id]||"-"})]}),e.jsx("div",{className:"col-12 border-top my-1"}),e.jsxs("div",{className:"col-4 text-center",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Start"}),e.jsx("span",{className:"fw-bold",children:a})]}),e.jsxs("div",{className:"col-4 text-center border-start border-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"End"}),e.jsx("span",{className:"fw-bold",children:s})]}),e.jsxs("div",{className:"col-4 text-center",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Net Hr"}),e.jsx("span",{className:"fw-bold text-success",children:c})]}),e.jsx("div",{className:"col-12 border-top my-1"}),e.jsxs("div",{className:"col-6",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Rate / Hr"}),String(t.id)===String(I)?e.jsx("input",{type:"number",value:H,min:0,step:"0.01",onChange:p=>Q(p.target.value),className:"form-control form-control-sm"}):e.jsxs("span",{className:"fw-bold",children:["â‚¹",i]})]}),e.jsxs("div",{className:"col-6 text-end",children:[e.jsx("span",{className:"text-secondary small d-block",children:"Total Price"}),e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",h.toFixed(2)]})]})]})]})},r)}),m.length>0&&(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,o=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,o-c);return a+l},0),r=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,o=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,o-c),i=Number(s.price_per_hour)||0;return a+l*i},0);return e.jsxs("div",{className:"position-sticky bottom-0 bg-white p-3 border-top shadow-lg rounded-top",style:{zIndex:1050},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-1",children:[e.jsxs("span",{className:"text-secondary fw-semibold",children:["Selected Logs (",m.length,")"]}),e.jsxs("span",{className:"badge bg-success",children:[t.toFixed(2)," Hrs"]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0 fw-bold",children:"Grand Total"}),e.jsxs("h4",{className:"mb-0 fw-bold text-primary",children:["â‚¹",r.toFixed(2)]})]})]})})()]})]}),L.length>0&&e.jsxs(we,{className:"mb-4 border-0 shadow-sm",children:[e.jsx(at,{style:{background:"#f3f4f6"},children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges"})}),e.jsx(ie,{children:v.map((t,r)=>e.jsxs(Y,{className:"align-items-end mb-3",style:{zIndex:1e3-r,position:"relative"},children:[e.jsxs(y,{xs:12,md:3,className:"mb-2 mb-md-0",children:[e.jsx(j,{children:"Charge Type"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx(N,{type:"text",placeholder:"Select or Search...",value:t.charge_type,onChange:a=>{re(r,"charge_type",a.target.value),_t(s=>({...s,[r]:a.target.value})),V(s=>({...s,[r]:!0}))},onFocus:()=>V(a=>({...a,[r]:!0})),onBlur:()=>setTimeout(()=>V(a=>({...a,[r]:!1})),200)}),jt[r]&&e.jsxs("div",{className:"dropdown-menu show",style:{width:"100%",maxHeight:"200px",overflowY:"auto",position:"absolute",top:"100%",left:0,zIndex:1050},children:[G.filter(a=>!t.charge_type||a.name.toLowerCase().includes(t.charge_type.toLowerCase())||a.local_name&&a.local_name.toLowerCase().includes(t.charge_type.toLowerCase())).map(a=>e.jsxs("button",{className:"dropdown-item",type:"button",onMouseDown:s=>s.preventDefault(),onClick:()=>{re(r,"charge_type",a.name),V(s=>({...s,[r]:!1}))},children:[a.name," ",a.local_name?`(${a.local_name})`:""," ",a.amount_deduct?"(-)":"(+)"]},a.id)),G.every(a=>a.name.toLowerCase()!==(t.charge_type||"").toLowerCase())&&e.jsxs("button",{className:"dropdown-item text-primary fw-bold",type:"button",onMouseDown:a=>a.preventDefault(),onClick:()=>{wt(a=>({...a,name:t.charge_type})),yt(r),Qe(!0),V(a=>({...a,[r]:!1}))},children:['+ Add "',t.charge_type,'"']})]})]})]}),e.jsxs(y,{xs:6,md:2,className:"mb-2 mb-md-0",children:[e.jsx(j,{children:"Amount"}),e.jsx(N,{type:"number",placeholder:"0",value:t.amount,onChange:a=>re(r,"amount",a.target.value)})]}),e.jsx(y,{xs:6,md:"auto",className:"mb-2 mb-md-0",children:e.jsx(w,{size:"sm",color:"primary",variant:"outline",onClick:vt,className:"w-100 w-md-auto",children:"+ Add"})}),e.jsx(y,{xs:12,md:1,className:"text-end text-md-start",children:v.length>1&&e.jsx(w,{color:"danger",variant:"ghost",onClick:()=>Ct(r),children:e.jsx(M,{icon:ve})})})]},r))}),v.some(t=>t.charge_type&&t.amount)&&e.jsx(ie,{className:"border-top bg-light",children:e.jsxs(Y,{className:"align-items-center",children:[e.jsx(y,{xs:6,md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges Net:"})}),e.jsx(y,{xs:6,md:3,className:"text-end text-md-start",children:e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",v.filter(t=>t.charge_type&&t.amount).reduce((t,r)=>{const a=parseFloat(r.amount)||0;return r.amount_deduct?t-a:t+a},0).toFixed(2)]})})]})})]}),m.length>0&&e.jsxs(Y,{className:"align-items-center mt-3 pt-3 border-top",children:[e.jsx(y,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold text-success",children:"Actual Payable(Logs + Additional Charges):"})}),e.jsx(y,{md:3,children:e.jsxs("h4",{className:"mb-0 fw-bold text-success",children:["â‚¹",(()=>{const t=f.filter(a=>m.includes(a.id)).reduce((a,s)=>{const c=Number(s.machine_start??s.start_reading??0)||0,o=Number(s.machine_end??s.end_reading??0)||0,l=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,o-c),i=Number(s.price_per_hour)||0;return a+l*i},0),r=v.filter(a=>a.charge_type&&a.amount).reduce((a,s)=>{const c=parseFloat(s.amount)||0;return s.amount_deduct?a-c:a+c},0);return(t+r).toFixed(2)})()]})})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${C?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${C?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"advanceSwitch",checked:C,disabled:A,onChange:t=>{const r=t.target.checked;Ie(r),r&&(Pe(!1),Me(""),Be(""),De(""),We(""),Oe(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"advanceSwitch",children:"Advance Payment"})]}),C&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(j,{children:["Advance Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(N,{type:"number",min:"0",placeholder:"Enter amount",value:S,onChange:t=>Te(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Transaction ID"}),e.jsx(N,{type:"text",placeholder:"Enter transaction ID",value:ge,onChange:t=>Fe(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Mode"}),e.jsxs(ct,{value:xe,onChange:t=>Ee(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Remark"}),e.jsx(N,{type:"text",placeholder:"Enter remark",value:fe,onChange:t=>Le(t.target.value)})]})]})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${A?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${A?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"fixedBidSwitch",checked:A,disabled:C,onChange:t=>{const r=t.target.checked;Pe(r),r&&(Ie(!1),Te(""),Ee(""),Fe(""),Le(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"fixedBidSwitch",children:"Fixed Bid Work"})]}),A&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(j,{children:["Total Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(N,{type:"number",min:"0",placeholder:"Enter total amount",value:P,onChange:t=>Me(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Advance Amount"}),e.jsx(N,{type:"number",min:"0",placeholder:"Enter paid amount",value:z,onChange:t=>{const r=parseFloat(t.target.value)||0,a=parseFloat(P)||0;if(r>a){u("danger","Paid amount cannot be greater than Total amount");return}Be(t.target.value)}})]}),Number(z)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Transaction ID"}),e.jsx(N,{type:"text",placeholder:"Enter transaction ID",value:ze,onChange:t=>We(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(j,{children:"Mode"}),e.jsxs(ct,{value:Re,onChange:t=>De(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx(j,{children:"Description"}),e.jsx(N,{type:"text",placeholder:"Enter description",value:$e,onChange:t=>Oe(t.target.value)})]})]})]}),e.jsx(w,{color:"primary",type:"submit",disabled:ke||!d.projectId||!d.customer_id||Se||m.length===0&&!(C&&Number(S)>0)&&!(A&&Number(P)>0),children:ke?e.jsx(tt,{size:"sm"}):W?"Update Invoice":"Submit Invoice"})]}),e.jsx(Rt,{visible:xt,onClose:()=>_e(!1),onSuccess:Et,initialName:gt})]})]})}),Nt&&e.jsx(Bt,{visible:!0,onClose:()=>Qe(!1),onSuccess:t=>{qe(),Ge!==null&&re(Ge,"charge_type",t.name)},initialData:Ve.name?{name:Ve.name}:null})]})};export{ga as default};

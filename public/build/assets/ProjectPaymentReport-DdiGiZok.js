import{r as n,R as bs,j as e,C as ce,b as Ns}from"./index-BM-84WYk.js";import{d as y,c as oe,a as U,b as f}from"./index.esm-CTbBYC_z.js";import{a as P,g as ze,h as cs,b as vs}from"./api-BUyL__Lx.js";import{g as os,h as _s}from"./InvoiceMulPdf-Z1q_sug2.js";import{C as Be,a as Le}from"./CCardBody-CaiSzWxA.js";import{C as We}from"./CCardHeader-BQ0n1MDF.js";import{C as pe,j as ws,a as ne,b as ae,e as re,c as ie,d as Ze}from"./DefaultLayout-DWs0eMK8.js";import{C as Cs}from"./RawMaterial-CaWWu20M.js";import{C as xe,a as he,b as j,c as l,d as ue,e as a}from"./CTable-BSEoQc56.js";import{C as Ps}from"./CInputGroup-CjoHj6nu.js";import{C as Ss}from"./CInputGroupText-4d8tVeae.js";import{C as Oe}from"./CFormInput-BRkWGjKH.js";import{C as Ke}from"./CTooltip-CxTfR8Q3.js";import{c as Fs}from"./cil-money-Dk3vHnQB.js";import{c as As}from"./cil-history-D-FQjjfl.js";import"./jspdf.es.min-CBXmQ7ls.js";import"./typeof-QjJsDpFa.js";import"./html2canvas.esm-DZlvpFNH.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-B_dTsj2G.js";import"./CFormControlWrapper-D5n2fvDj.js";import"./CFormControlValidation-lQ4ZFYm7.js";import"./CFormLabel-BSmkn9I7.js";import"./getTransitionDurationFromElement-Cpu4p4hx.js";var Ge=["512 512","<polygon fill='var(--ci-primary-color, currentColor)' points='272 434.744 272 209.176 240 209.176 240 434.744 188.118 382.862 165.49 405.489 256 496 346.51 405.489 323.882 382.862 272 434.744' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M400,161.176c0-79.4-64.6-144-144-144s-144,64.6-144,144a96,96,0,0,0,0,192h80v-32H112a64,64,0,0,1,0-128h32v-32a112,112,0,0,1,224,0v32h32a64,64,0,0,1,0,128H320v32h80a96,96,0,0,0,0-192Z' class='ci-primary'/>"];const ks=({projectId:m,inModal:r=!1})=>{const[c,je]=n.useState([]),[R,V]=n.useState(!0),[k,de]=n.useState([]),[D,O]=n.useState({show:!1,message:"",type:"success"}),[g,S]=n.useState([]),[T,z]=n.useState(!1),[Y,le]=n.useState(!1),[E,q]=n.useState([]),[v,B]=n.useState(!1);n.useState(null),n.useState(null),n.useState(!1);const[_,ge]=n.useState([]),[J,Se]=n.useState([]),[H,Ue]=n.useState([]),[Fe,X]=n.useState(!1),[h,Ve]=n.useState([]),[I,Ae]=n.useState([]);n.useEffect(()=>{(async()=>{try{const x=await P("/api/workingType");Ae(x||[])}catch(x){console.error("Error fetching work types",x)}})()},[]);const fe=bs.useMemo(()=>{const t={};return I.forEach(x=>{t[x.id]=x.type_of_work}),t},[I]),ke=async()=>{try{const t=await P("/api/machine-operators");console.log("machineries",t),ge(t||[])}catch(t){console.error("Error fetching machineries:",t)}},Ye=async()=>{try{const t=await P("/api/machineLog");Se(t||[])}catch(t){console.error("Error fetching machine logs:",t)}};n.useEffect(()=>{if(c!=null&&c.worklog_ids&&J.length>0){const t=J.filter(x=>c.worklog_ids.includes(x.id));Ue(t),console.log("Filtered Logs:",t)}},[c,J]);const ye=async()=>{try{V(!0);const t=await P(`/api/project-payments/${m}`);if(console.log(t),je(t),t!=null&&t.invoice_number){const x=await P(`/api/invoice-additional-charges/${t.invoice_number}`);Ve(x||[]),console.log("Additional Charges:",x)}}catch(t){console.error("Error fetching orders:",t),L("Failed to fetch orders","danger")}finally{V(!1)}},be=()=>{P("/api/operatorsByCompanyIdOperator").then(t=>{console.log(t),q(t)}).catch(t=>{console.log(t.message)})};n.useEffect(()=>{ye()},[m]),n.useEffect(()=>{Ye(),be(),ke(),De()},[]);const L=(t,x="success")=>{O({show:!0,message:t,type:x}),setTimeout(()=>O({show:!1,message:"",type:"success"}),5e3)},De=async()=>{try{const t=await P("/api/machine-price");de(t)}catch(t){console.error("Error fetching machine price:",t)}},Ne=async()=>{if(g.length===0){L("Please select at least one work order to download","warning");return}z(!0);try{await generateWorkOrdersPDF(g),L(`PDF generated successfully for ${g.length} work order(s)`,"success"),S([])}catch(t){console.error("Error generating PDF:",t),L("Failed to generate PDF. Please try again.","danger")}finally{z(!1)}},Te=()=>{B(!0)},ve=async()=>{var t,x,$,ee,se;if(!(!c||Object.keys(c).length===0))try{X(!0);const p=(t=ze())==null?void 0:t.company_info;if(!p){D("Company information not found. Please log in again.");return}const Re=Ie(c.created_at),we={invoice_number:c.invoice_number,date:Re,customer:{name:((x=c.project)==null?void 0:x.customer_name)||"N/A",address:(($=c.project)==null?void 0:$.work_place)||"",mobile:((ee=c.project)==null?void 0:ee.mobile_number)||"",gst_number:((se=c.project)==null?void 0:se.gst_number)||""},consignee:{name:p.company_name,address:`${p.land_mark||""}, ${p.Tal||""}, ${p.Dist||""}, ${p.pincode||""}`,phone_no:p.phone_no,gst_number:p.gst_number,email_id:p.email_id},totalAmount:M,amountPaid:me,finalAmount:M,baseTotal:K,additionalChargesTotal:W,additionalCharges:h,paymentMode:c.payment_mode,transaction_id:c.transaction_id,is_fixed_bid:c.is_fixed_bid==1,is_advance:c.is_advance==1,remark:c.remark},Ee=H.map(Ce=>({id:Ce.id,data:Ce}));await os(we,Ee,E,_,k,Ee,"english","save",fe)}catch(p){console.error("Error generating PDF:",p),D("Failed to generate PDF. Please try again.")}finally{X(!1)}},Ie=t=>t?new Date(t).toLocaleDateString("en-GB"):"",Me=t=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[t]||t;if(R)return e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(ce,{color:"primary"})});if(!c||Object.keys(c).length===0)return e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No invoice data found."})});const W=h.reduce((t,x)=>t+Number(x.amount||0),0),Z=h.reduce((t,x)=>t+Number(x.paid_amount||0),0),K=Number((c==null?void 0:c.base_total)||0),_e=Number((c==null?void 0:c.paid_amount)||0),M=K+W,me=_e+Z,Q=M-me,$e=Q<=0;return e.jsx("div",{className:"p-4",children:e.jsxs(Be,{children:[e.jsx(We,{className:"bg-primary text-white",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap",children:[e.jsx("h5",{className:"mb-0",children:"Invoice Details"}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(pe,{color:$e?"success":"warning",className:"fs-6 px-3 py-2 rounded-pill",children:$e?"✔️ Completed":"⏳ Pending"}),e.jsx(y,{color:"success",size:"sm",onClick:ve,disabled:Fe||!c,children:Fe?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})})]})]})}),e.jsxs(Le,{children:[e.jsxs(U,{className:"mb-4",children:[e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Invoice Number:"}),e.jsx("div",{className:"text-muted",children:c.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Date:"}),e.jsx("div",{className:"text-muted",children:Ie(c.created_at)})]})]}),e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Payment Mode:"}),e.jsx("div",{className:"text-muted",children:c.payment_mode||"-"})]}),c.transaction_id&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Transaction ID:"}),e.jsx("div",{className:"text-muted",children:c.transaction_id})]}),c.project&&e.jsxs("div",{className:"mb-3",children:[e.jsx("strong",{children:"Customer:"}),e.jsx("div",{className:"text-muted",children:c.project.customer_name||"-"})]})]})]}),!r&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2",children:[e.jsx("div",{children:g.length>0&&e.jsxs("span",{className:"text-muted small",children:[g.length," work order(s) selected"]})}),e.jsxs("div",{className:"d-flex flex-wrap gap-2",children:[e.jsx(y,{color:"primary",onClick:Ne,disabled:g.length===0||T,className:"d-flex align-items-center",size:"sm",children:T?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Work Order PDF"}),e.jsx("span",{className:"d-inline d-sm-none",children:"WO"}),g.length>0&&` (${g.length})`]})}),e.jsx(y,{color:"success",onClick:Te,disabled:Y,className:"d-flex align-items-center",size:"sm",children:Y?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),e.jsx("span",{className:"d-none d-md-inline",children:"Generating..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:ws,className:"me-1"}),e.jsx("span",{className:"d-none d-sm-inline",children:"Income Report"}),e.jsx("span",{className:"d-inline d-sm-none",children:"Income"})]})})]})]})}),D.show&&e.jsx(Cs,{color:D.type,dismissible:!0,onClose:()=>O({show:!1,message:"",type:"success"}),children:D.message}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"70vh",overflowY:"auto",overflowX:"auto",borderRadius:"6px"},children:e.jsxs(xe,{striped:!0,bordered:!0,hover:!0,className:"mb-0",children:[e.jsx(he,{style:{position:"sticky",top:0,zIndex:2,backgroundColor:"#f8f9fa",boxShadow:"0 2px 3px rgba(0,0,0,0.05)"},children:e.jsxs(j,{children:[e.jsx(l,{children:"Sr no."}),e.jsx(l,{children:"Work Date"}),e.jsx(l,{children:"Machine"}),e.jsx(l,{children:"Mode"}),e.jsx(l,{children:"Operator"}),e.jsx(l,{children:"Work Type"}),e.jsx(l,{children:"Start Reading"}),e.jsx(l,{children:"End Reading"}),e.jsx(l,{children:"Net Reading"}),e.jsx(l,{children:"Price Per Hour"}),e.jsx(l,{className:"text-end",children:"Total Price"})]})}),e.jsxs(ue,{children:[H.length>0?H.map((t,x)=>{var $,ee,se;return e.jsxs(j,{children:[e.jsx(a,{children:x+1}),e.jsx(a,{children:(t==null?void 0:t.work_date)||"-"}),e.jsx(a,{children:(($=_.find(p=>String(p.id)===String(t==null?void 0:t.machine_id)))==null?void 0:$.machine_name)||"N/A"}),e.jsx(a,{children:((ee=k.find(p=>p.id===Number(t.mode_id)))==null?void 0:ee.mode)||"-"}),e.jsx(a,{children:((se=E.find(p=>p.id===Number(t==null?void 0:t.operator_id)))==null?void 0:se.name)||"Unknown Operator"}),e.jsx(a,{children:fe[t==null?void 0:t.work_type_id]||"—"}),e.jsx(a,{children:(t==null?void 0:t.start_reading)||"-"}),e.jsx(a,{children:(t==null?void 0:t.end_reading)||"-"}),e.jsx(a,{children:t!=null&&t.end_reading&&(t!=null&&t.start_reading)?t.end_reading-t.start_reading:"-"}),e.jsxs(a,{children:["₹",(t==null?void 0:t.price_per_hour)||"0"]}),e.jsxs(a,{className:"text-end",children:["₹",t!=null&&t.end_reading&&(t!=null&&t.start_reading)&&(t!=null&&t.price_per_hour)?((t.end_reading-t.start_reading)*t.price_per_hour).toFixed(2):"0.00"]})]},t.id)}):e.jsx(j,{children:e.jsx(a,{colSpan:10,className:"text-center text-muted py-4",children:"No work orders found for this invoice."})}),h&&h.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(j,{style:{backgroundColor:"#f0f8ff"},children:e.jsx(a,{colSpan:11,className:"fw-bold text-primary",children:"Additional Charges"})}),h.map((t,x)=>e.jsxs(j,{style:{backgroundColor:"#f8f9fa"},children:[e.jsx(a,{children:H.length+x+1}),e.jsx(a,{children:t.date?new Date(t.date).toLocaleDateString("en-GB"):"-"}),e.jsxs(a,{colSpan:7,children:[e.jsx("strong",{children:Me(t.charge_type)}),t.remark&&e.jsxs("div",{className:"small text-muted mt-1",children:["Note: ",t.remark]})]}),e.jsx(a,{className:"text-center",children:e.jsx(pe,{color:t.is_paid?"success":"warning",children:t.is_paid?"Paid":"Pending"})}),e.jsxs(a,{className:"text-end fw-bold",children:["₹",Number(t.amount).toFixed(2)]})]},`charge-${t.id}`))]}),h.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Work Orders Subtotal"}),e.jsxs(a,{className:"text-end",children:["₹",K.toFixed(2)]})]}),e.jsxs(j,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Additional Charges Total"}),e.jsxs(a,{className:"text-end",children:["₹",W.toFixed(2)]})]})]}),e.jsxs(j,{className:"fw-bold bg-primary text-white",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Grand Total"}),e.jsxs(a,{className:"text-end",children:["₹",M.toFixed(2)]})]}),e.jsxs(j,{className:"bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Paid Amount"}),e.jsxs(a,{className:"text-end text-success",children:["₹",me.toFixed(2)]})]}),e.jsxs(j,{className:"fw-bold bg-light",children:[e.jsx(a,{colSpan:10,className:"text-end",children:"Remaining Amount"}),e.jsxs(a,{className:`text-end ${Q>0?"text-danger":"text-success"}`,children:["₹",Q.toFixed(2)]})]})]})]})}),e.jsxs("div",{className:"mt-4 p-3 bg-light rounded",children:[e.jsxs(U,{className:"w-100",children:[e.jsx(f,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Total Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold",children:["₹",M.toFixed(2)]})]})}),e.jsx(f,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Paid Amount:"}),e.jsxs("span",{className:"fs-5 fw-bold text-success",children:["₹",me.toFixed(2)]})]})}),e.jsx(f,{md:4,children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-2",children:[e.jsx("span",{className:"fw-bold me-2",children:"Remaining:"}),e.jsxs("span",{className:`fs-5 fw-bold ${Q>0?"text-danger":"text-success"}`,children:["₹",Q.toFixed(2)]})]})})]}),c.payment_mode&&e.jsx("div",{className:"mt-2 pt-2 border-top",children:e.jsxs("div",{className:"",children:[e.jsx("span",{className:"fw-bold me-2",children:"Payment Mode:"}),e.jsx(pe,{color:"info",className:"fs-6",children:c.payment_mode})]})})]})]})]})})},Ds=({paymentId:m})=>{const[r,c]=n.useState(null),[je,R]=n.useState(!0),[V,k]=n.useState(!1);n.useEffect(()=>{m&&de()},[m]);const de=async()=>{try{R(!0);const g=await P(`/api/project-payments/${m}`);c(g)}catch(g){console.error("Error fetching advance payment:",g)}finally{R(!1)}},D=g=>g?new Date(g).toLocaleDateString("en-GB"):"",O=async()=>{var g,S,T,z,Y,le,E,q;if(r)try{k(!0);const v=(g=ze())==null?void 0:g.company_info;if(!v){alert("Company information not found. Please log in again.");return}const B=D(r.created_at),_=r.is_fixed_bid==1,ge=!_,J={invoice_number:r.invoice_number,date:B,customer:{name:((S=r.project)==null?void 0:S.customer_name)||"N/A",address:((T=r.project)==null?void 0:T.work_place)||"",mobile:((z=r.project)==null?void 0:z.mobile_number)||"",gst_number:((Y=r.project)==null?void 0:Y.gst_number)||""},consignee:{name:v.company_name,address:`${v.land_mark||""}, ${v.Tal||""}, ${v.Dist||""}, ${v.pincode||""}`,phone_no:v.phone_no,gst_number:v.gst_number,email_id:v.email_id},totalAmount:r.total,amountPaid:r.paid_amount,finalAmount:r.total,paymentMode:r.payment_mode||(_?"Fixed Bid":"Advance"),transaction_id:r.transaction_id,is_fixed_bid:_,is_advance:ge,remark:r.remark,name:((le=r.project)==null?void 0:le.customer_name)||"N/A",address:((E=r.project)==null?void 0:E.work_place)||"",mobile:((q=r.project)==null?void 0:q.mobile_number)||"",total:r.total};await os(J,[],[],[],[],[],"english","save")}catch(v){console.error("Error generating PDF:",v),alert("Failed to generate PDF. Please try again.")}finally{k(!1)}};return je?e.jsx("div",{className:"d-flex justify-content-center align-items-center p-5",children:e.jsx(ce,{color:"primary"})}):r?e.jsx("div",{className:"p-4",children:e.jsxs(Be,{children:[e.jsxs(We,{className:"bg-warning text-dark d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:r.is_fixed_bid==1?"Fixed Bid Invoice":"Advance Payment Invoice"}),e.jsx(y,{color:"success",size:"sm",onClick:O,disabled:V||!r,children:V?e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:"sm",className:"me-1"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})})]}),e.jsxs(Le,{children:[e.jsxs(U,{className:"mb-4",children:[e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Invoice Number:"})," ",e.jsx("span",{className:"text-muted",children:r.invoice_number||"-"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Date:"})," ",e.jsx("span",{className:"text-muted",children:D(r.created_at)})]})]}),e.jsxs(f,{md:6,children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Payment Mode:"})," ",e.jsx("span",{className:"text-muted",children:r.payment_mode||(r.is_fixed_bid==1?"Fixed Bid":"Advance")})]}),r.transaction_id&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:"Transaction ID:"})," ",e.jsx("span",{className:"text-muted",children:r.transaction_id})]})]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(xe,{striped:!0,bordered:!0,children:[e.jsx(he,{children:e.jsxs(j,{children:[e.jsx(l,{children:"Description"}),e.jsx(l,{className:"text-end",children:"Amount"}),e.jsx(l,{className:"text-end",children:"Remaining"})]})}),e.jsxs(ue,{children:[e.jsxs(j,{children:[e.jsxs(a,{children:[e.jsx("strong",{children:r.is_fixed_bid==1?"Fixed Bid Work":"Advance Payment"}),r.remark&&e.jsx("div",{className:"text-muted small mt-1",children:r.remark})]}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-success",children:["₹",Number(r.total||0).toFixed(2)]})}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-danger",children:["₹",(Number(r.total||0)-Number(r.paid_amount||0)).toFixed(2)]})})]}),e.jsxs(j,{children:[e.jsx(a,{colSpan:2,children:e.jsx("strong",{children:"Total Paid Amount"})}),e.jsx(a,{className:"text-end",children:e.jsxs("strong",{className:"text-success fs-5",children:["₹",Number(r.paid_amount||0).toFixed(2)]})})]})]})]})}),e.jsx("div",{className:"mt-4 p-3 bg-light rounded",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Payment Mode:"}),e.jsx("span",{className:"badge bg-info fs-6 ms-2",children:r.payment_mode||(r.is_fixed_bid==1?"Fixed Bid":"Advance")})]})}),r.project&&e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("span",{className:"fw-bold",children:"Cust. Name :"}),e.jsx("span",{className:"text-muted ms-2",children:r.project.customer_name||"-"})]})})]})})]})]})}):e.jsx("div",{className:"p-4 text-center",children:e.jsx("p",{className:"text-muted",children:"No payment data found."})})},Ts=()=>e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",className:"bi bi-eye",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"}),e.jsx("path",{d:"M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"})]}),nt=()=>{var es,ss;const{showToast:m}=Ns(),r=(es=ze())==null?void 0:es.company_id;if(!r)return e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{minHeight:"400px"},children:e.jsx("p",{className:"text-muted",children:"Unable to determine company. Please log in again."})});const[c,je]=n.useState([]),[R,V]=n.useState(""),[k,de]=n.useState(""),[D,O]=n.useState(""),[g,S]=n.useState(!1),[T,z]=n.useState(null),[Y,le]=n.useState(!1),[E,q]=n.useState(null),[v,B]=n.useState(!1);n.useState("");const[_,ge]=n.useState(null),[J,Se]=n.useState(!1),[H,Ue]=n.useState([]),[Fe,X]=n.useState(!1),[h,Ve]=n.useState(null),[I,Ae]=n.useState(""),[fe,ke]=n.useState(""),[Ye,ye]=n.useState(!1),[be,L]=n.useState(""),[De,Ne]=n.useState(""),[Te,ve]=n.useState([]);n.useState(!1);const[Ie,Me]=n.useState(!1),[W,Z]=n.useState(""),[K,_e]=n.useState(!1);n.useState(""),n.useState([]);const[M,me]=n.useState([]),[Q,$e]=n.useState(!1),[t,x]=n.useState(null),$=async()=>{S(!0);try{const s=await P(`/api/project-payments?company_id=${r}`);je(Array.isArray(s)?s:[])}catch(s){m("danger","Error fetching project payments: "+((s==null?void 0:s.message)||s))}finally{S(!1)}},ee=async()=>{S(!0);try{const s=await P("/api/project-wise-hours");me(s.project_wise_hours||[]),console.log("machine hourse",s.project_wise_hours)}catch(s){m("danger","Error fetching Hours: "+((s==null?void 0:s.message)||s))}finally{S(!1)}},se=async()=>{try{const s=await P("/api/projects");if(!Array.isArray(s)){ve([]);return}const i={};s.forEach(o=>{var u;if(o.company_id!==r)return;const d=(u=o.customer_name)==null?void 0:u.trim();d&&(i[d]||(i[d]={name:d,mobile:o.mobile_number||"",projects:[]}),i[d].projects.push({id:o.id,company_id:o.company_id}))}),ve(Object.values(i))}catch(s){console.error(s),ve([])}},p=async()=>{if(_){S(!0);try{const s=await P(`/api/repayments?company_id=${r}&project_id=${_}`);Ue(Array.isArray(s)?s:[])}catch(s){m("danger","Error fetching history: "+((s==null?void 0:s.message)||s))}finally{S(!1)}}};n.useEffect(()=>{$(),se(),ee()},[r]),n.useEffect(()=>{_&&p()},[_,r]);const Re=s=>s?new Date(s).toLocaleDateString("en-GB"):"",we=s=>`₹${Number(s||0).toFixed(2)}`,Ee=s=>({travelling_charge:"Travelling Charges",service_charge:"Service Charges",other_charge:"Other Charges"})[s]||s,Ce=n.useMemo(()=>c.filter(s=>s.company_id===r),[c,r]),ds=n.useMemo(()=>{const s={};return M.forEach(i=>{s[Number(i.project_id)]=Number(i.total_hours||0)}),s},[M]),ls=n.useMemo(()=>M.reduce((s,i)=>s+Number(i.total_hours||0),0),[M]),ms=s=>[...new Set(s.map(o=>{var d;return(d=o.project)==null?void 0:d.id}).filter(Boolean))].reduce((o,d)=>o+(ds[d]||0),0),He=n.useMemo(()=>{const s={};if(Ce.forEach(i=>{var d;const o=((d=i.project)==null?void 0:d.customer_name)||"Unknown";s[o]||(s[o]=[]),s[o].push(i)}),k){const i=k.toLowerCase();return Object.fromEntries(Object.entries(s).filter(([o])=>o.toLowerCase().includes(i)))}return s},[Ce,k]),Pe=n.useMemo(()=>{const s=Object.values(He),i=s.flat(),o=i.filter(N=>!N.is_advance),d=s.length,u=i.length,b=o.reduce((N,A)=>N+Number(A.total||0),0),F=o.reduce((N,A)=>N+Number(A.paid_amount||0),0),C=b-F;return{customerCount:d,totalInvoices:u,totalBilled:b,totalPaid:F,totalOutstanding:C}},[He]);if(g&&!c.length)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center",style:{minHeight:"400px"},children:[e.jsx(ce,{color:"primary",size:"lg"}),e.jsx("p",{className:"mt-3 text-muted",children:"Loading project payments..."})]});const xs=async()=>{var F;if(!h||!I||Number(I)<=0)return;const s=Number(I),i=s,o=Number(h.total)-i,d=fe;try{const C={paid_amount:i,payment_mode:h.payment_mode||null},N=await fetch(`/api/project-payments/${h.id}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!N.ok){const A=await N.text();throw new Error(`Failed to update payment: ${A}`)}m("success","Payment updated successfully")}catch(C){console.error("Payment update error:",C),m("danger","Failed to update payment: "+C.message);return}const u=new Date().toISOString().split("T")[0],b={company_id:r,project_id:(F=h.project)==null?void 0:F.id,invoice_id:h.invoice_number,payment:s,total:h.total,remaining:o,is_completed:o<=0,date:u,remark:d};try{await fetch("/api/repayment/single",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)}),Ae(""),ke(""),X(!1),$(),_&&p()}catch(C){console.error("Repayment recording error:",C),m("danger","Payment recorded but history failed to save.")}};if(!T)return e.jsxs(e.Fragment,{children:[e.jsx(U,{children:e.jsx(f,{xs:12,children:e.jsxs(Be,{className:"shadow-sm",children:[e.jsx(We,{className:"bg-light d-flex justify-content-between align-items-center",children:e.jsxs("div",{children:[e.jsx("strong",{className:"fs-5",children:"Customers Payment Report"}),e.jsxs(pe,{color:"info",className:"ms-2",children:[Pe.customerCount," customers"]})]})}),e.jsxs(Le,{children:[e.jsxs(U,{className:"mb-2",children:[e.jsx(f,{xs:12,md:6,children:e.jsxs(Ps,{children:[e.jsx(Ss,{children:"Search"}),e.jsx(Oe,{placeholder:"Search by customer name...",value:D,onChange:s=>{O(s.target.value),de(s.target.value)}})]})}),k&&e.jsx(f,{xs:12,md:3,className:"mt-2 mt-md-0",children:e.jsx(y,{color:"light",size:"sm",onClick:()=>{O(""),de("")},children:"Clear"})})]}),e.jsxs(U,{className:"g-2 mb-3",children:[e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-primary text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Invoices"}),e.jsx("strong",{className:"fs-6",children:Pe.totalInvoices})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-success text-white shadow-sm",children:[e.jsxs("small",{className:"d-block",children:["Total Billed (",ls,"hrs.)"]}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalBilled)})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-warning text-dark shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Paid"}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalPaid)})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"rounded p-2 text-center bg-info text-white shadow-sm",children:[e.jsx("small",{className:"d-block",children:"Outstanding"}),e.jsx("strong",{className:"fs-6",children:we(Pe.totalOutstanding)})]})})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs(xe,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(he,{children:e.jsxs(j,{children:[e.jsx(l,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(l,{className:"text-center align-middle",children:"Customer Name"}),e.jsx(l,{className:"text-center align-middle",children:"Hours"}),e.jsx(l,{className:"text-center align-middle",children:"Total"}),e.jsx(l,{className:"text-center align-middle",children:"Paid"}),e.jsx(l,{className:"text-center align-middle",children:"Remaining"}),e.jsx(l,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ue,{children:Object.entries(He).map(([s,i],o)=>{const d=i.filter(N=>!N.is_advance),u=d.reduce((N,A)=>N+Number(A.total||0),0),b=d.reduce((N,A)=>N+Number(A.paid_amount||0),0),F=u-b,C=ms(i);return e.jsxs(j,{children:[e.jsx(a,{children:o+1}),e.jsx(a,{children:s}),e.jsx(a,{style:{color:C<0?"red":"blue",fontWeight:600},children:C}),e.jsxs(a,{className:"text-end",children:["₹",u.toFixed(2)]}),e.jsxs(a,{className:"text-success fw-bold text-end",children:["₹",b.toFixed(2)]}),e.jsxs(a,{className:"text-danger fw-bold text-end",children:["₹",F.toFixed(2)]}),e.jsx(a,{className:"text-center",children:e.jsx(y,{size:"sm",color:"info",onClick:()=>{z(s),ge(i[0].project_id)},children:"View Invoices"})})]},s)})})]})})]})]})})}),e.jsxs(ne,{visible:Ye,onClose:()=>{ye(!1),L(""),Ne("")},children:[e.jsx(ae,{children:e.jsx(re,{children:"Advance Payment"})}),e.jsxs(ie,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Customer"}),e.jsxs("select",{className:"form-select",value:be,onChange:s=>L(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select --"}),Te.map(s=>e.jsxs("option",{value:s.name,children:[s.name," ",s.mobile?`(${s.mobile})`:""]},s.name))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(Oe,{type:"number",placeholder:"Enter amount",value:De,onChange:s=>Ne(s.target.value),min:"0"})]})]}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>ye(!1),children:"Cancel"}),e.jsx(y,{color:"primary",onClick:async()=>{var u;if(!be)return m("danger","Select a customer");const s=Number(De);if(!s||s<=0)return m("danger","Enter a valid amount");const i=Te.find(b=>b.name===be);if(!((u=i==null?void 0:i.projects)!=null&&u.length))return m("danger","No project for this customer");const{id:o,company_id:d}=i.projects[0];try{await cs("/api/advance-payment",{company_id:d,project_id:o,amount:s}),m("success","Advance payment recorded"),ye(!1),L(""),Ne(""),$()}catch(b){m("danger","Failed: "+((b==null?void 0:b.message)||"Unknown error"))}},children:"Submit"})]})]})]});const qe=He[T]||[],Qe=qe.filter(s=>!s.is_advance),Je=Qe.reduce((s,i)=>s+Number(i.total||0),0),Xe=Qe.reduce((s,i)=>s+Number(i.paid_amount||0),0),te=Je-Xe,G=(H||[]).filter(s=>s.is_advance&&!s.advance_taken).reduce((s,i)=>s+Number(i.payment||0),0),hs=async()=>{const o=(Number(W)||0)+(K?G:0);if(o<=0)return m("danger","Total payment must be greater than 0");if(o>te)return m("danger","Total amount exceeds remaining balance");try{if(await cs("/api/repayments",{project_id:_,payment:o}),K)try{const d=await vs("/api/repayments/mark-advance-taken",{company_id:r,project_id:_});d.success?m("success",d.message||"Advance payments marked as cleared"):m("warning",d.message||"Advance status update failed")}catch(d){console.error("Advance clear update failed:",d),m("warning","Repayment saved, but advance status update failed: "+(d.message||"Unknown error"))}m("success","Payment recorded successfully"),B(!1),Z(""),_e(!1),$(),p()}catch(d){m("danger","Error: "+((d==null?void 0:d.message)||d))}},us=async()=>{var ns,as,rs,is;const s=c.find(w=>w.invoice_number===R);if(!s)return;const i=H.filter(w=>(w==null?void 0:w.invoice_id)===R);if(i.length===0){m("warning","No history to download");return}const o=(ns=ze())==null?void 0:ns.company_info;if(!o){alert("Company information not found. Please log in again.");return}const d=((as=s.project)==null?void 0:as.customer_name)||"N/A",u=s.is_fixed_bid==1?"FIXED BID INVOICE":"INVOICE",b=Number(s.total||0).toFixed(2),F=Number(s.paid_amount||0).toFixed(2),C=(Number(s.total)-Number(s.paid_amount)).toFixed(2);let N=0;const A=Number(s.total||0),ps=i.map((w,fs)=>{N+=Number(w.payment||0);const ys=A-N;return`
            <tr>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${fs+1}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    ${w!=null&&w.date?w.date.slice(0,10).split("-").reverse().join("-"):"-"}
                </td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${Number(w.payment).toFixed(2)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">₹${ys.toFixed(2)}</td>
            </tr>
        `}).join(""),js=`
        <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <!-- Header Section -->
            <div style="border-bottom: 3px solid #0d6efd; padding-bottom: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        ${o.logo?`<img src="/img/${o.logo}" alt="Logo" style="max-width: 120px; height: auto;" />`:""}
                    </div>
                    <div style="text-align: right; flex: 1;">
                        <h2 style="margin: 0; color: #333; font-size: 24px;">${o.company_name||""}</h2>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${o.land_mark||""}, ${o.Tal||""}, ${o.Dist||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Pincode: ${o.pincode||""}</p>
                        <p style="margin: 5px 0; color: #666; font-size: 14px;">Phone: ${o.phone_no||""}</p>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div style="text-align: center; background-color: #0d6efd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <h2 style="margin: 0; color: #fff; font-size: 20px;">PAYMENT HISTORY - ${u}</h2>
            </div>

            <!-- Invoice & Customer Details -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Invoice Details</h3>
                    <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${s.invoice_number}</p>
                    <p style="margin: 5px 0;"><strong>Date:</strong> ${Re(s.created_at)}</p>
                    <p style="margin: 5px 0;"><strong>Total Amount:</strong> ₹${b}</p>
                    <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ₹${F}</p>
                    <p style="margin: 5px 0;"><strong>Remaining:</strong> ₹${C}</p>
                </div>
                <div style="flex: 1;">
                    <h3 style="color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 10px;">Customer Details</h3>
                    <p style="margin: 5px 0;"><strong>Customer Name:</strong> ${d}</p>
                    <p style="margin: 5px 0;"><strong>Mobile:</strong> ${((rs=s.project)==null?void 0:rs.mobile_number)||"-"}</p>
                    <p style="margin: 5px 0;"><strong>Site:</strong> ${((is=s.project)==null?void 0:is.work_place)||"-"}</p>
                </div>
            </div>

            <!-- History Table -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Sr. No.</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">Date</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Paid Amount</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: right;">Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    ${ps}
                </tbody>
            </table>

            <!-- Footer -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #666; font-size: 12px;">
                <p>This is a computer-generated document and is valid without signature.</p>
            </div>
        </div>
    `,ts=document.createElement("div");ts.innerHTML=js;const gs={margin:[10,10,10,10],filename:`History-${s.invoice_number}-${d}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};try{await _s().set(gs).from(ts).save(),m("success","History PDF downloaded successfully")}catch(w){console.error("PDF generation error:",w),m("danger","Failed to generate PDF")}};return e.jsxs(e.Fragment,{children:[e.jsx(U,{children:e.jsx(f,{xs:12,children:e.jsxs(Be,{className:"shadow-sm",children:[e.jsxs(We,{className:"bg-light d-flex justify-content-between align-items-center flex-wrap",children:[e.jsxs("div",{children:[e.jsxs("strong",{className:"fs-5",children:["Invoices for ",T]}),e.jsxs(pe,{color:"info",className:"ms-2",children:[qe.length," entries"]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2 mt-md-0",children:[e.jsx(y,{color:"success",onClick:()=>{B(!0);const s=G>0&&G<=te;_e(s),Z("")},children:"Record Payment"}),e.jsx(y,{color:"secondary",size:"sm",onClick:()=>z(null),children:"Back"})]})]}),e.jsxs(Le,{children:[e.jsxs(U,{className:"g-2 mb-2",children:[e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-primary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Total"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Je.toFixed(2)]})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-success text-center text-white shadow-sm",children:[e.jsx("small",{children:"Paid"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",Xe.toFixed(2)]})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-danger text-center text-white shadow-sm",children:[e.jsx("small",{children:"Remaining"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",te.toFixed(2)]})]})}),e.jsx(f,{xs:6,md:3,children:e.jsxs("div",{className:"p-2 rounded bg-secondary text-center text-white shadow-sm",children:[e.jsx("small",{children:"Advance"}),e.jsxs("div",{className:"fw-semibold fs-6 mt-1",children:["₹",G.toFixed(2)]})]})})]}),e.jsx("div",{className:"table-responsive",style:{maxHeight:"500px",overflowY:"auto"},children:e.jsxs(xe,{hover:!0,bordered:!0,children:[e.jsx(he,{style:{position:"sticky",top:0,backgroundColor:"#f8f9fa"},children:e.jsxs(j,{children:[e.jsx(l,{className:"text-center align-middle",children:"Sr. No."}),e.jsx(l,{className:"text-center align-middle",children:"Invoice"}),e.jsx(l,{className:"text-center align-middle",children:"Date"}),e.jsx(l,{className:"text-center align-middle",children:"Total"}),e.jsx(l,{className:"text-center align-middle",children:"Paid"}),e.jsx(l,{className:"text-center align-middle",children:"Remaining"}),e.jsx(l,{className:"text-center align-middle",children:"Mode"}),e.jsx(l,{className:"text-center align-middle",children:"Action"})]})}),e.jsx(ue,{children:qe.sort((s,i)=>new Date(i.created_at)-new Date(s.created_at)).map((s,i)=>{const o=(Number(s.total)-Number(s.paid_amount)).toFixed(2);return e.jsxs(j,{className:s.is_advance==1?"table-primary":s.is_fixed_bid==1?"table-warning":"",children:[e.jsx(a,{children:i+1}),e.jsx(a,{children:s.is_advance==1?"Advance Payment":s.invoice_number}),e.jsx(a,{className:"text-center align-middle",children:Re(s.created_at)}),e.jsxs(a,{className:"text-end fw-bold",children:["₹",Number(s.total).toFixed(2)]}),e.jsxs(a,{className:"text-success fw-bold text-end",children:["₹",Number(s.paid_amount).toFixed(2)]}),e.jsxs(a,{className:"text-danger fw-bold text-end",children:["₹",o]}),e.jsx(a,{children:s.payment_mode||"-"}),e.jsx(a,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-1",children:[s.is_advance==0&&e.jsx(Ke,{content:"Add Payment",placement:"top",children:e.jsx(y,{color:"success",size:"sm",onClick:()=>{Ve(s),X(!0)},children:e.jsx(oe,{icon:Fs})})}),s.is_advance==0&&e.jsx(Ke,{content:"Payment History",placement:"top",children:e.jsx(y,{color:"info",size:"sm",onClick:()=>{V(s.invoice_number),Se(!0)},children:e.jsx(oe,{icon:As})})}),e.jsx(Ke,{content:s.is_advance==1?"View Advance Invoice":s.is_fixed_bid==1?"View Fixed Bid Invoice":"View Invoice",placement:"top",children:e.jsx(y,{color:s.is_advance==1||s.is_fixed_bid==1?"warning":"secondary",size:"sm",onClick:()=>{s.is_advance==1||s.is_fixed_bid==1?(q(s.id),Me(!0)):(q(s.id),le(!0))},children:e.jsx(Ts,{})})})]})})]},s.id)})})]})})]})]})})}),e.jsxs(ne,{visible:Ie,onClose:()=>Me(!1),size:"xl",backdrop:"static",children:[e.jsx(ae,{children:e.jsx(re,{children:((ss=c.find(s=>s.id===E))==null?void 0:ss.is_fixed_bid)==1?"Fixed Bid Invoice":"Advance Invoice"})}),e.jsx(ie,{style:{overflowY:"visible",padding:0},children:e.jsx(Ds,{paymentId:E})})]}),e.jsxs(ne,{visible:v,onClose:()=>B(!1),children:[e.jsx(ae,{children:e.jsxs(re,{children:["Add Repayment - ",T]})}),e.jsxs(ie,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total :"})," ₹",Je.toFixed(2)]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Advance Paid:"})," ",e.jsxs("span",{className:"text-success",children:["₹",G.toFixed(2)]})]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Paid :"})," ",e.jsxs("span",{className:"text-success",children:["₹",Xe.toFixed(2)]})]}),e.jsxs("p",{className:"mb-3",children:[e.jsx("strong",{children:"Remaining :"})," ",e.jsxs("span",{className:"text-danger",children:["₹",te.toFixed(2)]})]}),e.jsx("hr",{}),te>0?e.jsx(e.Fragment,{children:G>0&&G<=te?e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Additional Amount"}),e.jsx(Oe,{type:"number",placeholder:"Enter additional amount",value:W,onChange:s=>Z(s.target.value),min:"0"}),e.jsxs("div",{className:"mt-2 text-end",children:[e.jsx("strong",{children:"Total Payment: "}),"₹",((K?G:0)+(Number(W)||0)).toFixed(2)]})]}):e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Amount"}),e.jsx(Oe,{type:"number",placeholder:"Enter amount to pay",value:W,onChange:s=>Z(s.target.value),min:"0"})]})}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>{B(!1),_e(!1),Z("")},children:"Cancel"}),e.jsx(y,{color:"primary",onClick:hs,disabled:te<=0,children:"Submit"})]})]}),e.jsxs(ne,{visible:J,onClose:()=>Se(!1),size:"lg",children:[e.jsx(ae,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center w-100",children:[e.jsx(re,{children:"Payment History"}),e.jsxs(y,{color:"success",size:"sm",className:"me-4",onClick:us,title:"Download History PDF",children:[e.jsx(oe,{icon:Ge,className:"me-1"}),"Download PDF"]})]})}),e.jsx(ie,{children:H.filter(s=>(s==null?void 0:s.invoice_id)===R).length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(xe,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(he,{color:"dark",children:e.jsxs(j,{children:[e.jsx(l,{children:"Date"}),e.jsx(l,{children:"Paid"}),e.jsx(l,{children:"Remaining"}),e.jsx(l,{children:"Remark"})]})}),e.jsx(ue,{children:(()=>{var d;const s=H.filter(u=>(u==null?void 0:u.invoice_id)===R),i=((d=s[0])==null?void 0:d.total)||0;let o=0;return s.map((u,b)=>{o+=Number(u.payment||0);const F=Number(i)-o;return e.jsxs(j,{children:[e.jsx(a,{children:u!=null&&u.date?u.date.slice(0,10).split("-").reverse().join("-"):""}),e.jsxs(a,{children:["₹",u.payment]}),e.jsxs(a,{children:["₹",F.toFixed(2)]}),e.jsx(a,{children:u.remark})]},b)})})()})]})}):e.jsx("div",{className:"text-center py-4 text-muted",children:e.jsx("p",{className:"mb-0",children:"No payment history found for this invoice."})})})]}),e.jsxs(ne,{visible:Fe,onClose:()=>X(!1),children:[e.jsx(ae,{closeButton:!0,children:e.jsx(re,{children:"Make Payment"})}),e.jsx(ie,{children:h&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Invoice:"})," ",h.invoice_number]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Total:"})," ₹",h.total]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Remaining:"})," ₹",h.total-h.paid_amount]}),h.total-h.paid_amount>0?e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"form-label fw-semibold",children:"Amount to Pay"}),e.jsx("input",{type:"number",className:"form-control",value:I,onChange:s=>Ae(s.target.value),min:"1",max:h.total-h.paid_amount}),e.jsx("label",{className:"form-label fw-semibold",children:"Remark"}),e.jsx("input",{type:"text",className:"form-control",value:fe,onChange:s=>ke(s.target.value)})]}):e.jsx("div",{className:"alert alert-success text-center",children:"Payment Complete! No outstanding balance."})]})}),e.jsxs(Ze,{children:[e.jsx(y,{color:"secondary",onClick:()=>X(!1),children:"Cancel"}),e.jsx(y,{color:"success",onClick:()=>{if(!I||Number(I)<=0)return m("danger","Enter a valid amount");const s=Number(h.total)-Number(h.paid_amount);if(Number(I)>s)return m("danger","Amount cannot be greater than remaining amount");xs()},children:"Confirm"})]})]}),e.jsxs(ne,{visible:Y,onClose:()=>le(!1),size:"xl",backdrop:"static",children:[e.jsx(ae,{children:e.jsx(re,{children:"Invoice"})}),e.jsx(ie,{style:{overflowY:"visible",padding:0},children:e.jsx(ks,{projectId:E,inModal:!0})})]}),e.jsxs(ne,{visible:Q,onClose:()=>{$e(!1),x(null)},size:"lg",children:[e.jsx(ae,{children:e.jsxs(re,{children:["Additional Charges - ",t==null?void 0:t.invoice_number]})}),e.jsx(ie,{children:t!=null&&t.additionalCharges&&t.additionalCharges.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(xe,{striped:!0,bordered:!0,children:[e.jsx(he,{children:e.jsxs(j,{children:[e.jsx(l,{children:"Charge Type"}),e.jsx(l,{children:"Amount"}),e.jsx(l,{children:"Paid"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Remark"})]})}),e.jsx(ue,{children:t.additionalCharges.map((s,i)=>e.jsxs(j,{children:[e.jsx(a,{children:Ee(s.charge_type)}),e.jsxs(a,{className:"text-end",children:["₹",Number(s.amount).toFixed(2)]}),e.jsxs(a,{className:"text-end text-success fw-bold",children:["₹",Number(s.paid_amount||0).toFixed(2)]}),e.jsx(a,{children:e.jsx(pe,{color:s.is_paid?"success":"warning",children:s.is_paid?"Paid":"Pending"})}),e.jsx(a,{children:s.remark||"-"})]},s.id))})]})}):e.jsx("p",{className:"text-muted text-center",children:"No additional charges"})})]})]})};export{nt as default};

import{r as n,u as wt,b as Ct,j as e,C as Ye}from"./index-Cn-F0xzs.js";/* empty css                */import{a as U,b as _,c as H,d as N}from"./index.esm-7oL-v0Yv.js";import{a as B,b as ae,p as $}from"./api-BUyL__Lx.js";import{u as kt,a as St,b as At,c as It,d as Et}from"./DefaultLayout-pwnRm339.js";import{C as Xe,a as ve}from"./CCardBody-OOd8gb1I.js";import{C as Je}from"./CCardHeader-NWf5yg3Z.js";import{C as Ke}from"./CForm-CfRPYM1l.js";import{C as x}from"./CFormLabel-Dk6nlh4k.js";import{C as Ze}from"./CInputGroup-DPH3SzoJ.js";import{C as j}from"./CFormInput-CwIxlT0b.js";import{C as et}from"./CInputGroupText-BvWBaOqj.js";import{c as tt}from"./cil-search-CDkY_4k-.js";import{c as we}from"./cil-x-0440B5Ce.js";import{C as Ce}from"./CFormSelect-DE6tnved.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-BsLkniud.js";import"./CNavItem-8JWznpb2.js";import"./CFormControlWrapper-CeeeRFXe.js";import"./CFormControlValidation-P5rV7dKb.js";const Zt=({editMode:O=!1,initialData:u=null,onSubmit:ke=null})=>{const[rt,st]=n.useState(!1),[V,S]=n.useState(!1),[Se,Ae]=n.useState(!0),[ne,at]=n.useState([]),nt=wt();kt();const{showToast:m}=Ct(),[D,P]=n.useState([]),[A,ot]=n.useState([]),[Ft,oe]=n.useState([]),[g,Y]=n.useState(""),[z,R]=n.useState(!1),[ce,ie]=n.useState([]),[de,le]=n.useState([]),[me,ct]=n.useState([]),[T,X]=n.useState([]),[h,ue]=n.useState([]),he=n.useRef(null),J=n.useRef(null),[v,Ie]=n.useState(!1),[I,Ee]=n.useState(""),[pe,Fe]=n.useState(""),[xe,Le]=n.useState(""),[ge,Pe]=n.useState(""),[E,Te]=n.useState(!1),[M,Me]=n.useState(""),[W,Be]=n.useState(""),[Re,We]=n.useState(""),[Ue,$e]=n.useState(""),[Oe,De]=n.useState(""),[ze,it]=n.useState([]),[q,qe]=n.useState(""),[d,K]=n.useState({projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},invoiceType:3,invoiceDate:new Date().toISOString().split("T")[0],discount:0,paidAmount:0,finalAmount:0,projectCost:0,payed:0,start_date:"",end_date:"",selectedMachines:[],company_id:null}),[Lt,dt]=n.useState([{work_type:"",qty:0,price:0,total_price:0,remark:""}]),[Q,_e]=n.useState(null),[je,Z]=n.useState(""),[lt,ee]=n.useState(!1),[f,G]=n.useState({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),[w,fe]=n.useState([{charge_type:"",amount:"",remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}]),Qe=(t,r,a)=>{const s=[...w];s[t][r]=a,fe(s)},mt=()=>{fe([...w,{charge_type:"",amount:"",remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}])},ut=t=>{fe(w.filter((r,a)=>a!==t))};n.useEffect(()=>{(async()=>{try{const r=await B("/api/workingType");it(r||[])}catch(r){console.error("Error fetching work types",r)}})()},[]);const be=n.useMemo(()=>{const t={};return ze.forEach(r=>{t[r.id]=r.type_of_work}),t},[ze]),te=n.useCallback(async(t="")=>{Ae(!0);try{const r=t?`/api/projects?searchQuery=${encodeURIComponent(t)}`:"/api/projects",a=await B(r),s=Array.isArray(a)?a:a==null?void 0:a.data;if(!s||!Array.isArray(s)){P([]),t||m("warning","No projects data available from server");return}const i=s.map(c=>({id:c.id,project_name:c.project_name||"Unknown Project",customer_name:c.customer_name||"Unknown Customer",work_place:c.work_place||"",project_cost:c.project_cost||"0",mobile_number:c.mobile_number||"",gst_number:c.gst_number||"",remark:c.remark||"",paidamount:c.paidamount||0,customer_id:c.customer_id||c.id,company_id:c.company_id,machine_id:c.machine_id||[],customer:{name:c.customer_name||"Unknown",address:c.work_place||"N/A",mobile:c.mobile_number||"N/A"},start_date:c.start_date,end_date:c.end_date})).filter(c=>c.project_name&&c.customer_id);P(i)}catch(r){console.error("Error fetching projects:",r),P([]),t||m("danger","Failed to fetch projects")}finally{Ae(!1)}},[]);n.useEffect(()=>{var t,r,a,s;O&&u&&(K({projectId:u.projectId,customer_id:u.customer_id,customer_name:((t=u.customer)==null?void 0:t.name)||"",address:((r=u.customer)==null?void 0:r.address)||"",mobile_number:((a=u.customer)==null?void 0:a.mobile)||"",customer:u.customer,invoiceType:u.invoiceType,invoiceDate:u.invoiceDate,discount:u.discount||0,payed:u.paidamount||0,finalAmount:u.finalAmount||0,start_date:u.start_date||"",end_date:u.end_date||""}),dt(u.items||[{work_type:"",qty:0,price:0,total_price:0,remark:""}]),Y(((s=u.customer)==null?void 0:s.name)||""))},[O,u]),n.useEffect(()=>{te()},[te]),n.useEffect(()=>{const t=setTimeout(()=>{g&&g.length>0?te(g):g.length===0&&(P([]),R(!1))},100);return()=>clearTimeout(t)},[g,te]),n.useEffect(()=>{if(g&&D.length>0){const t=g.toLowerCase(),r=D.filter(a=>a.project_name&&a.project_name.toLowerCase().includes(t)||a.customer_name&&a.customer_name.toLowerCase().includes(t)||a.work_place&&a.work_place.toLowerCase().includes(t)||a.mobile_number&&a.mobile_number.includes(t)||a.remark&&a.remark.toLowerCase().includes(t));console.log("Filtered projects:",r,"Query:",g),ie(r)}else ie([])},[g,D]);const ht=async()=>{try{const t=await B("/api/machineLog");le(t||[])}catch(t){m("danger","Error fetching machine logs: "+t)}},pt=()=>{B("/api/operatorsByCompanyIdOperator").then(t=>{at(t||[]),S(!1)}).catch(t=>{console.log(t.message),S(!1)})};n.useEffect(()=>{ht(),pt()},[]),n.useEffect(()=>{const t=r=>{he.current&&!he.current.contains(r.target)&&J.current&&!J.current.contains(r.target)&&R(!1)};return z&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[z]);const xt=async()=>{try{const t=await B("/api/machine-operators");ot(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}},gt=async()=>{try{const t=await B("/api/machine-price");ct(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}};n.useEffect(()=>{xt(),gt()},[]);const ye=n.useCallback(t=>{if(!t||!t.machine_id||!Array.isArray(t.machine_id)||A.length===0){oe([]);return}const r=A.filter(a=>t.machine_id.includes(String(a.id)));oe(r)},[A]);n.useEffect(()=>{if(A.length>0&&d.projectId){const t=D.find(r=>r.id===d.projectId);t&&ye(t)}},[A,d.projectId,D,ye]),n.useEffect(()=>{if(!d.projectId)return;const t=setTimeout(async()=>{try{const r=Number(d.payed)||0;await ae(`/api/projects/${d.projectId}/paidamount`,{paidamount:r})}catch(r){console.error("Failed updating project paidamount:",r)}},500);return()=>clearTimeout(t)},[d.projectId,d.payed]),n.useEffect(()=>{if(!d.projectId||de.length===0){X([]);return}const r=de.filter(a=>String(a.project_id)===String(d.projectId)).filter(a=>a.isPaid==0);X(r)},[de,d.projectId]);const re=n.useCallback(t=>{if(!t||A.length===0)return"N/A";const r=A.find(a=>String(a.id)===String(t));return(r==null?void 0:r.machine_name)||"N/A"},[A]),Ge=t=>{const r=parseFloat(t.project_cost)||0,a=parseFloat(d.discount)||0,s=Math.max(0,r-a);K(i=>({...i,projectId:t.id,payed:t.paidamount,customer_id:t.customer_id,customer_name:t.customer_name,address:t.work_place,mobile_number:t.mobile_number,start_date:t.start_date,end_date:t.end_date,projectCost:r,finalAmount:s,company_id:t.company_id,customer:{name:t.customer_name,address:t.customer.address,mobile:t.customer.mobile},selectedMachines:[]})),R(!1),Y(t.customer_name),P([]),ye(t)},C=n.useMemo(()=>{if(!q.trim())return T;const t=q.toLowerCase();return T.filter(r=>{var y,k,b;const a=((y=be[r.work_type_id])==null?void 0:y.toLowerCase())||"",s=ne.find(F=>F.id==r.operator_id),i=((k=s==null?void 0:s.name)==null?void 0:k.toLowerCase())||"",c=re(r.machine_id).toLowerCase(),o=me.find(F=>F.id===Number(r.mode_id)),l=((b=o==null?void 0:o.mode)==null?void 0:b.toLowerCase())||"",p=String(r.work_date).slice(0,10);return a.includes(t)||i.includes(t)||c.includes(t)||l.includes(t)||p.includes(t)})},[T,q,be,ne,re,me]),_t=()=>{K(t=>({...t,projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},projectCost:0,payed:0,finalAmount:0,selectedMachines:[]})),Y(""),R(!1),P([]),oe([])},He=()=>{R(!1),G(t=>({...t,customer_name:g||""})),ee(!0)},se=t=>{const{name:r,value:a}=t.target;if(r==="mobile_number"){const s=a.replace(/\D/g,"");if(s.length>10)return;G(i=>({...i,mobile_number:s}));return}if(r==="gst_number"){if(a.length>15)return;G(s=>({...s,gst_number:a}));return}G(s=>({...s,[r]:a}))},Ve=async t=>{if(t.preventDefault(),!f.customer_name.trim()){m("danger","Customer name is required");return}if(!f.mobile_number||!/^[6-9]\d{9}$/.test(f.mobile_number)){m("danger","Please enter a valid 10-digit mobile number");return}try{S(!0);const r={customer_name:f.customer_name,mobile_number:f.mobile_number,gst_number:f.gst_number||"",work_place:f.work_place||"",project_name:"",project_cost:"",supervisor_id:"",commission:"",start_date:"",end_date:"",is_visible:!0,remark:"",operator_id:[""],machine_id:[]};await $("/api/projects",r);let a=null;try{const s=await B(`/api/projects?searchQuery=${encodeURIComponent(f.customer_name)}`),i=Array.isArray(s)?s:s==null?void 0:s.data;if(i&&Array.isArray(i)){const c=i.map(o=>({id:o.id,project_name:o.project_name||"Unknown Project",customer_name:o.customer_name||"Unknown Customer",work_place:o.work_place||"",project_cost:o.project_cost||"0",mobile_number:o.mobile_number||"",gst_number:o.gst_number||"",remark:o.remark||"",paidamount:o.paidamount||0,customer_id:o.customer_id||o.id,company_id:o.company_id,machine_id:o.machine_id||[],customer:{name:o.customer_name||"Unknown",address:o.work_place||"N/A",mobile:o.mobile_number||"N/A"},start_date:o.start_date,end_date:o.end_date})).filter(o=>o.project_name&&o.customer_id);a=c.find(o=>o.customer_name.toLowerCase()===f.customer_name.toLowerCase()&&o.mobile_number===f.mobile_number)||c[0]||null}}catch(s){console.error("Error fetching newly created customer project:",s)}a?(Ge(a),m("success","Customer added and selected successfully")):m("success","Customer added successfully, please search to select"),ee(!1),G({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),P([]),ie([])}catch(r){console.error("Error adding customer from invoice:",r),m("danger","Failed to add customer")}finally{S(!1)}},jt=t=>{const{name:r,value:a}=t.target,s=r==="discount"||r==="paidAmount"?parseFloat(a)||0:a;K(i=>{const c={...i,[r]:s};if(r==="discount"){const o=parseFloat(i.projectCost)||0,l=parseFloat(s)||0;c.finalAmount=Math.max(0,o-l)}return c})},ft=t=>{_e(t.id),Z(String(t.price_per_hour??0))},bt=()=>{_e(null),Z("")},yt=async t=>{const r=Number(je);if(isNaN(r)||r<0){m("danger","Enter a valid price");return}try{const a=await ae(`/api/machine-logs/${t.id}/price`,{price_per_hour:r});if(a&&a.error){m("danger","Failed to update price");return}X(s=>s.map(i=>String(i.id)===String(Q)?{...i,price_per_hour:r}:i)),typeof le=="function"&&le(s=>Array.isArray(s)?s.map(i=>String(i.id)===String(Q)?{...i,price_per_hour:r}:i):s),_e(null),Z(""),m("success","Price updated successfully")}catch(a){console.error("Error updating log price:",a),m("danger","Error updating price")}},Nt=t=>{ue(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},vt=async t=>{if(t.preventDefault(),!t.currentTarget.checkValidity()){st(!0);return}if(!d.projectId||!d.customer_id){m("danger","Please select a customer");return}const a=w.filter(s=>s.charge_type&&Number(s.amount)>0).map(s=>({charge_type:s.charge_type,amount:Number(s.amount),remark:s.remark||null,is_paid:s.is_paid??!1,date:s.date}));try{if(S(!0),d.projectId){const l=Number(d.payed)||0;try{await ae(`/api/projects/${d.projectId}/paidamount`,{paidamount:l})}catch(p){console.error("Failed to update project paidamount on submit:",p)}}const s=T.filter(l=>h.includes(l.id));console.log("Selected Rows:",s);const i=s.length>0?s[0].company_id:d.company_id;if(s.length===0&&!(v&&Number(I)>0)&&!(E&&Number(M)>0)){m("warning","Select logs, enable Advance Payment, or enable Fixed Bid Work"),S(!1);return}const c=s.reduce((l,p)=>{const y=Number(p.machine_start??p.start_reading??0)||0,k=Number(p.machine_end??p.end_reading??0)||0,b=p.actual_machine_hr!=null&&!isNaN(Number(p.actual_machine_hr))?Number(p.actual_machine_hr):Math.max(0,k-y),F=Number(p.price_per_hour)||0;return l+b*F},0);let o=null;if(s.length>0){console.log("ðŸ”„ Updating isPaid=1 for logs:",h);const l=h.map(L=>ae(`/api/machine-logs/${L}/isPaid`,{isPaid:1}));await Promise.all(l),console.log("âœ… ALL selected logs updated to isPaid = 1"),X(L=>L.map(Ne=>h.includes(Ne.id)?{...Ne,isPaid:1}:Ne)),ue([]);let p=0,y=null,k=null,b=null;v&&Number(I)>0&&(p=Number(I),y=pe,k=xe,b=ge);const F={project_id:d.projectId,company_id:i,total:c,paid_amount:p,worklog_ids:h,payment_mode:y,transaction_id:k,remark:b};if(O&&ke)await ke(F),m("success",`${s.length} logs marked as paid`);else{const L=await $("/api/project-payments",F);L&&L.id&&(o=L.id,a.length>0&&await $("/api/invoice-additional-charges/bulk",{invoice_id:String(L.invoice_number),company_id:i,charges:a}),m("success",`Invoice created! ${s.length} logs marked as PAID âœ…`))}}if(s.length===0&&v&&Number(I)>0){const l=await $("/api/project-payments",{company_id:i,project_id:d.projectId,total:Number(I),paid_amount:Number(I),is_advance:!0,transaction_id:xe||null,mode:pe||null,remark:ge||null});l&&l.id&&(m("success","Advance payment invoice created"),o||(o=l.id))}if(E&&Number(M)>0){if(Number(W)>Number(M)){m("danger","Advance amount cannot be greater than Total amount"),S(!1);return}const l=await $("/api/project-payments",{company_id:i,project_id:d.projectId,total:Number(M),paid_amount:Number(W)||0,is_fixed_bid:!0,transaction_id:Number(W)>0?Ue:null,mode:Number(W)>0?Re:"Fixed Bid",remark:Oe||null,date:d.invoiceDate});l&&l.id&&(o||(o=l.id),a.length>0&&await $("/api/invoice-additional-charges/bulk",{invoice_id:String(l.id),company_id:i,charges:a}),m("success","Fixed Bid Work invoice created"))}o&&setTimeout(()=>{nt(`/payment-page/${o}`)},1e3)}catch(s){console.error("Submit error:",s),m("danger","Failed to create invoice")}finally{S(!1)}};return e.jsx(U,{children:e.jsx(_,{xs:12,children:e.jsxs(Xe,{className:"mb-4",children:[e.jsx(Je,{children:e.jsx("strong",{children:O?"Edit Invoice":"Create Invoice"})}),e.jsxs(ve,{children:[e.jsxs(Ke,{validated:rt,onSubmit:vt,children:[e.jsxs(U,{className:"mb-3",children:[e.jsxs(_,{md:6,children:[e.jsxs(x,{children:["Customer Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("div",{ref:he,style:{position:"relative"},children:[e.jsxs(Ze,{children:[e.jsx(j,{type:"text",value:g,onChange:t=>{Y(t.target.value),R(!0)},placeholder:"Search by customer name, location, mobile...",required:!0}),e.jsx(et,{children:e.jsx(H,{icon:tt})}),g&&e.jsx(N,{color:"link",onClick:_t,className:"position-absolute end-0 me-5",children:e.jsx(H,{icon:we})})]}),Se&&z&&g.length>0&&e.jsxs("div",{className:"dropdown-menu show p-2",children:[e.jsx(Ye,{size:"sm"})," Loading customers..."]}),z&&ce.length>0&&e.jsxs("div",{ref:J,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:[ce.map(t=>e.jsxs("div",{className:"dropdown-item cursor-pointer p-2 border-bottom",onClick:()=>Ge(t),onMouseEnter:r=>r.target.style.backgroundColor="#f8f9fa",onMouseLeave:r=>r.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium text-primary",children:t.customer_name}),t.work_place&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",t.work_place]}),t.mobile_number&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Mobile:"})," ",t.mobile_number]})]},t.id)),e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:He,children:['Add customer "',g,'"']})})]}),g.length>0&&ce.length===0&&z&&e.jsx("div",{ref:J,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:He,children:['Add customer "',g,'"']})})})]}),d.customer_name&&e.jsxs("div",{className:"mt-1 p-2 bg-light rounded border",children:[e.jsxs("div",{className:"small text-success",children:[e.jsx("strong",{children:"Selected:"})," ",d.customer_name]}),d.customer.address&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",d.customer.address]})]})]}),e.jsxs(_,{md:6,children:[e.jsxs(x,{children:["Invoice Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(j,{type:"date",name:"invoiceDate",value:d.invoiceDate,onChange:jt,required:!0})]})]}),T.length>0&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"fw-semibold mb-0",children:["Project Logs (Total: ",T.length,") |",e.jsxs("span",{className:"text-primary ms-2",children:["Showing: ",C.length]})," |",e.jsxs("span",{className:"text-success ms-2",children:["Selected: ",h.length]})]}),e.jsx("div",{style:{width:"300px"},children:e.jsxs(Ze,{size:"sm",children:[e.jsx(et,{children:e.jsx(H,{icon:tt})}),e.jsx(j,{type:"text",placeholder:"Search by operator, work type, machine, mode...",value:q,onChange:t=>qe(t.target.value)}),q&&e.jsx(N,{color:"secondary",variant:"outline",onClick:()=>qe(""),children:e.jsx(H,{icon:we})})]})})]}),e.jsx("div",{className:"table-container",style:{width:"100%",overflowX:"auto",overflowY:"auto",border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff",WebkitOverflowScrolling:"touch"},children:e.jsxs("table",{className:"table table-bordered align-middle",style:{minWidth:"1200px",width:"100%",tableLayout:"fixed",margin:0},children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:C.length>0&&C.every(t=>h.includes(t.id)),onChange:t=>{const r=t.target.checked;ue(r?[...new Set([...h,...C.map(a=>a.id)])]:h.filter(a=>!C.map(s=>s.id).includes(a)))}})}),e.jsx("th",{style:{width:"90px",minWidth:"90px"},className:"text-center align-middle",children:"Date"}),e.jsx("th",{style:{width:"110px",minWidth:"100px"},className:"text-center align-middle",children:"Machine"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Operator"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Work Type"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Start"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"End"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Net"}),e.jsx("th",{style:{width:"70px"},className:"text-center align-middle",children:"Mode"}),e.jsx("th",{style:{width:"90px"},className:"text-center align-middle",children:"Price/Hr"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Total"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Action"})]})}),e.jsxs("tbody",{children:[C.map((t,r)=>{const a=Number(t.machine_start??t.start_reading??0)||0,s=Number(t.machine_end??t.end_reading??0)||0,i=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,s-a),c=String(t.work_date).slice(0,10).split("-").reverse().join("-"),o=ne.find(b=>b.id==t.operator_id)||{name:"N/A"},l=String(t.id)===String(Q)?Number(je||0):Number(t.price_per_hour||0),p=i*l,y=me.find(b=>b.id===Number(t.mode_id)),k=y?y.mode:"N/A";return e.jsxs("tr",{children:[e.jsx("td",{className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:h.includes(t.id),onChange:()=>Nt(t.id)})}),e.jsx("td",{className:"text-center small",children:c||"N/A"}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"110px"},title:re(t.machine_id),children:re(t.machine_id)}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"100px"},title:o.name,children:o.name}),e.jsx("td",{children:be[t.work_type_id]||"-"}),e.jsx("td",{className:"text-center",children:a}),e.jsx("td",{className:"text-center",children:s}),e.jsx("td",{className:"text-center",children:i}),e.jsx("td",{className:"text-center small",children:k}),e.jsx("td",{children:String(t.id)===String(Q)?e.jsx("input",{type:"number",value:je,min:0,step:"0.01",onChange:b=>Z(b.target.value),style:{width:"70px",fontSize:"0.875rem"},className:"form-control form-control-sm"}):e.jsxs("div",{className:"text-center small",children:["â‚¹",l]})}),e.jsxs("td",{className:"text-center small",children:["â‚¹",p.toFixed(2)]}),e.jsx("td",{className:"text-center",children:String(t.id)===String(Q)?e.jsxs(e.Fragment,{children:[e.jsx(N,{size:"sm",color:"success",className:"me-1",onClick:()=>yt(t),children:"Save"}),e.jsx(N,{size:"sm",color:"secondary",variant:"outline",onClick:bt,children:"Cancel"})]}):e.jsx(N,{size:"sm",color:"info",className:"text-white",onClick:()=>ft(t),children:"Edit"})})]},r)}),h.length>0&&(()=>{const t=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i);return a+o},0),r=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i),l=Number(s.price_per_hour)||0;return a+o*l},0);return e.jsxs("tr",{className:"fw-bold table-success",children:[e.jsx("td",{className:"text-center align-middle",children:h.length}),e.jsx("td",{colSpan:"6",className:"text-end pe-3",children:"Grand Total:"}),e.jsx("td",{className:"text-center",children:t.toFixed(2)}),e.jsx("td",{}),e.jsxs("td",{className:"text-end pe-3",children:["â‚¹",r.toFixed(2)]}),e.jsx("td",{})]})})()]})]})})]}),T.length>0&&e.jsxs(Xe,{className:"mb-4 border-0 shadow-sm",children:[e.jsx(Je,{style:{background:"#f3f4f6"},children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges"})}),e.jsx(ve,{children:w.map((t,r)=>e.jsxs(U,{className:"align-items-end mb-3",children:[e.jsxs(_,{md:3,children:[e.jsx(x,{children:"Charge Type"}),e.jsxs(Ce,{value:t.charge_type,onChange:a=>Qe(r,"charge_type",a.target.value),children:[e.jsx("option",{value:"",children:"Select charge type"}),e.jsx("option",{value:"service_charge",children:"Service Charge"}),e.jsx("option",{value:"travelling_charge",children:"Travelling Charge"}),e.jsx("option",{value:"other_charge",children:"Other Charge"})]})]}),e.jsxs(_,{md:2,children:[e.jsx(x,{children:"Amount"}),e.jsx(j,{type:"number",placeholder:"0",value:t.amount,onChange:a=>Qe(r,"amount",a.target.value)})]}),e.jsxs(_,{children:[" ",e.jsx(N,{size:"sm",color:"primary",variant:"outline",onClick:mt,children:"+ Add Additional Charge"})]}),e.jsx(_,{md:1,children:w.length>1&&e.jsx(N,{color:"danger",variant:"ghost",onClick:()=>ut(r),children:e.jsx(H,{icon:we})})})]},r))}),w.some(t=>t.charge_type&&t.amount)&&e.jsx(ve,{className:"border-top bg-light",children:e.jsxs(U,{className:"align-items-center",children:[e.jsx(_,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges:"})}),e.jsx(_,{md:3,children:e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",w.filter(t=>t.charge_type&&t.amount).reduce((t,r)=>t+(parseFloat(r.amount)||0),0).toFixed(2)]})})]})})]}),h.length>0&&e.jsxs(U,{className:"align-items-center mt-3 pt-3 border-top",children:[e.jsx(_,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold text-success",children:"Actual Payable(Logs + Additional Charges):"})}),e.jsx(_,{md:3,children:e.jsxs("h4",{className:"mb-0 fw-bold text-success",children:["â‚¹",(()=>{const t=C.filter(a=>h.includes(a.id)).reduce((a,s)=>{const i=Number(s.machine_start??s.start_reading??0)||0,c=Number(s.machine_end??s.end_reading??0)||0,o=s.actual_machine_hr!=null&&!isNaN(Number(s.actual_machine_hr))?Number(s.actual_machine_hr):Math.max(0,c-i),l=Number(s.price_per_hour)||0;return a+o*l},0),r=w.filter(a=>a.charge_type&&a.amount).reduce((a,s)=>a+(parseFloat(s.amount)||0),0);return(t+r).toFixed(2)})()]})})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${v?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${v?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"advanceSwitch",checked:v,disabled:E,onChange:t=>{const r=t.target.checked;Ie(r),r&&(Te(!1),Me(""),Be(""),We(""),$e(""),De(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"advanceSwitch",children:"Advance Payment"})]}),v&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(x,{children:["Advance Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(j,{type:"number",min:"0",placeholder:"Enter amount",value:I,onChange:t=>Ee(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Transaction ID"}),e.jsx(j,{type:"text",placeholder:"Enter transaction ID",value:xe,onChange:t=>Le(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Mode"}),e.jsxs(Ce,{value:pe,onChange:t=>Fe(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Remark"}),e.jsx(j,{type:"text",placeholder:"Enter remark",value:ge,onChange:t=>Pe(t.target.value)})]})]})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${E?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${E?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"fixedBidSwitch",checked:E,disabled:v,onChange:t=>{const r=t.target.checked;Te(r),r&&(Ie(!1),Ee(""),Fe(""),Le(""),Pe(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"fixedBidSwitch",children:"Fixed Bid Work"})]}),E&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(x,{children:["Total Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(j,{type:"number",min:"0",placeholder:"Enter total amount",value:M,onChange:t=>Me(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Advance Amount"}),e.jsx(j,{type:"number",min:"0",placeholder:"Enter paid amount",value:W,onChange:t=>{const r=parseFloat(t.target.value)||0,a=parseFloat(M)||0;if(r>a){m("danger","Paid amount cannot be greater than Total amount");return}Be(t.target.value)}})]}),Number(W)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Transaction ID"}),e.jsx(j,{type:"text",placeholder:"Enter transaction ID",value:Ue,onChange:t=>$e(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(x,{children:"Mode"}),e.jsxs(Ce,{value:Re,onChange:t=>We(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx(x,{children:"Description"}),e.jsx(j,{type:"text",placeholder:"Enter description",value:Oe,onChange:t=>De(t.target.value)})]})]})]}),e.jsx(N,{color:"primary",type:"submit",disabled:V||!d.projectId||!d.customer_id||Se||h.length===0&&!(v&&Number(I)>0)&&!(E&&Number(M)>0),children:V?e.jsx(Ye,{size:"sm"}):O?"Update Invoice":"Submit Invoice"})]}),e.jsxs(St,{visible:lt,onClose:()=>ee(!1),children:[e.jsx(At,{closeButton:!0,children:"Add New Customer"}),e.jsx(It,{children:e.jsx(Ke,{onSubmit:Ve,children:e.jsxs(U,{className:"g-3",children:[e.jsxs(_,{md:12,children:[e.jsx(x,{children:"Customer Name"}),e.jsx(j,{type:"text",name:"customer_name",value:f.customer_name,onChange:se,placeholder:"Enter Customer Name...",required:!0})]}),e.jsxs(_,{md:12,children:[e.jsx(x,{children:"Mobile Number"}),e.jsx(j,{type:"text",name:"mobile_number",value:f.mobile_number,onChange:se,placeholder:"Enter Customer Mobile...",maxLength:10,required:!0})]}),e.jsxs(_,{md:12,children:[e.jsx(x,{children:"GST Number (Optional)"}),e.jsx(j,{type:"text",name:"gst_number",value:f.gst_number,onChange:se,placeholder:"Enter GST number...",maxLength:15})]}),e.jsxs(_,{md:12,children:[e.jsx(x,{children:"Location"}),e.jsx(j,{type:"text",name:"work_place",value:f.work_place,onChange:se,placeholder:"Enter Location..."})]})]})})}),e.jsxs(Et,{children:[e.jsx(N,{color:"secondary",variant:"outline",onClick:()=>ee(!1),children:"Cancel"}),e.jsx(N,{color:"primary",onClick:Ve,disabled:V,children:V?"Saving...":"Save Customer"})]})]})]})]})})})};export{Zt as default};

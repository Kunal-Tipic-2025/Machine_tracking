import{r as d,u as Z,b as J,j as r,C as K}from"./index-BTeA492D.js";import{a as N,b as C,d as Q}from"./api-BUyL__Lx.js";import{C as W,a as X}from"./CCardBody-BDPTx9XL.js";import{C as Y}from"./CCardHeader-7X8EpRUb.js";import{d as h,a as u,b as c}from"./index.esm-UVM2W3HN.js";import{C as ee}from"./RawMaterial-DvMRSoFa.js";import{C as re,a as se,b as T,c as l,d as ae,e as m}from"./CTable-Dlaw-9GH.js";import{a as te,b as ie,c as ne,d as oe}from"./DefaultLayout-1THlq5Yf.js";import{C as de}from"./CForm-DLTIQo7N.js";import{C as j}from"./CFormInput-C-f2xD8x.js";import{C as O}from"./CFormSelect-B_ay71cr.js";import"./cil-user-Dlmw-Gem.js";import"./CNavItem-Dms8XRKU.js";import"./CFormControlWrapper-B0MocaRk.js";import"./CFormControlValidation-CspEyxkQ.js";import"./CFormLabel-N-ZSSVsb.js";const Ne=()=>{const[b,F]=d.useState([]),[q,w]=d.useState([]),[x,R]=d.useState([]),[M,E]=d.useState(!0),[S,k]=d.useState(""),[I,y]=d.useState(!1),[s,f]=d.useState(null),[_,le]=d.useState(""),[p,$]=d.useState([]),B=Z(),{showToast:t}=J();d.useEffect(()=>{v(),P(),A()},[]),d.useEffect(()=>{w(_===""?b:b.filter(e=>e.type===_))},[b,_]);const v=()=>{N("/api/operatorsByCompanyIdOperator").then(e=>{F(e||[]),E(!1)}).catch(e=>{k(e.message),E(!1)})},P=()=>{N("/api/myProjects").then(e=>{console.log("All my projets"),console.log(e),R(e||[])}).catch(e=>console.error("Failed to load projects:",e))},A=async()=>{try{const e=await N("/api/machine-operators");$(e||[])}catch(e){console.error("Error fetching machineries:",e),t("danger","Error fetching machineries")}},U=e=>{switch(e){case"0":return"Supervisor";case"1":return"Operator";case"2":return"Vendor";default:return"Unknown"}},z=e=>{f({...e,project_id:e.project_id||"",gst_no:e.gst_no||""}),y(!0)},g=e=>{const{name:a,value:i}=e.target;f(n=>({...n,[a]:i}))},L=async e=>{try{const a=p.find(n=>n.id===parseInt(e));if(!a)return;const i=Array.isArray(a.operator_id)?a.operator_id.filter(n=>String(n)!==String(s.id)):[];await C(`/api/machine-operators/${e}`,{operator_id:i}),A(),t("success","Machine removed successfully")}catch(a){console.error("Error removing machine:",a),t("danger","Failed to remove machine")}},H=async()=>{try{if(!s.name.trim()){t("danger","Name is required");return}if(!s.mobile||s.mobile.length!==10){t("danger","Mobile number must be 10 digits");return}if(!s.address.trim()){t("danger","Address is required");return}if(s.type==="0"&&!s.project_id){t("danger","Project is required for Supervisor");return}if((s.type==="0"||s.type==="1")&&!s.payment){t("danger","Payment is required for Supervisor and Operator");return}if(s.type==="2"&&!s.gst_no.trim()){t("danger","GST Number is required for Vendor");return}const e={...s,project_id:s.project_id?String(s.project_id):"",payment:s.type==="2"?"0":s.payment};await C(`/api/operators/${s.id}`,e),y(!1),t("success","User updated successfully."),v()}catch(e){console.error("Error updating user:",e),t("danger","Failed to update user!")}},D=async e=>{try{if(!s)return;const a=Array.isArray(e.operator_id)?e.operator_id.map(String):[],i=String(s.id),n=a.includes(i)?a.filter(o=>o!==i):[...a,i];await C(`/api/projects/${e.id}`,{operator_id:n}),P(),t("success","Project assignment updated")}catch(a){console.error("Error updating project assignment:",a),t("danger","Failed to update project assignment")}},G=async e=>{try{if(!window.confirm("Are you sure you want to delete this operator?"))return;await Q(`/api/operators/${e.id}`),t("success","User deleted successfully."),v()}catch(a){console.error("Error deleting user:",a),t("danger","Failed to delete user!")}},V=async e=>{if(e)try{const a=p.find(n=>n.id===parseInt(e));if(!a)return;const i=Array.isArray(a.operator_id)?[...new Set([...a.operator_id.map(String),String(s.id)])]:[String(s.id)];await C(`/api/machine-operators/${e}`,{operator_id:i}),A(),t("success","Machine allocated successfully")}catch(a){console.error("Error adding machine:",a),t("danger","Failed to allocate machine")}};return r.jsxs(W,{className:"mb-4",children:[r.jsxs(Y,{className:"d-flex justify-content-between align-items-center",children:[r.jsx("strong",{children:"Operators List"}),r.jsx("div",{className:"d-flex gap-2 align-items-center",children:r.jsx(h,{color:"danger",onClick:()=>B("/oprator"),children:"Add User"})})]}),r.jsxs(X,{children:[M&&r.jsx(K,{color:"primary"}),S&&r.jsx(ee,{color:"danger",children:S}),!M&&!S&&r.jsxs(re,{striped:!0,hover:!0,responsive:!0,children:[r.jsx(se,{children:r.jsxs(T,{children:[r.jsx(l,{children:"SR. NO."}),r.jsx(l,{children:"Name"}),r.jsx(l,{children:"Mobile"}),r.jsx(l,{children:"Address"}),r.jsx(l,{children:"Role"}),r.jsx(l,{children:"Payment/GST"}),r.jsx(l,{children:"Commission"}),r.jsx(l,{children:"Project"}),r.jsx(l,{children:"Machines"}),r.jsx(l,{children:"Action"})]})}),r.jsx(ae,{children:q.map((e,a)=>{const i=p.filter(o=>Array.isArray(o.operator_id)&&o.operator_id.map(String).includes(String(e.id))),n=x.filter(o=>Array.isArray(o.operator_id)&&o.operator_id.map(String).includes(String(e.id)));return r.jsxs(T,{children:[r.jsx(l,{children:a+1}),r.jsx(m,{children:e.name}),r.jsx(m,{children:e.mobile}),r.jsx(m,{children:e.address}),r.jsx(m,{children:U(e.type)}),r.jsx(m,{children:e.type==="2"?e.gst_no||"-":e.payment||"-"}),r.jsx(m,{children:(e==null?void 0:e.commission)||"0"}),r.jsx(m,{children:n.length>0?n.map(o=>o.project_name).join(", "):"-"}),r.jsx(m,{children:i.length>0?i.map(o=>o.machine_name).join(", "):"-"}),r.jsxs(m,{children:[r.jsx(h,{color:"info",size:"sm",onClick:()=>z(e),children:"Edit"}),r.jsx(h,{color:"danger",size:"sm",onClick:()=>G(e),children:"Delete"})]})]},e.id)})})]})]}),r.jsxs(te,{visible:I,onClose:()=>y(!1),size:"lg",children:[r.jsx(ie,{closeButton:!0,children:"Edit User"}),r.jsx(ne,{children:s&&r.jsxs(de,{children:[r.jsxs(u,{className:"mb-3",children:[r.jsx(c,{md:6,children:r.jsx(j,{label:"Name *",name:"name",value:s.name,onChange:g,required:!0})}),r.jsx(c,{md:6,children:r.jsx(j,{label:"Mobile *",name:"mobile",maxLength:10,value:s.mobile,onChange:e=>{const a=e.target.value;/^\d*$/.test(a)&&a.length<=10&&f(i=>({...i,mobile:a}))},required:!0})})]}),r.jsx(u,{className:"mb-3",children:r.jsx(c,{md:12,children:r.jsx(j,{label:"Address *",name:"address",value:s.address,onChange:g,required:!0})})}),(s.type==="0"||s.type==="1")&&r.jsxs(u,{className:"mb-3",children:[r.jsx(c,{md:6,children:r.jsx(j,{label:"Payment *",name:"payment",type:"number",value:s.payment,onChange:g,required:!0})}),r.jsx(c,{md:6,children:r.jsx(j,{label:"Commission",name:"commission",type:"number",value:s.commission||"0",onChange:g})})]}),s.type==="2"&&r.jsx(u,{className:"mb-3",children:r.jsx(c,{md:6,children:r.jsx(j,{label:"GST Number *",name:"gst_no",maxLength:15,value:s.gst_no,onChange:e=>{const a=e.target.value.toUpperCase();/^[0-9A-Z]*$/.test(a)&&f(i=>({...i,gst_no:a}))},required:!0})})}),s.type==="0"&&r.jsx(u,{className:"mb-3",children:r.jsx(c,{md:6,children:r.jsxs(O,{label:"Project *",name:"project_id",value:s.project_id,onChange:g,required:!0,children:[r.jsx("option",{value:"",children:"Select Project"}),x.map(e=>r.jsx("option",{value:e.id,children:e.project_name},e.id))]})})}),r.jsx(u,{className:"mb-3",children:r.jsxs(c,{md:12,children:[r.jsx("label",{className:"form-label",children:r.jsx("strong",{children:"Assigned Projects"})}),r.jsx("div",{className:"p-2 border rounded bg-light mb-2",children:x.filter(e=>Array.isArray(e.operator_id)&&e.operator_id.map(String).includes(String(s.id))).length>0?x.filter(e=>Array.isArray(e.operator_id)&&e.operator_id.map(String).includes(String(s.id))).map(e=>{const a=Array.isArray(e.operator_id)&&e.operator_id.map(String).includes(String(s.id));return r.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-1",children:[r.jsxs("span",{children:["• ",e.project_name]}),r.jsx("div",{className:"d-flex gap-2",children:r.jsx(h,{color:a?"danger":"success",size:"sm",variant:"outline",onClick:()=>D(e),children:a?"Remove":"Add"})})]},e.id)}):r.jsx("div",{children:"No projects assigned"})})]})}),r.jsx(u,{className:"mb-3",children:r.jsxs(c,{md:12,children:[r.jsx("label",{className:"form-label",children:r.jsx("strong",{children:"Allocated Machines"})}),r.jsx("div",{className:"p-2 border rounded bg-light mb-2",children:p.filter(e=>Array.isArray(e.operator_id)&&e.operator_id.map(String).includes(String(s.id))).length>0?p.filter(e=>Array.isArray(e.operator_id)&&e.operator_id.map(String).includes(String(s.id))).map(e=>r.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-1",children:[r.jsxs("span",{children:["• ",e.machine_name]}),r.jsx(h,{color:"danger",size:"sm",onClick:()=>L(e.id),children:"Remove"})]},e.id)):r.jsx("div",{children:"No machines allocated"})}),r.jsxs(O,{label:"Add Machine",value:"",onChange:e=>V(e.target.value),children:[r.jsx("option",{value:"",children:"-- Select Machine --"}),p.map(e=>r.jsx("option",{value:e.id,children:e.machine_name},e.id))]})]})})]})}),r.jsxs(oe,{children:[r.jsx(h,{color:"secondary",onClick:()=>y(!1),children:"Close"}),r.jsx(h,{color:"primary",onClick:H,children:"Save Changes"})]})]})]})};export{Ne as default};

import{r as n,u as Bt,b as Rt,j as e,C as et}from"./index-BTeA492D.js";/* empty css                */import{a as W,b as f,c as Y,d as w}from"./index.esm-UVM2W3HN.js";import{a as T,b as ce,p as $}from"./api-BUyL__Lx.js";import{C as Dt}from"./ChargeTypeModal-saJI5du2.js";import{u as Wt,a as $t,b as Ut,c as Ot,d as zt}from"./DefaultLayout-1THlq5Yf.js";import{C as tt,a as ke}from"./CCardBody-BDPTx9XL.js";import{C as at}from"./CCardHeader-7X8EpRUb.js";import{C as rt}from"./CForm-DLTIQo7N.js";import{C as g}from"./CFormLabel-N-ZSSVsb.js";import{C as st}from"./CInputGroup-CO3LbqLS.js";import{C as x}from"./CFormInput-C-f2xD8x.js";import{C as nt}from"./CInputGroupText-DcS059QV.js";import{c as ot}from"./cil-search-CDkY_4k-.js";import{c as Se}from"./cil-x-0440B5Ce.js";import{C as ct}from"./CFormSelect-B_ay71cr.js";import"./CFormCheck-ivdAOR5w.js";import"./CFormControlValidation-CspEyxkQ.js";import"./cil-user-Dlmw-Gem.js";import"./RawMaterial-DvMRSoFa.js";import"./CNavItem-Dms8XRKU.js";import"./CFormControlWrapper-B0MocaRk.js";const ga=({editMode:U=!1,initialData:u=null,onSubmit:Ae=null})=>{const[it,dt]=n.useState(!1),[X,S]=n.useState(!1),[Ie,Ee]=n.useState(!0),[ie,lt]=n.useState([]),mt=Bt();Wt();const{showToast:m}=Rt(),[O,P]=n.useState([]),[A,ut]=n.useState([]),[Qt,de]=n.useState([]),[_,J]=n.useState(""),[z,R]=n.useState(!1),[le,me]=n.useState([]),[ue,he]=n.useState([]),[pe,ht]=n.useState([]),[M,K]=n.useState([]),[h,ge]=n.useState([]),_e=n.useRef(null),Z=n.useRef(null),[C,Le]=n.useState(!1),[I,Fe]=n.useState(""),[xe,Te]=n.useState(""),[fe,Pe]=n.useState(""),[je,Me]=n.useState(""),[E,Be]=n.useState(!1),[B,Re]=n.useState(""),[D,De]=n.useState(""),[We,$e]=n.useState(""),[Ue,Oe]=n.useState(""),[ze,Qe]=n.useState(""),[qe,pt]=n.useState([]),[Q,He]=n.useState(""),[d,ee]=n.useState({projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},invoiceType:3,invoiceDate:new Date().toISOString().split("T")[0],discount:0,paidAmount:0,finalAmount:0,projectCost:0,payed:0,start_date:"",end_date:"",selectedMachines:[],company_id:null}),[qt,gt]=n.useState([{work_type:"",qty:0,price:0,total_price:0,remark:""}]),[q,be]=n.useState(null),[ye,te]=n.useState(""),[_t,ae]=n.useState(!1),[j,H]=n.useState({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),[V,xt]=n.useState([]),[Ht,ft]=n.useState({}),[jt,G]=n.useState({}),[bt,Ve]=n.useState(!1),[Ge,yt]=n.useState(null),[Ye,Nt]=n.useState({name:"",local_name:"",amount_deduct:!1}),[y,Ne]=n.useState([{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}]),Xe=async()=>{try{const t=await T("/api/charge-types");Array.isArray(t)&&xt(t)}catch(t){console.error("Error fetching charge types:",t)}};n.useEffect(()=>{Xe()},[]);const re=(t,s,a)=>{const r=[...y];if(s==="charge_type"){const o=V.find(c=>String(c.name)===String(a)||String(c.id)===String(a));r[t].charge_type=a,o?(r[t].charge_type_id=o.id,r[t].amount_deduct=!!o.amount_deduct,r[t].local_name=o.local_name):(r[t].charge_type_id=null,r[t].amount_deduct=!1)}else r[t][s]=a;Ne(r)},wt=()=>{Ne([...y,{charge_type:"",charge_type_id:null,amount:"",amount_deduct:!1,remark:"",is_paid:!1,date:new Date().toISOString().split("T")[0]}])},Ct=t=>{Ne(y.filter((s,a)=>a!==t))};n.useEffect(()=>{(async()=>{try{const s=await T("/api/workingType");pt(s||[])}catch(s){console.error("Error fetching work types",s)}})()},[]);const we=n.useMemo(()=>{const t={};return qe.forEach(s=>{t[s.id]=s.type_of_work}),t},[qe]),se=n.useCallback(async(t="")=>{Ee(!0);try{const s=t?`/api/projects?searchQuery=${encodeURIComponent(t)}`:"/api/projects",a=await T(s),r=Array.isArray(a)?a:a==null?void 0:a.data;if(!r||!Array.isArray(r)){P([]),t||m("warning","No projects data available from server");return}const o=r.map(c=>({id:c.id,project_name:c.project_name||"Unknown Project",customer_name:c.customer_name||"Unknown Customer",work_place:c.work_place||"",project_cost:c.project_cost||"0",mobile_number:c.mobile_number||"",gst_number:c.gst_number||"",remark:c.remark||"",paidamount:c.paidamount||0,customer_id:c.customer_id||c.id,company_id:c.company_id,machine_id:c.machine_id||[],customer:{name:c.customer_name||"Unknown",address:c.work_place||"N/A",mobile:c.mobile_number||"N/A"},start_date:c.start_date,end_date:c.end_date})).filter(c=>c.project_name&&c.customer_id);P(o)}catch(s){console.error("Error fetching projects:",s),P([]),t||m("danger","Failed to fetch projects")}finally{Ee(!1)}},[]);n.useEffect(()=>{var t,s,a,r;U&&u&&(ee({projectId:u.projectId,customer_id:u.customer_id,customer_name:((t=u.customer)==null?void 0:t.name)||"",address:((s=u.customer)==null?void 0:s.address)||"",mobile_number:((a=u.customer)==null?void 0:a.mobile)||"",customer:u.customer,invoiceType:u.invoiceType,invoiceDate:u.invoiceDate,discount:u.discount||0,payed:u.paidamount||0,finalAmount:u.finalAmount||0,start_date:u.start_date||"",end_date:u.end_date||""}),gt(u.items||[{work_type:"",qty:0,price:0,total_price:0,remark:""}]),J(((r=u.customer)==null?void 0:r.name)||""))},[U,u]),n.useEffect(()=>{se()},[se]),n.useEffect(()=>{const t=setTimeout(()=>{_&&_.length>0?se(_):_.length===0&&(P([]),R(!1))},100);return()=>clearTimeout(t)},[_,se]),n.useEffect(()=>{if(_&&O.length>0){const t=_.toLowerCase(),s=O.filter(a=>a.project_name&&a.project_name.toLowerCase().includes(t)||a.customer_name&&a.customer_name.toLowerCase().includes(t)||a.work_place&&a.work_place.toLowerCase().includes(t)||a.mobile_number&&a.mobile_number.includes(t)||a.remark&&a.remark.toLowerCase().includes(t));console.log("Filtered projects:",s,"Query:",_),me(s)}else me([])},[_,O]);const vt=async()=>{try{const t=await T("/api/machineLog");he(t||[])}catch(t){m("danger","Error fetching machine logs: "+t)}},kt=()=>{T("/api/operatorsByCompanyIdOperator").then(t=>{lt(t||[]),S(!1)}).catch(t=>{console.log(t.message),S(!1)})};n.useEffect(()=>{vt(),kt()},[]),n.useEffect(()=>{const t=s=>{_e.current&&!_e.current.contains(s.target)&&Z.current&&!Z.current.contains(s.target)&&R(!1)};return z&&document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[z]);const St=async()=>{try{const t=await T("/api/machine-operators");ut(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}},At=async()=>{try{const t=await T("/api/machine-price");ht(t)}catch(t){console.error("Error fetching machineries:",t),m("danger","Error fetching machineries")}};n.useEffect(()=>{St(),At()},[]);const Ce=n.useCallback(t=>{if(!t||!t.machine_id||!Array.isArray(t.machine_id)||A.length===0){de([]);return}const s=A.filter(a=>t.machine_id.includes(String(a.id)));de(s)},[A]);n.useEffect(()=>{if(A.length>0&&d.projectId){const t=O.find(s=>s.id===d.projectId);t&&Ce(t)}},[A,d.projectId,O,Ce]),n.useEffect(()=>{if(!d.projectId)return;const t=setTimeout(async()=>{try{const s=Number(d.payed)||0;await ce(`/api/projects/${d.projectId}/paidamount`,{paidamount:s})}catch(s){console.error("Failed updating project paidamount:",s)}},500);return()=>clearTimeout(t)},[d.projectId,d.payed]),n.useEffect(()=>{if(!d.projectId||ue.length===0){K([]);return}const s=ue.filter(a=>String(a.project_id)===String(d.projectId)).filter(a=>a.isPaid==0);K(s)},[ue,d.projectId]);const ne=n.useCallback(t=>{if(!t||A.length===0)return"N/A";const s=A.find(a=>String(a.id)===String(t));return(s==null?void 0:s.machine_name)||"N/A"},[A]),Je=t=>{const s=parseFloat(t.project_cost)||0,a=parseFloat(d.discount)||0,r=Math.max(0,s-a);ee(o=>({...o,projectId:t.id,payed:t.paidamount,customer_id:t.customer_id,customer_name:t.customer_name,address:t.work_place,mobile_number:t.mobile_number,start_date:t.start_date,end_date:t.end_date,projectCost:s,finalAmount:r,company_id:t.company_id,customer:{name:t.customer_name,address:t.customer.address,mobile:t.customer.mobile},selectedMachines:[]})),R(!1),J(t.customer_name),P([]),Ce(t)},v=n.useMemo(()=>{if(!Q.trim())return M;const t=Q.toLowerCase();return M.filter(s=>{var N,k,b;const a=((N=we[s.work_type_id])==null?void 0:N.toLowerCase())||"",r=ie.find(L=>L.id==s.operator_id),o=((k=r==null?void 0:r.name)==null?void 0:k.toLowerCase())||"",c=ne(s.machine_id).toLowerCase(),i=pe.find(L=>L.id===Number(s.mode_id)),l=((b=i==null?void 0:i.mode)==null?void 0:b.toLowerCase())||"",p=String(s.work_date).slice(0,10);return a.includes(t)||o.includes(t)||c.includes(t)||l.includes(t)||p.includes(t)})},[M,Q,we,ie,ne,pe]),It=()=>{ee(t=>({...t,projectId:null,customer_id:null,customer_name:"",address:"",mobile_number:"",customer:{name:"",address:"",mobile:""},projectCost:0,payed:0,finalAmount:0,selectedMachines:[]})),J(""),R(!1),P([]),de([])},Ke=()=>{R(!1),H(t=>({...t,customer_name:_||""})),ae(!0)},oe=t=>{const{name:s,value:a}=t.target;if(s==="mobile_number"){const r=a.replace(/\D/g,"");if(r.length>10)return;H(o=>({...o,mobile_number:r}));return}if(s==="gst_number"){if(a.length>15)return;H(r=>({...r,gst_number:a}));return}H(r=>({...r,[s]:a}))},Ze=async t=>{if(t.preventDefault(),!j.customer_name.trim()){m("danger","Customer name is required");return}if(!j.mobile_number||!/^[6-9]\d{9}$/.test(j.mobile_number)){m("danger","Please enter a valid 10-digit mobile number");return}try{S(!0);const s={customer_name:j.customer_name,mobile_number:j.mobile_number,gst_number:j.gst_number||"",work_place:j.work_place||"",project_name:"",project_cost:"",supervisor_id:"",commission:"",start_date:"",end_date:"",is_visible:!0,remark:"",operator_id:[""],machine_id:[]};await $("/api/projects",s);let a=null;try{const r=await T(`/api/projects?searchQuery=${encodeURIComponent(j.customer_name)}`),o=Array.isArray(r)?r:r==null?void 0:r.data;if(o&&Array.isArray(o)){const c=o.map(i=>({id:i.id,project_name:i.project_name||"Unknown Project",customer_name:i.customer_name||"Unknown Customer",work_place:i.work_place||"",project_cost:i.project_cost||"0",mobile_number:i.mobile_number||"",gst_number:i.gst_number||"",remark:i.remark||"",paidamount:i.paidamount||0,customer_id:i.customer_id||i.id,company_id:i.company_id,machine_id:i.machine_id||[],customer:{name:i.customer_name||"Unknown",address:i.work_place||"N/A",mobile:i.mobile_number||"N/A"},start_date:i.start_date,end_date:i.end_date})).filter(i=>i.project_name&&i.customer_id);a=c.find(i=>i.customer_name.toLowerCase()===j.customer_name.toLowerCase()&&i.mobile_number===j.mobile_number)||c[0]||null}}catch(r){console.error("Error fetching newly created customer project:",r)}a?(Je(a),m("success","Customer added and selected successfully")):m("success","Customer added successfully, please search to select"),ae(!1),H({customer_name:"",mobile_number:"",gst_number:"",work_place:""}),P([]),me([])}catch(s){console.error("Error adding customer from invoice:",s),m("danger","Failed to add customer")}finally{S(!1)}},Et=t=>{const{name:s,value:a}=t.target,r=s==="discount"||s==="paidAmount"?parseFloat(a)||0:a;ee(o=>{const c={...o,[s]:r};if(s==="discount"){const i=parseFloat(o.projectCost)||0,l=parseFloat(r)||0;c.finalAmount=Math.max(0,i-l)}return c})},Lt=t=>{be(t.id),te(String(t.price_per_hour??0))},Ft=()=>{be(null),te("")},Tt=async t=>{const s=Number(ye);if(isNaN(s)||s<0){m("danger","Enter a valid price");return}try{const a=await ce(`/api/machine-logs/${t.id}/price`,{price_per_hour:s});if(a&&a.error){m("danger","Failed to update price");return}K(r=>r.map(o=>String(o.id)===String(q)?{...o,price_per_hour:s}:o)),typeof he=="function"&&he(r=>Array.isArray(r)?r.map(o=>String(o.id)===String(q)?{...o,price_per_hour:s}:o):r),be(null),te(""),m("success","Price updated successfully")}catch(a){console.error("Error updating log price:",a),m("danger","Error updating price")}},Pt=t=>{ge(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},Mt=async t=>{if(t.preventDefault(),!t.currentTarget.checkValidity()){dt(!0);return}if(!d.projectId||!d.customer_id){m("danger","Please select a customer");return}for(const r of y)if(Number(r.amount)>0){if(!r.charge_type){m("danger","Please select a charge type for the entered amount");return}if(!V.some(c=>c.name===r.charge_type||c.id===r.charge_type_id)&&!r.charge_type_id){m("danger",`Charge type "${r.charge_type}" is invalid. Please add it using the dropdown options.`);return}}const a=y.filter(r=>r.charge_type&&Number(r.amount)>0).map(r=>{var o;return{charge_type:r.charge_type,charge_type_id:r.charge_type_id??((o=V.find(c=>c.name===r.charge_type))==null?void 0:o.id)??null,amount:Number(r.amount),amount_deduct:r.amount_deduct??!1,remark:r.remark||null,is_paid:r.is_paid??!1,date:r.date}});try{if(S(!0),d.projectId){const l=Number(d.payed)||0;try{await ce(`/api/projects/${d.projectId}/paidamount`,{paidamount:l})}catch(p){console.error("Failed to update project paidamount on submit:",p)}}const r=M.filter(l=>h.includes(l.id));console.log("Selected Rows:",r);const o=r.length>0?r[0].company_id:d.company_id;if(r.length===0&&!(C&&Number(I)>0)&&!(E&&Number(B)>0)){m("warning","Select logs, enable Advance Payment, or enable Fixed Bid Work"),S(!1);return}const c=r.reduce((l,p)=>{const N=Number(p.machine_start??p.start_reading??0)||0,k=Number(p.machine_end??p.end_reading??0)||0,b=p.actual_machine_hr!=null&&!isNaN(Number(p.actual_machine_hr))?Number(p.actual_machine_hr):Math.max(0,k-N),L=Number(p.price_per_hour)||0;return l+b*L},0);let i=null;if(r.length>0){console.log("ðŸ”„ Updating isPaid=1 for logs:",h);const l=h.map(F=>ce(`/api/machine-logs/${F}/isPaid`,{isPaid:1}));await Promise.all(l),console.log("âœ… ALL selected logs updated to isPaid = 1"),K(F=>F.map(ve=>h.includes(ve.id)?{...ve,isPaid:1}:ve)),ge([]);let p=0,N=null,k=null,b=null;C&&Number(I)>0&&(p=Number(I),N=xe,k=fe,b=je);const L={project_id:d.projectId,company_id:o,total:c,paid_amount:p,worklog_ids:h,payment_mode:N,transaction_id:k,remark:b};if(U&&Ae)await Ae(L),m("success",`${r.length} logs marked as paid`);else{const F=await $("/api/project-payments",L);F&&F.id&&(i=F.id,a.length>0&&await $("/api/invoice-additional-charges/bulk",{invoice_id:String(F.invoice_number),company_id:o,charges:a}),m("success",`Invoice created! ${r.length} logs marked as PAID âœ…`))}}if(r.length===0&&C&&Number(I)>0){const l=await $("/api/project-payments",{company_id:o,project_id:d.projectId,total:Number(I),paid_amount:Number(I),is_advance:!0,transaction_id:fe||null,mode:xe||null,remark:je||null});l&&l.id&&(m("success","Advance payment invoice created"),i||(i=l.id))}if(E&&Number(B)>0){if(Number(D)>Number(B)){m("danger","Advance amount cannot be greater than Total amount"),S(!1);return}const l=await $("/api/project-payments",{company_id:o,project_id:d.projectId,total:Number(B),paid_amount:Number(D)||0,is_fixed_bid:!0,transaction_id:Number(D)>0?Ue:null,mode:Number(D)>0?We:"Fixed Bid",remark:ze||null,date:d.invoiceDate});l&&l.id&&(i||(i=l.id),a.length>0&&await $("/api/invoice-additional-charges/bulk",{invoice_id:String(l.id),company_id:o,charges:a}),m("success","Fixed Bid Work invoice created"))}i&&setTimeout(()=>{mt(`/payment-page/${i}`)},1e3)}catch(r){console.error("Submit error:",r),m("danger","Failed to create invoice")}finally{S(!1)}};return e.jsxs(W,{children:[e.jsx(f,{xs:12,children:e.jsxs(tt,{className:"mb-4",children:[e.jsx(at,{children:e.jsx("strong",{children:U?"Edit Invoice":"Create Invoice"})}),e.jsxs(ke,{children:[e.jsxs(rt,{validated:it,onSubmit:Mt,children:[e.jsxs(W,{className:"mb-3",children:[e.jsxs(f,{md:6,children:[e.jsxs(g,{children:["Customer Name ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsxs("div",{ref:_e,style:{position:"relative"},children:[e.jsxs(st,{children:[e.jsx(x,{type:"text",value:_,onChange:t=>{J(t.target.value),R(!0)},placeholder:"Search by customer name, location, mobile...",required:!0}),e.jsx(nt,{children:e.jsx(Y,{icon:ot})}),_&&e.jsx(w,{color:"link",onClick:It,className:"position-absolute end-0 me-5",children:e.jsx(Y,{icon:Se})})]}),Ie&&z&&_.length>0&&e.jsxs("div",{className:"dropdown-menu show p-2",children:[e.jsx(et,{size:"sm"})," Loading customers..."]}),z&&le.length>0&&e.jsxs("div",{ref:Z,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:[le.map(t=>e.jsxs("div",{className:"dropdown-item cursor-pointer p-2 border-bottom",onClick:()=>Je(t),onMouseEnter:s=>s.target.style.backgroundColor="#f8f9fa",onMouseLeave:s=>s.target.style.backgroundColor="white",children:[e.jsx("div",{className:"fw-medium text-primary",children:t.customer_name}),t.work_place&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",t.work_place]}),t.mobile_number&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Mobile:"})," ",t.mobile_number]})]},t.id)),e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ke,children:['Add customer "',_,'"']})})]}),_.length>0&&le.length===0&&z&&e.jsx("div",{ref:Z,className:"dropdown-menu show",style:{maxHeight:"300px",overflowY:"auto"},children:e.jsx("div",{className:"dropdown-item text-center",children:e.jsxs("button",{type:"button",className:"btn btn-sm btn-primary w-100",onClick:Ke,children:['Add customer "',_,'"']})})})]}),d.customer_name&&e.jsxs("div",{className:"mt-1 p-2 bg-light rounded border",children:[e.jsxs("div",{className:"small text-success",children:[e.jsx("strong",{children:"Selected:"})," ",d.customer_name]}),d.customer.address&&e.jsxs("div",{className:"small text-muted",children:[e.jsx("strong",{children:"Location:"})," ",d.customer.address]})]})]}),e.jsxs(f,{md:6,children:[e.jsxs(g,{children:["Invoice Date ",e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx(x,{type:"date",name:"invoiceDate",value:d.invoiceDate,onChange:Et,required:!0})]})]}),M.length>0&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h6",{className:"fw-semibold mb-0",children:["Project Logs (Total: ",M.length,") |",e.jsxs("span",{className:"text-primary ms-2",children:["Showing: ",v.length]})," |",e.jsxs("span",{className:"text-success ms-2",children:["Selected: ",h.length]})]}),e.jsx("div",{style:{width:"300px"},children:e.jsxs(st,{size:"sm",children:[e.jsx(nt,{children:e.jsx(Y,{icon:ot})}),e.jsx(x,{type:"text",placeholder:"Search by operator, work type, machine, mode...",value:Q,onChange:t=>He(t.target.value)}),Q&&e.jsx(w,{color:"secondary",variant:"outline",onClick:()=>He(""),children:e.jsx(Y,{icon:Se})})]})})]}),e.jsx("div",{className:"table-container",style:{width:"100%",overflowX:"auto",overflowY:"auto",border:"1px solid #dee2e6",borderRadius:"8px",backgroundColor:"#fff",WebkitOverflowScrolling:"touch"},children:e.jsxs("table",{className:"table table-bordered align-middle",style:{minWidth:"1200px",width:"100%",tableLayout:"fixed",margin:0},children:[e.jsx("thead",{className:"table-light",style:{position:"sticky",top:0,backgroundColor:"#f8f9fa",zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"50px"},className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:v.length>0&&v.every(t=>h.includes(t.id)),onChange:t=>{const s=t.target.checked;ge(s?[...new Set([...h,...v.map(a=>a.id)])]:h.filter(a=>!v.map(r=>r.id).includes(a)))}})}),e.jsx("th",{style:{width:"90px",minWidth:"90px"},className:"text-center align-middle",children:"Date"}),e.jsx("th",{style:{width:"110px",minWidth:"100px"},className:"text-center align-middle",children:"Machine"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Operator"}),e.jsx("th",{style:{width:"100px",minWidth:"90px"},className:"text-center align-middle",children:"Work Type"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Start"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"End"}),e.jsx("th",{style:{width:"80px"},className:"text-center align-middle",children:"Net"}),e.jsx("th",{style:{width:"70px"},className:"text-center align-middle",children:"Mode"}),e.jsx("th",{style:{width:"90px"},className:"text-center align-middle",children:"Price/Hr"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Total"}),e.jsx("th",{style:{width:"100px"},className:"text-center align-middle",children:"Action"})]})}),e.jsxs("tbody",{children:[v.map((t,s)=>{const a=Number(t.machine_start??t.start_reading??0)||0,r=Number(t.machine_end??t.end_reading??0)||0,o=t.actual_machine_hr!=null&&!isNaN(Number(t.actual_machine_hr))?Number(t.actual_machine_hr):Math.max(0,r-a),c=String(t.work_date).slice(0,10).split("-").reverse().join("-"),i=ie.find(b=>b.id==t.operator_id)||{name:"N/A"},l=String(t.id)===String(q)?Number(ye||0):Number(t.price_per_hour||0),p=o*l,N=pe.find(b=>b.id===Number(t.mode_id)),k=N?N.mode:"N/A";return e.jsxs("tr",{children:[e.jsx("td",{className:"text-center align-middle",children:e.jsx("input",{type:"checkbox",checked:h.includes(t.id),onChange:()=>Pt(t.id)})}),e.jsx("td",{className:"text-center small",children:c||"N/A"}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"110px"},title:ne(t.machine_id),children:ne(t.machine_id)}),e.jsx("td",{className:"text-truncate small",style:{maxWidth:"100px"},title:i.name,children:i.name}),e.jsx("td",{children:we[t.work_type_id]||"-"}),e.jsx("td",{className:"text-center",children:a}),e.jsx("td",{className:"text-center",children:r}),e.jsx("td",{className:"text-center",children:o}),e.jsx("td",{className:"text-center small",children:k}),e.jsx("td",{children:String(t.id)===String(q)?e.jsx("input",{type:"number",value:ye,min:0,step:"0.01",onChange:b=>te(b.target.value),style:{width:"70px",fontSize:"0.875rem"},className:"form-control form-control-sm"}):e.jsxs("div",{className:"text-center small",children:["â‚¹",l]})}),e.jsxs("td",{className:"text-center small",children:["â‚¹",p.toFixed(2)]}),e.jsx("td",{className:"text-center",children:String(t.id)===String(q)?e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"sm",color:"success",className:"me-1",onClick:()=>Tt(t),children:"Save"}),e.jsx(w,{size:"sm",color:"secondary",variant:"outline",onClick:Ft,children:"Cancel"})]}):e.jsx(w,{size:"sm",color:"info",className:"text-white",onClick:()=>Lt(t),children:"Edit"})})]},s)}),h.length>0&&(()=>{const t=v.filter(a=>h.includes(a.id)).reduce((a,r)=>{const o=Number(r.machine_start??r.start_reading??0)||0,c=Number(r.machine_end??r.end_reading??0)||0,i=r.actual_machine_hr!=null&&!isNaN(Number(r.actual_machine_hr))?Number(r.actual_machine_hr):Math.max(0,c-o);return a+i},0),s=v.filter(a=>h.includes(a.id)).reduce((a,r)=>{const o=Number(r.machine_start??r.start_reading??0)||0,c=Number(r.machine_end??r.end_reading??0)||0,i=r.actual_machine_hr!=null&&!isNaN(Number(r.actual_machine_hr))?Number(r.actual_machine_hr):Math.max(0,c-o),l=Number(r.price_per_hour)||0;return a+i*l},0);return e.jsxs("tr",{className:"fw-bold table-success",children:[e.jsx("td",{className:"text-center align-middle",children:h.length}),e.jsx("td",{colSpan:"6",className:"text-end pe-3",children:"Grand Total:"}),e.jsx("td",{className:"text-center",children:t.toFixed(2)}),e.jsx("td",{}),e.jsxs("td",{className:"text-center",children:["â‚¹",s.toFixed(2)]}),e.jsx("td",{})]})})()]})]})})]}),M.length>0&&e.jsxs(tt,{className:"mb-4 border-0 shadow-sm",children:[e.jsx(at,{style:{background:"#f3f4f6"},children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges"})}),e.jsx(ke,{children:y.map((t,s)=>e.jsxs(W,{className:"align-items-end mb-3",style:{zIndex:1e3-s,position:"relative"},children:[e.jsxs(f,{md:3,children:[e.jsx(g,{children:"Charge Type"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx(x,{type:"text",placeholder:"Select or Search...",value:t.charge_type,onChange:a=>{re(s,"charge_type",a.target.value),ft(r=>({...r,[s]:a.target.value})),G(r=>({...r,[s]:!0}))},onFocus:()=>G(a=>({...a,[s]:!0})),onBlur:()=>setTimeout(()=>G(a=>({...a,[s]:!1})),200)}),jt[s]&&e.jsxs("div",{className:"dropdown-menu show",style:{width:"100%",maxHeight:"200px",overflowY:"auto",position:"absolute",top:"100%",left:0,zIndex:1050},children:[V.filter(a=>!t.charge_type||a.name.toLowerCase().includes(t.charge_type.toLowerCase())||a.local_name&&a.local_name.toLowerCase().includes(t.charge_type.toLowerCase())).map(a=>e.jsxs("button",{className:"dropdown-item",type:"button",onMouseDown:r=>r.preventDefault(),onClick:()=>{re(s,"charge_type",a.name),G(r=>({...r,[s]:!1}))},children:[a.name," ",a.local_name?`(${a.local_name})`:""," ",a.amount_deduct?"(-)":"(+)"]},a.id)),V.every(a=>a.name.toLowerCase()!==(t.charge_type||"").toLowerCase())&&e.jsxs("button",{className:"dropdown-item text-primary fw-bold",type:"button",onMouseDown:a=>a.preventDefault(),onClick:()=>{Nt(a=>({...a,name:t.charge_type})),yt(s),Ve(!0),G(a=>({...a,[s]:!1}))},children:['+ Add "',t.charge_type,'"']})]})]})]}),e.jsxs(f,{md:2,children:[e.jsx(g,{children:"Amount"}),e.jsx(x,{type:"number",placeholder:"0",value:t.amount,onChange:a=>re(s,"amount",a.target.value)})]}),e.jsxs(f,{children:[" ",e.jsx(w,{size:"sm",color:"primary",variant:"outline",onClick:wt,children:"+ Add Additional Charge"})]}),e.jsx(f,{md:1,children:y.length>1&&e.jsx(w,{color:"danger",variant:"ghost",onClick:()=>Ct(s),children:e.jsx(Y,{icon:Se})})})]},s))}),y.some(t=>t.charge_type&&t.amount)&&e.jsx(ke,{className:"border-top bg-light",children:e.jsxs(W,{className:"align-items-center",children:[e.jsx(f,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold",children:"Additional Charges Net:"})}),e.jsx(f,{md:3,children:e.jsxs("h5",{className:"mb-0 fw-bold text-primary",children:["â‚¹",y.filter(t=>t.charge_type&&t.amount).reduce((t,s)=>{const a=parseFloat(s.amount)||0;return s.amount_deduct?t-a:t+a},0).toFixed(2)]})})]})})]}),h.length>0&&e.jsxs(W,{className:"align-items-center mt-3 pt-3 border-top",children:[e.jsx(f,{md:9,className:"text-end",children:e.jsx("h6",{className:"mb-0 fw-bold text-success",children:"Actual Payable(Logs + Additional Charges):"})}),e.jsx(f,{md:3,children:e.jsxs("h4",{className:"mb-0 fw-bold text-success",children:["â‚¹",(()=>{const t=v.filter(a=>h.includes(a.id)).reduce((a,r)=>{const o=Number(r.machine_start??r.start_reading??0)||0,c=Number(r.machine_end??r.end_reading??0)||0,i=r.actual_machine_hr!=null&&!isNaN(Number(r.actual_machine_hr))?Number(r.actual_machine_hr):Math.max(0,c-o),l=Number(r.price_per_hour)||0;return a+i*l},0),s=y.filter(a=>a.charge_type&&a.amount).reduce((a,r)=>{const o=parseFloat(r.amount)||0;return r.amount_deduct?a-o:a+o},0);return(t+s).toFixed(2)})()]})})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${C?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${C?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"advanceSwitch",checked:C,disabled:E,onChange:t=>{const s=t.target.checked;Le(s),s&&(Be(!1),Re(""),De(""),$e(""),Oe(""),Qe(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"advanceSwitch",children:"Advance Payment"})]}),C&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(g,{children:["Advance Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(x,{type:"number",min:"0",placeholder:"Enter amount",value:I,onChange:t=>Fe(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Transaction ID"}),e.jsx(x,{type:"text",placeholder:"Enter transaction ID",value:fe,onChange:t=>Pe(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Mode"}),e.jsxs(ct,{value:xe,onChange:t=>Te(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Remark"}),e.jsx(x,{type:"text",placeholder:"Enter remark",value:je,onChange:t=>Me(t.target.value)})]})]})]}),d.projectId&&e.jsxs("div",{className:`my-2 ${E?"p-3":"px-3 py-2"} bg-light rounded border`,children:[e.jsxs("div",{className:`form-check form-switch d-flex align-items-center gap-2 ${E?"mb-3":"mb-0"}`,children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"fixedBidSwitch",checked:E,disabled:C,onChange:t=>{const s=t.target.checked;Be(s),s&&(Le(!1),Fe(""),Te(""),Pe(""),Me(""))}}),e.jsx("label",{className:"form-check-label mb-0 fw-semibold",htmlFor:"fixedBidSwitch",children:"Fixed Bid Work"})]}),E&&e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-3",children:[e.jsxs(g,{children:["Total Amount ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(x,{type:"number",min:"0",placeholder:"Enter total amount",value:B,onChange:t=>Re(t.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Advance Amount"}),e.jsx(x,{type:"number",min:"0",placeholder:"Enter paid amount",value:D,onChange:t=>{const s=parseFloat(t.target.value)||0,a=parseFloat(B)||0;if(s>a){m("danger","Paid amount cannot be greater than Total amount");return}De(t.target.value)}})]}),Number(D)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Transaction ID"}),e.jsx(x,{type:"text",placeholder:"Enter transaction ID",value:Ue,onChange:t=>Oe(t.target.value)})]}),e.jsxs("div",{className:"col-md-3",children:[e.jsx(g,{children:"Mode"}),e.jsxs(ct,{value:We,onChange:t=>$e(t.target.value),children:[e.jsx("option",{value:"",children:"Select mode"}),e.jsx("option",{value:"Cash",children:"Cash"}),e.jsx("option",{value:"UPI",children:"UPI and Online"}),e.jsx("option",{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx("option",{value:"Credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx(g,{children:"Description"}),e.jsx(x,{type:"text",placeholder:"Enter description",value:ze,onChange:t=>Qe(t.target.value)})]})]})]}),e.jsx(w,{color:"primary",type:"submit",disabled:X||!d.projectId||!d.customer_id||Ie||h.length===0&&!(C&&Number(I)>0)&&!(E&&Number(B)>0),children:X?e.jsx(et,{size:"sm"}):U?"Update Invoice":"Submit Invoice"})]}),e.jsxs($t,{visible:_t,onClose:()=>ae(!1),children:[e.jsx(Ut,{closeButton:!0,children:"Add New Customer"}),e.jsx(Ot,{children:e.jsx(rt,{onSubmit:Ze,children:e.jsxs(W,{className:"g-3",children:[e.jsxs(f,{md:12,children:[e.jsx(g,{children:"Customer Name"}),e.jsx(x,{type:"text",name:"customer_name",value:j.customer_name,onChange:oe,placeholder:"Enter Customer Name...",required:!0})]}),e.jsxs(f,{md:12,children:[e.jsx(g,{children:"Mobile Number"}),e.jsx(x,{type:"text",name:"mobile_number",value:j.mobile_number,onChange:oe,placeholder:"Enter Customer Mobile...",maxLength:10,required:!0})]}),e.jsxs(f,{md:12,children:[e.jsx(g,{children:"GST Number (Optional)"}),e.jsx(x,{type:"text",name:"gst_number",value:j.gst_number,onChange:oe,placeholder:"Enter GST number...",maxLength:15})]}),e.jsxs(f,{md:12,children:[e.jsx(g,{children:"Location"}),e.jsx(x,{type:"text",name:"work_place",value:j.work_place,onChange:oe,placeholder:"Enter Location..."})]})]})})}),e.jsxs(zt,{children:[e.jsx(w,{color:"secondary",variant:"outline",onClick:()=>ae(!1),children:"Cancel"}),e.jsx(w,{color:"primary",onClick:Ze,disabled:X,children:X?"Saving...":"Save Customer"})]})]})]})]})}),bt&&e.jsx(Dt,{visible:!0,onClose:()=>Ve(!1),onSuccess:t=>{Xe(),Ge!==null&&re(Ge,"charge_type",t.name)},initialData:Ye.name?{name:Ye.name}:null})]})};export{ga as default};
